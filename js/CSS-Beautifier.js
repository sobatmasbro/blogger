document.querySelector('.openMSpopup').addEventListener('click', function() {var SobatMasbroDemo = new SobatMasbro({contentHtml: '<iframe src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+Cjxib2R5Pgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgo8bGluayBocmVmPSdodHRwczovL3NvYmF0bWFzYnJvLmJsb2dzcG90LmNvbS9mYXZpY29uLmljbycgcmVsPSdpY29uJyB0eXBlPSdpbWFnZS94LWljb24nLz4KICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgIDx0aXRsZT5Dc3MgQmVhdXRpZmllciB8IFNvYmF0IE1hc2JybyA8L3RpdGxlPgogIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0Ij4KICAJLy8gQ29kZU1pcnJvciB2ZXJzaW9uIDIuMzQKCi8vIEFsbCBmdW5jdGlvbnMgdGhhdCBuZWVkIGFjY2VzcyB0byB0aGUgZWRpdG9yJ3Mgc3RhdGUgbGl2ZSBpbnNpZGUKLy8gdGhlIENvZGVNaXJyb3IgZnVuY3Rpb24uIEJlbG93IHRoYXQsIGF0IHRoZSBib3R0b20gb2YgdGhlIGZpbGUsCi8vIHNvbWUgdXRpbGl0aWVzIGFyZSBkZWZpbmVkLgoKLy8gQ29kZU1pcnJvciBpcyB0aGUgb25seSBnbG9iYWwgdmFyIHdlIGNsYWltCndpbmRvdy5Db2RlTWlycm9yID0gKGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICAvLyBUaGlzIGlzIHRoZSBmdW5jdGlvbiB0aGF0IHByb2R1Y2VzIGFuIGVkaXRvciBpbnN0YW5jZS4gSXRzCiAgLy8gY2xvc3VyZSBpcyB1c2VkIHRvIHN0b3JlIHRoZSBlZGl0b3Igc3RhdGUuCiAgZnVuY3Rpb24gQ29kZU1pcnJvcihwbGFjZSwgZ2l2ZW5PcHRpb25zKSB7CiAgICAvLyBEZXRlcm1pbmUgZWZmZWN0aXZlIG9wdGlvbnMgYmFzZWQgb24gZ2l2ZW4gdmFsdWVzIGFuZCBkZWZhdWx0cy4KICAgIHZhciBvcHRpb25zID0ge30sIGRlZmF1bHRzID0gQ29kZU1pcnJvci5kZWZhdWx0czsKICAgIGZvciAodmFyIG9wdCBpbiBkZWZhdWx0cykKICAgICAgaWYgKGRlZmF1bHRzLmhhc093blByb3BlcnR5KG9wdCkpCiAgICAgICAgb3B0aW9uc1tvcHRdID0gKGdpdmVuT3B0aW9ucyAmJiBnaXZlbk9wdGlvbnMuaGFzT3duUHJvcGVydHkob3B0KSA/IGdpdmVuT3B0aW9ucyA6IGRlZmF1bHRzKVtvcHRdOwoKICAgIHZhciBpbnB1dCA9IGVsdCgidGV4dGFyZWEiLCBudWxsLCBudWxsLCAicG9zaXRpb246IGFic29sdXRlOyBwYWRkaW5nOiAwOyB3aWR0aDogMXB4OyBoZWlnaHQ6IDFlbSIpOwogICAgaW5wdXQuc2V0QXR0cmlidXRlKCJ3cmFwIiwgIm9mZiIpOyBpbnB1dC5zZXRBdHRyaWJ1dGUoImF1dG9jb3JyZWN0IiwgIm9mZiIpOyBpbnB1dC5zZXRBdHRyaWJ1dGUoImF1dG9jYXBpdGFsaXplIiwgIm9mZiIpOwogICAgLy8gV3JhcHMgYW5kIGhpZGVzIGlucHV0IHRleHRhcmVhCiAgICB2YXIgaW5wdXREaXYgPSBlbHQoImRpdiIsIFtpbnB1dF0sIG51bGwsICJvdmVyZmxvdzogaGlkZGVuOyBwb3NpdGlvbjogcmVsYXRpdmU7IHdpZHRoOiAzcHg7IGhlaWdodDogMHB4OyIpOwogICAgLy8gVGhlIGVtcHR5IHNjcm9sbGJhciBjb250ZW50LCB1c2VkIHNvbGVseSBmb3IgbWFuYWdpbmcgdGhlIHNjcm9sbGJhciB0aHVtYi4KICAgIHZhciBzY3JvbGxiYXJJbm5lciA9IGVsdCgiZGl2IiwgbnVsbCwgIkNvZGVNaXJyb3Itc2Nyb2xsYmFyLWlubmVyIik7CiAgICAvLyBUaGUgdmVydGljYWwgc2Nyb2xsYmFyLiBIb3Jpem9udGFsIHNjcm9sbGluZyBpcyBoYW5kbGVkIGJ5IHRoZSBzY3JvbGxlciBpdHNlbGYuCiAgICB2YXIgc2Nyb2xsYmFyID0gZWx0KCJkaXYiLCBbc2Nyb2xsYmFySW5uZXJdLCAiQ29kZU1pcnJvci1zY3JvbGxiYXIiKTsKICAgIC8vIERJVnMgY29udGFpbmluZyB0aGUgc2VsZWN0aW9uIGFuZCB0aGUgYWN0dWFsIGNvZGUKICAgIHZhciBsaW5lRGl2ID0gZWx0KCJkaXYiKSwgc2VsZWN0aW9uRGl2ID0gZWx0KCJkaXYiLCBudWxsLCBudWxsLCAicG9zaXRpb246IHJlbGF0aXZlOyB6LWluZGV4OiAtMSIpOwogICAgLy8gQmxpbmt5IGN1cnNvciwgYW5kIGVsZW1lbnQgdXNlZCB0byBlbnN1cmUgY3Vyc29yIGZpdHMgYXQgdGhlIGVuZCBvZiBhIGxpbmUKICAgIHZhciBjdXJzb3IgPSBlbHQoInByZSIsICJcdTAwYTAiLCAiQ29kZU1pcnJvci1jdXJzb3IiKSwgd2lkdGhGb3JjZXIgPSBlbHQoInByZSIsICJcdTAwYTAiLCAiQ29kZU1pcnJvci1jdXJzb3IiLCAidmlzaWJpbGl0eTogaGlkZGVuIik7CiAgICAvLyBVc2VkIHRvIG1lYXN1cmUgdGV4dCBzaXplCiAgICB2YXIgbWVhc3VyZSA9IGVsdCgiZGl2IiwgbnVsbCwgbnVsbCwgInBvc2l0aW9uOiBhYnNvbHV0ZTsgd2lkdGg6IDEwMCU7IGhlaWdodDogMHB4OyBvdmVyZmxvdzogaGlkZGVuOyB2aXNpYmlsaXR5OiBoaWRkZW47Iik7CiAgICB2YXIgbGluZVNwYWNlID0gZWx0KCJkaXYiLCBbbWVhc3VyZSwgY3Vyc29yLCB3aWR0aEZvcmNlciwgc2VsZWN0aW9uRGl2LCBsaW5lRGl2XSwgbnVsbCwgInBvc2l0aW9uOiByZWxhdGl2ZTsgei1pbmRleDogMCIpOwogICAgdmFyIGd1dHRlclRleHQgPSBlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLWd1dHRlci10ZXh0IiksIGd1dHRlciA9IGVsdCgiZGl2IiwgW2d1dHRlclRleHRdLCAiQ29kZU1pcnJvci1ndXR0ZXIiKTsKICAgIC8vIE1vdmVkIGFyb3VuZCBpdHMgcGFyZW50IHRvIGNvdmVyIHZpc2libGUgdmlldwogICAgdmFyIG1vdmVyID0gZWx0KCJkaXYiLCBbZ3V0dGVyLCBlbHQoImRpdiIsIFtsaW5lU3BhY2VdLCAiQ29kZU1pcnJvci1saW5lcyIpXSwgbnVsbCwgInBvc2l0aW9uOiByZWxhdGl2ZSIpOwogICAgLy8gU2V0IHRvIHRoZSBoZWlnaHQgb2YgdGhlIHRleHQsIGNhdXNlcyBzY3JvbGxpbmcKICAgIHZhciBzaXplciA9IGVsdCgiZGl2IiwgW21vdmVyXSwgbnVsbCwgInBvc2l0aW9uOiByZWxhdGl2ZSIpOwogICAgLy8gUHJvdmlkZXMgc2Nyb2xsaW5nCiAgICB2YXIgc2Nyb2xsZXIgPSBlbHQoImRpdiIsIFtzaXplcl0sICJDb2RlTWlycm9yLXNjcm9sbCIpOwogICAgc2Nyb2xsZXIuc2V0QXR0cmlidXRlKCJ0YWJJbmRleCIsICItMSIpOwogICAgLy8gVGhlIGVsZW1lbnQgaW4gd2hpY2ggdGhlIGVkaXRvciBsaXZlcy4KICAgIHZhciB3cmFwcGVyID0gZWx0KCJkaXYiLCBbaW5wdXREaXYsIHNjcm9sbGJhciwgc2Nyb2xsZXJdLCAiQ29kZU1pcnJvciIgKyAob3B0aW9ucy5saW5lV3JhcHBpbmcgPyAiIENvZGVNaXJyb3Itd3JhcCIgOiAiIikpOwogICAgaWYgKHBsYWNlLmFwcGVuZENoaWxkKSBwbGFjZS5hcHBlbmRDaGlsZCh3cmFwcGVyKTsgZWxzZSBwbGFjZSh3cmFwcGVyKTsKCiAgICB0aGVtZUNoYW5nZWQoKTsga2V5TWFwQ2hhbmdlZCgpOwogICAgLy8gTmVlZGVkIHRvIGhpZGUgYmlnIGJsdWUgYmxpbmtpbmcgY3Vyc29yIG9uIE1vYmlsZSBTYWZhcmkKICAgIGlmIChpb3MpIGlucHV0LnN0eWxlLndpZHRoID0gIjBweCI7CiAgICBpZiAoIXdlYmtpdCkgc2Nyb2xsZXIuZHJhZ2dhYmxlID0gdHJ1ZTsKICAgIGxpbmVTcGFjZS5zdHlsZS5vdXRsaW5lID0gIm5vbmUiOwogICAgaWYgKG9wdGlvbnMudGFiaW5kZXggIT0gbnVsbCkgaW5wdXQudGFiSW5kZXggPSBvcHRpb25zLnRhYmluZGV4OwogICAgaWYgKG9wdGlvbnMuYXV0b2ZvY3VzKSBmb2N1c0lucHV0KCk7CiAgICBpZiAoIW9wdGlvbnMuZ3V0dGVyICYmICFvcHRpb25zLmxpbmVOdW1iZXJzKSBndXR0ZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIC8vIE5lZWRlZCB0byBoYW5kbGUgVGFiIGtleSBpbiBLSFRNTAogICAgaWYgKGtodG1sKSBpbnB1dERpdi5zdHlsZS5oZWlnaHQgPSAiMXB4IiwgaW5wdXREaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwoKICAgIC8vIENoZWNrIGZvciBPUyBYID49IDEwLjcuIFRoaXMgaGFzIHRyYW5zcGFyZW50IHNjcm9sbGJhcnMsIHNvIHRoZQogICAgLy8gb3ZlcmxheWluZyBvZiBvbmUgc2Nyb2xsYmFyIHdpdGggYW5vdGhlciB3b24ndCB3b3JrLiBUaGlzIGlzIGEKICAgIC8vIHRlbXBvcmFyeSBoYWNrIHRvIHNpbXBseSB0dXJuIG9mZiB0aGUgb3ZlcmxheSBzY3JvbGxiYXIuIFNlZQogICAgLy8gaXNzdWUgIzcyNy4KICAgIGlmIChtYWNfZ2VMaW9uKSB7IHNjcm9sbGJhci5zdHlsZS56SW5kZXggPSAtMjsgc2Nyb2xsYmFyLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsgfQogICAgLy8gTmVlZCB0byBzZXQgYSBtaW5pbXVtIHdpZHRoIHRvIHNlZSB0aGUgc2Nyb2xsYmFyIG9uIElFNyAoYnV0IG11c3Qgbm90IHNldCBpdCBvbiBJRTgpLgogICAgZWxzZSBpZiAoaWVfbHQ4KSBzY3JvbGxiYXIuc3R5bGUubWluV2lkdGggPSAiMThweCI7CgogICAgLy8gRGVsYXllZCBvYmplY3Qgd3JhcCB0aW1lb3V0cywgbWFraW5nIHN1cmUgb25seSBvbmUgaXMgYWN0aXZlLiBibGlua2VyIGhvbGRzIGFuIGludGVydmFsLgogICAgdmFyIHBvbGwgPSBuZXcgRGVsYXllZCgpLCBoaWdobGlnaHQgPSBuZXcgRGVsYXllZCgpLCBibGlua2VyOwoKICAgIC8vIG1vZGUgaG9sZHMgYSBtb2RlIEFQSSBvYmplY3QuIGRvYyBpcyB0aGUgdHJlZSBvZiBMaW5lIG9iamVjdHMsCiAgICAvLyBmcm9udGllciBpcyB0aGUgcG9pbnQgdXAgdG8gd2hpY2ggdGhlIGNvbnRlbnQgaGFzIGJlZW4gcGFyc2VkLAogICAgLy8gYW5kIGhpc3RvcnkgdGhlIHVuZG8gaGlzdG9yeSAoaW5zdGFuY2Ugb2YgSGlzdG9yeSBjb25zdHJ1Y3RvcikuCiAgICB2YXIgbW9kZSwgZG9jID0gbmV3IEJyYW5jaENodW5rKFtuZXcgTGVhZkNodW5rKFtuZXcgTGluZSgiIildKV0pLCBmcm9udGllciA9IDAsIGZvY3VzZWQ7CiAgICBsb2FkTW9kZSgpOwogICAgLy8gVGhlIHNlbGVjdGlvbi4gVGhlc2UgYXJlIGFsd2F5cyBtYWludGFpbmVkIHRvIHBvaW50IGF0IHZhbGlkCiAgICAvLyBwb3NpdGlvbnMuIEludmVydGVkIGlzIHVzZWQgdG8gcmVtZW1iZXIgdGhhdCB0aGUgdXNlciBpcwogICAgLy8gc2VsZWN0aW5nIGJvdHRvbS10by10b3AuCiAgICB2YXIgc2VsID0ge2Zyb206IHtsaW5lOiAwLCBjaDogMH0sIHRvOiB7bGluZTogMCwgY2g6IDB9LCBpbnZlcnRlZDogZmFsc2V9OwogICAgLy8gU2VsZWN0aW9uLXJlbGF0ZWQgZmxhZ3MuIHNoaWZ0U2VsZWN0aW5nIG9idmlvdXNseSB0cmFja3MKICAgIC8vIHdoZXRoZXIgdGhlIHVzZXIgaXMgaG9sZGluZyBzaGlmdC4KICAgIHZhciBzaGlmdFNlbGVjdGluZywgbGFzdENsaWNrLCBsYXN0RG91YmxlQ2xpY2ssIGxhc3RTY3JvbGxUb3AgPSAwLCBkcmFnZ2luZ1RleHQsCiAgICAgICAgb3ZlcndyaXRlID0gZmFsc2UsIHN1cHByZXNzRWRpdHMgPSBmYWxzZTsKICAgIC8vIFZhcmlhYmxlcyB1c2VkIGJ5IHN0YXJ0T3BlcmF0aW9uL2VuZE9wZXJhdGlvbiB0byB0cmFjayB3aGF0CiAgICAvLyBoYXBwZW5lZCBkdXJpbmcgdGhlIG9wZXJhdGlvbi4KICAgIHZhciB1cGRhdGVJbnB1dCwgdXNlclNlbENoYW5nZSwgY2hhbmdlcywgdGV4dENoYW5nZWQsIHNlbGVjdGlvbkNoYW5nZWQsCiAgICAgICAgZ3V0dGVyRGlydHksIGNhbGxiYWNrczsKICAgIC8vIEN1cnJlbnQgdmlzaWJsZSByYW5nZSAobWF5IGJlIGJpZ2dlciB0aGFuIHRoZSB2aWV3IHdpbmRvdykuCiAgICB2YXIgZGlzcGxheU9mZnNldCA9IDAsIHNob3dpbmdGcm9tID0gMCwgc2hvd2luZ1RvID0gMCwgbGFzdFNpemVDID0gMDsKICAgIC8vIGJyYWNrZXRIaWdobGlnaHRlZCBpcyB1c2VkIHRvIHJlbWVtYmVyIHRoYXQgYSBicmFja2V0IGhhcyBiZWVuCiAgICAvLyBtYXJrZWQuCiAgICB2YXIgYnJhY2tldEhpZ2hsaWdodGVkOwogICAgLy8gVHJhY2tzIHRoZSBtYXhpbXVtIGxpbmUgbGVuZ3RoIHNvIHRoYXQgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyCiAgICAvLyBjYW4gYmUga2VwdCBzdGF0aWMgd2hlbiBzY3JvbGxpbmcuCiAgICB2YXIgbWF4TGluZSA9IGdldExpbmUoMCksIHVwZGF0ZU1heExpbmUgPSBmYWxzZSwgbWF4TGluZUNoYW5nZWQgPSB0cnVlOwogICAgdmFyIHBvbGxpbmdGYXN0ID0gZmFsc2U7IC8vIEVuc3VyZXMgc2xvd1BvbGwgZG9lc24ndCBjYW5jZWwgZmFzdFBvbGwKICAgIHZhciBnb2FsQ29sdW1uID0gbnVsbDsKCiAgICAvLyBJbml0aWFsaXplIHRoZSBjb250ZW50LgogICAgb3BlcmF0aW9uKGZ1bmN0aW9uKCl7c2V0VmFsdWUob3B0aW9ucy52YWx1ZSB8fCAiIik7IHVwZGF0ZUlucHV0ID0gZmFsc2U7fSkoKTsKICAgIHZhciBoaXN0b3J5ID0gbmV3IEhpc3RvcnkoKTsKCiAgICAvLyBSZWdpc3RlciBvdXIgZXZlbnQgaGFuZGxlcnMuCiAgICBjb25uZWN0KHNjcm9sbGVyLCAibW91c2Vkb3duIiwgb3BlcmF0aW9uKG9uTW91c2VEb3duKSk7CiAgICBjb25uZWN0KHNjcm9sbGVyLCAiZGJsY2xpY2siLCBvcGVyYXRpb24ob25Eb3VibGVDbGljaykpOwogICAgY29ubmVjdChsaW5lU3BhY2UsICJzZWxlY3RzdGFydCIsIGVfcHJldmVudERlZmF1bHQpOwogICAgLy8gR2Vja28gYnJvd3NlcnMgZmlyZSBjb250ZXh0bWVudSAqYWZ0ZXIqIG9wZW5pbmcgdGhlIG1lbnUsIGF0CiAgICAvLyB3aGljaCBwb2ludCB3ZSBjYW4ndCBtZXNzIHdpdGggaXQgYW55bW9yZS4gQ29udGV4dCBtZW51IGlzCiAgICAvLyBoYW5kbGVkIGluIG9uTW91c2VEb3duIGZvciBHZWNrby4KICAgIGlmICghZ2Vja28pIGNvbm5lY3Qoc2Nyb2xsZXIsICJjb250ZXh0bWVudSIsIG9uQ29udGV4dE1lbnUpOwogICAgY29ubmVjdChzY3JvbGxlciwgInNjcm9sbCIsIG9uU2Nyb2xsTWFpbik7CiAgICBjb25uZWN0KHNjcm9sbGJhciwgInNjcm9sbCIsIG9uU2Nyb2xsQmFyKTsKICAgIGNvbm5lY3Qoc2Nyb2xsYmFyLCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7aWYgKGZvY3VzZWQpIHNldFRpbWVvdXQoZm9jdXNJbnB1dCwgMCk7fSk7CiAgICB2YXIgcmVzaXplSGFuZGxlciA9IGNvbm5lY3Qod2luZG93LCAicmVzaXplIiwgZnVuY3Rpb24oKSB7CiAgICAgIGlmICh3cmFwcGVyLnBhcmVudE5vZGUpIHVwZGF0ZURpc3BsYXkodHJ1ZSk7CiAgICAgIGVsc2UgcmVzaXplSGFuZGxlcigpOwogICAgfSwgdHJ1ZSk7CiAgICBjb25uZWN0KGlucHV0LCAia2V5dXAiLCBvcGVyYXRpb24ob25LZXlVcCkpOwogICAgY29ubmVjdChpbnB1dCwgImlucHV0IiwgZmFzdFBvbGwpOwogICAgY29ubmVjdChpbnB1dCwgImtleWRvd24iLCBvcGVyYXRpb24ob25LZXlEb3duKSk7CiAgICBjb25uZWN0KGlucHV0LCAia2V5cHJlc3MiLCBvcGVyYXRpb24ob25LZXlQcmVzcykpOwogICAgY29ubmVjdChpbnB1dCwgImZvY3VzIiwgb25Gb2N1cyk7CiAgICBjb25uZWN0KGlucHV0LCAiYmx1ciIsIG9uQmx1cik7CgogICAgZnVuY3Rpb24gZHJhZ18oZSkgewogICAgICBpZiAob3B0aW9ucy5vbkRyYWdFdmVudCAmJiBvcHRpb25zLm9uRHJhZ0V2ZW50KGluc3RhbmNlLCBhZGRTdG9wKGUpKSkgcmV0dXJuOwogICAgICBlX3N0b3AoZSk7CiAgICB9CiAgICBpZiAob3B0aW9ucy5kcmFnRHJvcCkgewogICAgICBjb25uZWN0KHNjcm9sbGVyLCAiZHJhZ3N0YXJ0Iiwgb25EcmFnU3RhcnQpOwogICAgICBjb25uZWN0KHNjcm9sbGVyLCAiZHJhZ2VudGVyIiwgZHJhZ18pOwogICAgICBjb25uZWN0KHNjcm9sbGVyLCAiZHJhZ292ZXIiLCBkcmFnXyk7CiAgICAgIGNvbm5lY3Qoc2Nyb2xsZXIsICJkcm9wIiwgb3BlcmF0aW9uKG9uRHJvcCkpOwogICAgfQogICAgY29ubmVjdChzY3JvbGxlciwgInBhc3RlIiwgZnVuY3Rpb24oKXtmb2N1c0lucHV0KCk7IGZhc3RQb2xsKCk7fSk7CiAgICBjb25uZWN0KGlucHV0LCAicGFzdGUiLCBmYXN0UG9sbCk7CiAgICBjb25uZWN0KGlucHV0LCAiY3V0Iiwgb3BlcmF0aW9uKGZ1bmN0aW9uKCl7CiAgICAgIGlmICghb3B0aW9ucy5yZWFkT25seSkgcmVwbGFjZVNlbGVjdGlvbigiIik7CiAgICB9KSk7CgogICAgLy8gTmVlZGVkIHRvIGhhbmRsZSBUYWIga2V5IGluIEtIVE1MCiAgICBpZiAoa2h0bWwpIGNvbm5lY3Qoc2l6ZXIsICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT0gaW5wdXQpIGlucHV0LmJsdXIoKTsKICAgICAgICBmb2N1c0lucHV0KCk7CiAgICB9KTsKCiAgICAvLyBJRSB0aHJvd3MgdW5zcGVjaWZpZWQgZXJyb3IgaW4gY2VydGFpbiBjYXNlcywgd2hlbgogICAgLy8gdHJ5aW5nIHRvIGFjY2VzcyBhY3RpdmVFbGVtZW50IGJlZm9yZSBvbmxvYWQKICAgIHZhciBoYXNGb2N1czsgdHJ5IHsgaGFzRm9jdXMgPSAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PSBpbnB1dCk7IH0gY2F0Y2goZSkgeyB9CiAgICBpZiAoaGFzRm9jdXMgfHwgb3B0aW9ucy5hdXRvZm9jdXMpIHNldFRpbWVvdXQob25Gb2N1cywgMjApOwogICAgZWxzZSBvbkJsdXIoKTsKCiAgICBmdW5jdGlvbiBpc0xpbmUobCkge3JldHVybiBsID49IDAgJiYgbCA8IGRvYy5zaXplO30KICAgIC8vIFRoZSBpbnN0YW5jZSBvYmplY3QgdGhhdCB3ZSdsbCByZXR1cm4uIE1vc3RseSBjYWxscyBvdXQgdG8KICAgIC8vIGxvY2FsIGZ1bmN0aW9ucyBpbiB0aGUgQ29kZU1pcnJvciBmdW5jdGlvbi4gU29tZSBkbyBzb21lIGV4dHJhCiAgICAvLyByYW5nZSBjaGVja2luZyBhbmQvb3IgY2xpcHBpbmcuIG9wZXJhdGlvbiBpcyB1c2VkIHRvIHdyYXAgdGhlCiAgICAvLyBjYWxsIHNvIHRoYXQgY2hhbmdlcyBpdCBtYWtlcyBhcmUgdHJhY2tlZCwgYW5kIHRoZSBkaXNwbGF5IGlzCiAgICAvLyB1cGRhdGVkIGFmdGVyd2FyZHMuCiAgICB2YXIgaW5zdGFuY2UgPSB3cmFwcGVyLkNvZGVNaXJyb3IgPSB7CiAgICAgIGdldFZhbHVlOiBnZXRWYWx1ZSwKICAgICAgc2V0VmFsdWU6IG9wZXJhdGlvbihzZXRWYWx1ZSksCiAgICAgIGdldFNlbGVjdGlvbjogZ2V0U2VsZWN0aW9uLAogICAgICByZXBsYWNlU2VsZWN0aW9uOiBvcGVyYXRpb24ocmVwbGFjZVNlbGVjdGlvbiksCiAgICAgIGZvY3VzOiBmdW5jdGlvbigpe3dpbmRvdy5mb2N1cygpOyBmb2N1c0lucHV0KCk7IG9uRm9jdXMoKTsgZmFzdFBvbGwoKTt9LAogICAgICBzZXRPcHRpb246IGZ1bmN0aW9uKG9wdGlvbiwgdmFsdWUpIHsKICAgICAgICB2YXIgb2xkVmFsID0gb3B0aW9uc1tvcHRpb25dOwogICAgICAgIG9wdGlvbnNbb3B0aW9uXSA9IHZhbHVlOwogICAgICAgIGlmIChvcHRpb24gPT0gIm1vZGUiIHx8IG9wdGlvbiA9PSAiaW5kZW50VW5pdCIpIGxvYWRNb2RlKCk7CiAgICAgICAgZWxzZSBpZiAob3B0aW9uID09ICJyZWFkT25seSIgJiYgdmFsdWUgPT0gIm5vY3Vyc29yIikge29uQmx1cigpOyBpbnB1dC5ibHVyKCk7fQogICAgICAgIGVsc2UgaWYgKG9wdGlvbiA9PSAicmVhZE9ubHkiICYmICF2YWx1ZSkge3Jlc2V0SW5wdXQodHJ1ZSk7fQogICAgICAgIGVsc2UgaWYgKG9wdGlvbiA9PSAidGhlbWUiKSB0aGVtZUNoYW5nZWQoKTsKICAgICAgICBlbHNlIGlmIChvcHRpb24gPT0gImxpbmVXcmFwcGluZyIgJiYgb2xkVmFsICE9IHZhbHVlKSBvcGVyYXRpb24od3JhcHBpbmdDaGFuZ2VkKSgpOwogICAgICAgIGVsc2UgaWYgKG9wdGlvbiA9PSAidGFiU2l6ZSIpIHVwZGF0ZURpc3BsYXkodHJ1ZSk7CiAgICAgICAgZWxzZSBpZiAob3B0aW9uID09ICJrZXlNYXAiKSBrZXlNYXBDaGFuZ2VkKCk7CiAgICAgICAgaWYgKG9wdGlvbiA9PSAibGluZU51bWJlcnMiIHx8IG9wdGlvbiA9PSAiZ3V0dGVyIiB8fCBvcHRpb24gPT0gImZpcnN0TGluZU51bWJlciIgfHwKICAgICAgICAgICAgb3B0aW9uID09ICJ0aGVtZSIgfHwgb3B0aW9uID09ICJsaW5lTnVtYmVyRm9ybWF0dGVyIikgewogICAgICAgICAgZ3V0dGVyQ2hhbmdlZCgpOwogICAgICAgICAgdXBkYXRlRGlzcGxheSh0cnVlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldE9wdGlvbjogZnVuY3Rpb24ob3B0aW9uKSB7cmV0dXJuIG9wdGlvbnNbb3B0aW9uXTt9LAogICAgICBnZXRNb2RlOiBmdW5jdGlvbigpIHtyZXR1cm4gbW9kZTt9LAogICAgICB1bmRvOiBvcGVyYXRpb24odW5kbyksCiAgICAgIHJlZG86IG9wZXJhdGlvbihyZWRvKSwKICAgICAgaW5kZW50TGluZTogb3BlcmF0aW9uKGZ1bmN0aW9uKG4sIGRpcikgewogICAgICAgIGlmICh0eXBlb2YgZGlyICE9ICJzdHJpbmciKSB7CiAgICAgICAgICBpZiAoZGlyID09IG51bGwpIGRpciA9IG9wdGlvbnMuc21hcnRJbmRlbnQgPyAic21hcnQiIDogInByZXYiOwogICAgICAgICAgZWxzZSBkaXIgPSBkaXIgPyAiYWRkIiA6ICJzdWJ0cmFjdCI7CiAgICAgICAgfQogICAgICAgIGlmIChpc0xpbmUobikpIGluZGVudExpbmUobiwgZGlyKTsKICAgICAgfSksCiAgICAgIGluZGVudFNlbGVjdGlvbjogb3BlcmF0aW9uKGluZGVudFNlbGVjdGVkKSwKICAgICAgaGlzdG9yeVNpemU6IGZ1bmN0aW9uKCkge3JldHVybiB7dW5kbzogaGlzdG9yeS5kb25lLmxlbmd0aCwgcmVkbzogaGlzdG9yeS51bmRvbmUubGVuZ3RofTt9LAogICAgICBjbGVhckhpc3Rvcnk6IGZ1bmN0aW9uKCkge2hpc3RvcnkgPSBuZXcgSGlzdG9yeSgpO30sCiAgICAgIHNldEhpc3Rvcnk6IGZ1bmN0aW9uKGhpc3REYXRhKSB7CiAgICAgICAgaGlzdG9yeSA9IG5ldyBIaXN0b3J5KCk7CiAgICAgICAgaGlzdG9yeS5kb25lID0gaGlzdERhdGEuZG9uZTsKICAgICAgICBoaXN0b3J5LnVuZG9uZSA9IGhpc3REYXRhLnVuZG9uZTsKICAgICAgfSwKICAgICAgZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gY3AoYXJyKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbncgPSBbXSwgbndlbHQ7IGkgPCBhcnIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgbncucHVzaChud2VsdCA9IFtdKTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGVsdCA9IGFycltpXTsgaiA8IGVsdC5sZW5ndGg7ICsraikgewogICAgICAgICAgICAgIHZhciBvbGQgPSBbXSwgY3VyID0gZWx0W2pdOwogICAgICAgICAgICAgIG53ZWx0LnB1c2goe3N0YXJ0OiBjdXIuc3RhcnQsIGFkZGVkOiBjdXIuYWRkZWQsIG9sZDogb2xkfSk7CiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBjdXIub2xkLmxlbmd0aDsgKytrKSBvbGQucHVzaChobFRleHQoY3VyLm9sZFtrXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7ZG9uZTogY3AoaGlzdG9yeS5kb25lKSwgdW5kb25lOiBjcChoaXN0b3J5LnVuZG9uZSl9OwogICAgICB9LAogICAgICBtYXRjaEJyYWNrZXRzOiBvcGVyYXRpb24oZnVuY3Rpb24oKXttYXRjaEJyYWNrZXRzKHRydWUpO30pLAogICAgICBnZXRUb2tlbkF0OiBvcGVyYXRpb24oZnVuY3Rpb24ocG9zKSB7CiAgICAgICAgcG9zID0gY2xpcFBvcyhwb3MpOwogICAgICAgIHJldHVybiBnZXRMaW5lKHBvcy5saW5lKS5nZXRUb2tlbkF0KG1vZGUsIGdldFN0YXRlQmVmb3JlKHBvcy5saW5lKSwgb3B0aW9ucy50YWJTaXplLCBwb3MuY2gpOwogICAgICB9KSwKICAgICAgZ2V0U3RhdGVBZnRlcjogZnVuY3Rpb24obGluZSkgewogICAgICAgIGxpbmUgPSBjbGlwTGluZShsaW5lID09IG51bGwgPyBkb2Muc2l6ZSAtIDE6IGxpbmUpOwogICAgICAgIHJldHVybiBnZXRTdGF0ZUJlZm9yZShsaW5lICsgMSk7CiAgICAgIH0sCiAgICAgIGN1cnNvckNvb3JkczogZnVuY3Rpb24oc3RhcnQsIG1vZGUpIHsKICAgICAgICBpZiAoc3RhcnQgPT0gbnVsbCkgc3RhcnQgPSBzZWwuaW52ZXJ0ZWQ7CiAgICAgICAgcmV0dXJuIHRoaXMuY2hhckNvb3JkcyhzdGFydCA/IHNlbC5mcm9tIDogc2VsLnRvLCBtb2RlKTsKICAgICAgfSwKICAgICAgY2hhckNvb3JkczogZnVuY3Rpb24ocG9zLCBtb2RlKSB7CiAgICAgICAgcG9zID0gY2xpcFBvcyhwb3MpOwogICAgICAgIGlmIChtb2RlID09ICJsb2NhbCIpIHJldHVybiBsb2NhbENvb3Jkcyhwb3MsIGZhbHNlKTsKICAgICAgICBpZiAobW9kZSA9PSAiZGl2IikgcmV0dXJuIGxvY2FsQ29vcmRzKHBvcywgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHBhZ2VDb29yZHMocG9zKTsKICAgICAgfSwKICAgICAgY29vcmRzQ2hhcjogZnVuY3Rpb24oY29vcmRzKSB7CiAgICAgICAgdmFyIG9mZiA9IGVsdE9mZnNldChsaW5lU3BhY2UpOwogICAgICAgIHJldHVybiBjb29yZHNDaGFyKGNvb3Jkcy54IC0gb2ZmLmxlZnQsIGNvb3Jkcy55IC0gb2ZmLnRvcCk7CiAgICAgIH0sCiAgICAgIG1hcmtUZXh0OiBvcGVyYXRpb24obWFya1RleHQpLAogICAgICBzZXRCb29rbWFyazogc2V0Qm9va21hcmssCiAgICAgIGZpbmRNYXJrc0F0OiBmaW5kTWFya3NBdCwKICAgICAgc2V0TWFya2VyOiBvcGVyYXRpb24oYWRkR3V0dGVyTWFya2VyKSwKICAgICAgY2xlYXJNYXJrZXI6IG9wZXJhdGlvbihyZW1vdmVHdXR0ZXJNYXJrZXIpLAogICAgICBzZXRMaW5lQ2xhc3M6IG9wZXJhdGlvbihzZXRMaW5lQ2xhc3MpLAogICAgICBoaWRlTGluZTogb3BlcmF0aW9uKGZ1bmN0aW9uKGgpIHtyZXR1cm4gc2V0TGluZUhpZGRlbihoLCB0cnVlKTt9KSwKICAgICAgc2hvd0xpbmU6IG9wZXJhdGlvbihmdW5jdGlvbihoKSB7cmV0dXJuIHNldExpbmVIaWRkZW4oaCwgZmFsc2UpO30pLAogICAgICBvbkRlbGV0ZUxpbmU6IGZ1bmN0aW9uKGxpbmUsIGYpIHsKICAgICAgICBpZiAodHlwZW9mIGxpbmUgPT0gIm51bWJlciIpIHsKICAgICAgICAgIGlmICghaXNMaW5lKGxpbmUpKSByZXR1cm4gbnVsbDsKICAgICAgICAgIGxpbmUgPSBnZXRMaW5lKGxpbmUpOwogICAgICAgIH0KICAgICAgICAobGluZS5oYW5kbGVycyB8fCAobGluZS5oYW5kbGVycyA9IFtdKSkucHVzaChmKTsKICAgICAgICByZXR1cm4gbGluZTsKICAgICAgfSwKICAgICAgbGluZUluZm86IGxpbmVJbmZvLAogICAgICBnZXRWaWV3cG9ydDogZnVuY3Rpb24oKSB7IHJldHVybiB7ZnJvbTogc2hvd2luZ0Zyb20sIHRvOiBzaG93aW5nVG99O30sCiAgICAgIGFkZFdpZGdldDogZnVuY3Rpb24ocG9zLCBub2RlLCBzY3JvbGwsIHZlcnQsIGhvcml6KSB7CiAgICAgICAgcG9zID0gbG9jYWxDb29yZHMoY2xpcFBvcyhwb3MpKTsKICAgICAgICB2YXIgdG9wID0gcG9zLnlCb3QsIGxlZnQgPSBwb3MueDsKICAgICAgICBub2RlLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgICAgICBzaXplci5hcHBlbmRDaGlsZChub2RlKTsKICAgICAgICBpZiAodmVydCA9PSAib3ZlciIpIHRvcCA9IHBvcy55OwogICAgICAgIGVsc2UgaWYgKHZlcnQgPT0gIm5lYXIiKSB7CiAgICAgICAgICB2YXIgdnNwYWNlID0gTWF0aC5tYXgoc2Nyb2xsZXIub2Zmc2V0SGVpZ2h0LCBkb2MuaGVpZ2h0ICogdGV4dEhlaWdodCgpKSwKICAgICAgICAgICAgICBoc3BhY2UgPSBNYXRoLm1heChzaXplci5jbGllbnRXaWR0aCwgbGluZVNwYWNlLmNsaWVudFdpZHRoKSAtIHBhZGRpbmdMZWZ0KCk7CiAgICAgICAgICBpZiAocG9zLnlCb3QgKyBub2RlLm9mZnNldEhlaWdodCA+IHZzcGFjZSAmJiBwb3MueSA+IG5vZGUub2Zmc2V0SGVpZ2h0KQogICAgICAgICAgICB0b3AgPSBwb3MueSAtIG5vZGUub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgaWYgKGxlZnQgKyBub2RlLm9mZnNldFdpZHRoID4gaHNwYWNlKQogICAgICAgICAgICBsZWZ0ID0gaHNwYWNlIC0gbm9kZS5vZmZzZXRXaWR0aDsKICAgICAgICB9CiAgICAgICAgbm9kZS5zdHlsZS50b3AgPSAodG9wICsgcGFkZGluZ1RvcCgpKSArICJweCI7CiAgICAgICAgbm9kZS5zdHlsZS5sZWZ0ID0gbm9kZS5zdHlsZS5yaWdodCA9ICIiOwogICAgICAgIGlmIChob3JpeiA9PSAicmlnaHQiKSB7CiAgICAgICAgICBsZWZ0ID0gc2l6ZXIuY2xpZW50V2lkdGggLSBub2RlLm9mZnNldFdpZHRoOwogICAgICAgICAgbm9kZS5zdHlsZS5yaWdodCA9ICIwcHgiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaG9yaXogPT0gImxlZnQiKSBsZWZ0ID0gMDsKICAgICAgICAgIGVsc2UgaWYgKGhvcml6ID09ICJtaWRkbGUiKSBsZWZ0ID0gKHNpemVyLmNsaWVudFdpZHRoIC0gbm9kZS5vZmZzZXRXaWR0aCkgLyAyOwogICAgICAgICAgbm9kZS5zdHlsZS5sZWZ0ID0gKGxlZnQgKyBwYWRkaW5nTGVmdCgpKSArICJweCI7CiAgICAgICAgfQogICAgICAgIGlmIChzY3JvbGwpCiAgICAgICAgICBzY3JvbGxJbnRvVmlldyhsZWZ0LCB0b3AsIGxlZnQgKyBub2RlLm9mZnNldFdpZHRoLCB0b3AgKyBub2RlLm9mZnNldEhlaWdodCk7CiAgICAgIH0sCgogICAgICBsaW5lQ291bnQ6IGZ1bmN0aW9uKCkge3JldHVybiBkb2Muc2l6ZTt9LAogICAgICBjbGlwUG9zOiBjbGlwUG9zLAogICAgICBnZXRDdXJzb3I6IGZ1bmN0aW9uKHN0YXJ0KSB7CiAgICAgICAgaWYgKHN0YXJ0ID09IG51bGwpIHN0YXJ0ID0gc2VsLmludmVydGVkOwogICAgICAgIHJldHVybiBjb3B5UG9zKHN0YXJ0ID8gc2VsLmZyb20gOiBzZWwudG8pOwogICAgICB9LAogICAgICBzb21ldGhpbmdTZWxlY3RlZDogZnVuY3Rpb24oKSB7cmV0dXJuICFwb3NFcShzZWwuZnJvbSwgc2VsLnRvKTt9LAogICAgICBzZXRDdXJzb3I6IG9wZXJhdGlvbihmdW5jdGlvbihsaW5lLCBjaCwgdXNlcikgewogICAgICAgIGlmIChjaCA9PSBudWxsICYmIHR5cGVvZiBsaW5lLmxpbmUgPT0gIm51bWJlciIpIHNldEN1cnNvcihsaW5lLmxpbmUsIGxpbmUuY2gsIHVzZXIpOwogICAgICAgIGVsc2Ugc2V0Q3Vyc29yKGxpbmUsIGNoLCB1c2VyKTsKICAgICAgfSksCiAgICAgIHNldFNlbGVjdGlvbjogb3BlcmF0aW9uKGZ1bmN0aW9uKGZyb20sIHRvLCB1c2VyKSB7CiAgICAgICAgKHVzZXIgPyBzZXRTZWxlY3Rpb25Vc2VyIDogc2V0U2VsZWN0aW9uKShjbGlwUG9zKGZyb20pLCBjbGlwUG9zKHRvIHx8IGZyb20pKTsKICAgICAgfSksCiAgICAgIGdldExpbmU6IGZ1bmN0aW9uKGxpbmUpIHtpZiAoaXNMaW5lKGxpbmUpKSByZXR1cm4gZ2V0TGluZShsaW5lKS50ZXh0O30sCiAgICAgIGdldExpbmVIYW5kbGU6IGZ1bmN0aW9uKGxpbmUpIHtpZiAoaXNMaW5lKGxpbmUpKSByZXR1cm4gZ2V0TGluZShsaW5lKTt9LAogICAgICBzZXRMaW5lOiBvcGVyYXRpb24oZnVuY3Rpb24obGluZSwgdGV4dCkgewogICAgICAgIGlmIChpc0xpbmUobGluZSkpIHJlcGxhY2VSYW5nZSh0ZXh0LCB7bGluZTogbGluZSwgY2g6IDB9LCB7bGluZTogbGluZSwgY2g6IGdldExpbmUobGluZSkudGV4dC5sZW5ndGh9KTsKICAgICAgfSksCiAgICAgIHJlbW92ZUxpbmU6IG9wZXJhdGlvbihmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgaWYgKGlzTGluZShsaW5lKSkgcmVwbGFjZVJhbmdlKCIiLCB7bGluZTogbGluZSwgY2g6IDB9LCBjbGlwUG9zKHtsaW5lOiBsaW5lKzEsIGNoOiAwfSkpOwogICAgICB9KSwKICAgICAgcmVwbGFjZVJhbmdlOiBvcGVyYXRpb24ocmVwbGFjZVJhbmdlKSwKICAgICAgZ2V0UmFuZ2U6IGZ1bmN0aW9uKGZyb20sIHRvLCBsaW5lU2VwKSB7cmV0dXJuIGdldFJhbmdlKGNsaXBQb3MoZnJvbSksIGNsaXBQb3ModG8pLCBsaW5lU2VwKTt9LAoKICAgICAgdHJpZ2dlck9uS2V5RG93bjogb3BlcmF0aW9uKG9uS2V5RG93biksCiAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbihjbWQpIHtyZXR1cm4gY29tbWFuZHNbY21kXShpbnN0YW5jZSk7fSwKICAgICAgLy8gU3R1ZmYgdXNlZCBieSBjb21tYW5kcywgcHJvYmFibHkgbm90IG11Y2ggdXNlIHRvIG91dHNpZGUgY29kZS4KICAgICAgbW92ZUg6IG9wZXJhdGlvbihtb3ZlSCksCiAgICAgIGRlbGV0ZUg6IG9wZXJhdGlvbihkZWxldGVIKSwKICAgICAgbW92ZVY6IG9wZXJhdGlvbihtb3ZlViksCiAgICAgIHRvZ2dsZU92ZXJ3cml0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYob3ZlcndyaXRlKXsKICAgICAgICAgIG92ZXJ3cml0ZSA9IGZhbHNlOwogICAgICAgICAgY3Vyc29yLmNsYXNzTmFtZSA9IGN1cnNvci5jbGFzc05hbWUucmVwbGFjZSgiIENvZGVNaXJyb3Itb3ZlcndyaXRlIiwgIiIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdmVyd3JpdGUgPSB0cnVlOwogICAgICAgICAgY3Vyc29yLmNsYXNzTmFtZSArPSAiIENvZGVNaXJyb3Itb3ZlcndyaXRlIjsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBwb3NGcm9tSW5kZXg6IGZ1bmN0aW9uKG9mZikgewogICAgICAgIHZhciBsaW5lTm8gPSAwLCBjaDsKICAgICAgICBkb2MuaXRlcigwLCBkb2Muc2l6ZSwgZnVuY3Rpb24obGluZSkgewogICAgICAgICAgdmFyIHN6ID0gbGluZS50ZXh0Lmxlbmd0aCArIDE7CiAgICAgICAgICBpZiAoc3ogPiBvZmYpIHsgY2ggPSBvZmY7IHJldHVybiB0cnVlOyB9CiAgICAgICAgICBvZmYgLT0gc3o7CiAgICAgICAgICArK2xpbmVObzsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2xpcFBvcyh7bGluZTogbGluZU5vLCBjaDogY2h9KTsKICAgICAgfSwKICAgICAgaW5kZXhGcm9tUG9zOiBmdW5jdGlvbiAoY29vcmRzKSB7CiAgICAgICAgaWYgKGNvb3Jkcy5saW5lIDwgMCB8fCBjb29yZHMuY2ggPCAwKSByZXR1cm4gMDsKICAgICAgICB2YXIgaW5kZXggPSBjb29yZHMuY2g7CiAgICAgICAgZG9jLml0ZXIoMCwgY29vcmRzLmxpbmUsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICBpbmRleCArPSBsaW5lLnRleHQubGVuZ3RoICsgMTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0sCiAgICAgIHNjcm9sbFRvOiBmdW5jdGlvbih4LCB5KSB7CiAgICAgICAgaWYgKHggIT0gbnVsbCkgc2Nyb2xsZXIuc2Nyb2xsTGVmdCA9IHg7CiAgICAgICAgaWYgKHkgIT0gbnVsbCkgc2Nyb2xsYmFyLnNjcm9sbFRvcCA9IHNjcm9sbGVyLnNjcm9sbFRvcCA9IHk7CiAgICAgICAgdXBkYXRlRGlzcGxheShbXSk7CiAgICAgIH0sCiAgICAgIGdldFNjcm9sbEluZm86IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7eDogc2Nyb2xsZXIuc2Nyb2xsTGVmdCwgeTogc2Nyb2xsYmFyLnNjcm9sbFRvcCwKICAgICAgICAgICAgICAgIGhlaWdodDogc2Nyb2xsYmFyLnNjcm9sbEhlaWdodCwgd2lkdGg6IHNjcm9sbGVyLnNjcm9sbFdpZHRofTsKICAgICAgfSwKICAgICAgc2V0U2l6ZTogZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGZ1bmN0aW9uIGludGVycHJldCh2YWwpIHsKICAgICAgICAgIHZhbCA9IFN0cmluZyh2YWwpOwogICAgICAgICAgcmV0dXJuIC9eXGQrJC8udGVzdCh2YWwpID8gdmFsICsgInB4IiA6IHZhbDsKICAgICAgICB9CiAgICAgICAgaWYgKHdpZHRoICE9IG51bGwpIHdyYXBwZXIuc3R5bGUud2lkdGggPSBpbnRlcnByZXQod2lkdGgpOwogICAgICAgIGlmIChoZWlnaHQgIT0gbnVsbCkgc2Nyb2xsZXIuc3R5bGUuaGVpZ2h0ID0gaW50ZXJwcmV0KGhlaWdodCk7CiAgICAgICAgaW5zdGFuY2UucmVmcmVzaCgpOwogICAgICB9LAoKICAgICAgb3BlcmF0aW9uOiBmdW5jdGlvbihmKXtyZXR1cm4gb3BlcmF0aW9uKGYpKCk7fSwKICAgICAgY29tcG91bmRDaGFuZ2U6IGZ1bmN0aW9uKGYpe3JldHVybiBjb21wb3VuZENoYW5nZShmKTt9LAogICAgICByZWZyZXNoOiBmdW5jdGlvbigpewogICAgICAgIHVwZGF0ZURpc3BsYXkodHJ1ZSwgbnVsbCwgbGFzdFNjcm9sbFRvcCk7CiAgICAgICAgaWYgKHNjcm9sbGJhci5zY3JvbGxIZWlnaHQgPiBsYXN0U2Nyb2xsVG9wKQogICAgICAgICAgc2Nyb2xsYmFyLnNjcm9sbFRvcCA9IGxhc3RTY3JvbGxUb3A7CiAgICAgIH0sCiAgICAgIGdldElucHV0RmllbGQ6IGZ1bmN0aW9uKCl7cmV0dXJuIGlucHV0O30sCiAgICAgIGdldFdyYXBwZXJFbGVtZW50OiBmdW5jdGlvbigpe3JldHVybiB3cmFwcGVyO30sCiAgICAgIGdldFNjcm9sbGVyRWxlbWVudDogZnVuY3Rpb24oKXtyZXR1cm4gc2Nyb2xsZXI7fSwKICAgICAgZ2V0R3V0dGVyRWxlbWVudDogZnVuY3Rpb24oKXtyZXR1cm4gZ3V0dGVyO30KICAgIH07CgogICAgZnVuY3Rpb24gZ2V0TGluZShuKSB7IHJldHVybiBnZXRMaW5lQXQoZG9jLCBuKTsgfQogICAgZnVuY3Rpb24gdXBkYXRlTGluZUhlaWdodChsaW5lLCBoZWlnaHQpIHsKICAgICAgZ3V0dGVyRGlydHkgPSB0cnVlOwogICAgICB2YXIgZGlmZiA9IGhlaWdodCAtIGxpbmUuaGVpZ2h0OwogICAgICBmb3IgKHZhciBuID0gbGluZTsgbjsgbiA9IG4ucGFyZW50KSBuLmhlaWdodCArPSBkaWZmOwogICAgfQoKICAgIGZ1bmN0aW9uIGxpbmVDb250ZW50KGxpbmUsIHdyYXBBdCkgewogICAgICBpZiAoIWxpbmUuc3R5bGVzKQogICAgICAgIGxpbmUuaGlnaGxpZ2h0KG1vZGUsIGxpbmUuc3RhdGVBZnRlciA9IGdldFN0YXRlQmVmb3JlKGxpbmVObyhsaW5lKSksIG9wdGlvbnMudGFiU2l6ZSk7CiAgICAgIHJldHVybiBsaW5lLmdldENvbnRlbnQob3B0aW9ucy50YWJTaXplLCB3cmFwQXQsIG9wdGlvbnMubGluZVdyYXBwaW5nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRWYWx1ZShjb2RlKSB7CiAgICAgIHZhciB0b3AgPSB7bGluZTogMCwgY2g6IDB9OwogICAgICB1cGRhdGVMaW5lcyh0b3AsIHtsaW5lOiBkb2Muc2l6ZSAtIDEsIGNoOiBnZXRMaW5lKGRvYy5zaXplLTEpLnRleHQubGVuZ3RofSwKICAgICAgICAgICAgICAgICAgc3BsaXRMaW5lcyhjb2RlKSwgdG9wLCB0b3ApOwogICAgICB1cGRhdGVJbnB1dCA9IHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRWYWx1ZShsaW5lU2VwKSB7CiAgICAgIHZhciB0ZXh0ID0gW107CiAgICAgIGRvYy5pdGVyKDAsIGRvYy5zaXplLCBmdW5jdGlvbihsaW5lKSB7IHRleHQucHVzaChsaW5lLnRleHQpOyB9KTsKICAgICAgcmV0dXJuIHRleHQuam9pbihsaW5lU2VwIHx8ICJcbiIpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uU2Nyb2xsQmFyKGUpIHsKICAgICAgaWYgKHNjcm9sbGJhci5zY3JvbGxUb3AgIT0gbGFzdFNjcm9sbFRvcCkgewogICAgICAgIGxhc3RTY3JvbGxUb3AgPSBzY3JvbGxlci5zY3JvbGxUb3AgPSBzY3JvbGxiYXIuc2Nyb2xsVG9wOwogICAgICAgIHVwZGF0ZURpc3BsYXkoW10pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gb25TY3JvbGxNYWluKGUpIHsKICAgICAgaWYgKG9wdGlvbnMuZml4ZWRHdXR0ZXIgJiYgZ3V0dGVyLnN0eWxlLmxlZnQgIT0gc2Nyb2xsZXIuc2Nyb2xsTGVmdCArICJweCIpCiAgICAgICAgZ3V0dGVyLnN0eWxlLmxlZnQgPSBzY3JvbGxlci5zY3JvbGxMZWZ0ICsgInB4IjsKICAgICAgaWYgKHNjcm9sbGVyLnNjcm9sbFRvcCAhPSBsYXN0U2Nyb2xsVG9wKSB7CiAgICAgICAgbGFzdFNjcm9sbFRvcCA9IHNjcm9sbGVyLnNjcm9sbFRvcDsKICAgICAgICBpZiAoc2Nyb2xsYmFyLnNjcm9sbFRvcCAhPSBsYXN0U2Nyb2xsVG9wKQogICAgICAgICAgc2Nyb2xsYmFyLnNjcm9sbFRvcCA9IGxhc3RTY3JvbGxUb3A7CiAgICAgICAgdXBkYXRlRGlzcGxheShbXSk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMub25TY3JvbGwpIG9wdGlvbnMub25TY3JvbGwoaW5zdGFuY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTW91c2VEb3duKGUpIHsKICAgICAgc2V0U2hpZnQoZV9wcm9wKGUsICJzaGlmdEtleSIpKTsKICAgICAgLy8gQ2hlY2sgd2hldGhlciB0aGlzIGlzIGEgY2xpY2sgaW4gYSB3aWRnZXQKICAgICAgZm9yICh2YXIgbiA9IGVfdGFyZ2V0KGUpOyBuICE9IHdyYXBwZXI7IG4gPSBuLnBhcmVudE5vZGUpCiAgICAgICAgaWYgKG4ucGFyZW50Tm9kZSA9PSBzaXplciAmJiBuICE9IG1vdmVyKSByZXR1cm47CgogICAgICAvLyBTZWUgaWYgdGhpcyBpcyBhIGNsaWNrIGluIHRoZSBndXR0ZXIKICAgICAgZm9yICh2YXIgbiA9IGVfdGFyZ2V0KGUpOyBuICE9IHdyYXBwZXI7IG4gPSBuLnBhcmVudE5vZGUpCiAgICAgICAgaWYgKG4ucGFyZW50Tm9kZSA9PSBndXR0ZXJUZXh0KSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5vbkd1dHRlckNsaWNrKQogICAgICAgICAgICBvcHRpb25zLm9uR3V0dGVyQ2xpY2soaW5zdGFuY2UsIGluZGV4T2YoZ3V0dGVyVGV4dC5jaGlsZE5vZGVzLCBuKSArIHNob3dpbmdGcm9tLCBlKTsKICAgICAgICAgIHJldHVybiBlX3ByZXZlbnREZWZhdWx0KGUpOwogICAgICAgIH0KCiAgICAgIHZhciBzdGFydCA9IHBvc0Zyb21Nb3VzZShlKTsKCiAgICAgIHN3aXRjaCAoZV9idXR0b24oZSkpIHsKICAgICAgY2FzZSAzOgogICAgICAgIGlmIChnZWNrbykgb25Db250ZXh0TWVudShlKTsKICAgICAgICByZXR1cm47CiAgICAgIGNhc2UgMjoKICAgICAgICBpZiAoc3RhcnQpIHNldEN1cnNvcihzdGFydC5saW5lLCBzdGFydC5jaCwgdHJ1ZSk7CiAgICAgICAgc2V0VGltZW91dChmb2N1c0lucHV0LCAyMCk7CiAgICAgICAgZV9wcmV2ZW50RGVmYXVsdChlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gRm9yIGJ1dHRvbiAxLCBpZiBpdCB3YXMgY2xpY2tlZCBpbnNpZGUgdGhlIGVkaXRvcgogICAgICAvLyAocG9zRnJvbU1vdXNlIHJldHVybmluZyBub24tbnVsbCksIHdlIGhhdmUgdG8gYWRqdXN0IHRoZQogICAgICAvLyBzZWxlY3Rpb24uCiAgICAgIGlmICghc3RhcnQpIHtpZiAoZV90YXJnZXQoZSkgPT0gc2Nyb2xsZXIpIGVfcHJldmVudERlZmF1bHQoZSk7IHJldHVybjt9CgogICAgICBpZiAoIWZvY3VzZWQpIG9uRm9jdXMoKTsKCiAgICAgIHZhciBub3cgPSArbmV3IERhdGUsIHR5cGUgPSAic2luZ2xlIjsKICAgICAgaWYgKGxhc3REb3VibGVDbGljayAmJiBsYXN0RG91YmxlQ2xpY2sudGltZSA+IG5vdyAtIDQwMCAmJiBwb3NFcShsYXN0RG91YmxlQ2xpY2sucG9zLCBzdGFydCkpIHsKICAgICAgICB0eXBlID0gInRyaXBsZSI7CiAgICAgICAgZV9wcmV2ZW50RGVmYXVsdChlKTsKICAgICAgICBzZXRUaW1lb3V0KGZvY3VzSW5wdXQsIDIwKTsKICAgICAgICBzZWxlY3RMaW5lKHN0YXJ0LmxpbmUpOwogICAgICB9IGVsc2UgaWYgKGxhc3RDbGljayAmJiBsYXN0Q2xpY2sudGltZSA+IG5vdyAtIDQwMCAmJiBwb3NFcShsYXN0Q2xpY2sucG9zLCBzdGFydCkpIHsKICAgICAgICB0eXBlID0gImRvdWJsZSI7CiAgICAgICAgbGFzdERvdWJsZUNsaWNrID0ge3RpbWU6IG5vdywgcG9zOiBzdGFydH07CiAgICAgICAgZV9wcmV2ZW50RGVmYXVsdChlKTsKICAgICAgICB2YXIgd29yZCA9IGZpbmRXb3JkQXQoc3RhcnQpOwogICAgICAgIHNldFNlbGVjdGlvblVzZXIod29yZC5mcm9tLCB3b3JkLnRvKTsKICAgICAgfSBlbHNlIHsgbGFzdENsaWNrID0ge3RpbWU6IG5vdywgcG9zOiBzdGFydH07IH0KCiAgICAgIGZ1bmN0aW9uIGRyYWdFbmQoZTIpIHsKICAgICAgICBpZiAod2Via2l0KSBzY3JvbGxlci5kcmFnZ2FibGUgPSBmYWxzZTsKICAgICAgICBkcmFnZ2luZ1RleHQgPSBmYWxzZTsKICAgICAgICB1cCgpOyBkcm9wKCk7CiAgICAgICAgaWYgKE1hdGguYWJzKGUuY2xpZW50WCAtIGUyLmNsaWVudFgpICsgTWF0aC5hYnMoZS5jbGllbnRZIC0gZTIuY2xpZW50WSkgPCAxMCkgewogICAgICAgICAgZV9wcmV2ZW50RGVmYXVsdChlMik7CiAgICAgICAgICBzZXRDdXJzb3Ioc3RhcnQubGluZSwgc3RhcnQuY2gsIHRydWUpOwogICAgICAgICAgZm9jdXNJbnB1dCgpOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgbGFzdCA9IHN0YXJ0LCBnb2luZzsKICAgICAgaWYgKG9wdGlvbnMuZHJhZ0Ryb3AgJiYgZHJhZ0FuZERyb3AgJiYgIW9wdGlvbnMucmVhZE9ubHkgJiYgIXBvc0VxKHNlbC5mcm9tLCBzZWwudG8pICYmCiAgICAgICAgICAhcG9zTGVzcyhzdGFydCwgc2VsLmZyb20pICYmICFwb3NMZXNzKHNlbC50bywgc3RhcnQpICYmIHR5cGUgPT0gInNpbmdsZSIpIHsKICAgICAgICAvLyBMZXQgdGhlIGRyYWcgaGFuZGxlciBoYW5kbGUgdGhpcy4KICAgICAgICBpZiAod2Via2l0KSBzY3JvbGxlci5kcmFnZ2FibGUgPSB0cnVlOwogICAgICAgIHZhciB1cCA9IGNvbm5lY3QoZG9jdW1lbnQsICJtb3VzZXVwIiwgb3BlcmF0aW9uKGRyYWdFbmQpLCB0cnVlKTsKICAgICAgICB2YXIgZHJvcCA9IGNvbm5lY3Qoc2Nyb2xsZXIsICJkcm9wIiwgb3BlcmF0aW9uKGRyYWdFbmQpLCB0cnVlKTsKICAgICAgICBkcmFnZ2luZ1RleHQgPSB0cnVlOwogICAgICAgIC8vIElFJ3MgYXBwcm9hY2ggdG8gZHJhZ2dhYmxlCiAgICAgICAgaWYgKHNjcm9sbGVyLmRyYWdEcm9wKSBzY3JvbGxlci5kcmFnRHJvcCgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBlX3ByZXZlbnREZWZhdWx0KGUpOwogICAgICBpZiAodHlwZSA9PSAic2luZ2xlIikgc2V0Q3Vyc29yKHN0YXJ0LmxpbmUsIHN0YXJ0LmNoLCB0cnVlKTsKCiAgICAgIHZhciBzdGFydHN0YXJ0ID0gc2VsLmZyb20sIHN0YXJ0ZW5kID0gc2VsLnRvOwoKICAgICAgZnVuY3Rpb24gZG9TZWxlY3QoY3VyKSB7CiAgICAgICAgaWYgKHR5cGUgPT0gInNpbmdsZSIpIHsKICAgICAgICAgIHNldFNlbGVjdGlvblVzZXIoc3RhcnQsIGN1cik7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJkb3VibGUiKSB7CiAgICAgICAgICB2YXIgd29yZCA9IGZpbmRXb3JkQXQoY3VyKTsKICAgICAgICAgIGlmIChwb3NMZXNzKGN1ciwgc3RhcnRzdGFydCkpIHNldFNlbGVjdGlvblVzZXIod29yZC5mcm9tLCBzdGFydGVuZCk7CiAgICAgICAgICBlbHNlIHNldFNlbGVjdGlvblVzZXIoc3RhcnRzdGFydCwgd29yZC50byk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJ0cmlwbGUiKSB7CiAgICAgICAgICBpZiAocG9zTGVzcyhjdXIsIHN0YXJ0c3RhcnQpKSBzZXRTZWxlY3Rpb25Vc2VyKHN0YXJ0ZW5kLCBjbGlwUG9zKHtsaW5lOiBjdXIubGluZSwgY2g6IDB9KSk7CiAgICAgICAgICBlbHNlIHNldFNlbGVjdGlvblVzZXIoc3RhcnRzdGFydCwgY2xpcFBvcyh7bGluZTogY3VyLmxpbmUgKyAxLCBjaDogMH0pKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGV4dGVuZChlKSB7CiAgICAgICAgdmFyIGN1ciA9IHBvc0Zyb21Nb3VzZShlLCB0cnVlKTsKICAgICAgICBpZiAoY3VyICYmICFwb3NFcShjdXIsIGxhc3QpKSB7CiAgICAgICAgICBpZiAoIWZvY3VzZWQpIG9uRm9jdXMoKTsKICAgICAgICAgIGxhc3QgPSBjdXI7CiAgICAgICAgICBkb1NlbGVjdChjdXIpOwogICAgICAgICAgdXBkYXRlSW5wdXQgPSBmYWxzZTsKICAgICAgICAgIHZhciB2aXNpYmxlID0gdmlzaWJsZUxpbmVzKCk7CiAgICAgICAgICBpZiAoY3VyLmxpbmUgPj0gdmlzaWJsZS50byB8fCBjdXIubGluZSA8IHZpc2libGUuZnJvbSkKICAgICAgICAgICAgZ29pbmcgPSBzZXRUaW1lb3V0KG9wZXJhdGlvbihmdW5jdGlvbigpe2V4dGVuZChlKTt9KSwgMTUwKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGRvbmUoZSkgewogICAgICAgIGNsZWFyVGltZW91dChnb2luZyk7CiAgICAgICAgdmFyIGN1ciA9IHBvc0Zyb21Nb3VzZShlKTsKICAgICAgICBpZiAoY3VyKSBkb1NlbGVjdChjdXIpOwogICAgICAgIGVfcHJldmVudERlZmF1bHQoZSk7CiAgICAgICAgZm9jdXNJbnB1dCgpOwogICAgICAgIHVwZGF0ZUlucHV0ID0gdHJ1ZTsKICAgICAgICBtb3ZlKCk7IHVwKCk7CiAgICAgIH0KICAgICAgdmFyIG1vdmUgPSBjb25uZWN0KGRvY3VtZW50LCAibW91c2Vtb3ZlIiwgb3BlcmF0aW9uKGZ1bmN0aW9uKGUpIHsKICAgICAgICBjbGVhclRpbWVvdXQoZ29pbmcpOwogICAgICAgIGVfcHJldmVudERlZmF1bHQoZSk7CiAgICAgICAgaWYgKCFpZSAmJiAhZV9idXR0b24oZSkpIGRvbmUoZSk7CiAgICAgICAgZWxzZSBleHRlbmQoZSk7CiAgICAgIH0pLCB0cnVlKTsKICAgICAgdmFyIHVwID0gY29ubmVjdChkb2N1bWVudCwgIm1vdXNldXAiLCBvcGVyYXRpb24oZG9uZSksIHRydWUpOwogICAgfQogICAgZnVuY3Rpb24gb25Eb3VibGVDbGljayhlKSB7CiAgICAgIGZvciAodmFyIG4gPSBlX3RhcmdldChlKTsgbiAhPSB3cmFwcGVyOyBuID0gbi5wYXJlbnROb2RlKQogICAgICAgIGlmIChuLnBhcmVudE5vZGUgPT0gZ3V0dGVyVGV4dCkgcmV0dXJuIGVfcHJldmVudERlZmF1bHQoZSk7CiAgICAgIGVfcHJldmVudERlZmF1bHQoZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkRyb3AoZSkgewogICAgICBpZiAob3B0aW9ucy5vbkRyYWdFdmVudCAmJiBvcHRpb25zLm9uRHJhZ0V2ZW50KGluc3RhbmNlLCBhZGRTdG9wKGUpKSkgcmV0dXJuOwogICAgICBlX3ByZXZlbnREZWZhdWx0KGUpOwogICAgICB2YXIgcG9zID0gcG9zRnJvbU1vdXNlKGUsIHRydWUpLCBmaWxlcyA9IGUuZGF0YVRyYW5zZmVyLmZpbGVzOwogICAgICBpZiAoIXBvcyB8fCBvcHRpb25zLnJlYWRPbmx5KSByZXR1cm47CiAgICAgIGlmIChmaWxlcyAmJiBmaWxlcy5sZW5ndGggJiYgd2luZG93LkZpbGVSZWFkZXIgJiYgd2luZG93LkZpbGUpIHsKICAgICAgICB2YXIgbiA9IGZpbGVzLmxlbmd0aCwgdGV4dCA9IEFycmF5KG4pLCByZWFkID0gMDsKICAgICAgICB2YXIgbG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlLCBpKSB7CiAgICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXI7CiAgICAgICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRleHRbaV0gPSByZWFkZXIucmVzdWx0OwogICAgICAgICAgICBpZiAoKytyZWFkID09IG4pIHsKICAgICAgICAgICAgICBwb3MgPSBjbGlwUG9zKHBvcyk7CiAgICAgICAgICAgICAgb3BlcmF0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGVuZCA9IHJlcGxhY2VSYW5nZSh0ZXh0LmpvaW4oIiIpLCBwb3MsIHBvcyk7CiAgICAgICAgICAgICAgICBzZXRTZWxlY3Rpb25Vc2VyKHBvcywgZW5kKTsKICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmVhZGVyLnJlYWRBc1RleHQoZmlsZSk7CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkgbG9hZEZpbGUoZmlsZXNbaV0sIGkpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIERvbid0IGRvIGEgcmVwbGFjZSBpZiB0aGUgZHJvcCBoYXBwZW5lZCBpbnNpZGUgb2YgdGhlIHNlbGVjdGVkIHRleHQuCiAgICAgICAgaWYgKGRyYWdnaW5nVGV4dCAmJiAhKHBvc0xlc3MocG9zLCBzZWwuZnJvbSkgfHwgcG9zTGVzcyhzZWwudG8sIHBvcykpKSByZXR1cm47CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciB0ZXh0ID0gZS5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgiVGV4dCIpOwogICAgICAgICAgaWYgKHRleHQpIHsKICAgICAgICAgICAgY29tcG91bmRDaGFuZ2UoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGN1ckZyb20gPSBzZWwuZnJvbSwgY3VyVG8gPSBzZWwudG87CiAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uVXNlcihwb3MsIHBvcyk7CiAgICAgICAgICAgICAgaWYgKGRyYWdnaW5nVGV4dCkgcmVwbGFjZVJhbmdlKCIiLCBjdXJGcm9tLCBjdXJUbyk7CiAgICAgICAgICAgICAgcmVwbGFjZVNlbGVjdGlvbih0ZXh0KTsKICAgICAgICAgICAgICBmb2N1c0lucHV0KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaChlKXt9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG9uRHJhZ1N0YXJ0KGUpIHsKICAgICAgdmFyIHR4dCA9IGdldFNlbGVjdGlvbigpOwogICAgICBlLmRhdGFUcmFuc2Zlci5zZXREYXRhKCJUZXh0IiwgdHh0KTsKCiAgICAgIC8vIFVzZSBkdW1teSBpbWFnZSBpbnN0ZWFkIG9mIGRlZmF1bHQgYnJvd3NlcnMgaW1hZ2UuCiAgICAgIGlmIChlLmRhdGFUcmFuc2Zlci5zZXREcmFnSW1hZ2UpCiAgICAgICAgZS5kYXRhVHJhbnNmZXIuc2V0RHJhZ0ltYWdlKGVsdCgnaW1nJyksIDAsIDApOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvSGFuZGxlQmluZGluZyhib3VuZCwgZHJvcFNoaWZ0KSB7CiAgICAgIGlmICh0eXBlb2YgYm91bmQgPT0gInN0cmluZyIpIHsKICAgICAgICBib3VuZCA9IGNvbW1hbmRzW2JvdW5kXTsKICAgICAgICBpZiAoIWJvdW5kKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIHByZXZTaGlmdCA9IHNoaWZ0U2VsZWN0aW5nOwogICAgICB0cnkgewogICAgICAgIGlmIChvcHRpb25zLnJlYWRPbmx5KSBzdXBwcmVzc0VkaXRzID0gdHJ1ZTsKICAgICAgICBpZiAoZHJvcFNoaWZ0KSBzaGlmdFNlbGVjdGluZyA9IG51bGw7CiAgICAgICAgYm91bmQoaW5zdGFuY2UpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBpZiAoZSAhPSBQYXNzKSB0aHJvdyBlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBzaGlmdFNlbGVjdGluZyA9IHByZXZTaGlmdDsKICAgICAgICBzdXBwcmVzc0VkaXRzID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB2YXIgbWF5YmVUcmFuc2l0aW9uOwogICAgZnVuY3Rpb24gaGFuZGxlS2V5QmluZGluZyhlKSB7CiAgICAgIC8vIEhhbmRsZSBhdXRvIGtleW1hcCB0cmFuc2l0aW9ucwogICAgICB2YXIgc3RhcnRNYXAgPSBnZXRLZXlNYXAob3B0aW9ucy5rZXlNYXApLCBuZXh0ID0gc3RhcnRNYXAuYXV0bzsKICAgICAgY2xlYXJUaW1lb3V0KG1heWJlVHJhbnNpdGlvbik7CiAgICAgIGlmIChuZXh0ICYmICFpc01vZGlmaWVyS2V5KGUpKSBtYXliZVRyYW5zaXRpb24gPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChnZXRLZXlNYXAob3B0aW9ucy5rZXlNYXApID09IHN0YXJ0TWFwKSB7CiAgICAgICAgICBvcHRpb25zLmtleU1hcCA9IChuZXh0LmNhbGwgPyBuZXh0LmNhbGwobnVsbCwgaW5zdGFuY2UpIDogbmV4dCk7CiAgICAgICAgfQogICAgICB9LCA1MCk7CgogICAgICB2YXIgbmFtZSA9IGtleU5hbWVzW2VfcHJvcChlLCAia2V5Q29kZSIpXSwgaGFuZGxlZCA9IGZhbHNlOwogICAgICB2YXIgZmxpcEN0cmxDbWQgPSBvcGVyYSAmJiBtYWM7CiAgICAgIGlmIChuYW1lID09IG51bGwgfHwgZS5hbHRHcmFwaEtleSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoZV9wcm9wKGUsICJhbHRLZXkiKSkgbmFtZSA9ICJBbHQtIiArIG5hbWU7CiAgICAgIGlmIChlX3Byb3AoZSwgZmxpcEN0cmxDbWQgPyAibWV0YUtleSIgOiAiY3RybEtleSIpKSBuYW1lID0gIkN0cmwtIiArIG5hbWU7CiAgICAgIGlmIChlX3Byb3AoZSwgZmxpcEN0cmxDbWQgPyAiY3RybEtleSIgOiAibWV0YUtleSIpKSBuYW1lID0gIkNtZC0iICsgbmFtZTsKCiAgICAgIHZhciBzdG9wcGVkID0gZmFsc2U7CiAgICAgIGZ1bmN0aW9uIHN0b3AoKSB7IHN0b3BwZWQgPSB0cnVlOyB9CgogICAgICBpZiAoZV9wcm9wKGUsICJzaGlmdEtleSIpKSB7CiAgICAgICAgaGFuZGxlZCA9IGxvb2t1cEtleSgiU2hpZnQtIiArIG5hbWUsIG9wdGlvbnMuZXh0cmFLZXlzLCBvcHRpb25zLmtleU1hcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGIpIHtyZXR1cm4gZG9IYW5kbGVCaW5kaW5nKGIsIHRydWUpO30sIHN0b3ApCiAgICAgICAgICAgICAgIHx8IGxvb2t1cEtleShuYW1lLCBvcHRpb25zLmV4dHJhS2V5cywgb3B0aW9ucy5rZXlNYXAsIGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGIgPT0gInN0cmluZyIgJiYgL15nb1tBLVpdLy50ZXN0KGIpKSByZXR1cm4gZG9IYW5kbGVCaW5kaW5nKGIpOwogICAgICAgICAgICAgICB9LCBzdG9wKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVkID0gbG9va3VwS2V5KG5hbWUsIG9wdGlvbnMuZXh0cmFLZXlzLCBvcHRpb25zLmtleU1hcCwgZG9IYW5kbGVCaW5kaW5nLCBzdG9wKTsKICAgICAgfQogICAgICBpZiAoc3RvcHBlZCkgaGFuZGxlZCA9IGZhbHNlOwogICAgICBpZiAoaGFuZGxlZCkgewogICAgICAgIGVfcHJldmVudERlZmF1bHQoZSk7CiAgICAgICAgcmVzdGFydEJsaW5rKCk7CiAgICAgICAgaWYgKGllKSB7IGUub2xkS2V5Q29kZSA9IGUua2V5Q29kZTsgZS5rZXlDb2RlID0gMDsgfQogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVkOwogICAgfQogICAgZnVuY3Rpb24gaGFuZGxlQ2hhckJpbmRpbmcoZSwgY2gpIHsKICAgICAgdmFyIGhhbmRsZWQgPSBsb29rdXBLZXkoIiciICsgY2ggKyAiJyIsIG9wdGlvbnMuZXh0cmFLZXlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmtleU1hcCwgZnVuY3Rpb24oYikgeyByZXR1cm4gZG9IYW5kbGVCaW5kaW5nKGIsIHRydWUpOyB9KTsKICAgICAgaWYgKGhhbmRsZWQpIHsKICAgICAgICBlX3ByZXZlbnREZWZhdWx0KGUpOwogICAgICAgIHJlc3RhcnRCbGluaygpOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVkOwogICAgfQoKICAgIHZhciBsYXN0U3RvcHBlZEtleSA9IG51bGw7CiAgICBmdW5jdGlvbiBvbktleURvd24oZSkgewogICAgICBpZiAoIWZvY3VzZWQpIG9uRm9jdXMoKTsKICAgICAgaWYgKGllICYmIGUua2V5Q29kZSA9PSAyNykgeyBlLnJldHVyblZhbHVlID0gZmFsc2U7IH0KICAgICAgaWYgKHBvbGxpbmdGYXN0KSB7IGlmIChyZWFkSW5wdXQoKSkgcG9sbGluZ0Zhc3QgPSBmYWxzZTsgfQogICAgICBpZiAob3B0aW9ucy5vbktleUV2ZW50ICYmIG9wdGlvbnMub25LZXlFdmVudChpbnN0YW5jZSwgYWRkU3RvcChlKSkpIHJldHVybjsKICAgICAgdmFyIGNvZGUgPSBlX3Byb3AoZSwgImtleUNvZGUiKTsKICAgICAgLy8gSUUgZG9lcyBzdHJhbmdlIHRoaW5ncyB3aXRoIGVzY2FwZS4KICAgICAgc2V0U2hpZnQoY29kZSA9PSAxNiB8fCBlX3Byb3AoZSwgInNoaWZ0S2V5IikpOwogICAgICAvLyBGaXJzdCBnaXZlIG9uS2V5RXZlbnQgb3B0aW9uIGEgY2hhbmNlIHRvIGhhbmRsZSB0aGlzLgogICAgICB2YXIgaGFuZGxlZCA9IGhhbmRsZUtleUJpbmRpbmcoZSk7CiAgICAgIGlmIChvcGVyYSkgewogICAgICAgIGxhc3RTdG9wcGVkS2V5ID0gaGFuZGxlZCA/IGNvZGUgOiBudWxsOwogICAgICAgIC8vIE9wZXJhIGhhcyBubyBjdXQgZXZlbnQuLi4gd2UgdHJ5IHRvIGF0IGxlYXN0IGNhdGNoIHRoZSBrZXkgY29tYm8KICAgICAgICBpZiAoIWhhbmRsZWQgJiYgY29kZSA9PSA4OCAmJiBlX3Byb3AoZSwgbWFjID8gIm1ldGFLZXkiIDogImN0cmxLZXkiKSkKICAgICAgICAgIHJlcGxhY2VTZWxlY3Rpb24oIiIpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBvbktleVByZXNzKGUpIHsKICAgICAgaWYgKHBvbGxpbmdGYXN0KSByZWFkSW5wdXQoKTsKICAgICAgaWYgKG9wdGlvbnMub25LZXlFdmVudCAmJiBvcHRpb25zLm9uS2V5RXZlbnQoaW5zdGFuY2UsIGFkZFN0b3AoZSkpKSByZXR1cm47CiAgICAgIHZhciBrZXlDb2RlID0gZV9wcm9wKGUsICJrZXlDb2RlIiksIGNoYXJDb2RlID0gZV9wcm9wKGUsICJjaGFyQ29kZSIpOwogICAgICBpZiAob3BlcmEgJiYga2V5Q29kZSA9PSBsYXN0U3RvcHBlZEtleSkge2xhc3RTdG9wcGVkS2V5ID0gbnVsbDsgZV9wcmV2ZW50RGVmYXVsdChlKTsgcmV0dXJuO30KICAgICAgaWYgKCgob3BlcmEgJiYgKCFlLndoaWNoIHx8IGUud2hpY2ggPCAxMCkpIHx8IGtodG1sKSAmJiBoYW5kbGVLZXlCaW5kaW5nKGUpKSByZXR1cm47CiAgICAgIHZhciBjaCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUgPT0gbnVsbCA/IGtleUNvZGUgOiBjaGFyQ29kZSk7CiAgICAgIGlmIChvcHRpb25zLmVsZWN0cmljQ2hhcnMgJiYgbW9kZS5lbGVjdHJpY0NoYXJzICYmIG9wdGlvbnMuc21hcnRJbmRlbnQgJiYgIW9wdGlvbnMucmVhZE9ubHkpIHsKICAgICAgICBpZiAobW9kZS5lbGVjdHJpY0NoYXJzLmluZGV4T2YoY2gpID4gLTEpCiAgICAgICAgICBzZXRUaW1lb3V0KG9wZXJhdGlvbihmdW5jdGlvbigpIHtpbmRlbnRMaW5lKHNlbC50by5saW5lLCAic21hcnQiKTt9KSwgNzUpOwogICAgICB9CiAgICAgIGlmIChoYW5kbGVDaGFyQmluZGluZyhlLCBjaCkpIHJldHVybjsKICAgICAgZmFzdFBvbGwoKTsKICAgIH0KICAgIGZ1bmN0aW9uIG9uS2V5VXAoZSkgewogICAgICBpZiAob3B0aW9ucy5vbktleUV2ZW50ICYmIG9wdGlvbnMub25LZXlFdmVudChpbnN0YW5jZSwgYWRkU3RvcChlKSkpIHJldHVybjsKICAgICAgaWYgKGVfcHJvcChlLCAia2V5Q29kZSIpID09IDE2KSBzaGlmdFNlbGVjdGluZyA9IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gb25Gb2N1cygpIHsKICAgICAgaWYgKG9wdGlvbnMucmVhZE9ubHkgPT0gIm5vY3Vyc29yIikgcmV0dXJuOwogICAgICBpZiAoIWZvY3VzZWQpIHsKICAgICAgICBpZiAob3B0aW9ucy5vbkZvY3VzKSBvcHRpb25zLm9uRm9jdXMoaW5zdGFuY2UpOwogICAgICAgIGZvY3VzZWQgPSB0cnVlOwogICAgICAgIGlmIChzY3JvbGxlci5jbGFzc05hbWUuc2VhcmNoKC9cYkNvZGVNaXJyb3ItZm9jdXNlZFxiLykgPT0gLTEpCiAgICAgICAgICBzY3JvbGxlci5jbGFzc05hbWUgKz0gIiBDb2RlTWlycm9yLWZvY3VzZWQiOwogICAgICB9CiAgICAgIHNsb3dQb2xsKCk7CiAgICAgIHJlc3RhcnRCbGluaygpOwogICAgfQogICAgZnVuY3Rpb24gb25CbHVyKCkgewogICAgICBpZiAoZm9jdXNlZCkgewogICAgICAgIGlmIChvcHRpb25zLm9uQmx1cikgb3B0aW9ucy5vbkJsdXIoaW5zdGFuY2UpOwogICAgICAgIGZvY3VzZWQgPSBmYWxzZTsKICAgICAgICBpZiAoYnJhY2tldEhpZ2hsaWdodGVkKQogICAgICAgICAgb3BlcmF0aW9uKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmIChicmFja2V0SGlnaGxpZ2h0ZWQpIHsgYnJhY2tldEhpZ2hsaWdodGVkKCk7IGJyYWNrZXRIaWdobGlnaHRlZCA9IG51bGw7IH0KICAgICAgICAgIH0pKCk7CiAgICAgICAgc2Nyb2xsZXIuY2xhc3NOYW1lID0gc2Nyb2xsZXIuY2xhc3NOYW1lLnJlcGxhY2UoIiBDb2RlTWlycm9yLWZvY3VzZWQiLCAiIik7CiAgICAgIH0KICAgICAgY2xlYXJJbnRlcnZhbChibGlua2VyKTsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtpZiAoIWZvY3VzZWQpIHNoaWZ0U2VsZWN0aW5nID0gbnVsbDt9LCAxNTApOwogICAgfQoKICAgIC8vIFJlcGxhY2UgdGhlIHJhbmdlIGZyb20gZnJvbSB0byB0byBieSB0aGUgc3RyaW5ncyBpbiBuZXdUZXh0LgogICAgLy8gQWZ0ZXJ3YXJkcywgc2V0IHRoZSBzZWxlY3Rpb24gdG8gc2VsRnJvbSwgc2VsVG8uCiAgICBmdW5jdGlvbiB1cGRhdGVMaW5lcyhmcm9tLCB0bywgbmV3VGV4dCwgc2VsRnJvbSwgc2VsVG8pIHsKICAgICAgaWYgKHN1cHByZXNzRWRpdHMpIHJldHVybjsKICAgICAgdmFyIG9sZCA9IFtdOwogICAgICBkb2MuaXRlcihmcm9tLmxpbmUsIHRvLmxpbmUgKyAxLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgb2xkLnB1c2gobmV3SEwobGluZS50ZXh0LCBsaW5lLm1hcmtlZFNwYW5zKSk7CiAgICAgIH0pOwogICAgICBpZiAoaGlzdG9yeSkgewogICAgICAgIGhpc3RvcnkuYWRkQ2hhbmdlKGZyb20ubGluZSwgbmV3VGV4dC5sZW5ndGgsIG9sZCk7CiAgICAgICAgd2hpbGUgKGhpc3RvcnkuZG9uZS5sZW5ndGggPiBvcHRpb25zLnVuZG9EZXB0aCkgaGlzdG9yeS5kb25lLnNoaWZ0KCk7CiAgICAgIH0KICAgICAgdmFyIGxpbmVzID0gdXBkYXRlTWFya2VkU3BhbnMoaGxTcGFucyhvbGRbMF0pLCBobFNwYW5zKGxzdChvbGQpKSwgZnJvbS5jaCwgdG8uY2gsIG5ld1RleHQpOwogICAgICB1cGRhdGVMaW5lc05vVW5kbyhmcm9tLCB0bywgbGluZXMsIHNlbEZyb20sIHNlbFRvKTsKICAgIH0KICAgIGZ1bmN0aW9uIHVucmVkb0hlbHBlcihmcm9tLCB0bykgewogICAgICBpZiAoIWZyb20ubGVuZ3RoKSByZXR1cm47CiAgICAgIHZhciBzZXQgPSBmcm9tLnBvcCgpLCBvdXQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IHNldC5sZW5ndGggLSAxOyBpID49IDA7IGkgLT0gMSkgewogICAgICAgIHZhciBjaGFuZ2UgPSBzZXRbaV07CiAgICAgICAgdmFyIHJlcGxhY2VkID0gW10sIGVuZCA9IGNoYW5nZS5zdGFydCArIGNoYW5nZS5hZGRlZDsKICAgICAgICBkb2MuaXRlcihjaGFuZ2Uuc3RhcnQsIGVuZCwgZnVuY3Rpb24obGluZSkgeyByZXBsYWNlZC5wdXNoKG5ld0hMKGxpbmUudGV4dCwgbGluZS5tYXJrZWRTcGFucykpOyB9KTsKICAgICAgICBvdXQucHVzaCh7c3RhcnQ6IGNoYW5nZS5zdGFydCwgYWRkZWQ6IGNoYW5nZS5vbGQubGVuZ3RoLCBvbGQ6IHJlcGxhY2VkfSk7CiAgICAgICAgdmFyIHBvcyA9IHtsaW5lOiBjaGFuZ2Uuc3RhcnQgKyBjaGFuZ2Uub2xkLmxlbmd0aCAtIDEsCiAgICAgICAgICAgICAgICAgICBjaDogZWRpdEVuZChobFRleHQobHN0KHJlcGxhY2VkKSksIGhsVGV4dChsc3QoY2hhbmdlLm9sZCkpKX07CiAgICAgICAgdXBkYXRlTGluZXNOb1VuZG8oe2xpbmU6IGNoYW5nZS5zdGFydCwgY2g6IDB9LCB7bGluZTogZW5kIC0gMSwgY2g6IGdldExpbmUoZW5kLTEpLnRleHQubGVuZ3RofSwKICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2Uub2xkLCBwb3MsIHBvcyk7CiAgICAgIH0KICAgICAgdXBkYXRlSW5wdXQgPSB0cnVlOwogICAgICB0by5wdXNoKG91dCk7CiAgICB9CiAgICBmdW5jdGlvbiB1bmRvKCkge3VucmVkb0hlbHBlcihoaXN0b3J5LmRvbmUsIGhpc3RvcnkudW5kb25lKTt9CiAgICBmdW5jdGlvbiByZWRvKCkge3VucmVkb0hlbHBlcihoaXN0b3J5LnVuZG9uZSwgaGlzdG9yeS5kb25lKTt9CgogICAgZnVuY3Rpb24gdXBkYXRlTGluZXNOb1VuZG8oZnJvbSwgdG8sIGxpbmVzLCBzZWxGcm9tLCBzZWxUbykgewogICAgICBpZiAoc3VwcHJlc3NFZGl0cykgcmV0dXJuOwogICAgICB2YXIgcmVjb21wdXRlTWF4TGVuZ3RoID0gZmFsc2UsIG1heExpbmVMZW5ndGggPSBtYXhMaW5lLnRleHQubGVuZ3RoOwogICAgICBpZiAoIW9wdGlvbnMubGluZVdyYXBwaW5nKQogICAgICAgIGRvYy5pdGVyKGZyb20ubGluZSwgdG8ubGluZSArIDEsIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgIGlmICghbGluZS5oaWRkZW4gJiYgbGluZS50ZXh0Lmxlbmd0aCA9PSBtYXhMaW5lTGVuZ3RoKSB7cmVjb21wdXRlTWF4TGVuZ3RoID0gdHJ1ZTsgcmV0dXJuIHRydWU7fQogICAgICAgIH0pOwogICAgICBpZiAoZnJvbS5saW5lICE9IHRvLmxpbmUgfHwgbGluZXMubGVuZ3RoID4gMSkgZ3V0dGVyRGlydHkgPSB0cnVlOwoKICAgICAgdmFyIG5saW5lcyA9IHRvLmxpbmUgLSBmcm9tLmxpbmUsIGZpcnN0TGluZSA9IGdldExpbmUoZnJvbS5saW5lKSwgbGFzdExpbmUgPSBnZXRMaW5lKHRvLmxpbmUpOwogICAgICB2YXIgbGFzdEhMID0gbHN0KGxpbmVzKTsKCiAgICAgIC8vIEZpcnN0IGFkanVzdCB0aGUgbGluZSBzdHJ1Y3R1cmUKICAgICAgaWYgKGZyb20uY2ggPT0gMCAmJiB0by5jaCA9PSAwICYmIGhsVGV4dChsYXN0SEwpID09ICIiKSB7CiAgICAgICAgLy8gVGhpcyBpcyBhIHdob2xlLWxpbmUgcmVwbGFjZS4gVHJlYXRlZCBzcGVjaWFsbHkgdG8gbWFrZQogICAgICAgIC8vIHN1cmUgbGluZSBvYmplY3RzIG1vdmUgdGhlIHdheSB0aGV5IGFyZSBzdXBwb3NlZCB0by4KICAgICAgICB2YXIgYWRkZWQgPSBbXSwgcHJldkxpbmUgPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBlID0gbGluZXMubGVuZ3RoIC0gMTsgaSA8IGU7ICsraSkKICAgICAgICAgIGFkZGVkLnB1c2gobmV3IExpbmUoaGxUZXh0KGxpbmVzW2ldKSwgaGxTcGFucyhsaW5lc1tpXSkpKTsKICAgICAgICBsYXN0TGluZS51cGRhdGUobGFzdExpbmUudGV4dCwgaGxTcGFucyhsYXN0SEwpKTsKICAgICAgICBpZiAobmxpbmVzKSBkb2MucmVtb3ZlKGZyb20ubGluZSwgbmxpbmVzLCBjYWxsYmFja3MpOwogICAgICAgIGlmIChhZGRlZC5sZW5ndGgpIGRvYy5pbnNlcnQoZnJvbS5saW5lLCBhZGRlZCk7CiAgICAgIH0gZWxzZSBpZiAoZmlyc3RMaW5lID09IGxhc3RMaW5lKSB7CiAgICAgICAgaWYgKGxpbmVzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICBmaXJzdExpbmUudXBkYXRlKGZpcnN0TGluZS50ZXh0LnNsaWNlKDAsIGZyb20uY2gpICsgaGxUZXh0KGxpbmVzWzBdKSArIGZpcnN0TGluZS50ZXh0LnNsaWNlKHRvLmNoKSwgaGxTcGFucyhsaW5lc1swXSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBhZGRlZCA9IFtdLCBpID0gMSwgZSA9IGxpbmVzLmxlbmd0aCAtIDE7IGkgPCBlOyArK2kpCiAgICAgICAgICAgIGFkZGVkLnB1c2gobmV3IExpbmUoaGxUZXh0KGxpbmVzW2ldKSwgaGxTcGFucyhsaW5lc1tpXSkpKTsKICAgICAgICAgIGFkZGVkLnB1c2gobmV3IExpbmUoaGxUZXh0KGxhc3RITCkgKyBmaXJzdExpbmUudGV4dC5zbGljZSh0by5jaCksIGhsU3BhbnMobGFzdEhMKSkpOwogICAgICAgICAgZmlyc3RMaW5lLnVwZGF0ZShmaXJzdExpbmUudGV4dC5zbGljZSgwLCBmcm9tLmNoKSArIGhsVGV4dChsaW5lc1swXSksIGhsU3BhbnMobGluZXNbMF0pKTsKICAgICAgICAgIGRvYy5pbnNlcnQoZnJvbS5saW5lICsgMSwgYWRkZWQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChsaW5lcy5sZW5ndGggPT0gMSkgewogICAgICAgIGZpcnN0TGluZS51cGRhdGUoZmlyc3RMaW5lLnRleHQuc2xpY2UoMCwgZnJvbS5jaCkgKyBobFRleHQobGluZXNbMF0pICsgbGFzdExpbmUudGV4dC5zbGljZSh0by5jaCksIGhsU3BhbnMobGluZXNbMF0pKTsKICAgICAgICBkb2MucmVtb3ZlKGZyb20ubGluZSArIDEsIG5saW5lcywgY2FsbGJhY2tzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYWRkZWQgPSBbXTsKICAgICAgICBmaXJzdExpbmUudXBkYXRlKGZpcnN0TGluZS50ZXh0LnNsaWNlKDAsIGZyb20uY2gpICsgaGxUZXh0KGxpbmVzWzBdKSwgaGxTcGFucyhsaW5lc1swXSkpOwogICAgICAgIGxhc3RMaW5lLnVwZGF0ZShobFRleHQobGFzdEhMKSArIGxhc3RMaW5lLnRleHQuc2xpY2UodG8uY2gpLCBobFNwYW5zKGxhc3RITCkpOwogICAgICAgIGZvciAodmFyIGkgPSAxLCBlID0gbGluZXMubGVuZ3RoIC0gMTsgaSA8IGU7ICsraSkKICAgICAgICAgIGFkZGVkLnB1c2gobmV3IExpbmUoaGxUZXh0KGxpbmVzW2ldKSwgaGxTcGFucyhsaW5lc1tpXSkpKTsKICAgICAgICBpZiAobmxpbmVzID4gMSkgZG9jLnJlbW92ZShmcm9tLmxpbmUgKyAxLCBubGluZXMgLSAxLCBjYWxsYmFja3MpOwogICAgICAgIGRvYy5pbnNlcnQoZnJvbS5saW5lICsgMSwgYWRkZWQpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLmxpbmVXcmFwcGluZykgewogICAgICAgIHZhciBwZXJMaW5lID0gTWF0aC5tYXgoNSwgc2Nyb2xsZXIuY2xpZW50V2lkdGggLyBjaGFyV2lkdGgoKSAtIDMpOwogICAgICAgIGRvYy5pdGVyKGZyb20ubGluZSwgZnJvbS5saW5lICsgbGluZXMubGVuZ3RoLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICBpZiAobGluZS5oaWRkZW4pIHJldHVybjsKICAgICAgICAgIHZhciBndWVzcyA9IE1hdGguY2VpbChsaW5lLnRleHQubGVuZ3RoIC8gcGVyTGluZSkgfHwgMTsKICAgICAgICAgIGlmIChndWVzcyAhPSBsaW5lLmhlaWdodCkgdXBkYXRlTGluZUhlaWdodChsaW5lLCBndWVzcyk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9jLml0ZXIoZnJvbS5saW5lLCBmcm9tLmxpbmUgKyBsaW5lcy5sZW5ndGgsIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgIHZhciBsID0gbGluZS50ZXh0OwogICAgICAgICAgaWYgKCFsaW5lLmhpZGRlbiAmJiBsLmxlbmd0aCA+IG1heExpbmVMZW5ndGgpIHsKICAgICAgICAgICAgbWF4TGluZSA9IGxpbmU7IG1heExpbmVMZW5ndGggPSBsLmxlbmd0aDsgbWF4TGluZUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICByZWNvbXB1dGVNYXhMZW5ndGggPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAocmVjb21wdXRlTWF4TGVuZ3RoKSB1cGRhdGVNYXhMaW5lID0gdHJ1ZTsKICAgICAgfQoKICAgICAgLy8gQWRqdXN0IGZyb250aWVyLCBzY2hlZHVsZSB3b3JrZXIKICAgICAgZnJvbnRpZXIgPSBNYXRoLm1pbihmcm9udGllciwgZnJvbS5saW5lKTsKICAgICAgc3RhcnRXb3JrZXIoNDAwKTsKCiAgICAgIHZhciBsZW5kaWZmID0gbGluZXMubGVuZ3RoIC0gbmxpbmVzIC0gMTsKICAgICAgLy8gUmVtZW1iZXIgdGhhdCB0aGVzZSBsaW5lcyBjaGFuZ2VkLCBmb3IgdXBkYXRpbmcgdGhlIGRpc3BsYXkKICAgICAgY2hhbmdlcy5wdXNoKHtmcm9tOiBmcm9tLmxpbmUsIHRvOiB0by5saW5lICsgMSwgZGlmZjogbGVuZGlmZn0pOwogICAgICBpZiAob3B0aW9ucy5vbkNoYW5nZSkgewogICAgICAgIC8vIE5vcm1hbGl6ZSBsaW5lcyB0byBjb250YWluIG9ubHkgc3RyaW5ncywgc2luY2UgdGhhdCdzIHdoYXQKICAgICAgICAvLyB0aGUgY2hhbmdlIGV2ZW50IGhhbmRsZXIgZXhwZWN0cwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyArK2kpCiAgICAgICAgICBpZiAodHlwZW9mIGxpbmVzW2ldICE9ICJzdHJpbmciKSBsaW5lc1tpXSA9IGxpbmVzW2ldLnRleHQ7CiAgICAgICAgdmFyIGNoYW5nZU9iaiA9IHtmcm9tOiBmcm9tLCB0bzogdG8sIHRleHQ6IGxpbmVzfTsKICAgICAgICBpZiAodGV4dENoYW5nZWQpIHsKICAgICAgICAgIGZvciAodmFyIGN1ciA9IHRleHRDaGFuZ2VkOyBjdXIubmV4dDsgY3VyID0gY3VyLm5leHQpIHt9CiAgICAgICAgICBjdXIubmV4dCA9IGNoYW5nZU9iajsKICAgICAgICB9IGVsc2UgdGV4dENoYW5nZWQgPSBjaGFuZ2VPYmo7CiAgICAgIH0KCiAgICAgIC8vIFVwZGF0ZSB0aGUgc2VsZWN0aW9uCiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxpbmUobikge3JldHVybiBuIDw9IE1hdGgubWluKHRvLmxpbmUsIHRvLmxpbmUgKyBsZW5kaWZmKSA/IG4gOiBuICsgbGVuZGlmZjt9CiAgICAgIHNldFNlbGVjdGlvbihjbGlwUG9zKHNlbEZyb20pLCBjbGlwUG9zKHNlbFRvKSwKICAgICAgICAgICAgICAgICAgIHVwZGF0ZUxpbmUoc2VsLmZyb20ubGluZSksIHVwZGF0ZUxpbmUoc2VsLnRvLmxpbmUpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBuZWVkc1Njcm9sbGJhcigpIHsKICAgICAgdmFyIHJlYWxIZWlnaHQgPSBkb2MuaGVpZ2h0ICogdGV4dEhlaWdodCgpICsgMiAqIHBhZGRpbmdUb3AoKTsKICAgICAgcmV0dXJuIHJlYWxIZWlnaHQgKiAuOTkgPiBzY3JvbGxlci5vZmZzZXRIZWlnaHQgPyByZWFsSGVpZ2h0IDogZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlVmVydGljYWxTY3JvbGwoc2Nyb2xsVG9wKSB7CiAgICAgIHZhciBzY3JvbGxIZWlnaHQgPSBuZWVkc1Njcm9sbGJhcigpOwogICAgICBzY3JvbGxiYXIuc3R5bGUuZGlzcGxheSA9IHNjcm9sbEhlaWdodCA/ICJibG9jayIgOiAibm9uZSI7CiAgICAgIGlmIChzY3JvbGxIZWlnaHQpIHsKICAgICAgICBzY3JvbGxiYXJJbm5lci5zdHlsZS5oZWlnaHQgPSBzaXplci5zdHlsZS5taW5IZWlnaHQgPSBzY3JvbGxIZWlnaHQgKyAicHgiOwogICAgICAgIHNjcm9sbGJhci5zdHlsZS5oZWlnaHQgPSBzY3JvbGxlci5jbGllbnRIZWlnaHQgKyAicHgiOwogICAgICAgIGlmIChzY3JvbGxUb3AgIT0gbnVsbCkgewogICAgICAgICAgc2Nyb2xsYmFyLnNjcm9sbFRvcCA9IHNjcm9sbGVyLnNjcm9sbFRvcCA9IHNjcm9sbFRvcDsKICAgICAgICAgIC8vICdOdWRnZScgdGhlIHNjcm9sbGJhciB0byB3b3JrIGFyb3VuZCBhIFdlYmtpdCBidWcgd2hlcmUsCiAgICAgICAgICAvLyBpbiBzb21lIHNpdHVhdGlvbnMsIHdlJ2QgZW5kIHVwIHdpdGggYSBzY3JvbGxiYXIgdGhhdAogICAgICAgICAgLy8gcmVwb3J0ZWQgaXRzIHNjcm9sbFRvcCAoYW5kIGxvb2tlZCkgYXMgZXhwZWN0ZWQsIGJ1dAogICAgICAgICAgLy8gKmJlaGF2ZWQqIGFzIGlmIGl0IHdhcyBzdGlsbCBpbiBhIHByZXZpb3VzIHN0YXRlIChpLmUuCiAgICAgICAgICAvLyBjb3VsZG4ndCBzY3JvbGwgdXAsIGV2ZW4gdGhvdWdoIGl0IGFwcGVhcmVkIHRvIGJlIGF0IHRoZQogICAgICAgICAgLy8gYm90dG9tKS4KICAgICAgICAgIGlmICh3ZWJraXQpIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChzY3JvbGxiYXIuc2Nyb2xsVG9wICE9IHNjcm9sbFRvcCkgcmV0dXJuOwogICAgICAgICAgICBzY3JvbGxiYXIuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wICsgKHNjcm9sbFRvcCA/IC0xIDogMSk7CiAgICAgICAgICAgIHNjcm9sbGJhci5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7CiAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2l6ZXIuc3R5bGUubWluSGVpZ2h0ID0gIiI7CiAgICAgIH0KICAgICAgLy8gUG9zaXRpb24gdGhlIG1vdmVyIGRpdiB0byBhbGlnbiB3aXRoIHRoZSBjdXJyZW50IHZpcnR1YWwgc2Nyb2xsIHBvc2l0aW9uCiAgICAgIG1vdmVyLnN0eWxlLnRvcCA9IGRpc3BsYXlPZmZzZXQgKiB0ZXh0SGVpZ2h0KCkgKyAicHgiOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXB1dGVNYXhMZW5ndGgoKSB7CiAgICAgIG1heExpbmUgPSBnZXRMaW5lKDApOyBtYXhMaW5lQ2hhbmdlZCA9IHRydWU7CiAgICAgIHZhciBtYXhMaW5lTGVuZ3RoID0gbWF4TGluZS50ZXh0Lmxlbmd0aDsKICAgICAgZG9jLml0ZXIoMSwgZG9jLnNpemUsIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICB2YXIgbCA9IGxpbmUudGV4dDsKICAgICAgICBpZiAoIWxpbmUuaGlkZGVuICYmIGwubGVuZ3RoID4gbWF4TGluZUxlbmd0aCkgewogICAgICAgICAgbWF4TGluZUxlbmd0aCA9IGwubGVuZ3RoOyBtYXhMaW5lID0gbGluZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB1cGRhdGVNYXhMaW5lID0gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gcmVwbGFjZVJhbmdlKGNvZGUsIGZyb20sIHRvKSB7CiAgICAgIGZyb20gPSBjbGlwUG9zKGZyb20pOwogICAgICBpZiAoIXRvKSB0byA9IGZyb207IGVsc2UgdG8gPSBjbGlwUG9zKHRvKTsKICAgICAgY29kZSA9IHNwbGl0TGluZXMoY29kZSk7CiAgICAgIGZ1bmN0aW9uIGFkanVzdFBvcyhwb3MpIHsKICAgICAgICBpZiAocG9zTGVzcyhwb3MsIGZyb20pKSByZXR1cm4gcG9zOwogICAgICAgIGlmICghcG9zTGVzcyh0bywgcG9zKSkgcmV0dXJuIGVuZDsKICAgICAgICB2YXIgbGluZSA9IHBvcy5saW5lICsgY29kZS5sZW5ndGggLSAodG8ubGluZSAtIGZyb20ubGluZSkgLSAxOwogICAgICAgIHZhciBjaCA9IHBvcy5jaDsKICAgICAgICBpZiAocG9zLmxpbmUgPT0gdG8ubGluZSkKICAgICAgICAgIGNoICs9IGxzdChjb2RlKS5sZW5ndGggLSAodG8uY2ggLSAodG8ubGluZSA9PSBmcm9tLmxpbmUgPyBmcm9tLmNoIDogMCkpOwogICAgICAgIHJldHVybiB7bGluZTogbGluZSwgY2g6IGNofTsKICAgICAgfQogICAgICB2YXIgZW5kOwogICAgICByZXBsYWNlUmFuZ2UxKGNvZGUsIGZyb20sIHRvLCBmdW5jdGlvbihlbmQxKSB7CiAgICAgICAgZW5kID0gZW5kMTsKICAgICAgICByZXR1cm4ge2Zyb206IGFkanVzdFBvcyhzZWwuZnJvbSksIHRvOiBhZGp1c3RQb3Moc2VsLnRvKX07CiAgICAgIH0pOwogICAgICByZXR1cm4gZW5kOwogICAgfQogICAgZnVuY3Rpb24gcmVwbGFjZVNlbGVjdGlvbihjb2RlLCBjb2xsYXBzZSkgewogICAgICByZXBsYWNlUmFuZ2UxKHNwbGl0TGluZXMoY29kZSksIHNlbC5mcm9tLCBzZWwudG8sIGZ1bmN0aW9uKGVuZCkgewogICAgICAgIGlmIChjb2xsYXBzZSA9PSAiZW5kIikgcmV0dXJuIHtmcm9tOiBlbmQsIHRvOiBlbmR9OwogICAgICAgIGVsc2UgaWYgKGNvbGxhcHNlID09ICJzdGFydCIpIHJldHVybiB7ZnJvbTogc2VsLmZyb20sIHRvOiBzZWwuZnJvbX07CiAgICAgICAgZWxzZSByZXR1cm4ge2Zyb206IHNlbC5mcm9tLCB0bzogZW5kfTsKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXBsYWNlUmFuZ2UxKGNvZGUsIGZyb20sIHRvLCBjb21wdXRlU2VsKSB7CiAgICAgIHZhciBlbmRjaCA9IGNvZGUubGVuZ3RoID09IDEgPyBjb2RlWzBdLmxlbmd0aCArIGZyb20uY2ggOiBsc3QoY29kZSkubGVuZ3RoOwogICAgICB2YXIgbmV3U2VsID0gY29tcHV0ZVNlbCh7bGluZTogZnJvbS5saW5lICsgY29kZS5sZW5ndGggLSAxLCBjaDogZW5kY2h9KTsKICAgICAgdXBkYXRlTGluZXMoZnJvbSwgdG8sIGNvZGUsIG5ld1NlbC5mcm9tLCBuZXdTZWwudG8pOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJhbmdlKGZyb20sIHRvLCBsaW5lU2VwKSB7CiAgICAgIHZhciBsMSA9IGZyb20ubGluZSwgbDIgPSB0by5saW5lOwogICAgICBpZiAobDEgPT0gbDIpIHJldHVybiBnZXRMaW5lKGwxKS50ZXh0LnNsaWNlKGZyb20uY2gsIHRvLmNoKTsKICAgICAgdmFyIGNvZGUgPSBbZ2V0TGluZShsMSkudGV4dC5zbGljZShmcm9tLmNoKV07CiAgICAgIGRvYy5pdGVyKGwxICsgMSwgbDIsIGZ1bmN0aW9uKGxpbmUpIHsgY29kZS5wdXNoKGxpbmUudGV4dCk7IH0pOwogICAgICBjb2RlLnB1c2goZ2V0TGluZShsMikudGV4dC5zbGljZSgwLCB0by5jaCkpOwogICAgICByZXR1cm4gY29kZS5qb2luKGxpbmVTZXAgfHwgIlxuIik7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24obGluZVNlcCkgewogICAgICByZXR1cm4gZ2V0UmFuZ2Uoc2VsLmZyb20sIHNlbC50bywgbGluZVNlcCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2xvd1BvbGwoKSB7CiAgICAgIGlmIChwb2xsaW5nRmFzdCkgcmV0dXJuOwogICAgICBwb2xsLnNldChvcHRpb25zLnBvbGxJbnRlcnZhbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgcmVhZElucHV0KCk7CiAgICAgICAgaWYgKGZvY3VzZWQpIHNsb3dQb2xsKCk7CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gZmFzdFBvbGwoKSB7CiAgICAgIHZhciBtaXNzZWQgPSBmYWxzZTsKICAgICAgcG9sbGluZ0Zhc3QgPSB0cnVlOwogICAgICBmdW5jdGlvbiBwKCkgewogICAgICAgIHZhciBjaGFuZ2VkID0gcmVhZElucHV0KCk7CiAgICAgICAgaWYgKCFjaGFuZ2VkICYmICFtaXNzZWQpIHttaXNzZWQgPSB0cnVlOyBwb2xsLnNldCg2MCwgcCk7fQogICAgICAgIGVsc2Uge3BvbGxpbmdGYXN0ID0gZmFsc2U7IHNsb3dQb2xsKCk7fQogICAgICB9CiAgICAgIHBvbGwuc2V0KDIwLCBwKTsKICAgIH0KCiAgICAvLyBQcmV2aW5wdXQgaXMgYSBoYWNrIHRvIHdvcmsgd2l0aCBJTUUuIElmIHdlIHJlc2V0IHRoZSB0ZXh0YXJlYQogICAgLy8gb24gZXZlcnkgY2hhbmdlLCB0aGF0IGJyZWFrcyBJTUUuIFNvIHdlIGxvb2sgZm9yIGNoYW5nZXMKICAgIC8vIGNvbXBhcmVkIHRvIHRoZSBwcmV2aW91cyBjb250ZW50IGluc3RlYWQuIChNb2Rlcm4gYnJvd3NlcnMgaGF2ZQogICAgLy8gZXZlbnRzIHRoYXQgaW5kaWNhdGUgSU1FIHRha2luZyBwbGFjZSwgYnV0IHRoZXNlIGFyZSBub3Qgd2lkZWx5CiAgICAvLyBzdXBwb3J0ZWQgb3IgY29tcGF0aWJsZSBlbm91Z2ggeWV0IHRvIHJlbHkgb24uKQogICAgdmFyIHByZXZJbnB1dCA9ICIiOwogICAgZnVuY3Rpb24gcmVhZElucHV0KCkgewogICAgICBpZiAoIWZvY3VzZWQgfHwgaGFzU2VsZWN0aW9uKGlucHV0KSB8fCBvcHRpb25zLnJlYWRPbmx5KSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciB0ZXh0ID0gaW5wdXQudmFsdWU7CiAgICAgIGlmICh0ZXh0ID09IHByZXZJbnB1dCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW5lc3RlZE9wZXJhdGlvbikgc3RhcnRPcGVyYXRpb24oKTsKICAgICAgc2hpZnRTZWxlY3RpbmcgPSBudWxsOwogICAgICB2YXIgc2FtZSA9IDAsIGwgPSBNYXRoLm1pbihwcmV2SW5wdXQubGVuZ3RoLCB0ZXh0Lmxlbmd0aCk7CiAgICAgIHdoaWxlIChzYW1lIDwgbCAmJiBwcmV2SW5wdXRbc2FtZV0gPT0gdGV4dFtzYW1lXSkgKytzYW1lOwogICAgICBpZiAoc2FtZSA8IHByZXZJbnB1dC5sZW5ndGgpCiAgICAgICAgc2VsLmZyb20gPSB7bGluZTogc2VsLmZyb20ubGluZSwgY2g6IHNlbC5mcm9tLmNoIC0gKHByZXZJbnB1dC5sZW5ndGggLSBzYW1lKX07CiAgICAgIGVsc2UgaWYgKG92ZXJ3cml0ZSAmJiBwb3NFcShzZWwuZnJvbSwgc2VsLnRvKSkKICAgICAgICBzZWwudG8gPSB7bGluZTogc2VsLnRvLmxpbmUsIGNoOiBNYXRoLm1pbihnZXRMaW5lKHNlbC50by5saW5lKS50ZXh0Lmxlbmd0aCwgc2VsLnRvLmNoICsgKHRleHQubGVuZ3RoIC0gc2FtZSkpfTsKICAgICAgcmVwbGFjZVNlbGVjdGlvbih0ZXh0LnNsaWNlKHNhbWUpLCAiZW5kIik7CiAgICAgIGlmICh0ZXh0Lmxlbmd0aCA+IDEwMDApIHsgaW5wdXQudmFsdWUgPSBwcmV2SW5wdXQgPSAiIjsgfQogICAgICBlbHNlIHByZXZJbnB1dCA9IHRleHQ7CiAgICAgIGlmICghbmVzdGVkT3BlcmF0aW9uKSBlbmRPcGVyYXRpb24oKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiByZXNldElucHV0KHVzZXIpIHsKICAgICAgaWYgKCFwb3NFcShzZWwuZnJvbSwgc2VsLnRvKSkgewogICAgICAgIHByZXZJbnB1dCA9ICIiOwogICAgICAgIGlucHV0LnZhbHVlID0gZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgaWYgKGZvY3VzZWQpIHNlbGVjdElucHV0KGlucHV0KTsKICAgICAgfSBlbHNlIGlmICh1c2VyKSBwcmV2SW5wdXQgPSBpbnB1dC52YWx1ZSA9ICIiOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvY3VzSW5wdXQoKSB7CiAgICAgIGlmIChvcHRpb25zLnJlYWRPbmx5ICE9ICJub2N1cnNvciIpIGlucHV0LmZvY3VzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2Nyb2xsQ3Vyc29ySW50b1ZpZXcoKSB7CiAgICAgIHZhciBjb29yZHMgPSBjYWxjdWxhdGVDdXJzb3JDb29yZHMoKTsKICAgICAgc2Nyb2xsSW50b1ZpZXcoY29vcmRzLngsIGNvb3Jkcy55LCBjb29yZHMueCwgY29vcmRzLnlCb3QpOwogICAgICBpZiAoIWZvY3VzZWQpIHJldHVybjsKICAgICAgdmFyIGJveCA9IHNpemVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCBkb1Njcm9sbCA9IG51bGw7CiAgICAgIGlmIChjb29yZHMueSArIGJveC50b3AgPCAwKSBkb1Njcm9sbCA9IHRydWU7CiAgICAgIGVsc2UgaWYgKGNvb3Jkcy55ICsgYm94LnRvcCArIHRleHRIZWlnaHQoKSA+ICh3aW5kb3cuaW5uZXJIZWlnaHQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkpIGRvU2Nyb2xsID0gZmFsc2U7CiAgICAgIGlmIChkb1Njcm9sbCAhPSBudWxsKSB7CiAgICAgICAgdmFyIGhpZGRlbiA9IGN1cnNvci5zdHlsZS5kaXNwbGF5ID09ICJub25lIjsKICAgICAgICBpZiAoaGlkZGVuKSB7CiAgICAgICAgICBjdXJzb3Iuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgICAgY3Vyc29yLnN0eWxlLmxlZnQgPSBjb29yZHMueCArICJweCI7CiAgICAgICAgICBjdXJzb3Iuc3R5bGUudG9wID0gKGNvb3Jkcy55IC0gZGlzcGxheU9mZnNldCkgKyAicHgiOwogICAgICAgIH0KICAgICAgICBjdXJzb3Iuc2Nyb2xsSW50b1ZpZXcoZG9TY3JvbGwpOwogICAgICAgIGlmIChoaWRkZW4pIGN1cnNvci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjYWxjdWxhdGVDdXJzb3JDb29yZHMoKSB7CiAgICAgIHZhciBjdXJzb3IgPSBsb2NhbENvb3JkcyhzZWwuaW52ZXJ0ZWQgPyBzZWwuZnJvbSA6IHNlbC50byk7CiAgICAgIHZhciB4ID0gb3B0aW9ucy5saW5lV3JhcHBpbmcgPyBNYXRoLm1pbihjdXJzb3IueCwgbGluZVNwYWNlLm9mZnNldFdpZHRoKSA6IGN1cnNvci54OwogICAgICByZXR1cm4ge3g6IHgsIHk6IGN1cnNvci55LCB5Qm90OiBjdXJzb3IueUJvdH07CiAgICB9CiAgICBmdW5jdGlvbiBzY3JvbGxJbnRvVmlldyh4MSwgeTEsIHgyLCB5MikgewogICAgICB2YXIgc2Nyb2xsUG9zID0gY2FsY3VsYXRlU2Nyb2xsUG9zKHgxLCB5MSwgeDIsIHkyKTsKICAgICAgaWYgKHNjcm9sbFBvcy5zY3JvbGxMZWZ0ICE9IG51bGwpIHtzY3JvbGxlci5zY3JvbGxMZWZ0ID0gc2Nyb2xsUG9zLnNjcm9sbExlZnQ7fQogICAgICBpZiAoc2Nyb2xsUG9zLnNjcm9sbFRvcCAhPSBudWxsKSB7c2Nyb2xsYmFyLnNjcm9sbFRvcCA9IHNjcm9sbGVyLnNjcm9sbFRvcCA9IHNjcm9sbFBvcy5zY3JvbGxUb3A7fQogICAgfQogICAgZnVuY3Rpb24gY2FsY3VsYXRlU2Nyb2xsUG9zKHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgIHZhciBwbCA9IHBhZGRpbmdMZWZ0KCksIHB0ID0gcGFkZGluZ1RvcCgpOwogICAgICB5MSArPSBwdDsgeTIgKz0gcHQ7IHgxICs9IHBsOyB4MiArPSBwbDsKICAgICAgdmFyIHNjcmVlbiA9IHNjcm9sbGVyLmNsaWVudEhlaWdodCwgc2NyZWVudG9wID0gc2Nyb2xsYmFyLnNjcm9sbFRvcCwgcmVzdWx0ID0ge307CiAgICAgIHZhciBkb2NCb3R0b20gPSBuZWVkc1Njcm9sbGJhcigpIHx8IEluZmluaXR5OwogICAgICB2YXIgYXRUb3AgPSB5MSA8IHB0ICsgMTAsIGF0Qm90dG9tID0geTIgKyBwdCA+IGRvY0JvdHRvbSAtIDEwOwogICAgICBpZiAoeTEgPCBzY3JlZW50b3ApIHJlc3VsdC5zY3JvbGxUb3AgPSBhdFRvcCA/IDAgOiBNYXRoLm1heCgwLCB5MSk7CiAgICAgIGVsc2UgaWYgKHkyID4gc2NyZWVudG9wICsgc2NyZWVuKSByZXN1bHQuc2Nyb2xsVG9wID0gKGF0Qm90dG9tID8gZG9jQm90dG9tIDogeTIpIC0gc2NyZWVuOwoKICAgICAgdmFyIHNjcmVlbncgPSBzY3JvbGxlci5jbGllbnRXaWR0aCwgc2NyZWVubGVmdCA9IHNjcm9sbGVyLnNjcm9sbExlZnQ7CiAgICAgIHZhciBndXR0ZXJ3ID0gb3B0aW9ucy5maXhlZEd1dHRlciA/IGd1dHRlci5jbGllbnRXaWR0aCA6IDA7CiAgICAgIHZhciBhdExlZnQgPSB4MSA8IGd1dHRlcncgKyBwbCArIDEwOwogICAgICBpZiAoeDEgPCBzY3JlZW5sZWZ0ICsgZ3V0dGVydyB8fCBhdExlZnQpIHsKICAgICAgICBpZiAoYXRMZWZ0KSB4MSA9IDA7CiAgICAgICAgcmVzdWx0LnNjcm9sbExlZnQgPSBNYXRoLm1heCgwLCB4MSAtIDEwIC0gZ3V0dGVydyk7CiAgICAgIH0gZWxzZSBpZiAoeDIgPiBzY3JlZW53ICsgc2NyZWVubGVmdCAtIDMpIHsKICAgICAgICByZXN1bHQuc2Nyb2xsTGVmdCA9IHgyICsgMTAgLSBzY3JlZW53OwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gdmlzaWJsZUxpbmVzKHNjcm9sbFRvcCkgewogICAgICB2YXIgbGggPSB0ZXh0SGVpZ2h0KCksIHRvcCA9IChzY3JvbGxUb3AgIT0gbnVsbCA/IHNjcm9sbFRvcCA6IHNjcm9sbGJhci5zY3JvbGxUb3ApIC0gcGFkZGluZ1RvcCgpOwogICAgICB2YXIgZnJvbUhlaWdodCA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3IodG9wIC8gbGgpKTsKICAgICAgdmFyIHRvSGVpZ2h0ID0gTWF0aC5jZWlsKCh0b3AgKyBzY3JvbGxlci5jbGllbnRIZWlnaHQpIC8gbGgpOwogICAgICByZXR1cm4ge2Zyb206IGxpbmVBdEhlaWdodChkb2MsIGZyb21IZWlnaHQpLAogICAgICAgICAgICAgIHRvOiBsaW5lQXRIZWlnaHQoZG9jLCB0b0hlaWdodCl9OwogICAgfQogICAgLy8gVXNlcyBhIHNldCBvZiBjaGFuZ2VzIHBsdXMgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uIHRvCiAgICAvLyBkZXRlcm1pbmUgd2hpY2ggRE9NIHVwZGF0ZXMgaGF2ZSB0byBiZSBtYWRlLCBhbmQgbWFrZXMgdGhlCiAgICAvLyB1cGRhdGVzLgogICAgZnVuY3Rpb24gdXBkYXRlRGlzcGxheShjaGFuZ2VzLCBzdXBwcmVzc0NhbGxiYWNrLCBzY3JvbGxUb3ApIHsKICAgICAgaWYgKCFzY3JvbGxlci5jbGllbnRXaWR0aCkgewogICAgICAgIHNob3dpbmdGcm9tID0gc2hvd2luZ1RvID0gZGlzcGxheU9mZnNldCA9IDA7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIENvbXB1dGUgdGhlIG5ldyB2aXNpYmxlIHdpbmRvdwogICAgICAvLyBJZiBzY3JvbGxUb3AgaXMgc3BlY2lmaWVkLCB1c2UgdGhhdCB0byBkZXRlcm1pbmUgd2hpY2ggbGluZXMKICAgICAgLy8gdG8gcmVuZGVyIGluc3RlYWQgb2YgdGhlIGN1cnJlbnQgc2Nyb2xsYmFyIHBvc2l0aW9uLgogICAgICB2YXIgdmlzaWJsZSA9IHZpc2libGVMaW5lcyhzY3JvbGxUb3ApOwogICAgICAvLyBCYWlsIG91dCBpZiB0aGUgdmlzaWJsZSBhcmVhIGlzIGFscmVhZHkgcmVuZGVyZWQgYW5kIG5vdGhpbmcgY2hhbmdlZC4KICAgICAgaWYgKGNoYW5nZXMgIT09IHRydWUgJiYgY2hhbmdlcy5sZW5ndGggPT0gMCAmJiB2aXNpYmxlLmZyb20gPiBzaG93aW5nRnJvbSAmJiB2aXNpYmxlLnRvIDwgc2hvd2luZ1RvKSB7CiAgICAgICAgdXBkYXRlVmVydGljYWxTY3JvbGwoc2Nyb2xsVG9wKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGZyb20gPSBNYXRoLm1heCh2aXNpYmxlLmZyb20gLSAxMDAsIDApLCB0byA9IE1hdGgubWluKGRvYy5zaXplLCB2aXNpYmxlLnRvICsgMTAwKTsKICAgICAgaWYgKHNob3dpbmdGcm9tIDwgZnJvbSAmJiBmcm9tIC0gc2hvd2luZ0Zyb20gPCAyMCkgZnJvbSA9IHNob3dpbmdGcm9tOwogICAgICBpZiAoc2hvd2luZ1RvID4gdG8gJiYgc2hvd2luZ1RvIC0gdG8gPCAyMCkgdG8gPSBNYXRoLm1pbihkb2Muc2l6ZSwgc2hvd2luZ1RvKTsKCiAgICAgIC8vIENyZWF0ZSBhIHJhbmdlIG9mIHRoZW9yZXRpY2FsbHkgaW50YWN0IGxpbmVzLCBhbmQgcHVuY2ggaG9sZXMKICAgICAgLy8gaW4gdGhhdCB1c2luZyB0aGUgY2hhbmdlIGluZm8uCiAgICAgIHZhciBpbnRhY3QgPSBjaGFuZ2VzID09PSB0cnVlID8gW10gOgogICAgICAgIGNvbXB1dGVJbnRhY3QoW3tmcm9tOiBzaG93aW5nRnJvbSwgdG86IHNob3dpbmdUbywgZG9tU3RhcnQ6IDB9XSwgY2hhbmdlcyk7CiAgICAgIC8vIENsaXAgb2ZmIHRoZSBwYXJ0cyB0aGF0IHdvbid0IGJlIHZpc2libGUKICAgICAgdmFyIGludGFjdExpbmVzID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRhY3QubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcmFuZ2UgPSBpbnRhY3RbaV07CiAgICAgICAgaWYgKHJhbmdlLmZyb20gPCBmcm9tKSB7cmFuZ2UuZG9tU3RhcnQgKz0gKGZyb20gLSByYW5nZS5mcm9tKTsgcmFuZ2UuZnJvbSA9IGZyb207fQogICAgICAgIGlmIChyYW5nZS50byA+IHRvKSByYW5nZS50byA9IHRvOwogICAgICAgIGlmIChyYW5nZS5mcm9tID49IHJhbmdlLnRvKSBpbnRhY3Quc3BsaWNlKGktLSwgMSk7CiAgICAgICAgZWxzZSBpbnRhY3RMaW5lcyArPSByYW5nZS50byAtIHJhbmdlLmZyb207CiAgICAgIH0KICAgICAgaWYgKGludGFjdExpbmVzID09IHRvIC0gZnJvbSAmJiBmcm9tID09IHNob3dpbmdGcm9tICYmIHRvID09IHNob3dpbmdUbykgewogICAgICAgIHVwZGF0ZVZlcnRpY2FsU2Nyb2xsKHNjcm9sbFRvcCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGludGFjdC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtyZXR1cm4gYS5kb21TdGFydCAtIGIuZG9tU3RhcnQ7fSk7CgogICAgICB2YXIgdGggPSB0ZXh0SGVpZ2h0KCksIGd1dHRlckRpc3BsYXkgPSBndXR0ZXIuc3R5bGUuZGlzcGxheTsKICAgICAgbGluZURpdi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICBwYXRjaERpc3BsYXkoZnJvbSwgdG8sIGludGFjdCk7CiAgICAgIGxpbmVEaXYuc3R5bGUuZGlzcGxheSA9IGd1dHRlci5zdHlsZS5kaXNwbGF5ID0gIiI7CgogICAgICB2YXIgZGlmZmVyZW50ID0gZnJvbSAhPSBzaG93aW5nRnJvbSB8fCB0byAhPSBzaG93aW5nVG8gfHwgbGFzdFNpemVDICE9IHNjcm9sbGVyLmNsaWVudEhlaWdodCArIHRoOwogICAgICAvLyBUaGlzIGlzIGp1c3QgYSBib2d1cyBmb3JtdWxhIHRoYXQgZGV0ZWN0cyB3aGVuIHRoZSBlZGl0b3IgaXMKICAgICAgLy8gcmVzaXplZCBvciB0aGUgZm9udCBzaXplIGNoYW5nZXMuCiAgICAgIGlmIChkaWZmZXJlbnQpIGxhc3RTaXplQyA9IHNjcm9sbGVyLmNsaWVudEhlaWdodCArIHRoOwogICAgICBpZiAoZnJvbSAhPSBzaG93aW5nRnJvbSB8fCB0byAhPSBzaG93aW5nVG8gJiYgb3B0aW9ucy5vblZpZXdwb3J0Q2hhbmdlKQogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIGlmIChvcHRpb25zLm9uVmlld3BvcnRDaGFuZ2UpIG9wdGlvbnMub25WaWV3cG9ydENoYW5nZShpbnN0YW5jZSwgZnJvbSwgdG8pOwogICAgICAgIH0pOwogICAgICBzaG93aW5nRnJvbSA9IGZyb207IHNob3dpbmdUbyA9IHRvOwogICAgICBkaXNwbGF5T2Zmc2V0ID0gaGVpZ2h0QXRMaW5lKGRvYywgZnJvbSk7CiAgICAgIHN0YXJ0V29ya2VyKDEwMCk7CgogICAgICAvLyBTaW5jZSB0aGlzIGlzIGFsbCByYXRoZXIgZXJyb3IgcHJvbmUsIGl0IGlzIGhvbm91cmVkIHdpdGggdGhlCiAgICAgIC8vIG9ubHkgYXNzZXJ0aW9uIGluIHRoZSB3aG9sZSBmaWxlLgogICAgICBpZiAobGluZURpdi5jaGlsZE5vZGVzLmxlbmd0aCAhPSBzaG93aW5nVG8gLSBzaG93aW5nRnJvbSkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJBRCBQQVRDSCEgIiArIEpTT04uc3RyaW5naWZ5KGludGFjdCkgKyAiIHNpemU9IiArIChzaG93aW5nVG8gLSBzaG93aW5nRnJvbSkgKwogICAgICAgICAgICAgICAgICAgICAgICAiIG5vZGVzPSIgKyBsaW5lRGl2LmNoaWxkTm9kZXMubGVuZ3RoKTsKCiAgICAgIGZ1bmN0aW9uIGNoZWNrSGVpZ2h0cygpIHsKICAgICAgICB2YXIgY3VyTm9kZSA9IGxpbmVEaXYuZmlyc3RDaGlsZCwgaGVpZ2h0Q2hhbmdlZCA9IGZhbHNlOwogICAgICAgIGRvYy5pdGVyKHNob3dpbmdGcm9tLCBzaG93aW5nVG8sIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgIC8vIFdvcmsgYXJvdW5kIGJpemFycm8gSUU3IGJ1ZyB3aGVyZSwgc29tZXRpbWVzLCBvdXIgY3VyTm9kZQogICAgICAgICAgLy8gaXMgbWFnaWNhbGx5IHJlcGxhY2VkIHdpdGggYSBuZXcgbm9kZSBpbiB0aGUgRE9NLCBsZWF2aW5nCiAgICAgICAgICAvLyB1cyB3aXRoIGEgcmVmZXJlbmNlIHRvIGFuIG9ycGhhbiAobmV4dFNpYmxpbmctbGVzcykgbm9kZS4KICAgICAgICAgIGlmICghY3VyTm9kZSkgcmV0dXJuOwogICAgICAgICAgaWYgKCFsaW5lLmhpZGRlbikgewogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gTWF0aC5yb3VuZChjdXJOb2RlLm9mZnNldEhlaWdodCAvIHRoKSB8fCAxOwogICAgICAgICAgICBpZiAobGluZS5oZWlnaHQgIT0gaGVpZ2h0KSB7CiAgICAgICAgICAgICAgdXBkYXRlTGluZUhlaWdodChsaW5lLCBoZWlnaHQpOwogICAgICAgICAgICAgIGd1dHRlckRpcnR5ID0gaGVpZ2h0Q2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1ck5vZGUgPSBjdXJOb2RlLm5leHRTaWJsaW5nOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBoZWlnaHRDaGFuZ2VkOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5saW5lV3JhcHBpbmcpIGNoZWNrSGVpZ2h0cygpOwoKICAgICAgZ3V0dGVyLnN0eWxlLmRpc3BsYXkgPSBndXR0ZXJEaXNwbGF5OwogICAgICBpZiAoZGlmZmVyZW50IHx8IGd1dHRlckRpcnR5KSB7CiAgICAgICAgLy8gSWYgdGhlIGd1dHRlciBncmV3IGluIHNpemUsIHJlLWNoZWNrIGhlaWdodHMuIElmIHRob3NlIGNoYW5nZWQsIHJlLWRyYXcgZ3V0dGVyLgogICAgICAgIHVwZGF0ZUd1dHRlcigpICYmIG9wdGlvbnMubGluZVdyYXBwaW5nICYmIGNoZWNrSGVpZ2h0cygpICYmIHVwZGF0ZUd1dHRlcigpOwogICAgICB9CiAgICAgIHVwZGF0ZVZlcnRpY2FsU2Nyb2xsKHNjcm9sbFRvcCk7CiAgICAgIHVwZGF0ZVNlbGVjdGlvbigpOwogICAgICBpZiAoIXN1cHByZXNzQ2FsbGJhY2sgJiYgb3B0aW9ucy5vblVwZGF0ZSkgb3B0aW9ucy5vblVwZGF0ZShpbnN0YW5jZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXB1dGVJbnRhY3QoaW50YWN0LCBjaGFuZ2VzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGggfHwgMDsgaSA8IGw7ICsraSkgewogICAgICAgIHZhciBjaGFuZ2UgPSBjaGFuZ2VzW2ldLCBpbnRhY3QyID0gW10sIGRpZmYgPSBjaGFuZ2UuZGlmZiB8fCAwOwogICAgICAgIGZvciAodmFyIGogPSAwLCBsMiA9IGludGFjdC5sZW5ndGg7IGogPCBsMjsgKytqKSB7CiAgICAgICAgICB2YXIgcmFuZ2UgPSBpbnRhY3Rbal07CiAgICAgICAgICBpZiAoY2hhbmdlLnRvIDw9IHJhbmdlLmZyb20gJiYgY2hhbmdlLmRpZmYpCiAgICAgICAgICAgIGludGFjdDIucHVzaCh7ZnJvbTogcmFuZ2UuZnJvbSArIGRpZmYsIHRvOiByYW5nZS50byArIGRpZmYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tU3RhcnQ6IHJhbmdlLmRvbVN0YXJ0fSk7CiAgICAgICAgICBlbHNlIGlmIChjaGFuZ2UudG8gPD0gcmFuZ2UuZnJvbSB8fCBjaGFuZ2UuZnJvbSA+PSByYW5nZS50bykKICAgICAgICAgICAgaW50YWN0Mi5wdXNoKHJhbmdlKTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoY2hhbmdlLmZyb20gPiByYW5nZS5mcm9tKQogICAgICAgICAgICAgIGludGFjdDIucHVzaCh7ZnJvbTogcmFuZ2UuZnJvbSwgdG86IGNoYW5nZS5mcm9tLCBkb21TdGFydDogcmFuZ2UuZG9tU3RhcnR9KTsKICAgICAgICAgICAgaWYgKGNoYW5nZS50byA8IHJhbmdlLnRvKQogICAgICAgICAgICAgIGludGFjdDIucHVzaCh7ZnJvbTogY2hhbmdlLnRvICsgZGlmZiwgdG86IHJhbmdlLnRvICsgZGlmZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVN0YXJ0OiByYW5nZS5kb21TdGFydCArIChjaGFuZ2UudG8gLSByYW5nZS5mcm9tKX0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbnRhY3QgPSBpbnRhY3QyOwogICAgICB9CiAgICAgIHJldHVybiBpbnRhY3Q7CiAgICB9CgogICAgZnVuY3Rpb24gcGF0Y2hEaXNwbGF5KGZyb20sIHRvLCBpbnRhY3QpIHsKICAgICAgZnVuY3Rpb24ga2lsbE5vZGUobm9kZSkgewogICAgICAgIHZhciB0bXAgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICByZXR1cm4gdG1wOwogICAgICB9CiAgICAgIC8vIFRoZSBmaXJzdCBwYXNzIHJlbW92ZXMgdGhlIERPTSBub2RlcyB0aGF0IGFyZW4ndCBpbnRhY3QuCiAgICAgIGlmICghaW50YWN0Lmxlbmd0aCkgcmVtb3ZlQ2hpbGRyZW4obGluZURpdik7CiAgICAgIGVsc2UgewogICAgICAgIHZhciBkb21Qb3MgPSAwLCBjdXJOb2RlID0gbGluZURpdi5maXJzdENoaWxkLCBuOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW50YWN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgY3VyID0gaW50YWN0W2ldOwogICAgICAgICAgd2hpbGUgKGN1ci5kb21TdGFydCA+IGRvbVBvcykge2N1ck5vZGUgPSBraWxsTm9kZShjdXJOb2RlKTsgZG9tUG9zKys7fQogICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGUgPSBjdXIudG8gLSBjdXIuZnJvbTsgaiA8IGU7ICsraikge2N1ck5vZGUgPSBjdXJOb2RlLm5leHRTaWJsaW5nOyBkb21Qb3MrKzt9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChjdXJOb2RlKSBjdXJOb2RlID0ga2lsbE5vZGUoY3VyTm9kZSk7CiAgICAgIH0KICAgICAgLy8gVGhpcyBwYXNzIGZpbGxzIGluIHRoZSBsaW5lcyB0aGF0IGFjdHVhbGx5IGNoYW5nZWQuCiAgICAgIHZhciBuZXh0SW50YWN0ID0gaW50YWN0LnNoaWZ0KCksIGN1ck5vZGUgPSBsaW5lRGl2LmZpcnN0Q2hpbGQsIGogPSBmcm9tOwogICAgICBkb2MuaXRlcihmcm9tLCB0bywgZnVuY3Rpb24obGluZSkgewogICAgICAgIGlmIChuZXh0SW50YWN0ICYmIG5leHRJbnRhY3QudG8gPT0gaikgbmV4dEludGFjdCA9IGludGFjdC5zaGlmdCgpOwogICAgICAgIGlmICghbmV4dEludGFjdCB8fCBuZXh0SW50YWN0LmZyb20gPiBqKSB7CiAgICAgICAgICBpZiAobGluZS5oaWRkZW4pIHZhciBsaW5lRWxlbWVudCA9IGVsdCgicHJlIik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGxpbmVFbGVtZW50ID0gbGluZUNvbnRlbnQobGluZSk7CiAgICAgICAgICAgIGlmIChsaW5lLmNsYXNzTmFtZSkgbGluZUVsZW1lbnQuY2xhc3NOYW1lID0gbGluZS5jbGFzc05hbWU7CiAgICAgICAgICAgIC8vIEtsdWRnZSB0byBtYWtlIHN1cmUgdGhlIHN0eWxlZCBlbGVtZW50IGxpZXMgYmVoaW5kIHRoZSBzZWxlY3Rpb24gKGJ5IHotaW5kZXgpCiAgICAgICAgICAgIGlmIChsaW5lLmJnQ2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgdmFyIHByZSA9IGVsdCgicHJlIiwgIlx1MDBhMCIsIGxpbmUuYmdDbGFzc05hbWUsICJwb3NpdGlvbjogYWJzb2x1dGU7IGxlZnQ6IDA7IHJpZ2h0OiAwOyB0b3A6IDA7IGJvdHRvbTogMDsgei1pbmRleDogLTIiKTsKICAgICAgICAgICAgICBsaW5lRWxlbWVudCA9IGVsdCgiZGl2IiwgW3ByZSwgbGluZUVsZW1lbnRdLCBudWxsLCAicG9zaXRpb246IHJlbGF0aXZlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGxpbmVEaXYuaW5zZXJ0QmVmb3JlKGxpbmVFbGVtZW50LCBjdXJOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VyTm9kZSA9IGN1ck5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfQogICAgICAgICsrajsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlR3V0dGVyKCkgewogICAgICBpZiAoIW9wdGlvbnMuZ3V0dGVyICYmICFvcHRpb25zLmxpbmVOdW1iZXJzKSByZXR1cm47CiAgICAgIHZhciBoVGV4dCA9IG1vdmVyLm9mZnNldEhlaWdodCwgaEVkaXRvciA9IHNjcm9sbGVyLmNsaWVudEhlaWdodDsKICAgICAgZ3V0dGVyLnN0eWxlLmhlaWdodCA9IChoVGV4dCAtIGhFZGl0b3IgPCAyID8gaEVkaXRvciA6IGhUZXh0KSArICJweCI7CiAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgaSA9IHNob3dpbmdGcm9tLCBub3JtYWxOb2RlOwogICAgICBkb2MuaXRlcihzaG93aW5nRnJvbSwgTWF0aC5tYXgoc2hvd2luZ1RvLCBzaG93aW5nRnJvbSArIDEpLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgaWYgKGxpbmUuaGlkZGVuKSB7CiAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChlbHQoInByZSIpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG1hcmtlciA9IGxpbmUuZ3V0dGVyTWFya2VyOwogICAgICAgICAgdmFyIHRleHQgPSBvcHRpb25zLmxpbmVOdW1iZXJzID8gb3B0aW9ucy5saW5lTnVtYmVyRm9ybWF0dGVyKGkgKyBvcHRpb25zLmZpcnN0TGluZU51bWJlcikgOiBudWxsOwogICAgICAgICAgaWYgKG1hcmtlciAmJiBtYXJrZXIudGV4dCkKICAgICAgICAgICAgdGV4dCA9IG1hcmtlci50ZXh0LnJlcGxhY2UoIiVOJSIsIHRleHQgIT0gbnVsbCA/IHRleHQgOiAiIik7CiAgICAgICAgICBlbHNlIGlmICh0ZXh0ID09IG51bGwpCiAgICAgICAgICAgIHRleHQgPSAiXHUwMGEwIjsKICAgICAgICAgIHZhciBtYXJrZXJFbGVtZW50ID0gZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWx0KCJwcmUiLCBudWxsLCBtYXJrZXIgJiYgbWFya2VyLnN0eWxlKSk7CiAgICAgICAgICBtYXJrZXJFbGVtZW50LmlubmVySFRNTCA9IHRleHQ7CiAgICAgICAgICBmb3IgKHZhciBqID0gMTsgaiA8IGxpbmUuaGVpZ2h0OyArK2opIHsKICAgICAgICAgICAgbWFya2VyRWxlbWVudC5hcHBlbmRDaGlsZChlbHQoImJyIikpOwogICAgICAgICAgICBtYXJrZXJFbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCJcdTAwYTAiKSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW1hcmtlcikgbm9ybWFsTm9kZSA9IGk7CiAgICAgICAgfQogICAgICAgICsraTsKICAgICAgfSk7CiAgICAgIGd1dHRlci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICByZW1vdmVDaGlsZHJlbkFuZEFkZChndXR0ZXJUZXh0LCBmcmFnbWVudCk7CiAgICAgIC8vIE1ha2Ugc3VyZSBzY3JvbGxpbmcgZG9lc24ndCBjYXVzZSBudW1iZXIgZ3V0dGVyIHNpemUgdG8gcG9wCiAgICAgIGlmIChub3JtYWxOb2RlICE9IG51bGwgJiYgb3B0aW9ucy5saW5lTnVtYmVycykgewogICAgICAgIHZhciBub2RlID0gZ3V0dGVyVGV4dC5jaGlsZE5vZGVzW25vcm1hbE5vZGUgLSBzaG93aW5nRnJvbV07CiAgICAgICAgdmFyIG1pbndpZHRoID0gU3RyaW5nKGRvYy5zaXplKS5sZW5ndGgsIHZhbCA9IGVsdFRleHQobm9kZS5maXJzdENoaWxkKSwgcGFkID0gIiI7CiAgICAgICAgd2hpbGUgKHZhbC5sZW5ndGggKyBwYWQubGVuZ3RoIDwgbWlud2lkdGgpIHBhZCArPSAiXHUwMGEwIjsKICAgICAgICBpZiAocGFkKSBub2RlLmluc2VydEJlZm9yZShkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShwYWQpLCBub2RlLmZpcnN0Q2hpbGQpOwogICAgICB9CiAgICAgIGd1dHRlci5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgIHZhciByZXNpemVkID0gTWF0aC5hYnMoKHBhcnNlSW50KGxpbmVTcGFjZS5zdHlsZS5tYXJnaW5MZWZ0KSB8fCAwKSAtIGd1dHRlci5vZmZzZXRXaWR0aCkgPiAyOwogICAgICBsaW5lU3BhY2Uuc3R5bGUubWFyZ2luTGVmdCA9IGd1dHRlci5vZmZzZXRXaWR0aCArICJweCI7CiAgICAgIGd1dHRlckRpcnR5ID0gZmFsc2U7CiAgICAgIHJldHVybiByZXNpemVkOwogICAgfQogICAgZnVuY3Rpb24gdXBkYXRlU2VsZWN0aW9uKCkgewogICAgICB2YXIgY29sbGFwc2VkID0gcG9zRXEoc2VsLmZyb20sIHNlbC50byk7CiAgICAgIHZhciBmcm9tUG9zID0gbG9jYWxDb29yZHMoc2VsLmZyb20sIHRydWUpOwogICAgICB2YXIgdG9Qb3MgPSBjb2xsYXBzZWQgPyBmcm9tUG9zIDogbG9jYWxDb29yZHMoc2VsLnRvLCB0cnVlKTsKICAgICAgdmFyIGhlYWRQb3MgPSBzZWwuaW52ZXJ0ZWQgPyBmcm9tUG9zIDogdG9Qb3MsIHRoID0gdGV4dEhlaWdodCgpOwogICAgICB2YXIgd3JhcE9mZiA9IGVsdE9mZnNldCh3cmFwcGVyKSwgbGluZU9mZiA9IGVsdE9mZnNldChsaW5lRGl2KTsKICAgICAgaW5wdXREaXYuc3R5bGUudG9wID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oc2Nyb2xsZXIub2Zmc2V0SGVpZ2h0LCBoZWFkUG9zLnkgKyBsaW5lT2ZmLnRvcCAtIHdyYXBPZmYudG9wKSkgKyAicHgiOwogICAgICBpbnB1dERpdi5zdHlsZS5sZWZ0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oc2Nyb2xsZXIub2Zmc2V0V2lkdGgsIGhlYWRQb3MueCArIGxpbmVPZmYubGVmdCAtIHdyYXBPZmYubGVmdCkpICsgInB4IjsKICAgICAgaWYgKGNvbGxhcHNlZCkgewogICAgICAgIGN1cnNvci5zdHlsZS50b3AgPSBoZWFkUG9zLnkgKyAicHgiOwogICAgICAgIGN1cnNvci5zdHlsZS5sZWZ0ID0gKG9wdGlvbnMubGluZVdyYXBwaW5nID8gTWF0aC5taW4oaGVhZFBvcy54LCBsaW5lU3BhY2Uub2Zmc2V0V2lkdGgpIDogaGVhZFBvcy54KSArICJweCI7CiAgICAgICAgY3Vyc29yLnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICBzZWxlY3Rpb25EaXYuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgc2FtZUxpbmUgPSBmcm9tUG9zLnkgPT0gdG9Qb3MueSwgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgdmFyIGNsaWVudFdpZHRoID0gbGluZVNwYWNlLmNsaWVudFdpZHRoIHx8IGxpbmVTcGFjZS5vZmZzZXRXaWR0aDsKICAgICAgICB2YXIgY2xpZW50SGVpZ2h0ID0gbGluZVNwYWNlLmNsaWVudEhlaWdodCB8fCBsaW5lU3BhY2Uub2Zmc2V0SGVpZ2h0OwogICAgICAgIHZhciBhZGQgPSBmdW5jdGlvbihsZWZ0LCB0b3AsIHJpZ2h0LCBoZWlnaHQpIHsKICAgICAgICAgIHZhciByc3R5bGUgPSBxdWlya3NNb2RlID8gIndpZHRoOiAiICsgKCFyaWdodCA/IGNsaWVudFdpZHRoIDogY2xpZW50V2lkdGggLSByaWdodCAtIGxlZnQpICsgInB4IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAicmlnaHQ6ICIgKyByaWdodCArICJweCI7CiAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLXNlbGVjdGVkIiwgInBvc2l0aW9uOiBhYnNvbHV0ZTsgbGVmdDogIiArIGxlZnQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJweDsgdG9wOiAiICsgdG9wICsgInB4OyAiICsgcnN0eWxlICsgIjsgaGVpZ2h0OiAiICsgaGVpZ2h0ICsgInB4IikpOwogICAgICAgIH07CiAgICAgICAgaWYgKHNlbC5mcm9tLmNoICYmIGZyb21Qb3MueSA+PSAwKSB7CiAgICAgICAgICB2YXIgcmlnaHQgPSBzYW1lTGluZSA/IGNsaWVudFdpZHRoIC0gdG9Qb3MueCA6IDA7CiAgICAgICAgICBhZGQoZnJvbVBvcy54LCBmcm9tUG9zLnksIHJpZ2h0LCB0aCk7CiAgICAgICAgfQogICAgICAgIHZhciBtaWRkbGVTdGFydCA9IE1hdGgubWF4KDAsIGZyb21Qb3MueSArIChzZWwuZnJvbS5jaCA/IHRoIDogMCkpOwogICAgICAgIHZhciBtaWRkbGVIZWlnaHQgPSBNYXRoLm1pbih0b1Bvcy55LCBjbGllbnRIZWlnaHQpIC0gbWlkZGxlU3RhcnQ7CiAgICAgICAgaWYgKG1pZGRsZUhlaWdodCA+IDAuMiAqIHRoKQogICAgICAgICAgYWRkKDAsIG1pZGRsZVN0YXJ0LCAwLCBtaWRkbGVIZWlnaHQpOwogICAgICAgIGlmICgoIXNhbWVMaW5lIHx8ICFzZWwuZnJvbS5jaCkgJiYgdG9Qb3MueSA8IGNsaWVudEhlaWdodCAtIC41ICogdGgpCiAgICAgICAgICBhZGQoMCwgdG9Qb3MueSwgY2xpZW50V2lkdGggLSB0b1Bvcy54LCB0aCk7CiAgICAgICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQoc2VsZWN0aW9uRGl2LCBmcmFnbWVudCk7CiAgICAgICAgY3Vyc29yLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgc2VsZWN0aW9uRGl2LnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldFNoaWZ0KHZhbCkgewogICAgICBpZiAodmFsKSBzaGlmdFNlbGVjdGluZyA9IHNoaWZ0U2VsZWN0aW5nIHx8IChzZWwuaW52ZXJ0ZWQgPyBzZWwudG8gOiBzZWwuZnJvbSk7CiAgICAgIGVsc2Ugc2hpZnRTZWxlY3RpbmcgPSBudWxsOwogICAgfQogICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uVXNlcihmcm9tLCB0bykgewogICAgICB2YXIgc2ggPSBzaGlmdFNlbGVjdGluZyAmJiBjbGlwUG9zKHNoaWZ0U2VsZWN0aW5nKTsKICAgICAgaWYgKHNoKSB7CiAgICAgICAgaWYgKHBvc0xlc3Moc2gsIGZyb20pKSBmcm9tID0gc2g7CiAgICAgICAgZWxzZSBpZiAocG9zTGVzcyh0bywgc2gpKSB0byA9IHNoOwogICAgICB9CiAgICAgIHNldFNlbGVjdGlvbihmcm9tLCB0byk7CiAgICAgIHVzZXJTZWxDaGFuZ2UgPSB0cnVlOwogICAgfQogICAgLy8gVXBkYXRlIHRoZSBzZWxlY3Rpb24uIExhc3QgdHdvIGFyZ3MgYXJlIG9ubHkgdXNlZCBieQogICAgLy8gdXBkYXRlTGluZXMsIHNpbmNlIHRoZXkgaGF2ZSB0byBiZSBleHByZXNzZWQgaW4gdGhlIGxpbmUKICAgIC8vIG51bWJlcnMgYmVmb3JlIHRoZSB1cGRhdGUuCiAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb24oZnJvbSwgdG8sIG9sZEZyb20sIG9sZFRvKSB7CiAgICAgIGdvYWxDb2x1bW4gPSBudWxsOwogICAgICBpZiAob2xkRnJvbSA9PSBudWxsKSB7b2xkRnJvbSA9IHNlbC5mcm9tLmxpbmU7IG9sZFRvID0gc2VsLnRvLmxpbmU7fQogICAgICBpZiAocG9zRXEoc2VsLmZyb20sIGZyb20pICYmIHBvc0VxKHNlbC50bywgdG8pKSByZXR1cm47CiAgICAgIGlmIChwb3NMZXNzKHRvLCBmcm9tKSkge3ZhciB0bXAgPSB0bzsgdG8gPSBmcm9tOyBmcm9tID0gdG1wO30KCiAgICAgIC8vIFNraXAgb3ZlciBoaWRkZW4gbGluZXMuCiAgICAgIGlmIChmcm9tLmxpbmUgIT0gb2xkRnJvbSkgewogICAgICAgIHZhciBmcm9tMSA9IHNraXBIaWRkZW4oZnJvbSwgb2xkRnJvbSwgc2VsLmZyb20uY2gpOwogICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIG5vbi1oaWRkZW4gbGluZSBsZWZ0LCBmb3JjZSB2aXNpYmlsaXR5IG9uIGN1cnJlbnQgbGluZQogICAgICAgIGlmICghZnJvbTEpIHNldExpbmVIaWRkZW4oZnJvbS5saW5lLCBmYWxzZSk7CiAgICAgICAgZWxzZSBmcm9tID0gZnJvbTE7CiAgICAgIH0KICAgICAgaWYgKHRvLmxpbmUgIT0gb2xkVG8pIHRvID0gc2tpcEhpZGRlbih0bywgb2xkVG8sIHNlbC50by5jaCk7CgogICAgICBpZiAocG9zRXEoZnJvbSwgdG8pKSBzZWwuaW52ZXJ0ZWQgPSBmYWxzZTsKICAgICAgZWxzZSBpZiAocG9zRXEoZnJvbSwgc2VsLnRvKSkgc2VsLmludmVydGVkID0gZmFsc2U7CiAgICAgIGVsc2UgaWYgKHBvc0VxKHRvLCBzZWwuZnJvbSkpIHNlbC5pbnZlcnRlZCA9IHRydWU7CgogICAgICBpZiAob3B0aW9ucy5hdXRvQ2xlYXJFbXB0eUxpbmVzICYmIHBvc0VxKHNlbC5mcm9tLCBzZWwudG8pKSB7CiAgICAgICAgdmFyIGhlYWQgPSBzZWwuaW52ZXJ0ZWQgPyBmcm9tIDogdG87CiAgICAgICAgaWYgKGhlYWQubGluZSAhPSBzZWwuZnJvbS5saW5lICYmIHNlbC5mcm9tLmxpbmUgPCBkb2Muc2l6ZSkgewogICAgICAgICAgdmFyIG9sZExpbmUgPSBnZXRMaW5lKHNlbC5mcm9tLmxpbmUpOwogICAgICAgICAgaWYgKC9eXHMrJC8udGVzdChvbGRMaW5lLnRleHQpKQogICAgICAgICAgICBzZXRUaW1lb3V0KG9wZXJhdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAob2xkTGluZS5wYXJlbnQgJiYgL15ccyskLy50ZXN0KG9sZExpbmUudGV4dCkpIHsKICAgICAgICAgICAgICAgIHZhciBubyA9IGxpbmVObyhvbGRMaW5lKTsKICAgICAgICAgICAgICAgIHJlcGxhY2VSYW5nZSgiIiwge2xpbmU6IG5vLCBjaDogMH0sIHtsaW5lOiBubywgY2g6IG9sZExpbmUudGV4dC5sZW5ndGh9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDEwKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBzZWwuZnJvbSA9IGZyb207IHNlbC50byA9IHRvOwogICAgICBzZWxlY3Rpb25DaGFuZ2VkID0gdHJ1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIHNraXBIaWRkZW4ocG9zLCBvbGRMaW5lLCBvbGRDaCkgewogICAgICBmdW5jdGlvbiBnZXROb25IaWRkZW4oZGlyKSB7CiAgICAgICAgdmFyIGxObyA9IHBvcy5saW5lICsgZGlyLCBlbmQgPSBkaXIgPT0gMSA/IGRvYy5zaXplIDogLTE7CiAgICAgICAgd2hpbGUgKGxObyAhPSBlbmQpIHsKICAgICAgICAgIHZhciBsaW5lID0gZ2V0TGluZShsTm8pOwogICAgICAgICAgaWYgKCFsaW5lLmhpZGRlbikgewogICAgICAgICAgICB2YXIgY2ggPSBwb3MuY2g7CiAgICAgICAgICAgIGlmICh0b0VuZCB8fCBjaCA+IG9sZENoIHx8IGNoID4gbGluZS50ZXh0Lmxlbmd0aCkgY2ggPSBsaW5lLnRleHQubGVuZ3RoOwogICAgICAgICAgICByZXR1cm4ge2xpbmU6IGxObywgY2g6IGNofTsKICAgICAgICAgIH0KICAgICAgICAgIGxObyArPSBkaXI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBsaW5lID0gZ2V0TGluZShwb3MubGluZSk7CiAgICAgIHZhciB0b0VuZCA9IHBvcy5jaCA9PSBsaW5lLnRleHQubGVuZ3RoICYmIHBvcy5jaCAhPSBvbGRDaDsKICAgICAgaWYgKCFsaW5lLmhpZGRlbikgcmV0dXJuIHBvczsKICAgICAgaWYgKHBvcy5saW5lID49IG9sZExpbmUpIHJldHVybiBnZXROb25IaWRkZW4oMSkgfHwgZ2V0Tm9uSGlkZGVuKC0xKTsKICAgICAgZWxzZSByZXR1cm4gZ2V0Tm9uSGlkZGVuKC0xKSB8fCBnZXROb25IaWRkZW4oMSk7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdXJzb3IobGluZSwgY2gsIHVzZXIpIHsKICAgICAgdmFyIHBvcyA9IGNsaXBQb3Moe2xpbmU6IGxpbmUsIGNoOiBjaCB8fCAwfSk7CiAgICAgICh1c2VyID8gc2V0U2VsZWN0aW9uVXNlciA6IHNldFNlbGVjdGlvbikocG9zLCBwb3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsaXBMaW5lKG4pIHtyZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4obiwgZG9jLnNpemUtMSkpO30KICAgIGZ1bmN0aW9uIGNsaXBQb3MocG9zKSB7CiAgICAgIGlmIChwb3MubGluZSA8IDApIHJldHVybiB7bGluZTogMCwgY2g6IDB9OwogICAgICBpZiAocG9zLmxpbmUgPj0gZG9jLnNpemUpIHJldHVybiB7bGluZTogZG9jLnNpemUtMSwgY2g6IGdldExpbmUoZG9jLnNpemUtMSkudGV4dC5sZW5ndGh9OwogICAgICB2YXIgY2ggPSBwb3MuY2gsIGxpbmVsZW4gPSBnZXRMaW5lKHBvcy5saW5lKS50ZXh0Lmxlbmd0aDsKICAgICAgaWYgKGNoID09IG51bGwgfHwgY2ggPiBsaW5lbGVuKSByZXR1cm4ge2xpbmU6IHBvcy5saW5lLCBjaDogbGluZWxlbn07CiAgICAgIGVsc2UgaWYgKGNoIDwgMCkgcmV0dXJuIHtsaW5lOiBwb3MubGluZSwgY2g6IDB9OwogICAgICBlbHNlIHJldHVybiBwb3M7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZFBvc0goZGlyLCB1bml0KSB7CiAgICAgIHZhciBlbmQgPSBzZWwuaW52ZXJ0ZWQgPyBzZWwuZnJvbSA6IHNlbC50bywgbGluZSA9IGVuZC5saW5lLCBjaCA9IGVuZC5jaDsKICAgICAgdmFyIGxpbmVPYmogPSBnZXRMaW5lKGxpbmUpOwogICAgICBmdW5jdGlvbiBmaW5kTmV4dExpbmUoKSB7CiAgICAgICAgZm9yICh2YXIgbCA9IGxpbmUgKyBkaXIsIGUgPSBkaXIgPCAwID8gLTEgOiBkb2Muc2l6ZTsgbCAhPSBlOyBsICs9IGRpcikgewogICAgICAgICAgdmFyIGxvID0gZ2V0TGluZShsKTsKICAgICAgICAgIGlmICghbG8uaGlkZGVuKSB7IGxpbmUgPSBsOyBsaW5lT2JqID0gbG87IHJldHVybiB0cnVlOyB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIG1vdmVPbmNlKGJvdW5kVG9MaW5lKSB7CiAgICAgICAgaWYgKGNoID09IChkaXIgPCAwID8gMCA6IGxpbmVPYmoudGV4dC5sZW5ndGgpKSB7CiAgICAgICAgICBpZiAoIWJvdW5kVG9MaW5lICYmIGZpbmROZXh0TGluZSgpKSBjaCA9IGRpciA8IDAgPyBsaW5lT2JqLnRleHQubGVuZ3RoIDogMDsKICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBjaCArPSBkaXI7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKHVuaXQgPT0gImNoYXIiKSBtb3ZlT25jZSgpOwogICAgICBlbHNlIGlmICh1bml0ID09ICJjb2x1bW4iKSBtb3ZlT25jZSh0cnVlKTsKICAgICAgZWxzZSBpZiAodW5pdCA9PSAid29yZCIpIHsKICAgICAgICB2YXIgc2F3V29yZCA9IGZhbHNlOwogICAgICAgIGZvciAoOzspIHsKICAgICAgICAgIGlmIChkaXIgPCAwKSBpZiAoIW1vdmVPbmNlKCkpIGJyZWFrOwogICAgICAgICAgaWYgKGlzV29yZENoYXIobGluZU9iai50ZXh0LmNoYXJBdChjaCkpKSBzYXdXb3JkID0gdHJ1ZTsKICAgICAgICAgIGVsc2UgaWYgKHNhd1dvcmQpIHtpZiAoZGlyIDwgMCkge2RpciA9IDE7IG1vdmVPbmNlKCk7fSBicmVhazt9CiAgICAgICAgICBpZiAoZGlyID4gMCkgaWYgKCFtb3ZlT25jZSgpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHtsaW5lOiBsaW5lLCBjaDogY2h9OwogICAgfQogICAgZnVuY3Rpb24gbW92ZUgoZGlyLCB1bml0KSB7CiAgICAgIHZhciBwb3MgPSBkaXIgPCAwID8gc2VsLmZyb20gOiBzZWwudG87CiAgICAgIGlmIChzaGlmdFNlbGVjdGluZyB8fCBwb3NFcShzZWwuZnJvbSwgc2VsLnRvKSkgcG9zID0gZmluZFBvc0goZGlyLCB1bml0KTsKICAgICAgc2V0Q3Vyc29yKHBvcy5saW5lLCBwb3MuY2gsIHRydWUpOwogICAgfQogICAgZnVuY3Rpb24gZGVsZXRlSChkaXIsIHVuaXQpIHsKICAgICAgaWYgKCFwb3NFcShzZWwuZnJvbSwgc2VsLnRvKSkgcmVwbGFjZVJhbmdlKCIiLCBzZWwuZnJvbSwgc2VsLnRvKTsKICAgICAgZWxzZSBpZiAoZGlyIDwgMCkgcmVwbGFjZVJhbmdlKCIiLCBmaW5kUG9zSChkaXIsIHVuaXQpLCBzZWwudG8pOwogICAgICBlbHNlIHJlcGxhY2VSYW5nZSgiIiwgc2VsLmZyb20sIGZpbmRQb3NIKGRpciwgdW5pdCkpOwogICAgICB1c2VyU2VsQ2hhbmdlID0gdHJ1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIG1vdmVWKGRpciwgdW5pdCkgewogICAgICB2YXIgZGlzdCA9IDAsIHBvcyA9IGxvY2FsQ29vcmRzKHNlbC5pbnZlcnRlZCA/IHNlbC5mcm9tIDogc2VsLnRvLCB0cnVlKTsKICAgICAgaWYgKGdvYWxDb2x1bW4gIT0gbnVsbCkgcG9zLnggPSBnb2FsQ29sdW1uOwogICAgICBpZiAodW5pdCA9PSAicGFnZSIpIHsKICAgICAgICB2YXIgc2NyZWVuID0gTWF0aC5taW4oc2Nyb2xsZXIuY2xpZW50SGVpZ2h0LCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCk7CiAgICAgICAgdmFyIHRhcmdldCA9IGNvb3Jkc0NoYXIocG9zLngsIHBvcy55ICsgc2NyZWVuICogZGlyKTsKICAgICAgfSBlbHNlIGlmICh1bml0ID09ICJsaW5lIikgewogICAgICAgIHZhciB0aCA9IHRleHRIZWlnaHQoKTsKICAgICAgICB2YXIgdGFyZ2V0ID0gY29vcmRzQ2hhcihwb3MueCwgcG9zLnkgKyAuNSAqIHRoICsgZGlyICogdGgpOwogICAgICB9CiAgICAgIGlmICh1bml0ID09ICJwYWdlIikgc2Nyb2xsYmFyLnNjcm9sbFRvcCArPSBsb2NhbENvb3Jkcyh0YXJnZXQsIHRydWUpLnkgLSBwb3MueTsKICAgICAgc2V0Q3Vyc29yKHRhcmdldC5saW5lLCB0YXJnZXQuY2gsIHRydWUpOwogICAgICBnb2FsQ29sdW1uID0gcG9zLng7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZFdvcmRBdChwb3MpIHsKICAgICAgdmFyIGxpbmUgPSBnZXRMaW5lKHBvcy5saW5lKS50ZXh0OwogICAgICB2YXIgc3RhcnQgPSBwb3MuY2gsIGVuZCA9IHBvcy5jaDsKICAgICAgaWYgKGxpbmUpIHsKICAgICAgICBpZiAocG9zLmFmdGVyID09PSBmYWxzZSB8fCBlbmQgPT0gbGluZS5sZW5ndGgpIC0tc3RhcnQ7IGVsc2UgKytlbmQ7CiAgICAgICAgdmFyIHN0YXJ0Q2hhciA9IGxpbmUuY2hhckF0KHN0YXJ0KTsKICAgICAgICB2YXIgY2hlY2sgPSBpc1dvcmRDaGFyKHN0YXJ0Q2hhcikgPyBpc1dvcmRDaGFyIDoKICAgICAgICAgICAgICAgICAgICAvXHMvLnRlc3Qoc3RhcnRDaGFyKSA/IGZ1bmN0aW9uKGNoKSB7cmV0dXJuIC9ccy8udGVzdChjaCk7fSA6CiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oY2gpIHtyZXR1cm4gIS9ccy8udGVzdChjaCkgJiYgIWlzV29yZENoYXIoY2gpO307CiAgICAgICAgd2hpbGUgKHN0YXJ0ID4gMCAmJiBjaGVjayhsaW5lLmNoYXJBdChzdGFydCAtIDEpKSkgLS1zdGFydDsKICAgICAgICB3aGlsZSAoZW5kIDwgbGluZS5sZW5ndGggJiYgY2hlY2sobGluZS5jaGFyQXQoZW5kKSkpICsrZW5kOwogICAgICB9CiAgICAgIHJldHVybiB7ZnJvbToge2xpbmU6IHBvcy5saW5lLCBjaDogc3RhcnR9LCB0bzoge2xpbmU6IHBvcy5saW5lLCBjaDogZW5kfX07CiAgICB9CiAgICBmdW5jdGlvbiBzZWxlY3RMaW5lKGxpbmUpIHsKICAgICAgc2V0U2VsZWN0aW9uVXNlcih7bGluZTogbGluZSwgY2g6IDB9LCBjbGlwUG9zKHtsaW5lOiBsaW5lICsgMSwgY2g6IDB9KSk7CiAgICB9CiAgICBmdW5jdGlvbiBpbmRlbnRTZWxlY3RlZChtb2RlKSB7CiAgICAgIGlmIChwb3NFcShzZWwuZnJvbSwgc2VsLnRvKSkgcmV0dXJuIGluZGVudExpbmUoc2VsLmZyb20ubGluZSwgbW9kZSk7CiAgICAgIHZhciBlID0gc2VsLnRvLmxpbmUgLSAoc2VsLnRvLmNoID8gMCA6IDEpOwogICAgICBmb3IgKHZhciBpID0gc2VsLmZyb20ubGluZTsgaSA8PSBlOyArK2kpIGluZGVudExpbmUoaSwgbW9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5kZW50TGluZShuLCBob3cpIHsKICAgICAgaWYgKCFob3cpIGhvdyA9ICJhZGQiOwogICAgICBpZiAoaG93ID09ICJzbWFydCIpIHsKICAgICAgICBpZiAoIW1vZGUuaW5kZW50KSBob3cgPSAicHJldiI7CiAgICAgICAgZWxzZSB2YXIgc3RhdGUgPSBnZXRTdGF0ZUJlZm9yZShuKTsKICAgICAgfQoKICAgICAgdmFyIGxpbmUgPSBnZXRMaW5lKG4pLCBjdXJTcGFjZSA9IGxpbmUuaW5kZW50YXRpb24ob3B0aW9ucy50YWJTaXplKSwKICAgICAgICAgIGN1clNwYWNlU3RyaW5nID0gbGluZS50ZXh0Lm1hdGNoKC9eXHMqLylbMF0sIGluZGVudGF0aW9uOwogICAgICBpZiAoaG93ID09ICJzbWFydCIpIHsKICAgICAgICBpbmRlbnRhdGlvbiA9IG1vZGUuaW5kZW50KHN0YXRlLCBsaW5lLnRleHQuc2xpY2UoY3VyU3BhY2VTdHJpbmcubGVuZ3RoKSwgbGluZS50ZXh0KTsKICAgICAgICBpZiAoaW5kZW50YXRpb24gPT0gUGFzcykgaG93ID0gInByZXYiOwogICAgICB9CiAgICAgIGlmIChob3cgPT0gInByZXYiKSB7CiAgICAgICAgaWYgKG4pIGluZGVudGF0aW9uID0gZ2V0TGluZShuLTEpLmluZGVudGF0aW9uKG9wdGlvbnMudGFiU2l6ZSk7CiAgICAgICAgZWxzZSBpbmRlbnRhdGlvbiA9IDA7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaG93ID09ICJhZGQiKSBpbmRlbnRhdGlvbiA9IGN1clNwYWNlICsgb3B0aW9ucy5pbmRlbnRVbml0OwogICAgICBlbHNlIGlmIChob3cgPT0gInN1YnRyYWN0IikgaW5kZW50YXRpb24gPSBjdXJTcGFjZSAtIG9wdGlvbnMuaW5kZW50VW5pdDsKICAgICAgaW5kZW50YXRpb24gPSBNYXRoLm1heCgwLCBpbmRlbnRhdGlvbik7CiAgICAgIHZhciBkaWZmID0gaW5kZW50YXRpb24gLSBjdXJTcGFjZTsKCiAgICAgIHZhciBpbmRlbnRTdHJpbmcgPSAiIiwgcG9zID0gMDsKICAgICAgaWYgKG9wdGlvbnMuaW5kZW50V2l0aFRhYnMpCiAgICAgICAgZm9yICh2YXIgaSA9IE1hdGguZmxvb3IoaW5kZW50YXRpb24gLyBvcHRpb25zLnRhYlNpemUpOyBpOyAtLWkpIHtwb3MgKz0gb3B0aW9ucy50YWJTaXplOyBpbmRlbnRTdHJpbmcgKz0gIlx0Ijt9CiAgICAgIGlmIChwb3MgPCBpbmRlbnRhdGlvbikgaW5kZW50U3RyaW5nICs9IHNwYWNlU3RyKGluZGVudGF0aW9uIC0gcG9zKTsKCiAgICAgIGlmIChpbmRlbnRTdHJpbmcgIT0gY3VyU3BhY2VTdHJpbmcpCiAgICAgICAgcmVwbGFjZVJhbmdlKGluZGVudFN0cmluZywge2xpbmU6IG4sIGNoOiAwfSwge2xpbmU6IG4sIGNoOiBjdXJTcGFjZVN0cmluZy5sZW5ndGh9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBsb2FkTW9kZSgpIHsKICAgICAgbW9kZSA9IENvZGVNaXJyb3IuZ2V0TW9kZShvcHRpb25zLCBvcHRpb25zLm1vZGUpOwogICAgICBkb2MuaXRlcigwLCBkb2Muc2l6ZSwgZnVuY3Rpb24obGluZSkgeyBsaW5lLnN0YXRlQWZ0ZXIgPSBudWxsOyB9KTsKICAgICAgZnJvbnRpZXIgPSAwOwogICAgICBzdGFydFdvcmtlcigxMDApOwogICAgfQogICAgZnVuY3Rpb24gZ3V0dGVyQ2hhbmdlZCgpIHsKICAgICAgdmFyIHZpc2libGUgPSBvcHRpb25zLmd1dHRlciB8fCBvcHRpb25zLmxpbmVOdW1iZXJzOwogICAgICBndXR0ZXIuc3R5bGUuZGlzcGxheSA9IHZpc2libGUgPyAiIiA6ICJub25lIjsKICAgICAgaWYgKHZpc2libGUpIGd1dHRlckRpcnR5ID0gdHJ1ZTsKICAgICAgZWxzZSBsaW5lRGl2LnBhcmVudE5vZGUuc3R5bGUubWFyZ2luTGVmdCA9IDA7CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwcGluZ0NoYW5nZWQoZnJvbSwgdG8pIHsKICAgICAgaWYgKG9wdGlvbnMubGluZVdyYXBwaW5nKSB7CiAgICAgICAgd3JhcHBlci5jbGFzc05hbWUgKz0gIiBDb2RlTWlycm9yLXdyYXAiOwogICAgICAgIHZhciBwZXJMaW5lID0gc2Nyb2xsZXIuY2xpZW50V2lkdGggLyBjaGFyV2lkdGgoKSAtIDM7CiAgICAgICAgZG9jLml0ZXIoMCwgZG9jLnNpemUsIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgIGlmIChsaW5lLmhpZGRlbikgcmV0dXJuOwogICAgICAgICAgdmFyIGd1ZXNzID0gTWF0aC5jZWlsKGxpbmUudGV4dC5sZW5ndGggLyBwZXJMaW5lKSB8fCAxOwogICAgICAgICAgaWYgKGd1ZXNzICE9IDEpIHVwZGF0ZUxpbmVIZWlnaHQobGluZSwgZ3Vlc3MpOwogICAgICAgIH0pOwogICAgICAgIGxpbmVTcGFjZS5zdHlsZS5taW5XaWR0aCA9IHdpZHRoRm9yY2VyLnN0eWxlLmxlZnQgPSAiIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB3cmFwcGVyLmNsYXNzTmFtZSA9IHdyYXBwZXIuY2xhc3NOYW1lLnJlcGxhY2UoIiBDb2RlTWlycm9yLXdyYXAiLCAiIik7CiAgICAgICAgY29tcHV0ZU1heExlbmd0aCgpOwogICAgICAgIGRvYy5pdGVyKDAsIGRvYy5zaXplLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICBpZiAobGluZS5oZWlnaHQgIT0gMSAmJiAhbGluZS5oaWRkZW4pIHVwZGF0ZUxpbmVIZWlnaHQobGluZSwgMSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY2hhbmdlcy5wdXNoKHtmcm9tOiAwLCB0bzogZG9jLnNpemV9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHRoZW1lQ2hhbmdlZCgpIHsKICAgICAgc2Nyb2xsZXIuY2xhc3NOYW1lID0gc2Nyb2xsZXIuY2xhc3NOYW1lLnJlcGxhY2UoL1xzKmNtLXMtXFMrL2csICIiKSArCiAgICAgICAgb3B0aW9ucy50aGVtZS5yZXBsYWNlKC8oXnxccylccyovZywgIiBjbS1zLSIpOwogICAgfQogICAgZnVuY3Rpb24ga2V5TWFwQ2hhbmdlZCgpIHsKICAgICAgdmFyIHN0eWxlID0ga2V5TWFwW29wdGlvbnMua2V5TWFwXS5zdHlsZTsKICAgICAgd3JhcHBlci5jbGFzc05hbWUgPSB3cmFwcGVyLmNsYXNzTmFtZS5yZXBsYWNlKC9ccypjbS1rZXltYXAtXFMrL2csICIiKSArCiAgICAgICAgKHN0eWxlID8gIiBjbS1rZXltYXAtIiArIHN0eWxlIDogIiIpOwogICAgfQoKICAgIGZ1bmN0aW9uIFRleHRNYXJrZXIodHlwZSwgc3R5bGUpIHsgdGhpcy5saW5lcyA9IFtdOyB0aGlzLnR5cGUgPSB0eXBlOyBpZiAoc3R5bGUpIHRoaXMuc3R5bGUgPSBzdHlsZTsgfQogICAgVGV4dE1hcmtlci5wcm90b3R5cGUuY2xlYXIgPSBvcGVyYXRpb24oZnVuY3Rpb24oKSB7CiAgICAgIHZhciBtaW4gPSBJbmZpbml0eSwgbWF4ID0gLUluZmluaXR5OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGluZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgbGluZSA9IHRoaXMubGluZXNbaV07CiAgICAgICAgdmFyIHNwYW4gPSBnZXRNYXJrZWRTcGFuRm9yKGxpbmUubWFya2VkU3BhbnMsIHRoaXMsIHRydWUpOwogICAgICAgIGlmIChzcGFuLmZyb20gIT0gbnVsbCB8fCBzcGFuLnRvICE9IG51bGwpIHsKICAgICAgICAgIHZhciBsaW5lTiA9IGxpbmVObyhsaW5lKTsKICAgICAgICAgIG1pbiA9IE1hdGgubWluKG1pbiwgbGluZU4pOyBtYXggPSBNYXRoLm1heChtYXgsIGxpbmVOKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG1pbiAhPSBJbmZpbml0eSkKICAgICAgICBjaGFuZ2VzLnB1c2goe2Zyb206IG1pbiwgdG86IG1heCArIDF9KTsKICAgICAgdGhpcy5saW5lcy5sZW5ndGggPSAwOwogICAgfSk7CiAgICBUZXh0TWFya2VyLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmcm9tLCB0bzsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxpbmVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGxpbmUgPSB0aGlzLmxpbmVzW2ldOwogICAgICAgIHZhciBzcGFuID0gZ2V0TWFya2VkU3BhbkZvcihsaW5lLm1hcmtlZFNwYW5zLCB0aGlzKTsKICAgICAgICBpZiAoc3Bhbi5mcm9tICE9IG51bGwgfHwgc3Bhbi50byAhPSBudWxsKSB7CiAgICAgICAgICB2YXIgZm91bmQgPSBsaW5lTm8obGluZSk7CiAgICAgICAgICBpZiAoc3Bhbi5mcm9tICE9IG51bGwpIGZyb20gPSB7bGluZTogZm91bmQsIGNoOiBzcGFuLmZyb219OwogICAgICAgICAgaWYgKHNwYW4udG8gIT0gbnVsbCkgdG8gPSB7bGluZTogZm91bmQsIGNoOiBzcGFuLnRvfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMudHlwZSA9PSAiYm9va21hcmsiKSByZXR1cm4gZnJvbTsKICAgICAgcmV0dXJuIGZyb20gJiYge2Zyb206IGZyb20sIHRvOiB0b307CiAgICB9OwoKICAgIGZ1bmN0aW9uIG1hcmtUZXh0KGZyb20sIHRvLCBjbGFzc05hbWUsIG9wdGlvbnMpIHsKICAgICAgZnJvbSA9IGNsaXBQb3MoZnJvbSk7IHRvID0gY2xpcFBvcyh0byk7CiAgICAgIHZhciBtYXJrZXIgPSBuZXcgVGV4dE1hcmtlcigicmFuZ2UiLCBjbGFzc05hbWUpOwogICAgICBpZiAob3B0aW9ucykgZm9yICh2YXIgb3B0IGluIG9wdGlvbnMpIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KG9wdCkpCiAgICAgICAgbWFya2VyW29wdF0gPSBvcHRpb25zW29wdF07CiAgICAgIHZhciBjdXJMaW5lID0gZnJvbS5saW5lOwogICAgICBkb2MuaXRlcihjdXJMaW5lLCB0by5saW5lICsgMSwgZnVuY3Rpb24obGluZSkgewogICAgICAgIHZhciBzcGFuID0ge2Zyb206IGN1ckxpbmUgPT0gZnJvbS5saW5lID8gZnJvbS5jaCA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgdG86IGN1ckxpbmUgPT0gdG8ubGluZSA/IHRvLmNoIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBtYXJrZXI6IG1hcmtlcn07CiAgICAgICAgKGxpbmUubWFya2VkU3BhbnMgfHwgKGxpbmUubWFya2VkU3BhbnMgPSBbXSkpLnB1c2goc3Bhbik7CiAgICAgICAgbWFya2VyLmxpbmVzLnB1c2gobGluZSk7CiAgICAgICAgKytjdXJMaW5lOwogICAgICB9KTsKICAgICAgY2hhbmdlcy5wdXNoKHtmcm9tOiBmcm9tLmxpbmUsIHRvOiB0by5saW5lICsgMX0pOwogICAgICByZXR1cm4gbWFya2VyOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldEJvb2ttYXJrKHBvcykgewogICAgICBwb3MgPSBjbGlwUG9zKHBvcyk7CiAgICAgIHZhciBtYXJrZXIgPSBuZXcgVGV4dE1hcmtlcigiYm9va21hcmsiKSwgbGluZSA9IGdldExpbmUocG9zLmxpbmUpOwogICAgICB2YXIgc3BhbiA9IHtmcm9tOiBwb3MuY2gsIHRvOiBwb3MuY2gsIG1hcmtlcjogbWFya2VyfTsKICAgICAgKGxpbmUubWFya2VkU3BhbnMgfHwgKGxpbmUubWFya2VkU3BhbnMgPSBbXSkpLnB1c2goc3Bhbik7CiAgICAgIG1hcmtlci5saW5lcy5wdXNoKGxpbmUpOwogICAgICByZXR1cm4gbWFya2VyOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRNYXJrc0F0KHBvcykgewogICAgICBwb3MgPSBjbGlwUG9zKHBvcyk7CiAgICAgIHZhciBtYXJrZXJzID0gW10sIHNwYW5zID0gZ2V0TGluZShwb3MubGluZSkubWFya2VkU3BhbnM7CiAgICAgIGlmIChzcGFucykgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFucy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBzcGFuID0gc3BhbnNbaV07CiAgICAgICAgaWYgKChzcGFuLmZyb20gPT0gbnVsbCB8fCBzcGFuLmZyb20gPD0gcG9zLmNoKSAmJgogICAgICAgICAgICAoc3Bhbi50byA9PSBudWxsIHx8IHNwYW4udG8gPj0gcG9zLmNoKSkKICAgICAgICAgIG1hcmtlcnMucHVzaChzcGFuLm1hcmtlcik7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hcmtlcnM7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkR3V0dGVyTWFya2VyKGxpbmUsIHRleHQsIGNsYXNzTmFtZSkgewogICAgICBpZiAodHlwZW9mIGxpbmUgPT0gIm51bWJlciIpIGxpbmUgPSBnZXRMaW5lKGNsaXBMaW5lKGxpbmUpKTsKICAgICAgbGluZS5ndXR0ZXJNYXJrZXIgPSB7dGV4dDogdGV4dCwgc3R5bGU6IGNsYXNzTmFtZX07CiAgICAgIGd1dHRlckRpcnR5ID0gdHJ1ZTsKICAgICAgcmV0dXJuIGxpbmU7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVHdXR0ZXJNYXJrZXIobGluZSkgewogICAgICBpZiAodHlwZW9mIGxpbmUgPT0gIm51bWJlciIpIGxpbmUgPSBnZXRMaW5lKGNsaXBMaW5lKGxpbmUpKTsKICAgICAgbGluZS5ndXR0ZXJNYXJrZXIgPSBudWxsOwogICAgICBndXR0ZXJEaXJ0eSA9IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gY2hhbmdlTGluZShoYW5kbGUsIG9wKSB7CiAgICAgIHZhciBubyA9IGhhbmRsZSwgbGluZSA9IGhhbmRsZTsKICAgICAgaWYgKHR5cGVvZiBoYW5kbGUgPT0gIm51bWJlciIpIGxpbmUgPSBnZXRMaW5lKGNsaXBMaW5lKGhhbmRsZSkpOwogICAgICBlbHNlIG5vID0gbGluZU5vKGhhbmRsZSk7CiAgICAgIGlmIChubyA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKG9wKGxpbmUsIG5vKSkgY2hhbmdlcy5wdXNoKHtmcm9tOiBubywgdG86IG5vICsgMX0pOwogICAgICBlbHNlIHJldHVybiBudWxsOwogICAgICByZXR1cm4gbGluZTsKICAgIH0KICAgIGZ1bmN0aW9uIHNldExpbmVDbGFzcyhoYW5kbGUsIGNsYXNzTmFtZSwgYmdDbGFzc05hbWUpIHsKICAgICAgcmV0dXJuIGNoYW5nZUxpbmUoaGFuZGxlLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgaWYgKGxpbmUuY2xhc3NOYW1lICE9IGNsYXNzTmFtZSB8fCBsaW5lLmJnQ2xhc3NOYW1lICE9IGJnQ2xhc3NOYW1lKSB7CiAgICAgICAgICBsaW5lLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTsKICAgICAgICAgIGxpbmUuYmdDbGFzc05hbWUgPSBiZ0NsYXNzTmFtZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRMaW5lSGlkZGVuKGhhbmRsZSwgaGlkZGVuKSB7CiAgICAgIHJldHVybiBjaGFuZ2VMaW5lKGhhbmRsZSwgZnVuY3Rpb24obGluZSwgbm8pIHsKICAgICAgICBpZiAobGluZS5oaWRkZW4gIT0gaGlkZGVuKSB7CiAgICAgICAgICBsaW5lLmhpZGRlbiA9IGhpZGRlbjsKICAgICAgICAgIGlmICghb3B0aW9ucy5saW5lV3JhcHBpbmcpIHsKICAgICAgICAgICAgaWYgKGhpZGRlbiAmJiBsaW5lLnRleHQubGVuZ3RoID09IG1heExpbmUudGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICB1cGRhdGVNYXhMaW5lID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaGlkZGVuICYmIGxpbmUudGV4dC5sZW5ndGggPiBtYXhMaW5lLnRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgbWF4TGluZSA9IGxpbmU7IHVwZGF0ZU1heExpbmUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdXBkYXRlTGluZUhlaWdodChsaW5lLCBoaWRkZW4gPyAwIDogMSk7CiAgICAgICAgICB2YXIgZmxpbmUgPSBzZWwuZnJvbS5saW5lLCB0bGluZSA9IHNlbC50by5saW5lOwogICAgICAgICAgaWYgKGhpZGRlbiAmJiAoZmxpbmUgPT0gbm8gfHwgdGxpbmUgPT0gbm8pKSB7CiAgICAgICAgICAgIHZhciBmcm9tID0gZmxpbmUgPT0gbm8gPyBza2lwSGlkZGVuKHtsaW5lOiBmbGluZSwgY2g6IDB9LCBmbGluZSwgMCkgOiBzZWwuZnJvbTsKICAgICAgICAgICAgdmFyIHRvID0gdGxpbmUgPT0gbm8gPyBza2lwSGlkZGVuKHtsaW5lOiB0bGluZSwgY2g6IDB9LCB0bGluZSwgMCkgOiBzZWwudG87CiAgICAgICAgICAgIC8vIENhbid0IGhpZGUgdGhlIGxhc3QgdmlzaWJsZSBsaW5lLCB3ZSdkIGhhdmUgbm8gcGxhY2UgdG8gcHV0IHRoZSBjdXJzb3IKICAgICAgICAgICAgaWYgKCF0bykgcmV0dXJuOwogICAgICAgICAgICBzZXRTZWxlY3Rpb24oZnJvbSwgdG8pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIChndXR0ZXJEaXJ0eSA9IHRydWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gbGluZUluZm8obGluZSkgewogICAgICBpZiAodHlwZW9mIGxpbmUgPT0gIm51bWJlciIpIHsKICAgICAgICBpZiAoIWlzTGluZShsaW5lKSkgcmV0dXJuIG51bGw7CiAgICAgICAgdmFyIG4gPSBsaW5lOwogICAgICAgIGxpbmUgPSBnZXRMaW5lKGxpbmUpOwogICAgICAgIGlmICghbGluZSkgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG4gPSBsaW5lTm8obGluZSk7CiAgICAgICAgaWYgKG4gPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgdmFyIG1hcmtlciA9IGxpbmUuZ3V0dGVyTWFya2VyOwogICAgICByZXR1cm4ge2xpbmU6IG4sIGhhbmRsZTogbGluZSwgdGV4dDogbGluZS50ZXh0LCBtYXJrZXJUZXh0OiBtYXJrZXIgJiYgbWFya2VyLnRleHQsCiAgICAgICAgICAgICAgbWFya2VyQ2xhc3M6IG1hcmtlciAmJiBtYXJrZXIuc3R5bGUsIGxpbmVDbGFzczogbGluZS5jbGFzc05hbWUsIGJnQ2xhc3M6IGxpbmUuYmdDbGFzc05hbWV9OwogICAgfQoKICAgIGZ1bmN0aW9uIG1lYXN1cmVMaW5lKGxpbmUsIGNoKSB7CiAgICAgIGlmIChjaCA9PSAwKSByZXR1cm4ge3RvcDogMCwgbGVmdDogMH07CiAgICAgIHZhciB3YnIgPSBvcHRpb25zLmxpbmVXcmFwcGluZyAmJiBjaCA8IGxpbmUudGV4dC5sZW5ndGggJiYKICAgICAgICAgICAgICAgIHNwYW5BZmZlY3RzV3JhcHBpbmcudGVzdChsaW5lLnRleHQuc2xpY2UoY2ggLSAxLCBjaCArIDEpKTsKICAgICAgdmFyIHByZSA9IGxpbmVDb250ZW50KGxpbmUsIGNoKTsKICAgICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQobWVhc3VyZSwgcHJlKTsKICAgICAgdmFyIGFuY2hvciA9IHByZS5hbmNob3I7CiAgICAgIHZhciB0b3AgPSBhbmNob3Iub2Zmc2V0VG9wLCBsZWZ0ID0gYW5jaG9yLm9mZnNldExlZnQ7CiAgICAgIC8vIE9sZGVyIElFcyByZXBvcnQgemVybyBvZmZzZXRzIGZvciBzcGFucyBkaXJlY3RseSBhZnRlciBhIHdyYXAKICAgICAgaWYgKGllICYmIHRvcCA9PSAwICYmIGxlZnQgPT0gMCkgewogICAgICAgIHZhciBiYWNrdXAgPSBlbHQoInNwYW4iLCAieCIpOwogICAgICAgIGFuY2hvci5wYXJlbnROb2RlLmluc2VydEJlZm9yZShiYWNrdXAsIGFuY2hvci5uZXh0U2libGluZyk7CiAgICAgICAgdG9wID0gYmFja3VwLm9mZnNldFRvcDsKICAgICAgfQogICAgICByZXR1cm4ge3RvcDogdG9wLCBsZWZ0OiBsZWZ0fTsKICAgIH0KICAgIGZ1bmN0aW9uIGxvY2FsQ29vcmRzKHBvcywgaW5MaW5lV3JhcCkgewogICAgICB2YXIgeCwgbGggPSB0ZXh0SGVpZ2h0KCksIHkgPSBsaCAqIChoZWlnaHRBdExpbmUoZG9jLCBwb3MubGluZSkgLSAoaW5MaW5lV3JhcCA/IGRpc3BsYXlPZmZzZXQgOiAwKSk7CiAgICAgIGlmIChwb3MuY2ggPT0gMCkgeCA9IDA7CiAgICAgIGVsc2UgewogICAgICAgIHZhciBzcCA9IG1lYXN1cmVMaW5lKGdldExpbmUocG9zLmxpbmUpLCBwb3MuY2gpOwogICAgICAgIHggPSBzcC5sZWZ0OwogICAgICAgIGlmIChvcHRpb25zLmxpbmVXcmFwcGluZykgeSArPSBNYXRoLm1heCgwLCBzcC50b3ApOwogICAgICB9CiAgICAgIHJldHVybiB7eDogeCwgeTogeSwgeUJvdDogeSArIGxofTsKICAgIH0KICAgIC8vIENvb3JkcyBtdXN0IGJlIGxpbmVTcGFjZS1sb2NhbAogICAgZnVuY3Rpb24gY29vcmRzQ2hhcih4LCB5KSB7CiAgICAgIHZhciB0aCA9IHRleHRIZWlnaHQoKSwgY3cgPSBjaGFyV2lkdGgoKSwgaGVpZ2h0UG9zID0gZGlzcGxheU9mZnNldCArIE1hdGguZmxvb3IoeSAvIHRoKTsKICAgICAgaWYgKGhlaWdodFBvcyA8IDApIHJldHVybiB7bGluZTogMCwgY2g6IDB9OwogICAgICB2YXIgbGluZU5vID0gbGluZUF0SGVpZ2h0KGRvYywgaGVpZ2h0UG9zKTsKICAgICAgaWYgKGxpbmVObyA+PSBkb2Muc2l6ZSkgcmV0dXJuIHtsaW5lOiBkb2Muc2l6ZSAtIDEsIGNoOiBnZXRMaW5lKGRvYy5zaXplIC0gMSkudGV4dC5sZW5ndGh9OwogICAgICB2YXIgbGluZU9iaiA9IGdldExpbmUobGluZU5vKSwgdGV4dCA9IGxpbmVPYmoudGV4dDsKICAgICAgdmFyIHR3ID0gb3B0aW9ucy5saW5lV3JhcHBpbmcsIGlubmVyT2ZmID0gdHcgPyBoZWlnaHRQb3MgLSBoZWlnaHRBdExpbmUoZG9jLCBsaW5lTm8pIDogMDsKICAgICAgaWYgKHggPD0gMCAmJiBpbm5lck9mZiA9PSAwKSByZXR1cm4ge2xpbmU6IGxpbmVObywgY2g6IDB9OwogICAgICB2YXIgd3JvbmdMaW5lID0gZmFsc2U7CiAgICAgIGZ1bmN0aW9uIGdldFgobGVuKSB7CiAgICAgICAgdmFyIHNwID0gbWVhc3VyZUxpbmUobGluZU9iaiwgbGVuKTsKICAgICAgICBpZiAodHcpIHsKICAgICAgICAgIHZhciBvZmYgPSBNYXRoLnJvdW5kKHNwLnRvcCAvIHRoKTsKICAgICAgICAgIHdyb25nTGluZSA9IG9mZiAhPSBpbm5lck9mZjsKICAgICAgICAgIHJldHVybiBNYXRoLm1heCgwLCBzcC5sZWZ0ICsgKG9mZiAtIGlubmVyT2ZmKSAqIHNjcm9sbGVyLmNsaWVudFdpZHRoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNwLmxlZnQ7CiAgICAgIH0KICAgICAgdmFyIGZyb20gPSAwLCBmcm9tWCA9IDAsIHRvID0gdGV4dC5sZW5ndGgsIHRvWDsKICAgICAgLy8gR3Vlc3MgYSBzdWl0YWJsZSB1cHBlciBib3VuZCBmb3Igb3VyIHNlYXJjaC4KICAgICAgdmFyIGVzdGltYXRlZCA9IE1hdGgubWluKHRvLCBNYXRoLmNlaWwoKHggKyBpbm5lck9mZiAqIHNjcm9sbGVyLmNsaWVudFdpZHRoICogLjkpIC8gY3cpKTsKICAgICAgZm9yICg7OykgewogICAgICAgIHZhciBlc3RYID0gZ2V0WChlc3RpbWF0ZWQpOwogICAgICAgIGlmIChlc3RYIDw9IHggJiYgZXN0aW1hdGVkIDwgdG8pIGVzdGltYXRlZCA9IE1hdGgubWluKHRvLCBNYXRoLmNlaWwoZXN0aW1hdGVkICogMS4yKSk7CiAgICAgICAgZWxzZSB7dG9YID0gZXN0WDsgdG8gPSBlc3RpbWF0ZWQ7IGJyZWFrO30KICAgICAgfQogICAgICBpZiAoeCA+IHRvWCkgcmV0dXJuIHtsaW5lOiBsaW5lTm8sIGNoOiB0b307CiAgICAgIC8vIFRyeSB0byBndWVzcyBhIHN1aXRhYmxlIGxvd2VyIGJvdW5kIGFzIHdlbGwuCiAgICAgIGVzdGltYXRlZCA9IE1hdGguZmxvb3IodG8gKiAwLjgpOyBlc3RYID0gZ2V0WChlc3RpbWF0ZWQpOwogICAgICBpZiAoZXN0WCA8IHgpIHtmcm9tID0gZXN0aW1hdGVkOyBmcm9tWCA9IGVzdFg7fQogICAgICAvLyBEbyBhIGJpbmFyeSBzZWFyY2ggYmV0d2VlbiB0aGVzZSBib3VuZHMuCiAgICAgIGZvciAoOzspIHsKICAgICAgICBpZiAodG8gLSBmcm9tIDw9IDEpIHsKICAgICAgICAgIHZhciBhZnRlciA9IHggLSBmcm9tWCA8IHRvWCAtIHg7CiAgICAgICAgICByZXR1cm4ge2xpbmU6IGxpbmVObywgY2g6IGFmdGVyID8gZnJvbSA6IHRvLCBhZnRlcjogYWZ0ZXJ9OwogICAgICAgIH0KICAgICAgICB2YXIgbWlkZGxlID0gTWF0aC5jZWlsKChmcm9tICsgdG8pIC8gMiksIG1pZGRsZVggPSBnZXRYKG1pZGRsZSk7CiAgICAgICAgaWYgKG1pZGRsZVggPiB4KSB7dG8gPSBtaWRkbGU7IHRvWCA9IG1pZGRsZVg7IGlmICh3cm9uZ0xpbmUpIHRvWCArPSAxMDAwOyB9CiAgICAgICAgZWxzZSB7ZnJvbSA9IG1pZGRsZTsgZnJvbVggPSBtaWRkbGVYO30KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcGFnZUNvb3Jkcyhwb3MpIHsKICAgICAgdmFyIGxvY2FsID0gbG9jYWxDb29yZHMocG9zLCB0cnVlKSwgb2ZmID0gZWx0T2Zmc2V0KGxpbmVTcGFjZSk7CiAgICAgIHJldHVybiB7eDogb2ZmLmxlZnQgKyBsb2NhbC54LCB5OiBvZmYudG9wICsgbG9jYWwueSwgeUJvdDogb2ZmLnRvcCArIGxvY2FsLnlCb3R9OwogICAgfQoKICAgIHZhciBjYWNoZWRIZWlnaHQsIGNhY2hlZEhlaWdodEZvciwgbWVhc3VyZVByZTsKICAgIGZ1bmN0aW9uIHRleHRIZWlnaHQoKSB7CiAgICAgIGlmIChtZWFzdXJlUHJlID09IG51bGwpIHsKICAgICAgICBtZWFzdXJlUHJlID0gZWx0KCJwcmUiKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQ5OyArK2kpIHsKICAgICAgICAgIG1lYXN1cmVQcmUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIngiKSk7CiAgICAgICAgICBtZWFzdXJlUHJlLmFwcGVuZENoaWxkKGVsdCgiYnIiKSk7CiAgICAgICAgfQogICAgICAgIG1lYXN1cmVQcmUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIngiKSk7CiAgICAgIH0KICAgICAgdmFyIG9mZnNldEhlaWdodCA9IGxpbmVEaXYuY2xpZW50SGVpZ2h0OwogICAgICBpZiAob2Zmc2V0SGVpZ2h0ID09IGNhY2hlZEhlaWdodEZvcikgcmV0dXJuIGNhY2hlZEhlaWdodDsKICAgICAgY2FjaGVkSGVpZ2h0Rm9yID0gb2Zmc2V0SGVpZ2h0OwogICAgICByZW1vdmVDaGlsZHJlbkFuZEFkZChtZWFzdXJlLCBtZWFzdXJlUHJlLmNsb25lTm9kZSh0cnVlKSk7CiAgICAgIGNhY2hlZEhlaWdodCA9IG1lYXN1cmUuZmlyc3RDaGlsZC5vZmZzZXRIZWlnaHQgLyA1MCB8fCAxOwogICAgICByZW1vdmVDaGlsZHJlbihtZWFzdXJlKTsKICAgICAgcmV0dXJuIGNhY2hlZEhlaWdodDsKICAgIH0KICAgIHZhciBjYWNoZWRXaWR0aCwgY2FjaGVkV2lkdGhGb3IgPSAwOwogICAgZnVuY3Rpb24gY2hhcldpZHRoKCkgewogICAgICBpZiAoc2Nyb2xsZXIuY2xpZW50V2lkdGggPT0gY2FjaGVkV2lkdGhGb3IpIHJldHVybiBjYWNoZWRXaWR0aDsKICAgICAgY2FjaGVkV2lkdGhGb3IgPSBzY3JvbGxlci5jbGllbnRXaWR0aDsKICAgICAgdmFyIGFuY2hvciA9IGVsdCgic3BhbiIsICJ4Iik7CiAgICAgIHZhciBwcmUgPSBlbHQoInByZSIsIFthbmNob3JdKTsKICAgICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQobWVhc3VyZSwgcHJlKTsKICAgICAgcmV0dXJuIChjYWNoZWRXaWR0aCA9IGFuY2hvci5vZmZzZXRXaWR0aCB8fCAxMCk7CiAgICB9CiAgICBmdW5jdGlvbiBwYWRkaW5nVG9wKCkge3JldHVybiBsaW5lU3BhY2Uub2Zmc2V0VG9wO30KICAgIGZ1bmN0aW9uIHBhZGRpbmdMZWZ0KCkge3JldHVybiBsaW5lU3BhY2Uub2Zmc2V0TGVmdDt9CgogICAgZnVuY3Rpb24gcG9zRnJvbU1vdXNlKGUsIGxpYmVyYWwpIHsKICAgICAgdmFyIG9mZlcgPSBlbHRPZmZzZXQoc2Nyb2xsZXIsIHRydWUpLCB4LCB5OwogICAgICAvLyBGYWlscyB1bnByZWRpY3RhYmx5IG9uIElFWzY3XSB3aGVuIG1vdXNlIGlzIGRyYWdnZWQgYXJvdW5kIHF1aWNrbHkuCiAgICAgIHRyeSB7IHggPSBlLmNsaWVudFg7IHkgPSBlLmNsaWVudFk7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGw7IH0KICAgICAgLy8gVGhpcyBpcyBhIG1lc3Mgb2YgYSBoZXVyaXN0aWMgdG8gdHJ5IGFuZCBkZXRlcm1pbmUgd2hldGhlciBhCiAgICAgIC8vIHNjcm9sbC1iYXIgd2FzIGNsaWNrZWQgb3Igbm90LCBhbmQgdG8gcmV0dXJuIG51bGwgaWYgb25lIHdhcwogICAgICAvLyAoYW5kICFsaWJlcmFsKS4KICAgICAgaWYgKCFsaWJlcmFsICYmICh4IC0gb2ZmVy5sZWZ0ID4gc2Nyb2xsZXIuY2xpZW50V2lkdGggfHwgeSAtIG9mZlcudG9wID4gc2Nyb2xsZXIuY2xpZW50SGVpZ2h0KSkKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgdmFyIG9mZkwgPSBlbHRPZmZzZXQobGluZVNwYWNlLCB0cnVlKTsKICAgICAgcmV0dXJuIGNvb3Jkc0NoYXIoeCAtIG9mZkwubGVmdCwgeSAtIG9mZkwudG9wKTsKICAgIH0KICAgIHZhciBkZXRlY3RpbmdTZWxlY3RBbGw7CiAgICBmdW5jdGlvbiBvbkNvbnRleHRNZW51KGUpIHsKICAgICAgdmFyIHBvcyA9IHBvc0Zyb21Nb3VzZShlKSwgc2Nyb2xsUG9zID0gc2Nyb2xsYmFyLnNjcm9sbFRvcDsKICAgICAgaWYgKCFwb3MgfHwgb3BlcmEpIHJldHVybjsgLy8gT3BlcmEgaXMgZGlmZmljdWx0LgogICAgICBpZiAocG9zRXEoc2VsLmZyb20sIHNlbC50bykgfHwgcG9zTGVzcyhwb3MsIHNlbC5mcm9tKSB8fCAhcG9zTGVzcyhwb3MsIHNlbC50bykpCiAgICAgICAgb3BlcmF0aW9uKHNldEN1cnNvcikocG9zLmxpbmUsIHBvcy5jaCk7CgogICAgICB2YXIgb2xkQ1NTID0gaW5wdXQuc3R5bGUuY3NzVGV4dDsKICAgICAgaW5wdXREaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICBpbnB1dC5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOiBmaXhlZDsgd2lkdGg6IDMwcHg7IGhlaWdodDogMzBweDsgdG9wOiAiICsgKGUuY2xpZW50WSAtIDUpICsKICAgICAgICAicHg7IGxlZnQ6ICIgKyAoZS5jbGllbnRYIC0gNSkgKyAicHg7IHotaW5kZXg6IDEwMDA7IGJhY2tncm91bmQ6IHdoaXRlOyAiICsKICAgICAgICAiYm9yZGVyLXdpZHRoOiAwOyBvdXRsaW5lOiBub25lOyBvdmVyZmxvdzogaGlkZGVuOyBvcGFjaXR5OiAuMDU7IGZpbHRlcjogYWxwaGEob3BhY2l0eT01KTsiOwogICAgICBmb2N1c0lucHV0KCk7CiAgICAgIHJlc2V0SW5wdXQodHJ1ZSk7CiAgICAgIC8vIEFkZHMgIlNlbGVjdCBhbGwiIHRvIGNvbnRleHQgbWVudSBpbiBGRgogICAgICBpZiAocG9zRXEoc2VsLmZyb20sIHNlbC50bykpIGlucHV0LnZhbHVlID0gcHJldklucHV0ID0gIiAiOwoKICAgICAgZnVuY3Rpb24gcmVoaWRlKCkgewogICAgICAgIGlucHV0RGl2LnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICBpbnB1dC5zdHlsZS5jc3NUZXh0ID0gb2xkQ1NTOwogICAgICAgIGlmIChpZV9sdDkpIHNjcm9sbGJhci5zY3JvbGxUb3AgPSBzY3JvbGxQb3M7CiAgICAgICAgc2xvd1BvbGwoKTsKCiAgICAgICAgLy8gVHJ5IHRvIGRldGVjdCB0aGUgdXNlciBjaG9vc2luZyBzZWxlY3QtYWxsIAogICAgICAgIGlmIChpbnB1dC5zZWxlY3Rpb25TdGFydCAhPSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoZGV0ZWN0aW5nU2VsZWN0QWxsKTsKICAgICAgICAgIHZhciBleHR2YWwgPSBpbnB1dC52YWx1ZSA9ICIgIiArIChwb3NFcShzZWwuZnJvbSwgc2VsLnRvKSA/ICIiIDogaW5wdXQudmFsdWUpLCBpID0gMDsKICAgICAgICAgIHByZXZJbnB1dCA9ICIgIjsKICAgICAgICAgIGlucHV0LnNlbGVjdGlvblN0YXJ0ID0gMTsgaW5wdXQuc2VsZWN0aW9uRW5kID0gZXh0dmFsLmxlbmd0aDsKICAgICAgICAgIGRldGVjdGluZ1NlbGVjdEFsbCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gcG9sbCgpewogICAgICAgICAgICBpZiAocHJldklucHV0ID09ICIgIiAmJiBpbnB1dC5zZWxlY3Rpb25TdGFydCA9PSAwKQogICAgICAgICAgICAgIG9wZXJhdGlvbihjb21tYW5kcy5zZWxlY3RBbGwpKGluc3RhbmNlKTsKICAgICAgICAgICAgZWxzZSBpZiAoaSsrIDwgMTApIGRldGVjdGluZ1NlbGVjdEFsbCA9IHNldFRpbWVvdXQocG9sbCwgNTAwKTsKICAgICAgICAgICAgZWxzZSByZXNldElucHV0KCk7CiAgICAgICAgICB9LCAyMDApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGdlY2tvKSB7CiAgICAgICAgZV9zdG9wKGUpOwogICAgICAgIHZhciBtb3VzZXVwID0gY29ubmVjdCh3aW5kb3csICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBtb3VzZXVwKCk7CiAgICAgICAgICBzZXRUaW1lb3V0KHJlaGlkZSwgMjApOwogICAgICAgIH0sIHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFRpbWVvdXQocmVoaWRlLCA1MCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBDdXJzb3ItYmxpbmtpbmcKICAgIGZ1bmN0aW9uIHJlc3RhcnRCbGluaygpIHsKICAgICAgY2xlYXJJbnRlcnZhbChibGlua2VyKTsKICAgICAgdmFyIG9uID0gdHJ1ZTsKICAgICAgY3Vyc29yLnN0eWxlLnZpc2liaWxpdHkgPSAiIjsKICAgICAgYmxpbmtlciA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgIGN1cnNvci5zdHlsZS52aXNpYmlsaXR5ID0gKG9uID0gIW9uKSA/ICIiIDogImhpZGRlbiI7CiAgICAgIH0sIG9wdGlvbnMuY3Vyc29yQmxpbmtSYXRlKTsKICAgIH0KCiAgICB2YXIgbWF0Y2hpbmcgPSB7IigiOiAiKT4iLCAiKSI6ICIoPCIsICJbIjogIl0+IiwgIl0iOiAiWzwiLCAieyI6ICJ9PiIsICJ9IjogIns8In07CiAgICBmdW5jdGlvbiBtYXRjaEJyYWNrZXRzKGF1dG9jbGVhcikgewogICAgICB2YXIgaGVhZCA9IHNlbC5pbnZlcnRlZCA/IHNlbC5mcm9tIDogc2VsLnRvLCBsaW5lID0gZ2V0TGluZShoZWFkLmxpbmUpLCBwb3MgPSBoZWFkLmNoIC0gMTsKICAgICAgdmFyIG1hdGNoID0gKHBvcyA+PSAwICYmIG1hdGNoaW5nW2xpbmUudGV4dC5jaGFyQXQocG9zKV0pIHx8IG1hdGNoaW5nW2xpbmUudGV4dC5jaGFyQXQoKytwb3MpXTsKICAgICAgaWYgKCFtYXRjaCkgcmV0dXJuOwogICAgICB2YXIgY2ggPSBtYXRjaC5jaGFyQXQoMCksIGZvcndhcmQgPSBtYXRjaC5jaGFyQXQoMSkgPT0gIj4iLCBkID0gZm9yd2FyZCA/IDEgOiAtMSwgc3QgPSBsaW5lLnN0eWxlczsKICAgICAgZm9yICh2YXIgb2ZmID0gcG9zICsgMSwgaSA9IDAsIGUgPSBzdC5sZW5ndGg7IGkgPCBlOyBpKz0yKQogICAgICAgIGlmICgob2ZmIC09IHN0W2ldLmxlbmd0aCkgPD0gMCkge3ZhciBzdHlsZSA9IHN0W2krMV07IGJyZWFrO30KCiAgICAgIHZhciBzdGFjayA9IFtsaW5lLnRleHQuY2hhckF0KHBvcyldLCByZSA9IC9bKCl7fVtcXV0vOwogICAgICBmdW5jdGlvbiBzY2FuKGxpbmUsIGZyb20sIHRvKSB7CiAgICAgICAgaWYgKCFsaW5lLnRleHQpIHJldHVybjsKICAgICAgICB2YXIgc3QgPSBsaW5lLnN0eWxlcywgcG9zID0gZm9yd2FyZCA/IDAgOiBsaW5lLnRleHQubGVuZ3RoIC0gMSwgY3VyOwogICAgICAgIGZvciAodmFyIGkgPSBmb3J3YXJkID8gMCA6IHN0Lmxlbmd0aCAtIDIsIGUgPSBmb3J3YXJkID8gc3QubGVuZ3RoIDogLTI7IGkgIT0gZTsgaSArPSAyKmQpIHsKICAgICAgICAgIHZhciB0ZXh0ID0gc3RbaV07CiAgICAgICAgICBpZiAoc3RbaSsxXSAhPSBzdHlsZSkge3BvcyArPSBkICogdGV4dC5sZW5ndGg7IGNvbnRpbnVlO30KICAgICAgICAgIGZvciAodmFyIGogPSBmb3J3YXJkID8gMCA6IHRleHQubGVuZ3RoIC0gMSwgdGUgPSBmb3J3YXJkID8gdGV4dC5sZW5ndGggOiAtMTsgaiAhPSB0ZTsgaiArPSBkLCBwb3MrPWQpIHsKICAgICAgICAgICAgaWYgKHBvcyA+PSBmcm9tICYmIHBvcyA8IHRvICYmIHJlLnRlc3QoY3VyID0gdGV4dC5jaGFyQXQoaikpKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hpbmdbY3VyXTsKICAgICAgICAgICAgICBpZiAobWF0Y2guY2hhckF0KDEpID09ICI+IiA9PSBmb3J3YXJkKSBzdGFjay5wdXNoKGN1cik7CiAgICAgICAgICAgICAgZWxzZSBpZiAoc3RhY2sucG9wKCkgIT0gbWF0Y2guY2hhckF0KDApKSByZXR1cm4ge3BvczogcG9zLCBtYXRjaDogZmFsc2V9OwogICAgICAgICAgICAgIGVsc2UgaWYgKCFzdGFjay5sZW5ndGgpIHJldHVybiB7cG9zOiBwb3MsIG1hdGNoOiB0cnVlfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciBpID0gaGVhZC5saW5lLCBlID0gZm9yd2FyZCA/IE1hdGgubWluKGkgKyAxMDAsIGRvYy5zaXplKSA6IE1hdGgubWF4KC0xLCBpIC0gMTAwKTsgaSAhPSBlOyBpKz1kKSB7CiAgICAgICAgdmFyIGxpbmUgPSBnZXRMaW5lKGkpLCBmaXJzdCA9IGkgPT0gaGVhZC5saW5lOwogICAgICAgIHZhciBmb3VuZCA9IHNjYW4obGluZSwgZmlyc3QgJiYgZm9yd2FyZCA/IHBvcyArIDEgOiAwLCBmaXJzdCAmJiAhZm9yd2FyZCA/IHBvcyA6IGxpbmUudGV4dC5sZW5ndGgpOwogICAgICAgIGlmIChmb3VuZCkgYnJlYWs7CiAgICAgIH0KICAgICAgaWYgKCFmb3VuZCkgZm91bmQgPSB7cG9zOiBudWxsLCBtYXRjaDogZmFsc2V9OwogICAgICB2YXIgc3R5bGUgPSBmb3VuZC5tYXRjaCA/ICJDb2RlTWlycm9yLW1hdGNoaW5nYnJhY2tldCIgOiAiQ29kZU1pcnJvci1ub25tYXRjaGluZ2JyYWNrZXQiOwogICAgICB2YXIgb25lID0gbWFya1RleHQoe2xpbmU6IGhlYWQubGluZSwgY2g6IHBvc30sIHtsaW5lOiBoZWFkLmxpbmUsIGNoOiBwb3MrMX0sIHN0eWxlKSwKICAgICAgICAgIHR3byA9IGZvdW5kLnBvcyAhPSBudWxsICYmIG1hcmtUZXh0KHtsaW5lOiBpLCBjaDogZm91bmQucG9zfSwge2xpbmU6IGksIGNoOiBmb3VuZC5wb3MgKyAxfSwgc3R5bGUpOwogICAgICB2YXIgY2xlYXIgPSBvcGVyYXRpb24oZnVuY3Rpb24oKXtvbmUuY2xlYXIoKTsgdHdvICYmIHR3by5jbGVhcigpO30pOwogICAgICBpZiAoYXV0b2NsZWFyKSBzZXRUaW1lb3V0KGNsZWFyLCA4MDApOwogICAgICBlbHNlIGJyYWNrZXRIaWdobGlnaHRlZCA9IGNsZWFyOwogICAgfQoKICAgIC8vIEZpbmRzIHRoZSBsaW5lIHRvIHN0YXJ0IHdpdGggd2hlbiBzdGFydGluZyBhIHBhcnNlLiBUcmllcyB0bwogICAgLy8gZmluZCBhIGxpbmUgd2l0aCBhIHN0YXRlQWZ0ZXIsIHNvIHRoYXQgaXQgY2FuIHN0YXJ0IHdpdGggYQogICAgLy8gdmFsaWQgc3RhdGUuIElmIHRoYXQgZmFpbHMsIGl0IHJldHVybnMgdGhlIGxpbmUgd2l0aCB0aGUKICAgIC8vIHNtYWxsZXN0IGluZGVudGF0aW9uLCB3aGljaCB0ZW5kcyB0byBuZWVkIHRoZSBsZWFzdCBjb250ZXh0IHRvCiAgICAvLyBwYXJzZSBjb3JyZWN0bHkuCiAgICBmdW5jdGlvbiBmaW5kU3RhcnRMaW5lKG4pIHsKICAgICAgdmFyIG1pbmluZGVudCwgbWlubGluZTsKICAgICAgZm9yICh2YXIgc2VhcmNoID0gbiwgbGltID0gbiAtIDQwOyBzZWFyY2ggPiBsaW07IC0tc2VhcmNoKSB7CiAgICAgICAgaWYgKHNlYXJjaCA9PSAwKSByZXR1cm4gMDsKICAgICAgICB2YXIgbGluZSA9IGdldExpbmUoc2VhcmNoLTEpOwogICAgICAgIGlmIChsaW5lLnN0YXRlQWZ0ZXIpIHJldHVybiBzZWFyY2g7CiAgICAgICAgdmFyIGluZGVudGVkID0gbGluZS5pbmRlbnRhdGlvbihvcHRpb25zLnRhYlNpemUpOwogICAgICAgIGlmIChtaW5saW5lID09IG51bGwgfHwgbWluaW5kZW50ID4gaW5kZW50ZWQpIHsKICAgICAgICAgIG1pbmxpbmUgPSBzZWFyY2ggLSAxOwogICAgICAgICAgbWluaW5kZW50ID0gaW5kZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtaW5saW5lOwogICAgfQogICAgZnVuY3Rpb24gZ2V0U3RhdGVCZWZvcmUobikgewogICAgICB2YXIgcG9zID0gZmluZFN0YXJ0TGluZShuKSwgc3RhdGUgPSBwb3MgJiYgZ2V0TGluZShwb3MtMSkuc3RhdGVBZnRlcjsKICAgICAgaWYgKCFzdGF0ZSkgc3RhdGUgPSBzdGFydFN0YXRlKG1vZGUpOwogICAgICBlbHNlIHN0YXRlID0gY29weVN0YXRlKG1vZGUsIHN0YXRlKTsKICAgICAgZG9jLml0ZXIocG9zLCBuLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgbGluZS5wcm9jZXNzKG1vZGUsIHN0YXRlLCBvcHRpb25zLnRhYlNpemUpOwogICAgICAgIGxpbmUuc3RhdGVBZnRlciA9IChwb3MgPT0gbiAtIDEgfHwgcG9zICUgNSA9PSAwKSA/IGNvcHlTdGF0ZShtb2RlLCBzdGF0ZSkgOiBudWxsOwogICAgICB9KTsKICAgICAgcmV0dXJuIHN0YXRlOwogICAgfQogICAgZnVuY3Rpb24gaGlnaGxpZ2h0V29ya2VyKCkgewogICAgICBpZiAoZnJvbnRpZXIgPj0gc2hvd2luZ1RvKSByZXR1cm47CiAgICAgIHZhciBlbmQgPSArbmV3IERhdGUgKyBvcHRpb25zLndvcmtUaW1lLCBzdGF0ZSA9IGNvcHlTdGF0ZShtb2RlLCBnZXRTdGF0ZUJlZm9yZShmcm9udGllcikpOwogICAgICB2YXIgc3RhcnRGcm9udGllciA9IGZyb250aWVyOwogICAgICBkb2MuaXRlcihmcm9udGllciwgc2hvd2luZ1RvLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgaWYgKGZyb250aWVyID49IHNob3dpbmdGcm9tKSB7IC8vIFZpc2libGUKICAgICAgICAgIGxpbmUuaGlnaGxpZ2h0KG1vZGUsIHN0YXRlLCBvcHRpb25zLnRhYlNpemUpOwogICAgICAgICAgbGluZS5zdGF0ZUFmdGVyID0gY29weVN0YXRlKG1vZGUsIHN0YXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGluZS5wcm9jZXNzKG1vZGUsIHN0YXRlLCBvcHRpb25zLnRhYlNpemUpOwogICAgICAgICAgbGluZS5zdGF0ZUFmdGVyID0gZnJvbnRpZXIgJSA1ID09IDAgPyBjb3B5U3RhdGUobW9kZSwgc3RhdGUpIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgKytmcm9udGllcjsKICAgICAgICBpZiAoK25ldyBEYXRlID4gZW5kKSB7CiAgICAgICAgICBzdGFydFdvcmtlcihvcHRpb25zLndvcmtEZWxheSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAoc2hvd2luZ1RvID4gc3RhcnRGcm9udGllciAmJiBmcm9udGllciA+PSBzaG93aW5nRnJvbSkKICAgICAgICBvcGVyYXRpb24oZnVuY3Rpb24oKSB7Y2hhbmdlcy5wdXNoKHtmcm9tOiBzdGFydEZyb250aWVyLCB0bzogZnJvbnRpZXJ9KTt9KSgpOwogICAgfQogICAgZnVuY3Rpb24gc3RhcnRXb3JrZXIodGltZSkgewogICAgICBpZiAoZnJvbnRpZXIgPCBzaG93aW5nVG8pCiAgICAgICAgaGlnaGxpZ2h0LnNldCh0aW1lLCBoaWdobGlnaHRXb3JrZXIpOwogICAgfQoKICAgIC8vIE9wZXJhdGlvbnMgYXJlIHVzZWQgdG8gd3JhcCBjaGFuZ2VzIGluIHN1Y2ggYSB3YXkgdGhhdCBlYWNoCiAgICAvLyBjaGFuZ2Ugd29uJ3QgaGF2ZSB0byB1cGRhdGUgdGhlIGN1cnNvciBhbmQgZGlzcGxheSAod2hpY2ggd291bGQKICAgIC8vIGJlIGF3a3dhcmQsIHNsb3csIGFuZCBlcnJvci1wcm9uZSksIGJ1dCBpbnN0ZWFkIHVwZGF0ZXMgYXJlCiAgICAvLyBiYXRjaGVkIGFuZCB0aGVuIGFsbCBjb21iaW5lZCBhbmQgZXhlY3V0ZWQgYXQgb25jZS4KICAgIGZ1bmN0aW9uIHN0YXJ0T3BlcmF0aW9uKCkgewogICAgICB1cGRhdGVJbnB1dCA9IHVzZXJTZWxDaGFuZ2UgPSB0ZXh0Q2hhbmdlZCA9IG51bGw7CiAgICAgIGNoYW5nZXMgPSBbXTsgc2VsZWN0aW9uQ2hhbmdlZCA9IGZhbHNlOyBjYWxsYmFja3MgPSBbXTsKICAgIH0KICAgIGZ1bmN0aW9uIGVuZE9wZXJhdGlvbigpIHsKICAgICAgaWYgKHVwZGF0ZU1heExpbmUpIGNvbXB1dGVNYXhMZW5ndGgoKTsKICAgICAgaWYgKG1heExpbmVDaGFuZ2VkICYmICFvcHRpb25zLmxpbmVXcmFwcGluZykgewogICAgICAgIHZhciBjdXJzb3JXaWR0aCA9IHdpZHRoRm9yY2VyLm9mZnNldFdpZHRoLCBsZWZ0ID0gbWVhc3VyZUxpbmUobWF4TGluZSwgbWF4TGluZS50ZXh0Lmxlbmd0aCkubGVmdDsKICAgICAgICBpZiAoIWllX2x0OCkgewogICAgICAgICAgd2lkdGhGb3JjZXIuc3R5bGUubGVmdCA9IGxlZnQgKyAicHgiOwogICAgICAgICAgbGluZVNwYWNlLnN0eWxlLm1pbldpZHRoID0gKGxlZnQgKyBjdXJzb3JXaWR0aCkgKyAicHgiOwogICAgICAgIH0KICAgICAgICBtYXhMaW5lQ2hhbmdlZCA9IGZhbHNlOwogICAgICB9CiAgICAgIHZhciBuZXdTY3JvbGxQb3MsIHVwZGF0ZWQ7CiAgICAgIGlmIChzZWxlY3Rpb25DaGFuZ2VkKSB7CiAgICAgICAgdmFyIGNvb3JkcyA9IGNhbGN1bGF0ZUN1cnNvckNvb3JkcygpOwogICAgICAgIG5ld1Njcm9sbFBvcyA9IGNhbGN1bGF0ZVNjcm9sbFBvcyhjb29yZHMueCwgY29vcmRzLnksIGNvb3Jkcy54LCBjb29yZHMueUJvdCk7CiAgICAgIH0KICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoIHx8IG5ld1Njcm9sbFBvcyAmJiBuZXdTY3JvbGxQb3Muc2Nyb2xsVG9wICE9IG51bGwpCiAgICAgICAgdXBkYXRlZCA9IHVwZGF0ZURpc3BsYXkoY2hhbmdlcywgdHJ1ZSwgbmV3U2Nyb2xsUG9zICYmIG5ld1Njcm9sbFBvcy5zY3JvbGxUb3ApOwogICAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgICBpZiAoc2VsZWN0aW9uQ2hhbmdlZCkgdXBkYXRlU2VsZWN0aW9uKCk7CiAgICAgICAgaWYgKGd1dHRlckRpcnR5KSB1cGRhdGVHdXR0ZXIoKTsKICAgICAgfQogICAgICBpZiAobmV3U2Nyb2xsUG9zKSBzY3JvbGxDdXJzb3JJbnRvVmlldygpOwogICAgICBpZiAoc2VsZWN0aW9uQ2hhbmdlZCkgcmVzdGFydEJsaW5rKCk7CgogICAgICBpZiAoZm9jdXNlZCAmJiAodXBkYXRlSW5wdXQgPT09IHRydWUgfHwgKHVwZGF0ZUlucHV0ICE9PSBmYWxzZSAmJiBzZWxlY3Rpb25DaGFuZ2VkKSkpCiAgICAgICAgcmVzZXRJbnB1dCh1c2VyU2VsQ2hhbmdlKTsKCiAgICAgIGlmIChzZWxlY3Rpb25DaGFuZ2VkICYmIG9wdGlvbnMubWF0Y2hCcmFja2V0cykKICAgICAgICBzZXRUaW1lb3V0KG9wZXJhdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChicmFja2V0SGlnaGxpZ2h0ZWQpIHticmFja2V0SGlnaGxpZ2h0ZWQoKTsgYnJhY2tldEhpZ2hsaWdodGVkID0gbnVsbDt9CiAgICAgICAgICBpZiAocG9zRXEoc2VsLmZyb20sIHNlbC50bykpIG1hdGNoQnJhY2tldHMoZmFsc2UpOwogICAgICAgIH0pLCAyMCk7CiAgICAgIHZhciBzYyA9IHNlbGVjdGlvbkNoYW5nZWQsIGNicyA9IGNhbGxiYWNrczsgLy8gdGhlc2UgY2FuIGJlIHJlc2V0IGJ5IGNhbGxiYWNrcwogICAgICBpZiAodGV4dENoYW5nZWQgJiYgb3B0aW9ucy5vbkNoYW5nZSAmJiBpbnN0YW5jZSkKICAgICAgICBvcHRpb25zLm9uQ2hhbmdlKGluc3RhbmNlLCB0ZXh0Q2hhbmdlZCk7CiAgICAgIGlmIChzYyAmJiBvcHRpb25zLm9uQ3Vyc29yQWN0aXZpdHkpCiAgICAgICAgb3B0aW9ucy5vbkN1cnNvckFjdGl2aXR5KGluc3RhbmNlKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYnMubGVuZ3RoOyArK2kpIGNic1tpXShpbnN0YW5jZSk7CiAgICAgIGlmICh1cGRhdGVkICYmIG9wdGlvbnMub25VcGRhdGUpIG9wdGlvbnMub25VcGRhdGUoaW5zdGFuY2UpOwogICAgfQogICAgdmFyIG5lc3RlZE9wZXJhdGlvbiA9IDA7CiAgICBmdW5jdGlvbiBvcGVyYXRpb24oZikgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFuZXN0ZWRPcGVyYXRpb24rKykgc3RhcnRPcGVyYXRpb24oKTsKICAgICAgICB0cnkge3ZhciByZXN1bHQgPSBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7fQogICAgICAgIGZpbmFsbHkge2lmICghLS1uZXN0ZWRPcGVyYXRpb24pIGVuZE9wZXJhdGlvbigpO30KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXBvdW5kQ2hhbmdlKGYpIHsKICAgICAgaGlzdG9yeS5zdGFydENvbXBvdW5kKCk7CiAgICAgIHRyeSB7IHJldHVybiBmKCk7IH0gZmluYWxseSB7IGhpc3RvcnkuZW5kQ29tcG91bmQoKTsgfQogICAgfQoKICAgIGZvciAodmFyIGV4dCBpbiBleHRlbnNpb25zKQogICAgICBpZiAoZXh0ZW5zaW9ucy5wcm9wZXJ0eUlzRW51bWVyYWJsZShleHQpICYmCiAgICAgICAgICAhaW5zdGFuY2UucHJvcGVydHlJc0VudW1lcmFibGUoZXh0KSkKICAgICAgICBpbnN0YW5jZVtleHRdID0gZXh0ZW5zaW9uc1tleHRdOwogICAgcmV0dXJuIGluc3RhbmNlOwogIH0gLy8gKGVuZCBvZiBmdW5jdGlvbiBDb2RlTWlycm9yKQoKICAvLyBUaGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIG9wdGlvbnMuCiAgQ29kZU1pcnJvci5kZWZhdWx0cyA9IHsKICAgIHZhbHVlOiAiIiwKICAgIG1vZGU6IG51bGwsCiAgICB0aGVtZTogImRlZmF1bHQiLAogICAgaW5kZW50VW5pdDogMiwKICAgIGluZGVudFdpdGhUYWJzOiBmYWxzZSwKICAgIHNtYXJ0SW5kZW50OiB0cnVlLAogICAgdGFiU2l6ZTogNCwKICAgIGtleU1hcDogImRlZmF1bHQiLAogICAgZXh0cmFLZXlzOiBudWxsLAogICAgZWxlY3RyaWNDaGFyczogdHJ1ZSwKICAgIGF1dG9DbGVhckVtcHR5TGluZXM6IGZhbHNlLAogICAgb25LZXlFdmVudDogbnVsbCwKICAgIG9uRHJhZ0V2ZW50OiBudWxsLAogICAgbGluZVdyYXBwaW5nOiBmYWxzZSwKICAgIGxpbmVOdW1iZXJzOiBmYWxzZSwKICAgIGd1dHRlcjogZmFsc2UsCiAgICBmaXhlZEd1dHRlcjogZmFsc2UsCiAgICBmaXJzdExpbmVOdW1iZXI6IDEsCiAgICByZWFkT25seTogZmFsc2UsCiAgICBkcmFnRHJvcDogdHJ1ZSwKICAgIG9uQ2hhbmdlOiBudWxsLAogICAgb25DdXJzb3JBY3Rpdml0eTogbnVsbCwKICAgIG9uVmlld3BvcnRDaGFuZ2U6IG51bGwsCiAgICBvbkd1dHRlckNsaWNrOiBudWxsLAogICAgb25VcGRhdGU6IG51bGwsCiAgICBvbkZvY3VzOiBudWxsLCBvbkJsdXI6IG51bGwsIG9uU2Nyb2xsOiBudWxsLAogICAgbWF0Y2hCcmFja2V0czogZmFsc2UsCiAgICBjdXJzb3JCbGlua1JhdGU6IDUzMCwKICAgIHdvcmtUaW1lOiAxMDAsCiAgICB3b3JrRGVsYXk6IDIwMCwKICAgIHBvbGxJbnRlcnZhbDogMTAwLAogICAgdW5kb0RlcHRoOiA0MCwKICAgIHRhYmluZGV4OiBudWxsLAogICAgYXV0b2ZvY3VzOiBudWxsLAogICAgbGluZU51bWJlckZvcm1hdHRlcjogZnVuY3Rpb24oaW50ZWdlcikgeyByZXR1cm4gaW50ZWdlcjsgfQogIH07CgogIHZhciBpb3MgPSAvQXBwbGVXZWJLaXQvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkgJiYgL01vYmlsZVwvXHcrLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBtYWMgPSBpb3MgfHwgL01hYy8udGVzdChuYXZpZ2F0b3IucGxhdGZvcm0pOwogIHZhciB3aW4gPSAvV2luLy50ZXN0KG5hdmlnYXRvci5wbGF0Zm9ybSk7CgogIC8vIEtub3duIG1vZGVzLCBieSBuYW1lIGFuZCBieSBNSU1FCiAgdmFyIG1vZGVzID0gQ29kZU1pcnJvci5tb2RlcyA9IHt9LCBtaW1lTW9kZXMgPSBDb2RlTWlycm9yLm1pbWVNb2RlcyA9IHt9OwogIENvZGVNaXJyb3IuZGVmaW5lTW9kZSA9IGZ1bmN0aW9uKG5hbWUsIG1vZGUpIHsKICAgIGlmICghQ29kZU1pcnJvci5kZWZhdWx0cy5tb2RlICYmIG5hbWUgIT0gIm51bGwiKSBDb2RlTWlycm9yLmRlZmF1bHRzLm1vZGUgPSBuYW1lOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7CiAgICAgIG1vZGUuZGVwZW5kZW5jaWVzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSBtb2RlLmRlcGVuZGVuY2llcy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICB9CiAgICBtb2Rlc1tuYW1lXSA9IG1vZGU7CiAgfTsKICBDb2RlTWlycm9yLmRlZmluZU1JTUUgPSBmdW5jdGlvbihtaW1lLCBzcGVjKSB7CiAgICBtaW1lTW9kZXNbbWltZV0gPSBzcGVjOwogIH07CiAgQ29kZU1pcnJvci5yZXNvbHZlTW9kZSA9IGZ1bmN0aW9uKHNwZWMpIHsKICAgIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIiAmJiBtaW1lTW9kZXMuaGFzT3duUHJvcGVydHkoc3BlYykpCiAgICAgIHNwZWMgPSBtaW1lTW9kZXNbc3BlY107CiAgICBlbHNlIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIiAmJiAvXltcd1wtXStcL1tcd1wtXStcK3htbCQvLnRlc3Qoc3BlYykpCiAgICAgIHJldHVybiBDb2RlTWlycm9yLnJlc29sdmVNb2RlKCJhcHBsaWNhdGlvbi94bWwiKTsKICAgIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIikgcmV0dXJuIHtuYW1lOiBzcGVjfTsKICAgIGVsc2UgcmV0dXJuIHNwZWMgfHwge25hbWU6ICJudWxsIn07CiAgfTsKICBDb2RlTWlycm9yLmdldE1vZGUgPSBmdW5jdGlvbihvcHRpb25zLCBzcGVjKSB7CiAgICB2YXIgc3BlYyA9IENvZGVNaXJyb3IucmVzb2x2ZU1vZGUoc3BlYyk7CiAgICB2YXIgbWZhY3RvcnkgPSBtb2Rlc1tzcGVjLm5hbWVdOwogICAgaWYgKCFtZmFjdG9yeSkgcmV0dXJuIENvZGVNaXJyb3IuZ2V0TW9kZShvcHRpb25zLCAidGV4dC9wbGFpbiIpOwogICAgdmFyIG1vZGVPYmogPSBtZmFjdG9yeShvcHRpb25zLCBzcGVjKTsKICAgIGlmIChtb2RlRXh0ZW5zaW9ucy5oYXNPd25Qcm9wZXJ0eShzcGVjLm5hbWUpKSB7CiAgICAgIHZhciBleHRzID0gbW9kZUV4dGVuc2lvbnNbc3BlYy5uYW1lXTsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBleHRzKSBpZiAoZXh0cy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgbW9kZU9ialtwcm9wXSA9IGV4dHNbcHJvcF07CiAgICB9CiAgICBtb2RlT2JqLm5hbWUgPSBzcGVjLm5hbWU7CiAgICByZXR1cm4gbW9kZU9iajsKICB9OwogIENvZGVNaXJyb3IubGlzdE1vZGVzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbGlzdCA9IFtdOwogICAgZm9yICh2YXIgbSBpbiBtb2RlcykKICAgICAgaWYgKG1vZGVzLnByb3BlcnR5SXNFbnVtZXJhYmxlKG0pKSBsaXN0LnB1c2gobSk7CiAgICByZXR1cm4gbGlzdDsKICB9OwogIENvZGVNaXJyb3IubGlzdE1JTUVzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbGlzdCA9IFtdOwogICAgZm9yICh2YXIgbSBpbiBtaW1lTW9kZXMpCiAgICAgIGlmIChtaW1lTW9kZXMucHJvcGVydHlJc0VudW1lcmFibGUobSkpIGxpc3QucHVzaCh7bWltZTogbSwgbW9kZTogbWltZU1vZGVzW21dfSk7CiAgICByZXR1cm4gbGlzdDsKICB9OwoKICB2YXIgZXh0ZW5zaW9ucyA9IENvZGVNaXJyb3IuZXh0ZW5zaW9ucyA9IHt9OwogIENvZGVNaXJyb3IuZGVmaW5lRXh0ZW5zaW9uID0gZnVuY3Rpb24obmFtZSwgZnVuYykgewogICAgZXh0ZW5zaW9uc1tuYW1lXSA9IGZ1bmM7CiAgfTsKCiAgdmFyIG1vZGVFeHRlbnNpb25zID0gQ29kZU1pcnJvci5tb2RlRXh0ZW5zaW9ucyA9IHt9OwogIENvZGVNaXJyb3IuZXh0ZW5kTW9kZSA9IGZ1bmN0aW9uKG1vZGUsIHByb3BlcnRpZXMpIHsKICAgIHZhciBleHRzID0gbW9kZUV4dGVuc2lvbnMuaGFzT3duUHJvcGVydHkobW9kZSkgPyBtb2RlRXh0ZW5zaW9uc1ttb2RlXSA6IChtb2RlRXh0ZW5zaW9uc1ttb2RlXSA9IHt9KTsKICAgIGZvciAodmFyIHByb3AgaW4gcHJvcGVydGllcykgaWYgKHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkocHJvcCkpCiAgICAgIGV4dHNbcHJvcF0gPSBwcm9wZXJ0aWVzW3Byb3BdOwogIH07CgogIHZhciBjb21tYW5kcyA9IENvZGVNaXJyb3IuY29tbWFuZHMgPSB7CiAgICBzZWxlY3RBbGw6IGZ1bmN0aW9uKGNtKSB7Y20uc2V0U2VsZWN0aW9uKHtsaW5lOiAwLCBjaDogMH0sIHtsaW5lOiBjbS5saW5lQ291bnQoKSAtIDF9KTt9LAogICAga2lsbExpbmU6IGZ1bmN0aW9uKGNtKSB7CiAgICAgIHZhciBmcm9tID0gY20uZ2V0Q3Vyc29yKHRydWUpLCB0byA9IGNtLmdldEN1cnNvcihmYWxzZSksIHNlbCA9ICFwb3NFcShmcm9tLCB0byk7CiAgICAgIGlmICghc2VsICYmIGNtLmdldExpbmUoZnJvbS5saW5lKS5sZW5ndGggPT0gZnJvbS5jaCkgY20ucmVwbGFjZVJhbmdlKCIiLCBmcm9tLCB7bGluZTogZnJvbS5saW5lICsgMSwgY2g6IDB9KTsKICAgICAgZWxzZSBjbS5yZXBsYWNlUmFuZ2UoIiIsIGZyb20sIHNlbCA/IHRvIDoge2xpbmU6IGZyb20ubGluZX0pOwogICAgfSwKICAgIGRlbGV0ZUxpbmU6IGZ1bmN0aW9uKGNtKSB7dmFyIGwgPSBjbS5nZXRDdXJzb3IoKS5saW5lOyBjbS5yZXBsYWNlUmFuZ2UoIiIsIHtsaW5lOiBsLCBjaDogMH0sIHtsaW5lOiBsfSk7fSwKICAgIHVuZG86IGZ1bmN0aW9uKGNtKSB7Y20udW5kbygpO30sCiAgICByZWRvOiBmdW5jdGlvbihjbSkge2NtLnJlZG8oKTt9LAogICAgZ29Eb2NTdGFydDogZnVuY3Rpb24oY20pIHtjbS5zZXRDdXJzb3IoMCwgMCwgdHJ1ZSk7fSwKICAgIGdvRG9jRW5kOiBmdW5jdGlvbihjbSkge2NtLnNldFNlbGVjdGlvbih7bGluZTogY20ubGluZUNvdW50KCkgLSAxfSwgbnVsbCwgdHJ1ZSk7fSwKICAgIGdvTGluZVN0YXJ0OiBmdW5jdGlvbihjbSkge2NtLnNldEN1cnNvcihjbS5nZXRDdXJzb3IoKS5saW5lLCAwLCB0cnVlKTt9LAogICAgZ29MaW5lU3RhcnRTbWFydDogZnVuY3Rpb24oY20pIHsKICAgICAgdmFyIGN1ciA9IGNtLmdldEN1cnNvcigpOwogICAgICB2YXIgdGV4dCA9IGNtLmdldExpbmUoY3VyLmxpbmUpLCBmaXJzdE5vbldTID0gTWF0aC5tYXgoMCwgdGV4dC5zZWFyY2goL1xTLykpOwogICAgICBjbS5zZXRDdXJzb3IoY3VyLmxpbmUsIGN1ci5jaCA8PSBmaXJzdE5vbldTICYmIGN1ci5jaCA/IDAgOiBmaXJzdE5vbldTLCB0cnVlKTsKICAgIH0sCiAgICBnb0xpbmVFbmQ6IGZ1bmN0aW9uKGNtKSB7Y20uc2V0U2VsZWN0aW9uKHtsaW5lOiBjbS5nZXRDdXJzb3IoKS5saW5lfSwgbnVsbCwgdHJ1ZSk7fSwKICAgIGdvTGluZVVwOiBmdW5jdGlvbihjbSkge2NtLm1vdmVWKC0xLCAibGluZSIpO30sCiAgICBnb0xpbmVEb3duOiBmdW5jdGlvbihjbSkge2NtLm1vdmVWKDEsICJsaW5lIik7fSwKICAgIGdvUGFnZVVwOiBmdW5jdGlvbihjbSkge2NtLm1vdmVWKC0xLCAicGFnZSIpO30sCiAgICBnb1BhZ2VEb3duOiBmdW5jdGlvbihjbSkge2NtLm1vdmVWKDEsICJwYWdlIik7fSwKICAgIGdvQ2hhckxlZnQ6IGZ1bmN0aW9uKGNtKSB7Y20ubW92ZUgoLTEsICJjaGFyIik7fSwKICAgIGdvQ2hhclJpZ2h0OiBmdW5jdGlvbihjbSkge2NtLm1vdmVIKDEsICJjaGFyIik7fSwKICAgIGdvQ29sdW1uTGVmdDogZnVuY3Rpb24oY20pIHtjbS5tb3ZlSCgtMSwgImNvbHVtbiIpO30sCiAgICBnb0NvbHVtblJpZ2h0OiBmdW5jdGlvbihjbSkge2NtLm1vdmVIKDEsICJjb2x1bW4iKTt9LAogICAgZ29Xb3JkTGVmdDogZnVuY3Rpb24oY20pIHtjbS5tb3ZlSCgtMSwgIndvcmQiKTt9LAogICAgZ29Xb3JkUmlnaHQ6IGZ1bmN0aW9uKGNtKSB7Y20ubW92ZUgoMSwgIndvcmQiKTt9LAogICAgZGVsQ2hhckxlZnQ6IGZ1bmN0aW9uKGNtKSB7Y20uZGVsZXRlSCgtMSwgImNoYXIiKTt9LAogICAgZGVsQ2hhclJpZ2h0OiBmdW5jdGlvbihjbSkge2NtLmRlbGV0ZUgoMSwgImNoYXIiKTt9LAogICAgZGVsV29yZExlZnQ6IGZ1bmN0aW9uKGNtKSB7Y20uZGVsZXRlSCgtMSwgIndvcmQiKTt9LAogICAgZGVsV29yZFJpZ2h0OiBmdW5jdGlvbihjbSkge2NtLmRlbGV0ZUgoMSwgIndvcmQiKTt9LAogICAgaW5kZW50QXV0bzogZnVuY3Rpb24oY20pIHtjbS5pbmRlbnRTZWxlY3Rpb24oInNtYXJ0Iik7fSwKICAgIGluZGVudE1vcmU6IGZ1bmN0aW9uKGNtKSB7Y20uaW5kZW50U2VsZWN0aW9uKCJhZGQiKTt9LAogICAgaW5kZW50TGVzczogZnVuY3Rpb24oY20pIHtjbS5pbmRlbnRTZWxlY3Rpb24oInN1YnRyYWN0Iik7fSwKICAgIGluc2VydFRhYjogZnVuY3Rpb24oY20pIHtjbS5yZXBsYWNlU2VsZWN0aW9uKCJcdCIsICJlbmQiKTt9LAogICAgZGVmYXVsdFRhYjogZnVuY3Rpb24oY20pIHsKICAgICAgaWYgKGNtLnNvbWV0aGluZ1NlbGVjdGVkKCkpIGNtLmluZGVudFNlbGVjdGlvbigiYWRkIik7CiAgICAgIGVsc2UgY20ucmVwbGFjZVNlbGVjdGlvbigiXHQiLCAiZW5kIik7CiAgICB9LAogICAgdHJhbnNwb3NlQ2hhcnM6IGZ1bmN0aW9uKGNtKSB7CiAgICAgIHZhciBjdXIgPSBjbS5nZXRDdXJzb3IoKSwgbGluZSA9IGNtLmdldExpbmUoY3VyLmxpbmUpOwogICAgICBpZiAoY3VyLmNoID4gMCAmJiBjdXIuY2ggPCBsaW5lLmxlbmd0aCAtIDEpCiAgICAgICAgY20ucmVwbGFjZVJhbmdlKGxpbmUuY2hhckF0KGN1ci5jaCkgKyBsaW5lLmNoYXJBdChjdXIuY2ggLSAxKSwKICAgICAgICAgICAgICAgICAgICAgICAge2xpbmU6IGN1ci5saW5lLCBjaDogY3VyLmNoIC0gMX0sIHtsaW5lOiBjdXIubGluZSwgY2g6IGN1ci5jaCArIDF9KTsKICAgIH0sCiAgICBuZXdsaW5lQW5kSW5kZW50OiBmdW5jdGlvbihjbSkgewogICAgICBjbS5yZXBsYWNlU2VsZWN0aW9uKCJcbiIsICJlbmQiKTsKICAgICAgY20uaW5kZW50TGluZShjbS5nZXRDdXJzb3IoKS5saW5lKTsKICAgIH0sCiAgICB0b2dnbGVPdmVyd3JpdGU6IGZ1bmN0aW9uKGNtKSB7Y20udG9nZ2xlT3ZlcndyaXRlKCk7fQogIH07CgogIHZhciBrZXlNYXAgPSBDb2RlTWlycm9yLmtleU1hcCA9IHt9OwogIGtleU1hcC5iYXNpYyA9IHsKICAgICJMZWZ0IjogImdvQ2hhckxlZnQiLCAiUmlnaHQiOiAiZ29DaGFyUmlnaHQiLCAiVXAiOiAiZ29MaW5lVXAiLCAiRG93biI6ICJnb0xpbmVEb3duIiwKICAgICJFbmQiOiAiZ29MaW5lRW5kIiwgIkhvbWUiOiAiZ29MaW5lU3RhcnRTbWFydCIsICJQYWdlVXAiOiAiZ29QYWdlVXAiLCAiUGFnZURvd24iOiAiZ29QYWdlRG93biIsCiAgICAiRGVsZXRlIjogImRlbENoYXJSaWdodCIsICJCYWNrc3BhY2UiOiAiZGVsQ2hhckxlZnQiLCAiVGFiIjogImRlZmF1bHRUYWIiLCAiU2hpZnQtVGFiIjogImluZGVudEF1dG8iLAogICAgIkVudGVyIjogIm5ld2xpbmVBbmRJbmRlbnQiLCAiSW5zZXJ0IjogInRvZ2dsZU92ZXJ3cml0ZSIKICB9OwogIC8vIE5vdGUgdGhhdCB0aGUgc2F2ZSBhbmQgZmluZC1yZWxhdGVkIGNvbW1hbmRzIGFyZW4ndCBkZWZpbmVkIGJ5CiAgLy8gZGVmYXVsdC4gVW5rbm93biBjb21tYW5kcyBhcmUgc2ltcGx5IGlnbm9yZWQuCiAga2V5TWFwLnBjRGVmYXVsdCA9IHsKICAgICJDdHJsLUEiOiAic2VsZWN0QWxsIiwgIkN0cmwtRCI6ICJkZWxldGVMaW5lIiwgIkN0cmwtWiI6ICJ1bmRvIiwgIlNoaWZ0LUN0cmwtWiI6ICJyZWRvIiwgIkN0cmwtWSI6ICJyZWRvIiwKICAgICJDdHJsLUhvbWUiOiAiZ29Eb2NTdGFydCIsICJBbHQtVXAiOiAiZ29Eb2NTdGFydCIsICJDdHJsLUVuZCI6ICJnb0RvY0VuZCIsICJDdHJsLURvd24iOiAiZ29Eb2NFbmQiLAogICAgIkN0cmwtTGVmdCI6ICJnb1dvcmRMZWZ0IiwgIkN0cmwtUmlnaHQiOiAiZ29Xb3JkUmlnaHQiLCAiQWx0LUxlZnQiOiAiZ29MaW5lU3RhcnQiLCAiQWx0LVJpZ2h0IjogImdvTGluZUVuZCIsCiAgICAiQ3RybC1CYWNrc3BhY2UiOiAiZGVsV29yZExlZnQiLCAiQ3RybC1EZWxldGUiOiAiZGVsV29yZFJpZ2h0IiwgIkN0cmwtUyI6ICJzYXZlIiwgIkN0cmwtRiI6ICJmaW5kIiwKICAgICJDdHJsLUciOiAiZmluZE5leHQiLCAiU2hpZnQtQ3RybC1HIjogImZpbmRQcmV2IiwgIlNoaWZ0LUN0cmwtRiI6ICJyZXBsYWNlIiwgIlNoaWZ0LUN0cmwtUiI6ICJyZXBsYWNlQWxsIiwKICAgICJDdHJsLVsiOiAiaW5kZW50TGVzcyIsICJDdHJsLV0iOiAiaW5kZW50TW9yZSIsCiAgICBmYWxsdGhyb3VnaDogImJhc2ljIgogIH07CiAga2V5TWFwLm1hY0RlZmF1bHQgPSB7CiAgICAiQ21kLUEiOiAic2VsZWN0QWxsIiwgIkNtZC1EIjogImRlbGV0ZUxpbmUiLCAiQ21kLVoiOiAidW5kbyIsICJTaGlmdC1DbWQtWiI6ICJyZWRvIiwgIkNtZC1ZIjogInJlZG8iLAogICAgIkNtZC1VcCI6ICJnb0RvY1N0YXJ0IiwgIkNtZC1FbmQiOiAiZ29Eb2NFbmQiLCAiQ21kLURvd24iOiAiZ29Eb2NFbmQiLCAiQWx0LUxlZnQiOiAiZ29Xb3JkTGVmdCIsCiAgICAiQWx0LVJpZ2h0IjogImdvV29yZFJpZ2h0IiwgIkNtZC1MZWZ0IjogImdvTGluZVN0YXJ0IiwgIkNtZC1SaWdodCI6ICJnb0xpbmVFbmQiLCAiQWx0LUJhY2tzcGFjZSI6ICJkZWxXb3JkTGVmdCIsCiAgICAiQ3RybC1BbHQtQmFja3NwYWNlIjogImRlbFdvcmRSaWdodCIsICJBbHQtRGVsZXRlIjogImRlbFdvcmRSaWdodCIsICJDbWQtUyI6ICJzYXZlIiwgIkNtZC1GIjogImZpbmQiLAogICAgIkNtZC1HIjogImZpbmROZXh0IiwgIlNoaWZ0LUNtZC1HIjogImZpbmRQcmV2IiwgIkNtZC1BbHQtRiI6ICJyZXBsYWNlIiwgIlNoaWZ0LUNtZC1BbHQtRiI6ICJyZXBsYWNlQWxsIiwKICAgICJDbWQtWyI6ICJpbmRlbnRMZXNzIiwgIkNtZC1dIjogImluZGVudE1vcmUiLAogICAgZmFsbHRocm91Z2g6IFsiYmFzaWMiLCAiZW1hY3N5Il0KICB9OwogIGtleU1hcFsiZGVmYXVsdCJdID0gbWFjID8ga2V5TWFwLm1hY0RlZmF1bHQgOiBrZXlNYXAucGNEZWZhdWx0OwogIGtleU1hcC5lbWFjc3kgPSB7CiAgICAiQ3RybC1GIjogImdvQ2hhclJpZ2h0IiwgIkN0cmwtQiI6ICJnb0NoYXJMZWZ0IiwgIkN0cmwtUCI6ICJnb0xpbmVVcCIsICJDdHJsLU4iOiAiZ29MaW5lRG93biIsCiAgICAiQWx0LUYiOiAiZ29Xb3JkUmlnaHQiLCAiQWx0LUIiOiAiZ29Xb3JkTGVmdCIsICJDdHJsLUEiOiAiZ29MaW5lU3RhcnQiLCAiQ3RybC1FIjogImdvTGluZUVuZCIsCiAgICAiQ3RybC1WIjogImdvUGFnZVVwIiwgIlNoaWZ0LUN0cmwtViI6ICJnb1BhZ2VEb3duIiwgIkN0cmwtRCI6ICJkZWxDaGFyUmlnaHQiLCAiQ3RybC1IIjogImRlbENoYXJMZWZ0IiwKICAgICJBbHQtRCI6ICJkZWxXb3JkUmlnaHQiLCAiQWx0LUJhY2tzcGFjZSI6ICJkZWxXb3JkTGVmdCIsICJDdHJsLUsiOiAia2lsbExpbmUiLCAiQ3RybC1UIjogInRyYW5zcG9zZUNoYXJzIgogIH07CgogIGZ1bmN0aW9uIGdldEtleU1hcCh2YWwpIHsKICAgIGlmICh0eXBlb2YgdmFsID09ICJzdHJpbmciKSByZXR1cm4ga2V5TWFwW3ZhbF07CiAgICBlbHNlIHJldHVybiB2YWw7CiAgfQogIGZ1bmN0aW9uIGxvb2t1cEtleShuYW1lLCBleHRyYU1hcCwgbWFwLCBoYW5kbGUsIHN0b3ApIHsKICAgIGZ1bmN0aW9uIGxvb2t1cChtYXApIHsKICAgICAgbWFwID0gZ2V0S2V5TWFwKG1hcCk7CiAgICAgIHZhciBmb3VuZCA9IG1hcFtuYW1lXTsKICAgICAgaWYgKGZvdW5kID09PSBmYWxzZSkgewogICAgICAgIGlmIChzdG9wKSBzdG9wKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGZvdW5kICE9IG51bGwgJiYgaGFuZGxlKGZvdW5kKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmIChtYXAubm9mYWxsdGhyb3VnaCkgewogICAgICAgIGlmIChzdG9wKSBzdG9wKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgdmFyIGZhbGx0aHJvdWdoID0gbWFwLmZhbGx0aHJvdWdoOwogICAgICBpZiAoZmFsbHRocm91Z2ggPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZhbGx0aHJvdWdoKSAhPSAiW29iamVjdCBBcnJheV0iKQogICAgICAgIHJldHVybiBsb29rdXAoZmFsbHRocm91Z2gpOwogICAgICBmb3IgKHZhciBpID0gMCwgZSA9IGZhbGx0aHJvdWdoLmxlbmd0aDsgaSA8IGU7ICsraSkgewogICAgICAgIGlmIChsb29rdXAoZmFsbHRocm91Z2hbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoZXh0cmFNYXAgJiYgbG9va3VwKGV4dHJhTWFwKSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gbG9va3VwKG1hcCk7CiAgfQogIGZ1bmN0aW9uIGlzTW9kaWZpZXJLZXkoZXZlbnQpIHsKICAgIHZhciBuYW1lID0ga2V5TmFtZXNbZV9wcm9wKGV2ZW50LCAia2V5Q29kZSIpXTsKICAgIHJldHVybiBuYW1lID09ICJDdHJsIiB8fCBuYW1lID09ICJBbHQiIHx8IG5hbWUgPT0gIlNoaWZ0IiB8fCBuYW1lID09ICJNb2QiOwogIH0KCiAgQ29kZU1pcnJvci5mcm9tVGV4dEFyZWEgPSBmdW5jdGlvbih0ZXh0YXJlYSwgb3B0aW9ucykgewogICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICBvcHRpb25zLnZhbHVlID0gdGV4dGFyZWEudmFsdWU7CiAgICBpZiAoIW9wdGlvbnMudGFiaW5kZXggJiYgdGV4dGFyZWEudGFiaW5kZXgpCiAgICAgIG9wdGlvbnMudGFiaW5kZXggPSB0ZXh0YXJlYS50YWJpbmRleDsKICAgIC8vIFNldCBhdXRvZm9jdXMgdG8gdHJ1ZSBpZiB0aGlzIHRleHRhcmVhIGlzIGZvY3VzZWQsIG9yIGlmIGl0IGhhcwogICAgLy8gYXV0b2ZvY3VzIGFuZCBubyBvdGhlciBlbGVtZW50IGlzIGZvY3VzZWQuCiAgICBpZiAob3B0aW9ucy5hdXRvZm9jdXMgPT0gbnVsbCkgewogICAgICB2YXIgaGFzRm9jdXMgPSBkb2N1bWVudC5ib2R5OwogICAgICAvLyBkb2MuYWN0aXZlRWxlbWVudCBvY2Nhc2lvbmFsbHkgdGhyb3dzIG9uIElFCiAgICAgIHRyeSB7IGhhc0ZvY3VzID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsgfSBjYXRjaChlKSB7fQogICAgICBvcHRpb25zLmF1dG9mb2N1cyA9IGhhc0ZvY3VzID09IHRleHRhcmVhIHx8CiAgICAgICAgdGV4dGFyZWEuZ2V0QXR0cmlidXRlKCJhdXRvZm9jdXMiKSAhPSBudWxsICYmIGhhc0ZvY3VzID09IGRvY3VtZW50LmJvZHk7CiAgICB9CgogICAgZnVuY3Rpb24gc2F2ZSgpIHt0ZXh0YXJlYS52YWx1ZSA9IGluc3RhbmNlLmdldFZhbHVlKCk7fQogICAgaWYgKHRleHRhcmVhLmZvcm0pIHsKICAgICAgLy8gRGVwbG9yYWJsZSBoYWNrIHRvIG1ha2UgdGhlIHN1Ym1pdCBtZXRob2QgZG8gdGhlIHJpZ2h0IHRoaW5nLgogICAgICB2YXIgcm1TdWJtaXQgPSBjb25uZWN0KHRleHRhcmVhLmZvcm0sICJzdWJtaXQiLCBzYXZlLCB0cnVlKTsKICAgICAgaWYgKHR5cGVvZiB0ZXh0YXJlYS5mb3JtLnN1Ym1pdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdmFyIHJlYWxTdWJtaXQgPSB0ZXh0YXJlYS5mb3JtLnN1Ym1pdDsKICAgICAgICB0ZXh0YXJlYS5mb3JtLnN1Ym1pdCA9IGZ1bmN0aW9uIHdyYXBwZWRTdWJtaXQoKSB7CiAgICAgICAgICBzYXZlKCk7CiAgICAgICAgICB0ZXh0YXJlYS5mb3JtLnN1Ym1pdCA9IHJlYWxTdWJtaXQ7CiAgICAgICAgICB0ZXh0YXJlYS5mb3JtLnN1Ym1pdCgpOwogICAgICAgICAgdGV4dGFyZWEuZm9ybS5zdWJtaXQgPSB3cmFwcGVkU3VibWl0OwogICAgICAgIH07CiAgICAgIH0KICAgIH0KCiAgICB0ZXh0YXJlYS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgdmFyIGluc3RhbmNlID0gQ29kZU1pcnJvcihmdW5jdGlvbihub2RlKSB7CiAgICAgIHRleHRhcmVhLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIHRleHRhcmVhLm5leHRTaWJsaW5nKTsKICAgIH0sIG9wdGlvbnMpOwogICAgaW5zdGFuY2Uuc2F2ZSA9IHNhdmU7CiAgICBpbnN0YW5jZS5nZXRUZXh0QXJlYSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGV4dGFyZWE7IH07CiAgICBpbnN0YW5jZS50b1RleHRBcmVhID0gZnVuY3Rpb24oKSB7CiAgICAgIHNhdmUoKTsKICAgICAgdGV4dGFyZWEucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpbnN0YW5jZS5nZXRXcmFwcGVyRWxlbWVudCgpKTsKICAgICAgdGV4dGFyZWEuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICBpZiAodGV4dGFyZWEuZm9ybSkgewogICAgICAgIHJtU3VibWl0KCk7CiAgICAgICAgaWYgKHR5cGVvZiB0ZXh0YXJlYS5mb3JtLnN1Ym1pdCA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgdGV4dGFyZWEuZm9ybS5zdWJtaXQgPSByZWFsU3VibWl0OwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIGluc3RhbmNlOwogIH07CgogIHZhciBnZWNrbyA9IC9nZWNrb1wvXGR7N30vaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBpZSA9IC9NU0lFIFxkLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBpZV9sdDggPSAvTVNJRSBbMS03XVxiLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBpZV9sdDkgPSAvTVNJRSBbMS04XVxiLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBxdWlya3NNb2RlID0gaWUgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09IDU7CiAgdmFyIHdlYmtpdCA9IC9XZWJLaXRcLy8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTsKICB2YXIgY2hyb21lID0gL0Nocm9tZVwvLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBvcGVyYSA9IC9PcGVyYVwvLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwogIHZhciBzYWZhcmkgPSAvQXBwbGUgQ29tcHV0ZXIvLnRlc3QobmF2aWdhdG9yLnZlbmRvcik7CiAgdmFyIGtodG1sID0gL0tIVE1MXC8vLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgdmFyIG1hY19nZUxpb24gPSAvTWFjIE9TIFggMTBcRChbNy05XXxcZFxkKVxELy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpOwoKICAvLyBVdGlsaXR5IGZ1bmN0aW9ucyBmb3Igd29ya2luZyB3aXRoIHN0YXRlLiBFeHBvcnRlZCBiZWNhdXNlIG1vZGVzCiAgLy8gc29tZXRpbWVzIG5lZWQgdG8gZG8gdGhpcy4KICBmdW5jdGlvbiBjb3B5U3RhdGUobW9kZSwgc3RhdGUpIHsKICAgIGlmIChzdGF0ZSA9PT0gdHJ1ZSkgcmV0dXJuIHN0YXRlOwogICAgaWYgKG1vZGUuY29weVN0YXRlKSByZXR1cm4gbW9kZS5jb3B5U3RhdGUoc3RhdGUpOwogICAgdmFyIG5zdGF0ZSA9IHt9OwogICAgZm9yICh2YXIgbiBpbiBzdGF0ZSkgewogICAgICB2YXIgdmFsID0gc3RhdGVbbl07CiAgICAgIGlmICh2YWwgaW5zdGFuY2VvZiBBcnJheSkgdmFsID0gdmFsLmNvbmNhdChbXSk7CiAgICAgIG5zdGF0ZVtuXSA9IHZhbDsKICAgIH0KICAgIHJldHVybiBuc3RhdGU7CiAgfQogIENvZGVNaXJyb3IuY29weVN0YXRlID0gY29weVN0YXRlOwogIGZ1bmN0aW9uIHN0YXJ0U3RhdGUobW9kZSwgYTEsIGEyKSB7CiAgICByZXR1cm4gbW9kZS5zdGFydFN0YXRlID8gbW9kZS5zdGFydFN0YXRlKGExLCBhMikgOiB0cnVlOwogIH0KICBDb2RlTWlycm9yLnN0YXJ0U3RhdGUgPSBzdGFydFN0YXRlOwogIENvZGVNaXJyb3IuaW5uZXJNb2RlID0gZnVuY3Rpb24obW9kZSwgc3RhdGUpIHsKICAgIHdoaWxlIChtb2RlLmlubmVyTW9kZSkgewogICAgICB2YXIgaW5mbyA9IG1vZGUuaW5uZXJNb2RlKHN0YXRlKTsKICAgICAgc3RhdGUgPSBpbmZvLnN0YXRlOwogICAgICBtb2RlID0gaW5mby5tb2RlOwogICAgfQogICAgcmV0dXJuIGluZm8gfHwge21vZGU6IG1vZGUsIHN0YXRlOiBzdGF0ZX07CiAgfTsKCiAgLy8gVGhlIGNoYXJhY3RlciBzdHJlYW0gdXNlZCBieSBhIG1vZGUncyBwYXJzZXIuCiAgZnVuY3Rpb24gU3RyaW5nU3RyZWFtKHN0cmluZywgdGFiU2l6ZSkgewogICAgdGhpcy5wb3MgPSB0aGlzLnN0YXJ0ID0gMDsKICAgIHRoaXMuc3RyaW5nID0gc3RyaW5nOwogICAgdGhpcy50YWJTaXplID0gdGFiU2l6ZSB8fCA4OwogIH0KICBTdHJpbmdTdHJlYW0ucHJvdG90eXBlID0gewogICAgZW9sOiBmdW5jdGlvbigpIHtyZXR1cm4gdGhpcy5wb3MgPj0gdGhpcy5zdHJpbmcubGVuZ3RoO30sCiAgICBzb2w6IGZ1bmN0aW9uKCkge3JldHVybiB0aGlzLnBvcyA9PSAwO30sCiAgICBwZWVrOiBmdW5jdGlvbigpIHtyZXR1cm4gdGhpcy5zdHJpbmcuY2hhckF0KHRoaXMucG9zKSB8fCB1bmRlZmluZWQ7fSwKICAgIG5leHQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5wb3MgPCB0aGlzLnN0cmluZy5sZW5ndGgpCiAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5nLmNoYXJBdCh0aGlzLnBvcysrKTsKICAgIH0sCiAgICBlYXQ6IGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgIHZhciBjaCA9IHRoaXMuc3RyaW5nLmNoYXJBdCh0aGlzLnBvcyk7CiAgICAgIGlmICh0eXBlb2YgbWF0Y2ggPT0gInN0cmluZyIpIHZhciBvayA9IGNoID09IG1hdGNoOwogICAgICBlbHNlIHZhciBvayA9IGNoICYmIChtYXRjaC50ZXN0ID8gbWF0Y2gudGVzdChjaCkgOiBtYXRjaChjaCkpOwogICAgICBpZiAob2spIHsrK3RoaXMucG9zOyByZXR1cm4gY2g7fQogICAgfSwKICAgIGVhdFdoaWxlOiBmdW5jdGlvbihtYXRjaCkgewogICAgICB2YXIgc3RhcnQgPSB0aGlzLnBvczsKICAgICAgd2hpbGUgKHRoaXMuZWF0KG1hdGNoKSl7fQogICAgICByZXR1cm4gdGhpcy5wb3MgPiBzdGFydDsKICAgIH0sCiAgICBlYXRTcGFjZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdGFydCA9IHRoaXMucG9zOwogICAgICB3aGlsZSAoL1tcc1x1MDBhMF0vLnRlc3QodGhpcy5zdHJpbmcuY2hhckF0KHRoaXMucG9zKSkpICsrdGhpcy5wb3M7CiAgICAgIHJldHVybiB0aGlzLnBvcyA+IHN0YXJ0OwogICAgfSwKICAgIHNraXBUb0VuZDogZnVuY3Rpb24oKSB7dGhpcy5wb3MgPSB0aGlzLnN0cmluZy5sZW5ndGg7fSwKICAgIHNraXBUbzogZnVuY3Rpb24oY2gpIHsKICAgICAgdmFyIGZvdW5kID0gdGhpcy5zdHJpbmcuaW5kZXhPZihjaCwgdGhpcy5wb3MpOwogICAgICBpZiAoZm91bmQgPiAtMSkge3RoaXMucG9zID0gZm91bmQ7IHJldHVybiB0cnVlO30KICAgIH0sCiAgICBiYWNrVXA6IGZ1bmN0aW9uKG4pIHt0aGlzLnBvcyAtPSBuO30sCiAgICBjb2x1bW46IGZ1bmN0aW9uKCkge3JldHVybiBjb3VudENvbHVtbih0aGlzLnN0cmluZywgdGhpcy5zdGFydCwgdGhpcy50YWJTaXplKTt9LAogICAgaW5kZW50YXRpb246IGZ1bmN0aW9uKCkge3JldHVybiBjb3VudENvbHVtbih0aGlzLnN0cmluZywgbnVsbCwgdGhpcy50YWJTaXplKTt9LAogICAgbWF0Y2g6IGZ1bmN0aW9uKHBhdHRlcm4sIGNvbnN1bWUsIGNhc2VJbnNlbnNpdGl2ZSkgewogICAgICBpZiAodHlwZW9mIHBhdHRlcm4gPT0gInN0cmluZyIpIHsKICAgICAgICB2YXIgY2FzZWQgPSBmdW5jdGlvbihzdHIpIHtyZXR1cm4gY2FzZUluc2Vuc2l0aXZlID8gc3RyLnRvTG93ZXJDYXNlKCkgOiBzdHI7fTsKICAgICAgICBpZiAoY2FzZWQodGhpcy5zdHJpbmcpLmluZGV4T2YoY2FzZWQocGF0dGVybiksIHRoaXMucG9zKSA9PSB0aGlzLnBvcykgewogICAgICAgICAgaWYgKGNvbnN1bWUgIT09IGZhbHNlKSB0aGlzLnBvcyArPSBwYXR0ZXJuLmxlbmd0aDsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWF0Y2ggPSB0aGlzLnN0cmluZy5zbGljZSh0aGlzLnBvcykubWF0Y2gocGF0dGVybik7CiAgICAgICAgaWYgKG1hdGNoICYmIG1hdGNoLmluZGV4ID4gMCkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKG1hdGNoICYmIGNvbnN1bWUgIT09IGZhbHNlKSB0aGlzLnBvcyArPSBtYXRjaFswXS5sZW5ndGg7CiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICB9CiAgICB9LAogICAgY3VycmVudDogZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5zdHJpbmcuc2xpY2UodGhpcy5zdGFydCwgdGhpcy5wb3MpO30KICB9OwogIENvZGVNaXJyb3IuU3RyaW5nU3RyZWFtID0gU3RyaW5nU3RyZWFtOwoKICBmdW5jdGlvbiBNYXJrZWRTcGFuKGZyb20sIHRvLCBtYXJrZXIpIHsKICAgIHRoaXMuZnJvbSA9IGZyb207IHRoaXMudG8gPSB0bzsgdGhpcy5tYXJrZXIgPSBtYXJrZXI7CiAgfQoKICBmdW5jdGlvbiBnZXRNYXJrZWRTcGFuRm9yKHNwYW5zLCBtYXJrZXIsIGRlbCkgewogICAgaWYgKHNwYW5zKSBmb3IgKHZhciBpID0gMDsgaSA8IHNwYW5zLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzcGFuID0gc3BhbnNbaV07CiAgICAgIGlmIChzcGFuLm1hcmtlciA9PSBtYXJrZXIpIHsKICAgICAgICBpZiAoZGVsKSBzcGFucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgcmV0dXJuIHNwYW47CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIG1hcmtlZFNwYW5zQmVmb3JlKG9sZCwgc3RhcnRDaCwgZW5kQ2gpIHsKICAgIGlmIChvbGQpIGZvciAodmFyIGkgPSAwLCBudzsgaSA8IG9sZC5sZW5ndGg7ICsraSkgewogICAgICB2YXIgc3BhbiA9IG9sZFtpXSwgbWFya2VyID0gc3Bhbi5tYXJrZXI7CiAgICAgIHZhciBzdGFydHNCZWZvcmUgPSBzcGFuLmZyb20gPT0gbnVsbCB8fCAobWFya2VyLmluY2x1c2l2ZUxlZnQgPyBzcGFuLmZyb20gPD0gc3RhcnRDaCA6IHNwYW4uZnJvbSA8IHN0YXJ0Q2gpOwogICAgICBpZiAoc3RhcnRzQmVmb3JlIHx8IG1hcmtlci50eXBlID09ICJib29rbWFyayIgJiYgc3Bhbi5mcm9tID09IHN0YXJ0Q2ggJiYgc3Bhbi5mcm9tICE9IGVuZENoKSB7CiAgICAgICAgdmFyIGVuZHNBZnRlciA9IHNwYW4udG8gPT0gbnVsbCB8fCAobWFya2VyLmluY2x1c2l2ZVJpZ2h0ID8gc3Bhbi50byA+PSBzdGFydENoIDogc3Bhbi50byA+IHN0YXJ0Q2gpOwogICAgICAgIChudyB8fCAobncgPSBbXSkpLnB1c2goe2Zyb206IHNwYW4uZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogZW5kc0FmdGVyID8gbnVsbCA6IHNwYW4udG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya2VyOiBtYXJrZXJ9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG53OwogIH0KCiAgZnVuY3Rpb24gbWFya2VkU3BhbnNBZnRlcihvbGQsIGVuZENoKSB7CiAgICBpZiAob2xkKSBmb3IgKHZhciBpID0gMCwgbnc7IGkgPCBvbGQubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIHNwYW4gPSBvbGRbaV0sIG1hcmtlciA9IHNwYW4ubWFya2VyOwogICAgICB2YXIgZW5kc0FmdGVyID0gc3Bhbi50byA9PSBudWxsIHx8IChtYXJrZXIuaW5jbHVzaXZlUmlnaHQgPyBzcGFuLnRvID49IGVuZENoIDogc3Bhbi50byA+IGVuZENoKTsKICAgICAgaWYgKGVuZHNBZnRlciB8fCBtYXJrZXIudHlwZSA9PSAiYm9va21hcmsiICYmIHNwYW4uZnJvbSA9PSBlbmRDaCkgewogICAgICAgIHZhciBzdGFydHNCZWZvcmUgPSBzcGFuLmZyb20gPT0gbnVsbCB8fCAobWFya2VyLmluY2x1c2l2ZUxlZnQgPyBzcGFuLmZyb20gPD0gZW5kQ2ggOiBzcGFuLmZyb20gPCBlbmRDaCk7CiAgICAgICAgKG53IHx8IChudyA9IFtdKSkucHVzaCh7ZnJvbTogc3RhcnRzQmVmb3JlID8gbnVsbCA6IHNwYW4uZnJvbSAtIGVuZENoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBzcGFuLnRvID09IG51bGwgPyBudWxsIDogc3Bhbi50byAtIGVuZENoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtlcjogbWFya2VyfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudzsKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZU1hcmtlZFNwYW5zKG9sZEZpcnN0LCBvbGRMYXN0LCBzdGFydENoLCBlbmRDaCwgbmV3VGV4dCkgewogICAgaWYgKCFvbGRGaXJzdCAmJiAhb2xkTGFzdCkgcmV0dXJuIG5ld1RleHQ7CiAgICAvLyBHZXQgdGhlIHNwYW5zIHRoYXQgJ3N0aWNrIG91dCcgb24gYm90aCBzaWRlcwogICAgdmFyIGZpcnN0ID0gbWFya2VkU3BhbnNCZWZvcmUob2xkRmlyc3QsIHN0YXJ0Q2gpOwogICAgdmFyIGxhc3QgPSBtYXJrZWRTcGFuc0FmdGVyKG9sZExhc3QsIGVuZENoKTsKCiAgICAvLyBOZXh0LCBtZXJnZSB0aG9zZSB0d28gZW5kcwogICAgdmFyIHNhbWVMaW5lID0gbmV3VGV4dC5sZW5ndGggPT0gMSwgb2Zmc2V0ID0gbHN0KG5ld1RleHQpLmxlbmd0aCArIChzYW1lTGluZSA/IHN0YXJ0Q2ggOiAwKTsKICAgIGlmIChmaXJzdCkgewogICAgICAvLyBGaXggdXAgLnRvIHByb3BlcnRpZXMgb2YgZmlyc3QKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaXJzdC5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBzcGFuID0gZmlyc3RbaV07CiAgICAgICAgaWYgKHNwYW4udG8gPT0gbnVsbCkgewogICAgICAgICAgdmFyIGZvdW5kID0gZ2V0TWFya2VkU3BhbkZvcihsYXN0LCBzcGFuLm1hcmtlcik7CiAgICAgICAgICBpZiAoIWZvdW5kKSBzcGFuLnRvID0gc3RhcnRDaDsKICAgICAgICAgIGVsc2UgaWYgKHNhbWVMaW5lKSBzcGFuLnRvID0gZm91bmQudG8gPT0gbnVsbCA/IG51bGwgOiBmb3VuZC50byArIG9mZnNldDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChsYXN0KSB7CiAgICAgIC8vIEZpeCB1cCAuZnJvbSBpbiBsYXN0IChvciBtb3ZlIHRoZW0gaW50byBmaXJzdCBpbiBjYXNlIG9mIHNhbWVMaW5lKQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxhc3QubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgc3BhbiA9IGxhc3RbaV07CiAgICAgICAgaWYgKHNwYW4udG8gIT0gbnVsbCkgc3Bhbi50byArPSBvZmZzZXQ7CiAgICAgICAgaWYgKHNwYW4uZnJvbSA9PSBudWxsKSB7CiAgICAgICAgICB2YXIgZm91bmQgPSBnZXRNYXJrZWRTcGFuRm9yKGZpcnN0LCBzcGFuLm1hcmtlcik7CiAgICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgIHNwYW4uZnJvbSA9IG9mZnNldDsKICAgICAgICAgICAgaWYgKHNhbWVMaW5lKSAoZmlyc3QgfHwgKGZpcnN0ID0gW10pKS5wdXNoKHNwYW4pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzcGFuLmZyb20gKz0gb2Zmc2V0OwogICAgICAgICAgaWYgKHNhbWVMaW5lKSAoZmlyc3QgfHwgKGZpcnN0ID0gW10pKS5wdXNoKHNwYW4pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHZhciBuZXdNYXJrZXJzID0gW25ld0hMKG5ld1RleHRbMF0sIGZpcnN0KV07CiAgICBpZiAoIXNhbWVMaW5lKSB7CiAgICAgIC8vIEZpbGwgZ2FwIHdpdGggd2hvbGUtbGluZS1zcGFucwogICAgICB2YXIgZ2FwID0gbmV3VGV4dC5sZW5ndGggLSAyLCBnYXBNYXJrZXJzOwogICAgICBpZiAoZ2FwID4gMCAmJiBmaXJzdCkKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpcnN0Lmxlbmd0aDsgKytpKQogICAgICAgICAgaWYgKGZpcnN0W2ldLnRvID09IG51bGwpCiAgICAgICAgICAgIChnYXBNYXJrZXJzIHx8IChnYXBNYXJrZXJzID0gW10pKS5wdXNoKHtmcm9tOiBudWxsLCB0bzogbnVsbCwgbWFya2VyOiBmaXJzdFtpXS5tYXJrZXJ9KTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBnYXA7ICsraSkKICAgICAgICBuZXdNYXJrZXJzLnB1c2gobmV3SEwobmV3VGV4dFtpKzFdLCBnYXBNYXJrZXJzKSk7CiAgICAgIG5ld01hcmtlcnMucHVzaChuZXdITChsc3QobmV3VGV4dCksIGxhc3QpKTsKICAgIH0KICAgIHJldHVybiBuZXdNYXJrZXJzOwogIH0KCiAgLy8gaGwgc3RhbmRzIGZvciBoaXN0b3J5LWxpbmUsIGEgZGF0YSBzdHJ1Y3R1cmUgdGhhdCBjYW4gYmUgZWl0aGVyIGEKICAvLyBzdHJpbmcgKGxpbmUgd2l0aG91dCBtYXJrZXJzKSBvciBhIHt0ZXh0LCBtYXJrZWRTcGFuc30gb2JqZWN0LgogIGZ1bmN0aW9uIGhsVGV4dCh2YWwpIHsgcmV0dXJuIHR5cGVvZiB2YWwgPT0gInN0cmluZyIgPyB2YWwgOiB2YWwudGV4dDsgfQogIGZ1bmN0aW9uIGhsU3BhbnModmFsKSB7IHJldHVybiB0eXBlb2YgdmFsID09ICJzdHJpbmciID8gbnVsbCA6IHZhbC5tYXJrZWRTcGFuczsgfQogIGZ1bmN0aW9uIG5ld0hMKHRleHQsIHNwYW5zKSB7IHJldHVybiBzcGFucyA/IHt0ZXh0OiB0ZXh0LCBtYXJrZWRTcGFuczogc3BhbnN9IDogdGV4dDsgfQoKICBmdW5jdGlvbiBkZXRhY2hNYXJrZWRTcGFucyhsaW5lKSB7CiAgICB2YXIgc3BhbnMgPSBsaW5lLm1hcmtlZFNwYW5zOwogICAgaWYgKCFzcGFucykgcmV0dXJuOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFucy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgbGluZXMgPSBzcGFuc1tpXS5tYXJrZXIubGluZXM7CiAgICAgIHZhciBpeCA9IGluZGV4T2YobGluZXMsIGxpbmUpOwogICAgICBsaW5lcy5zcGxpY2UoaXgsIDEpOwogICAgfQogICAgbGluZS5tYXJrZWRTcGFucyA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiBhdHRhY2hNYXJrZWRTcGFucyhsaW5lLCBzcGFucykgewogICAgaWYgKCFzcGFucykgcmV0dXJuOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFucy5sZW5ndGg7ICsraSkKICAgICAgdmFyIG1hcmtlciA9IHNwYW5zW2ldLm1hcmtlci5saW5lcy5wdXNoKGxpbmUpOwogICAgbGluZS5tYXJrZWRTcGFucyA9IHNwYW5zOwogIH0KCiAgLy8gV2hlbiBtZWFzdXJpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSBlbmQgb2YgYSBsaW5lLCBkaWZmZXJlbnQKICAvLyBicm93c2VycyByZXF1aXJlIGRpZmZlcmVudCBhcHByb2FjaGVzLiBJZiBhbiBlbXB0eSBzcGFuIGlzIGFkZGVkLAogIC8vIG1hbnkgYnJvd3NlcnMgcmVwb3J0IGJvZ3VzIG9mZnNldHMuIE9mIHRob3NlLCBzb21lIChXZWJraXQsCiAgLy8gcmVjZW50IElFKSB3aWxsIGFjY2VwdCBhIHNwYWNlIHdpdGhvdXQgbW92aW5nIHRoZSB3aG9sZSBzcGFuIHRvCiAgLy8gdGhlIG5leHQgbGluZSB3aGVuIHdyYXBwaW5nIGl0LCBvdGhlcnMgd29yayB3aXRoIGEgemVyby13aWR0aAogIC8vIHNwYWNlLgogIHZhciBlb2xTcGFuQ29udGVudCA9ICIgIjsKICBpZiAoZ2Vja28gfHwgKGllICYmICFpZV9sdDgpKSBlb2xTcGFuQ29udGVudCA9ICJcdTIwMGIiOwogIGVsc2UgaWYgKG9wZXJhKSBlb2xTcGFuQ29udGVudCA9ICIiOwoKICAvLyBMaW5lIG9iamVjdHMuIFRoZXNlIGhvbGQgc3RhdGUgcmVsYXRlZCB0byBhIGxpbmUsIGluY2x1ZGluZwogIC8vIGhpZ2hsaWdodGluZyBpbmZvICh0aGUgc3R5bGVzIGFycmF5KS4KICBmdW5jdGlvbiBMaW5lKHRleHQsIG1hcmtlZFNwYW5zKSB7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy5oZWlnaHQgPSAxOwogICAgYXR0YWNoTWFya2VkU3BhbnModGhpcywgbWFya2VkU3BhbnMpOwogIH0KICBMaW5lLnByb3RvdHlwZSA9IHsKICAgIHVwZGF0ZTogZnVuY3Rpb24odGV4dCwgbWFya2VkU3BhbnMpIHsKICAgICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgICAgdGhpcy5zdGF0ZUFmdGVyID0gdGhpcy5zdHlsZXMgPSBudWxsOwogICAgICBkZXRhY2hNYXJrZWRTcGFucyh0aGlzKTsKICAgICAgYXR0YWNoTWFya2VkU3BhbnModGhpcywgbWFya2VkU3BhbnMpOwogICAgfSwKICAgIC8vIFJ1biB0aGUgZ2l2ZW4gbW9kZSdzIHBhcnNlciBvdmVyIGEgbGluZSwgdXBkYXRlIHRoZSBzdHlsZXMKICAgIC8vIGFycmF5LCB3aGljaCBjb250YWlucyBhbHRlcm5hdGluZyBmcmFnbWVudHMgb2YgdGV4dCBhbmQgQ1NTCiAgICAvLyBjbGFzc2VzLgogICAgaGlnaGxpZ2h0OiBmdW5jdGlvbihtb2RlLCBzdGF0ZSwgdGFiU2l6ZSkgewogICAgICB2YXIgc3RyZWFtID0gbmV3IFN0cmluZ1N0cmVhbSh0aGlzLnRleHQsIHRhYlNpemUpLCBzdCA9IHRoaXMuc3R5bGVzIHx8ICh0aGlzLnN0eWxlcyA9IFtdKTsKICAgICAgdmFyIHBvcyA9IHN0Lmxlbmd0aCA9IDA7CiAgICAgIGlmICh0aGlzLnRleHQgPT0gIiIgJiYgbW9kZS5ibGFua0xpbmUpIG1vZGUuYmxhbmtMaW5lKHN0YXRlKTsKICAgICAgd2hpbGUgKCFzdHJlYW0uZW9sKCkpIHsKICAgICAgICB2YXIgc3R5bGUgPSBtb2RlLnRva2VuKHN0cmVhbSwgc3RhdGUpLCBzdWJzdHIgPSBzdHJlYW0uY3VycmVudCgpOwogICAgICAgIHN0cmVhbS5zdGFydCA9IHN0cmVhbS5wb3M7CiAgICAgICAgaWYgKHBvcyAmJiBzdFtwb3MtMV0gPT0gc3R5bGUpIHsKICAgICAgICAgIHN0W3Bvcy0yXSArPSBzdWJzdHI7CiAgICAgICAgfSBlbHNlIGlmIChzdWJzdHIpIHsKICAgICAgICAgIHN0W3BvcysrXSA9IHN1YnN0cjsgc3RbcG9zKytdID0gc3R5bGU7CiAgICAgICAgfQogICAgICAgIC8vIEdpdmUgdXAgd2hlbiBsaW5lIGlzIHJpZGljdWxvdXNseSBsb25nCiAgICAgICAgaWYgKHN0cmVhbS5wb3MgPiA1MDAwKSB7CiAgICAgICAgICBzdFtwb3MrK10gPSB0aGlzLnRleHQuc2xpY2Uoc3RyZWFtLnBvcyk7IHN0W3BvcysrXSA9IG51bGw7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBwcm9jZXNzOiBmdW5jdGlvbihtb2RlLCBzdGF0ZSwgdGFiU2l6ZSkgewogICAgICB2YXIgc3RyZWFtID0gbmV3IFN0cmluZ1N0cmVhbSh0aGlzLnRleHQsIHRhYlNpemUpOwogICAgICBpZiAodGhpcy50ZXh0ID09ICIiICYmIG1vZGUuYmxhbmtMaW5lKSBtb2RlLmJsYW5rTGluZShzdGF0ZSk7CiAgICAgIHdoaWxlICghc3RyZWFtLmVvbCgpICYmIHN0cmVhbS5wb3MgPD0gNTAwMCkgewogICAgICAgIG1vZGUudG9rZW4oc3RyZWFtLCBzdGF0ZSk7CiAgICAgICAgc3RyZWFtLnN0YXJ0ID0gc3RyZWFtLnBvczsKICAgICAgfQogICAgfSwKICAgIC8vIEZldGNoIHRoZSBwYXJzZXIgdG9rZW4gZm9yIGEgZ2l2ZW4gY2hhcmFjdGVyLiBVc2VmdWwgZm9yIGhhY2tzCiAgICAvLyB0aGF0IHdhbnQgdG8gaW5zcGVjdCB0aGUgbW9kZSBzdGF0ZSAoc2F5LCBmb3IgY29tcGxldGlvbikuCiAgICBnZXRUb2tlbkF0OiBmdW5jdGlvbihtb2RlLCBzdGF0ZSwgdGFiU2l6ZSwgY2gpIHsKICAgICAgdmFyIHR4dCA9IHRoaXMudGV4dCwgc3RyZWFtID0gbmV3IFN0cmluZ1N0cmVhbSh0eHQsIHRhYlNpemUpOwogICAgICB3aGlsZSAoc3RyZWFtLnBvcyA8IGNoICYmICFzdHJlYW0uZW9sKCkpIHsKICAgICAgICBzdHJlYW0uc3RhcnQgPSBzdHJlYW0ucG9zOwogICAgICAgIHZhciBzdHlsZSA9IG1vZGUudG9rZW4oc3RyZWFtLCBzdGF0ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHtzdGFydDogc3RyZWFtLnN0YXJ0LAogICAgICAgICAgICAgIGVuZDogc3RyZWFtLnBvcywKICAgICAgICAgICAgICBzdHJpbmc6IHN0cmVhbS5jdXJyZW50KCksCiAgICAgICAgICAgICAgY2xhc3NOYW1lOiBzdHlsZSB8fCBudWxsLAogICAgICAgICAgICAgIHN0YXRlOiBzdGF0ZX07CiAgICB9LAogICAgaW5kZW50YXRpb246IGZ1bmN0aW9uKHRhYlNpemUpIHtyZXR1cm4gY291bnRDb2x1bW4odGhpcy50ZXh0LCBudWxsLCB0YWJTaXplKTt9LAogICAgLy8gUHJvZHVjZXMgYW4gSFRNTCBmcmFnbWVudCBmb3IgdGhlIGxpbmUsIHRha2luZyBzZWxlY3Rpb24sCiAgICAvLyBtYXJraW5nLCBhbmQgaGlnaGxpZ2h0aW5nIGludG8gYWNjb3VudC4KICAgIGdldENvbnRlbnQ6IGZ1bmN0aW9uKHRhYlNpemUsIHdyYXBBdCwgY29tcGVuc2F0ZUZvcldyYXBwaW5nKSB7CiAgICAgIHZhciBmaXJzdCA9IHRydWUsIGNvbCA9IDAsIHNwZWNpYWxzID0gL1tcdFx1MDAwMC1cdTAwMTlcdTIwMGJcdTIwMjhcdTIwMjlcdUZFRkZdL2c7CiAgICAgIHZhciBwcmUgPSBlbHQoInByZSIpOwogICAgICBmdW5jdGlvbiBzcGFuXyhodG1sLCB0ZXh0LCBzdHlsZSkgewogICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgIC8vIFdvcmsgYXJvdW5kIGEgYnVnIHdoZXJlLCBpbiBzb21lIGNvbXBhdCBtb2RlcywgSUUgaWdub3JlcyBsZWFkaW5nIHNwYWNlcwogICAgICAgIGlmIChmaXJzdCAmJiBpZSAmJiB0ZXh0LmNoYXJBdCgwKSA9PSAiICIpIHRleHQgPSAiXHUwMGEwIiArIHRleHQuc2xpY2UoMSk7CiAgICAgICAgZmlyc3QgPSBmYWxzZTsKICAgICAgICBpZiAoIXNwZWNpYWxzLnRlc3QodGV4dCkpIHsKICAgICAgICAgIGNvbCArPSB0ZXh0Lmxlbmd0aDsKICAgICAgICAgIHZhciBjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLCBwb3MgPSAwOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgc3BlY2lhbHMubGFzdEluZGV4ID0gcG9zOwogICAgICAgICAgICB2YXIgbSA9IHNwZWNpYWxzLmV4ZWModGV4dCk7CiAgICAgICAgICAgIHZhciBza2lwcGVkID0gbSA/IG0uaW5kZXggLSBwb3MgOiB0ZXh0Lmxlbmd0aCAtIHBvczsKICAgICAgICAgICAgaWYgKHNraXBwZWQpIHsKICAgICAgICAgICAgICBjb250ZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQuc2xpY2UocG9zLCBwb3MgKyBza2lwcGVkKSkpOwogICAgICAgICAgICAgIGNvbCArPSBza2lwcGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbSkgYnJlYWs7CiAgICAgICAgICAgIHBvcyArPSBza2lwcGVkICsgMTsKICAgICAgICAgICAgaWYgKG1bMF0gPT0gIlx0IikgewogICAgICAgICAgICAgIHZhciB0YWJXaWR0aCA9IHRhYlNpemUgLSBjb2wgJSB0YWJTaXplOwogICAgICAgICAgICAgIGNvbnRlbnQuYXBwZW5kQ2hpbGQoZWx0KCJzcGFuIiwgc3BhY2VTdHIodGFiV2lkdGgpLCAiY20tdGFiIikpOwogICAgICAgICAgICAgIGNvbCArPSB0YWJXaWR0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBlbHQoInNwYW4iLCAiXHUyMDIyIiwgImNtLWludmFsaWRjaGFyIik7CiAgICAgICAgICAgICAgdG9rZW4udGl0bGUgPSAiXFx1IiArIG1bMF0uY2hhckNvZGVBdCgwKS50b1N0cmluZygxNik7CiAgICAgICAgICAgICAgY29udGVudC5hcHBlbmRDaGlsZCh0b2tlbik7CiAgICAgICAgICAgICAgY29sICs9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHN0eWxlKSBodG1sLmFwcGVuZENoaWxkKGVsdCgic3BhbiIsIFtjb250ZW50XSwgc3R5bGUpKTsKICAgICAgICBlbHNlIGh0bWwuYXBwZW5kQ2hpbGQoY29udGVudCk7CiAgICAgIH0KICAgICAgdmFyIHNwYW4gPSBzcGFuXzsKICAgICAgaWYgKHdyYXBBdCAhPSBudWxsKSB7CiAgICAgICAgdmFyIG91dFBvcyA9IDAsIGFuY2hvciA9IHByZS5hbmNob3IgPSBlbHQoInNwYW4iKTsKICAgICAgICBzcGFuID0gZnVuY3Rpb24oaHRtbCwgdGV4dCwgc3R5bGUpIHsKICAgICAgICAgIHZhciBsID0gdGV4dC5sZW5ndGg7CiAgICAgICAgICBpZiAod3JhcEF0ID49IG91dFBvcyAmJiB3cmFwQXQgPCBvdXRQb3MgKyBsKSB7CiAgICAgICAgICAgIGlmICh3cmFwQXQgPiBvdXRQb3MpIHsKICAgICAgICAgICAgICBzcGFuXyhodG1sLCB0ZXh0LnNsaWNlKDAsIHdyYXBBdCAtIG91dFBvcyksIHN0eWxlKTsKICAgICAgICAgICAgICAvLyBTZWUgY29tbWVudCBhdCB0aGUgZGVmaW5pdGlvbiBvZiBzcGFuQWZmZWN0c1dyYXBwaW5nCiAgICAgICAgICAgICAgaWYgKGNvbXBlbnNhdGVGb3JXcmFwcGluZykgaHRtbC5hcHBlbmRDaGlsZChlbHQoIndiciIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBodG1sLmFwcGVuZENoaWxkKGFuY2hvcik7CiAgICAgICAgICAgIHZhciBjdXQgPSB3cmFwQXQgLSBvdXRQb3M7CiAgICAgICAgICAgIHNwYW5fKGFuY2hvciwgb3BlcmEgPyB0ZXh0LnNsaWNlKGN1dCwgY3V0ICsgMSkgOiB0ZXh0LnNsaWNlKGN1dCksIHN0eWxlKTsKICAgICAgICAgICAgaWYgKG9wZXJhKSBzcGFuXyhodG1sLCB0ZXh0LnNsaWNlKGN1dCArIDEpLCBzdHlsZSk7CiAgICAgICAgICAgIHdyYXBBdC0tOwogICAgICAgICAgICBvdXRQb3MgKz0gbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG91dFBvcyArPSBsOwogICAgICAgICAgICBzcGFuXyhodG1sLCB0ZXh0LCBzdHlsZSk7CiAgICAgICAgICAgIGlmIChvdXRQb3MgPT0gd3JhcEF0ICYmIG91dFBvcyA9PSBsZW4pIHsKICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChhbmNob3IsIGVvbFNwYW5Db250ZW50KTsKICAgICAgICAgICAgICBodG1sLmFwcGVuZENoaWxkKGFuY2hvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3RvcCBvdXRwdXR0aW5nIEhUTUwgd2hlbiBnb25lIHN1ZmZpY2llbnRseSBmYXIgYmV5b25kIG1lYXN1cmUKICAgICAgICAgICAgZWxzZSBpZiAob3V0UG9zID4gd3JhcEF0ICsgMTAgJiYgL1xzLy50ZXN0KHRleHQpKSBzcGFuID0gZnVuY3Rpb24oKXt9OwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHZhciBzdCA9IHRoaXMuc3R5bGVzLCBhbGxUZXh0ID0gdGhpcy50ZXh0LCBtYXJrZWQgPSB0aGlzLm1hcmtlZFNwYW5zOwogICAgICB2YXIgbGVuID0gYWxsVGV4dC5sZW5ndGg7CiAgICAgIGZ1bmN0aW9uIHN0eWxlVG9DbGFzcyhzdHlsZSkgewogICAgICAgIGlmICghc3R5bGUpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiAiY20tIiArIHN0eWxlLnJlcGxhY2UoLyArL2csICIgY20tIik7CiAgICAgIH0KICAgICAgaWYgKCFhbGxUZXh0ICYmIHdyYXBBdCA9PSBudWxsKSB7CiAgICAgICAgc3BhbihwcmUsICIgIik7CiAgICAgIH0gZWxzZSBpZiAoIW1hcmtlZCB8fCAhbWFya2VkLmxlbmd0aCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBjaCA9IDA7IGNoIDwgbGVuOyBpKz0yKSB7CiAgICAgICAgICB2YXIgc3RyID0gc3RbaV0sIHN0eWxlID0gc3RbaSsxXSwgbCA9IHN0ci5sZW5ndGg7CiAgICAgICAgICBpZiAoY2ggKyBsID4gbGVuKSBzdHIgPSBzdHIuc2xpY2UoMCwgbGVuIC0gY2gpOwogICAgICAgICAgY2ggKz0gbDsKICAgICAgICAgIHNwYW4ocHJlLCBzdHIsIHN0eWxlVG9DbGFzcyhzdHlsZSkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBtYXJrZWQuc29ydChmdW5jdGlvbihhLCBiKSB7IHJldHVybiBhLmZyb20gLSBiLmZyb207IH0pOwogICAgICAgIHZhciBwb3MgPSAwLCBpID0gMCwgdGV4dCA9ICIiLCBzdHlsZSwgc2cgPSAwOwogICAgICAgIHZhciBuZXh0Q2hhbmdlID0gbWFya2VkWzBdLmZyb20gfHwgMCwgbWFya3MgPSBbXSwgbWFya3BvcyA9IDA7CiAgICAgICAgdmFyIGFkdmFuY2VNYXJrcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG07CiAgICAgICAgICB3aGlsZSAobWFya3BvcyA8IG1hcmtlZC5sZW5ndGggJiYKICAgICAgICAgICAgICAgICAoKG0gPSBtYXJrZWRbbWFya3Bvc10pLmZyb20gPT0gcG9zIHx8IG0uZnJvbSA9PSBudWxsKSkgewogICAgICAgICAgICBpZiAobS5tYXJrZXIudHlwZSA9PSAicmFuZ2UiKSBtYXJrcy5wdXNoKG0pOwogICAgICAgICAgICArK21hcmtwb3M7CiAgICAgICAgICB9CiAgICAgICAgICBuZXh0Q2hhbmdlID0gbWFya3BvcyA8IG1hcmtlZC5sZW5ndGggPyBtYXJrZWRbbWFya3Bvc10uZnJvbSA6IEluZmluaXR5OwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtYXJrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICB2YXIgdG8gPSBtYXJrc1tpXS50bzsKICAgICAgICAgICAgaWYgKHRvID09IG51bGwpIHRvID0gSW5maW5pdHk7CiAgICAgICAgICAgIGlmICh0byA9PSBwb3MpIG1hcmtzLnNwbGljZShpLS0sIDEpOwogICAgICAgICAgICBlbHNlIG5leHRDaGFuZ2UgPSBNYXRoLm1pbih0bywgbmV4dENoYW5nZSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgbSA9IDA7CiAgICAgICAgd2hpbGUgKHBvcyA8IGxlbikgewogICAgICAgICAgaWYgKG5leHRDaGFuZ2UgPT0gcG9zKSBhZHZhbmNlTWFya3MoKTsKICAgICAgICAgIHZhciB1cHRvID0gTWF0aC5taW4obGVuLCBuZXh0Q2hhbmdlKTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGVuZCA9IHBvcyArIHRleHQubGVuZ3RoOwogICAgICAgICAgICAgIHZhciBhcHBsaWVkU3R5bGUgPSBzdHlsZTsKICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG1hcmtzLmxlbmd0aDsgKytqKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFyayA9IG1hcmtzW2pdOwogICAgICAgICAgICAgICAgYXBwbGllZFN0eWxlID0gKGFwcGxpZWRTdHlsZSA/IGFwcGxpZWRTdHlsZSArICIgIiA6ICIiKSArIG1hcmsubWFya2VyLnN0eWxlOwogICAgICAgICAgICAgICAgaWYgKG1hcmsubWFya2VyLmVuZFN0eWxlICYmIG1hcmsudG8gPT09IE1hdGgubWluKGVuZCwgdXB0bykpIGFwcGxpZWRTdHlsZSArPSAiICIgKyBtYXJrLm1hcmtlci5lbmRTdHlsZTsKICAgICAgICAgICAgICAgIGlmIChtYXJrLm1hcmtlci5zdGFydFN0eWxlICYmIG1hcmsuZnJvbSA9PT0gcG9zKSBhcHBsaWVkU3R5bGUgKz0gIiAiICsgbWFyay5tYXJrZXIuc3RhcnRTdHlsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3BhbihwcmUsIGVuZCA+IHVwdG8gPyB0ZXh0LnNsaWNlKDAsIHVwdG8gLSBwb3MpIDogdGV4dCwgYXBwbGllZFN0eWxlKTsKICAgICAgICAgICAgICBpZiAoZW5kID49IHVwdG8pIHt0ZXh0ID0gdGV4dC5zbGljZSh1cHRvIC0gcG9zKTsgcG9zID0gdXB0bzsgYnJlYWs7fQogICAgICAgICAgICAgIHBvcyA9IGVuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZXh0ID0gc3RbaSsrXTsgc3R5bGUgPSBzdHlsZVRvQ2xhc3Moc3RbaSsrXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwcmU7CiAgICB9LAogICAgY2xlYW5VcDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucGFyZW50ID0gbnVsbDsKICAgICAgZGV0YWNoTWFya2VkU3BhbnModGhpcyk7CiAgICB9CiAgfTsKCiAgLy8gRGF0YSBzdHJ1Y3R1cmUgdGhhdCBob2xkcyB0aGUgc2VxdWVuY2Ugb2YgbGluZXMuCiAgZnVuY3Rpb24gTGVhZkNodW5rKGxpbmVzKSB7CiAgICB0aGlzLmxpbmVzID0gbGluZXM7CiAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgICBmb3IgKHZhciBpID0gMCwgZSA9IGxpbmVzLmxlbmd0aCwgaGVpZ2h0ID0gMDsgaSA8IGU7ICsraSkgewogICAgICBsaW5lc1tpXS5wYXJlbnQgPSB0aGlzOwogICAgICBoZWlnaHQgKz0gbGluZXNbaV0uaGVpZ2h0OwogICAgfQogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgfQogIExlYWZDaHVuay5wcm90b3R5cGUgPSB7CiAgICBjaHVua1NpemU6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5saW5lcy5sZW5ndGg7IH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKGF0LCBuLCBjYWxsYmFja3MpIHsKICAgICAgZm9yICh2YXIgaSA9IGF0LCBlID0gYXQgKyBuOyBpIDwgZTsgKytpKSB7CiAgICAgICAgdmFyIGxpbmUgPSB0aGlzLmxpbmVzW2ldOwogICAgICAgIHRoaXMuaGVpZ2h0IC09IGxpbmUuaGVpZ2h0OwogICAgICAgIGxpbmUuY2xlYW5VcCgpOwogICAgICAgIGlmIChsaW5lLmhhbmRsZXJzKQogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsaW5lLmhhbmRsZXJzLmxlbmd0aDsgKytqKSBjYWxsYmFja3MucHVzaChsaW5lLmhhbmRsZXJzW2pdKTsKICAgICAgfQogICAgICB0aGlzLmxpbmVzLnNwbGljZShhdCwgbik7CiAgICB9LAogICAgY29sbGFwc2U6IGZ1bmN0aW9uKGxpbmVzKSB7CiAgICAgIGxpbmVzLnNwbGljZS5hcHBseShsaW5lcywgW2xpbmVzLmxlbmd0aCwgMF0uY29uY2F0KHRoaXMubGluZXMpKTsKICAgIH0sCiAgICBpbnNlcnRIZWlnaHQ6IGZ1bmN0aW9uKGF0LCBsaW5lcywgaGVpZ2h0KSB7CiAgICAgIHRoaXMuaGVpZ2h0ICs9IGhlaWdodDsKICAgICAgdGhpcy5saW5lcyA9IHRoaXMubGluZXMuc2xpY2UoMCwgYXQpLmNvbmNhdChsaW5lcykuY29uY2F0KHRoaXMubGluZXMuc2xpY2UoYXQpKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGUgPSBsaW5lcy5sZW5ndGg7IGkgPCBlOyArK2kpIGxpbmVzW2ldLnBhcmVudCA9IHRoaXM7CiAgICB9LAogICAgaXRlck46IGZ1bmN0aW9uKGF0LCBuLCBvcCkgewogICAgICBmb3IgKHZhciBlID0gYXQgKyBuOyBhdCA8IGU7ICsrYXQpCiAgICAgICAgaWYgKG9wKHRoaXMubGluZXNbYXRdKSkgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBCcmFuY2hDaHVuayhjaGlsZHJlbikgewogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgdmFyIHNpemUgPSAwLCBoZWlnaHQgPSAwOwogICAgZm9yICh2YXIgaSA9IDAsIGUgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBlOyArK2kpIHsKICAgICAgdmFyIGNoID0gY2hpbGRyZW5baV07CiAgICAgIHNpemUgKz0gY2guY2h1bmtTaXplKCk7IGhlaWdodCArPSBjaC5oZWlnaHQ7CiAgICAgIGNoLnBhcmVudCA9IHRoaXM7CiAgICB9CiAgICB0aGlzLnNpemUgPSBzaXplOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgfQogIEJyYW5jaENodW5rLnByb3RvdHlwZSA9IHsKICAgIGNodW5rU2l6ZTogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLnNpemU7IH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKGF0LCBuLCBjYWxsYmFja3MpIHsKICAgICAgdGhpcy5zaXplIC09IG47CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baV0sIHN6ID0gY2hpbGQuY2h1bmtTaXplKCk7CiAgICAgICAgaWYgKGF0IDwgc3opIHsKICAgICAgICAgIHZhciBybSA9IE1hdGgubWluKG4sIHN6IC0gYXQpLCBvbGRIZWlnaHQgPSBjaGlsZC5oZWlnaHQ7CiAgICAgICAgICBjaGlsZC5yZW1vdmUoYXQsIHJtLCBjYWxsYmFja3MpOwogICAgICAgICAgdGhpcy5oZWlnaHQgLT0gb2xkSGVpZ2h0IC0gY2hpbGQuaGVpZ2h0OwogICAgICAgICAgaWYgKHN6ID09IHJtKSB7IHRoaXMuY2hpbGRyZW4uc3BsaWNlKGktLSwgMSk7IGNoaWxkLnBhcmVudCA9IG51bGw7IH0KICAgICAgICAgIGlmICgobiAtPSBybSkgPT0gMCkgYnJlYWs7CiAgICAgICAgICBhdCA9IDA7CiAgICAgICAgfSBlbHNlIGF0IC09IHN6OwogICAgICB9CiAgICAgIGlmICh0aGlzLnNpemUgLSBuIDwgMjUpIHsKICAgICAgICB2YXIgbGluZXMgPSBbXTsKICAgICAgICB0aGlzLmNvbGxhcHNlKGxpbmVzKTsKICAgICAgICB0aGlzLmNoaWxkcmVuID0gW25ldyBMZWFmQ2h1bmsobGluZXMpXTsKICAgICAgICB0aGlzLmNoaWxkcmVuWzBdLnBhcmVudCA9IHRoaXM7CiAgICAgIH0KICAgIH0sCiAgICBjb2xsYXBzZTogZnVuY3Rpb24obGluZXMpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGUgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGU7ICsraSkgdGhpcy5jaGlsZHJlbltpXS5jb2xsYXBzZShsaW5lcyk7CiAgICB9LAogICAgaW5zZXJ0OiBmdW5jdGlvbihhdCwgbGluZXMpIHsKICAgICAgdmFyIGhlaWdodCA9IDA7CiAgICAgIGZvciAodmFyIGkgPSAwLCBlID0gbGluZXMubGVuZ3RoOyBpIDwgZTsgKytpKSBoZWlnaHQgKz0gbGluZXNbaV0uaGVpZ2h0OwogICAgICB0aGlzLmluc2VydEhlaWdodChhdCwgbGluZXMsIGhlaWdodCk7CiAgICB9LAogICAgaW5zZXJ0SGVpZ2h0OiBmdW5jdGlvbihhdCwgbGluZXMsIGhlaWdodCkgewogICAgICB0aGlzLnNpemUgKz0gbGluZXMubGVuZ3RoOwogICAgICB0aGlzLmhlaWdodCArPSBoZWlnaHQ7CiAgICAgIGZvciAodmFyIGkgPSAwLCBlID0gdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkgPCBlOyArK2kpIHsKICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLmNoaWxkcmVuW2ldLCBzeiA9IGNoaWxkLmNodW5rU2l6ZSgpOwogICAgICAgIGlmIChhdCA8PSBzeikgewogICAgICAgICAgY2hpbGQuaW5zZXJ0SGVpZ2h0KGF0LCBsaW5lcywgaGVpZ2h0KTsKICAgICAgICAgIGlmIChjaGlsZC5saW5lcyAmJiBjaGlsZC5saW5lcy5sZW5ndGggPiA1MCkgewogICAgICAgICAgICB3aGlsZSAoY2hpbGQubGluZXMubGVuZ3RoID4gNTApIHsKICAgICAgICAgICAgICB2YXIgc3BpbGxlZCA9IGNoaWxkLmxpbmVzLnNwbGljZShjaGlsZC5saW5lcy5sZW5ndGggLSAyNSwgMjUpOwogICAgICAgICAgICAgIHZhciBuZXdsZWFmID0gbmV3IExlYWZDaHVuayhzcGlsbGVkKTsKICAgICAgICAgICAgICBjaGlsZC5oZWlnaHQgLT0gbmV3bGVhZi5oZWlnaHQ7CiAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSArIDEsIDAsIG5ld2xlYWYpOwogICAgICAgICAgICAgIG5ld2xlYWYucGFyZW50ID0gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1heWJlU3BpbGwoKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBhdCAtPSBzejsKICAgICAgfQogICAgfSwKICAgIG1heWJlU3BpbGw6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPD0gMTApIHJldHVybjsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgZG8gewogICAgICAgIHZhciBzcGlsbGVkID0gbWUuY2hpbGRyZW4uc3BsaWNlKG1lLmNoaWxkcmVuLmxlbmd0aCAtIDUsIDUpOwogICAgICAgIHZhciBzaWJsaW5nID0gbmV3IEJyYW5jaENodW5rKHNwaWxsZWQpOwogICAgICAgIGlmICghbWUucGFyZW50KSB7IC8vIEJlY29tZSB0aGUgcGFyZW50IG5vZGUKICAgICAgICAgIHZhciBjb3B5ID0gbmV3IEJyYW5jaENodW5rKG1lLmNoaWxkcmVuKTsKICAgICAgICAgIGNvcHkucGFyZW50ID0gbWU7CiAgICAgICAgICBtZS5jaGlsZHJlbiA9IFtjb3B5LCBzaWJsaW5nXTsKICAgICAgICAgIG1lID0gY29weTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWUuc2l6ZSAtPSBzaWJsaW5nLnNpemU7CiAgICAgICAgICBtZS5oZWlnaHQgLT0gc2libGluZy5oZWlnaHQ7CiAgICAgICAgICB2YXIgbXlJbmRleCA9IGluZGV4T2YobWUucGFyZW50LmNoaWxkcmVuLCBtZSk7CiAgICAgICAgICBtZS5wYXJlbnQuY2hpbGRyZW4uc3BsaWNlKG15SW5kZXggKyAxLCAwLCBzaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgc2libGluZy5wYXJlbnQgPSBtZS5wYXJlbnQ7CiAgICAgIH0gd2hpbGUgKG1lLmNoaWxkcmVuLmxlbmd0aCA+IDEwKTsKICAgICAgbWUucGFyZW50Lm1heWJlU3BpbGwoKTsKICAgIH0sCiAgICBpdGVyOiBmdW5jdGlvbihmcm9tLCB0bywgb3ApIHsgdGhpcy5pdGVyTihmcm9tLCB0byAtIGZyb20sIG9wKTsgfSwKICAgIGl0ZXJOOiBmdW5jdGlvbihhdCwgbiwgb3ApIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGUgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGU7ICsraSkgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baV0sIHN6ID0gY2hpbGQuY2h1bmtTaXplKCk7CiAgICAgICAgaWYgKGF0IDwgc3opIHsKICAgICAgICAgIHZhciB1c2VkID0gTWF0aC5taW4obiwgc3ogLSBhdCk7CiAgICAgICAgICBpZiAoY2hpbGQuaXRlck4oYXQsIHVzZWQsIG9wKSkgcmV0dXJuIHRydWU7CiAgICAgICAgICBpZiAoKG4gLT0gdXNlZCkgPT0gMCkgYnJlYWs7CiAgICAgICAgICBhdCA9IDA7CiAgICAgICAgfSBlbHNlIGF0IC09IHN6OwogICAgICB9CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0TGluZUF0KGNodW5rLCBuKSB7CiAgICB3aGlsZSAoIWNodW5rLmxpbmVzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOzsgKytpKSB7CiAgICAgICAgdmFyIGNoaWxkID0gY2h1bmsuY2hpbGRyZW5baV0sIHN6ID0gY2hpbGQuY2h1bmtTaXplKCk7CiAgICAgICAgaWYgKG4gPCBzeikgeyBjaHVuayA9IGNoaWxkOyBicmVhazsgfQogICAgICAgIG4gLT0gc3o7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjaHVuay5saW5lc1tuXTsKICB9CiAgZnVuY3Rpb24gbGluZU5vKGxpbmUpIHsKICAgIGlmIChsaW5lLnBhcmVudCA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIHZhciBjdXIgPSBsaW5lLnBhcmVudCwgbm8gPSBpbmRleE9mKGN1ci5saW5lcywgbGluZSk7CiAgICBmb3IgKHZhciBjaHVuayA9IGN1ci5wYXJlbnQ7IGNodW5rOyBjdXIgPSBjaHVuaywgY2h1bmsgPSBjaHVuay5wYXJlbnQpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGUgPSBjaHVuay5jaGlsZHJlbi5sZW5ndGg7IDsgKytpKSB7CiAgICAgICAgaWYgKGNodW5rLmNoaWxkcmVuW2ldID09IGN1cikgYnJlYWs7CiAgICAgICAgbm8gKz0gY2h1bmsuY2hpbGRyZW5baV0uY2h1bmtTaXplKCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBubzsKICB9CiAgZnVuY3Rpb24gbGluZUF0SGVpZ2h0KGNodW5rLCBoKSB7CiAgICB2YXIgbiA9IDA7CiAgICBvdXRlcjogZG8gewogICAgICBmb3IgKHZhciBpID0gMCwgZSA9IGNodW5rLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGU7ICsraSkgewogICAgICAgIHZhciBjaGlsZCA9IGNodW5rLmNoaWxkcmVuW2ldLCBjaCA9IGNoaWxkLmhlaWdodDsKICAgICAgICBpZiAoaCA8IGNoKSB7IGNodW5rID0gY2hpbGQ7IGNvbnRpbnVlIG91dGVyOyB9CiAgICAgICAgaCAtPSBjaDsKICAgICAgICBuICs9IGNoaWxkLmNodW5rU2l6ZSgpOwogICAgICB9CiAgICAgIHJldHVybiBuOwogICAgfSB3aGlsZSAoIWNodW5rLmxpbmVzKTsKICAgIGZvciAodmFyIGkgPSAwLCBlID0gY2h1bmsubGluZXMubGVuZ3RoOyBpIDwgZTsgKytpKSB7CiAgICAgIHZhciBsaW5lID0gY2h1bmsubGluZXNbaV0sIGxoID0gbGluZS5oZWlnaHQ7CiAgICAgIGlmIChoIDwgbGgpIGJyZWFrOwogICAgICBoIC09IGxoOwogICAgfQogICAgcmV0dXJuIG4gKyBpOwogIH0KICBmdW5jdGlvbiBoZWlnaHRBdExpbmUoY2h1bmssIG4pIHsKICAgIHZhciBoID0gMDsKICAgIG91dGVyOiBkbyB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBlID0gY2h1bmsuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgZTsgKytpKSB7CiAgICAgICAgdmFyIGNoaWxkID0gY2h1bmsuY2hpbGRyZW5baV0sIHN6ID0gY2hpbGQuY2h1bmtTaXplKCk7CiAgICAgICAgaWYgKG4gPCBzeikgeyBjaHVuayA9IGNoaWxkOyBjb250aW51ZSBvdXRlcjsgfQogICAgICAgIG4gLT0gc3o7CiAgICAgICAgaCArPSBjaGlsZC5oZWlnaHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGg7CiAgICB9IHdoaWxlICghY2h1bmsubGluZXMpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIGggKz0gY2h1bmsubGluZXNbaV0uaGVpZ2h0OwogICAgcmV0dXJuIGg7CiAgfQoKICAvLyBUaGUgaGlzdG9yeSBvYmplY3QgJ2NodW5rcycgY2hhbmdlcyB0aGF0IGFyZSBtYWRlIGNsb3NlIHRvZ2V0aGVyCiAgLy8gYW5kIGF0IGFsbW9zdCB0aGUgc2FtZSB0aW1lIGludG8gYmlnZ2VyIHVuZG9hYmxlIHVuaXRzLgogIGZ1bmN0aW9uIEhpc3RvcnkoKSB7CiAgICB0aGlzLnRpbWUgPSAwOwogICAgdGhpcy5kb25lID0gW107IHRoaXMudW5kb25lID0gW107CiAgICB0aGlzLmNvbXBvdW5kID0gMDsKICAgIHRoaXMuY2xvc2VkID0gZmFsc2U7CiAgfQogIEhpc3RvcnkucHJvdG90eXBlID0gewogICAgYWRkQ2hhbmdlOiBmdW5jdGlvbihzdGFydCwgYWRkZWQsIG9sZCkgewogICAgICB0aGlzLnVuZG9uZS5sZW5ndGggPSAwOwogICAgICB2YXIgdGltZSA9ICtuZXcgRGF0ZSwgY3VyID0gbHN0KHRoaXMuZG9uZSksIGxhc3QgPSBjdXIgJiYgbHN0KGN1cik7CiAgICAgIHZhciBkdGltZSA9IHRpbWUgLSB0aGlzLnRpbWU7CgogICAgICBpZiAodGhpcy5jb21wb3VuZCAmJiBjdXIgJiYgIXRoaXMuY2xvc2VkKSB7CiAgICAgICAgY3VyLnB1c2goe3N0YXJ0OiBzdGFydCwgYWRkZWQ6IGFkZGVkLCBvbGQ6IG9sZH0pOwogICAgICB9IGVsc2UgaWYgKGR0aW1lID4gNDAwIHx8ICFsYXN0IHx8IHRoaXMuY2xvc2VkIHx8CiAgICAgICAgICAgICAgICAgbGFzdC5zdGFydCA+IHN0YXJ0ICsgb2xkLmxlbmd0aCB8fCBsYXN0LnN0YXJ0ICsgbGFzdC5hZGRlZCA8IHN0YXJ0KSB7CiAgICAgICAgdGhpcy5kb25lLnB1c2goW3tzdGFydDogc3RhcnQsIGFkZGVkOiBhZGRlZCwgb2xkOiBvbGR9XSk7CiAgICAgICAgdGhpcy5jbG9zZWQgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgc3RhcnRCZWZvcmUgPSBNYXRoLm1heCgwLCBsYXN0LnN0YXJ0IC0gc3RhcnQpLAogICAgICAgICAgICBlbmRBZnRlciA9IE1hdGgubWF4KDAsIChzdGFydCArIG9sZC5sZW5ndGgpIC0gKGxhc3Quc3RhcnQgKyBsYXN0LmFkZGVkKSk7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0QmVmb3JlOyBpID4gMDsgLS1pKSBsYXN0Lm9sZC51bnNoaWZ0KG9sZFtpIC0gMV0pOwogICAgICAgIGZvciAodmFyIGkgPSBlbmRBZnRlcjsgaSA+IDA7IC0taSkgbGFzdC5vbGQucHVzaChvbGRbb2xkLmxlbmd0aCAtIGldKTsKICAgICAgICBpZiAoc3RhcnRCZWZvcmUpIGxhc3Quc3RhcnQgPSBzdGFydDsKICAgICAgICBsYXN0LmFkZGVkICs9IGFkZGVkIC0gKG9sZC5sZW5ndGggLSBzdGFydEJlZm9yZSAtIGVuZEFmdGVyKTsKICAgICAgfQogICAgICB0aGlzLnRpbWUgPSB0aW1lOwogICAgfSwKICAgIHN0YXJ0Q29tcG91bmQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuY29tcG91bmQrKykgdGhpcy5jbG9zZWQgPSB0cnVlOwogICAgfSwKICAgIGVuZENvbXBvdW5kOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEtLXRoaXMuY29tcG91bmQpIHRoaXMuY2xvc2VkID0gdHJ1ZTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBzdG9wTWV0aG9kKCkge2Vfc3RvcCh0aGlzKTt9CiAgLy8gRW5zdXJlIGFuIGV2ZW50IGhhcyBhIHN0b3AgbWV0aG9kLgogIGZ1bmN0aW9uIGFkZFN0b3AoZXZlbnQpIHsKICAgIGlmICghZXZlbnQuc3RvcCkgZXZlbnQuc3RvcCA9IHN0b3BNZXRob2Q7CiAgICByZXR1cm4gZXZlbnQ7CiAgfQoKICBmdW5jdGlvbiBlX3ByZXZlbnREZWZhdWx0KGUpIHsKICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBlbHNlIGUucmV0dXJuVmFsdWUgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gZV9zdG9wUHJvcGFnYXRpb24oZSkgewogICAgaWYgKGUuc3RvcFByb3BhZ2F0aW9uKSBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgZWxzZSBlLmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgfQogIGZ1bmN0aW9uIGVfc3RvcChlKSB7ZV9wcmV2ZW50RGVmYXVsdChlKTsgZV9zdG9wUHJvcGFnYXRpb24oZSk7fQogIENvZGVNaXJyb3IuZV9zdG9wID0gZV9zdG9wOwogIENvZGVNaXJyb3IuZV9wcmV2ZW50RGVmYXVsdCA9IGVfcHJldmVudERlZmF1bHQ7CiAgQ29kZU1pcnJvci5lX3N0b3BQcm9wYWdhdGlvbiA9IGVfc3RvcFByb3BhZ2F0aW9uOwoKICBmdW5jdGlvbiBlX3RhcmdldChlKSB7cmV0dXJuIGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudDt9CiAgZnVuY3Rpb24gZV9idXR0b24oZSkgewogICAgdmFyIGIgPSBlLndoaWNoOwogICAgaWYgKGIgPT0gbnVsbCkgewogICAgICBpZiAoZS5idXR0b24gJiAxKSBiID0gMTsKICAgICAgZWxzZSBpZiAoZS5idXR0b24gJiAyKSBiID0gMzsKICAgICAgZWxzZSBpZiAoZS5idXR0b24gJiA0KSBiID0gMjsKICAgIH0KICAgIGlmIChtYWMgJiYgZS5jdHJsS2V5ICYmIGIgPT0gMSkgYiA9IDM7CiAgICByZXR1cm4gYjsKICB9CgogIC8vIEFsbG93IDNyZC1wYXJ0eSBjb2RlIHRvIG92ZXJyaWRlIGV2ZW50IHByb3BlcnRpZXMgYnkgYWRkaW5nIGFuIG92ZXJyaWRlCiAgLy8gb2JqZWN0IHRvIGFuIGV2ZW50IG9iamVjdC4KICBmdW5jdGlvbiBlX3Byb3AoZSwgcHJvcCkgewogICAgdmFyIG92ZXJyaWRkZW4gPSBlLm92ZXJyaWRlICYmIGUub3ZlcnJpZGUuaGFzT3duUHJvcGVydHkocHJvcCk7CiAgICByZXR1cm4gb3ZlcnJpZGRlbiA/IGUub3ZlcnJpZGVbcHJvcF0gOiBlW3Byb3BdOwogIH0KCiAgLy8gRXZlbnQgaGFuZGxlciByZWdpc3RyYXRpb24uIElmIGRpc2Nvbm5lY3QgaXMgdHJ1ZSwgaXQnbGwgcmV0dXJuIGEKICAvLyBmdW5jdGlvbiB0aGF0IHVucmVnaXN0ZXJzIHRoZSBoYW5kbGVyLgogIGZ1bmN0aW9uIGNvbm5lY3Qobm9kZSwgdHlwZSwgaGFuZGxlciwgZGlzY29ubmVjdCkgewogICAgaWYgKHR5cGVvZiBub2RlLmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikgewogICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlciwgZmFsc2UpOwogICAgICBpZiAoZGlzY29ubmVjdCkgcmV0dXJuIGZ1bmN0aW9uKCkge25vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyLCBmYWxzZSk7fTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB3cmFwSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7aGFuZGxlcihldmVudCB8fCB3aW5kb3cuZXZlbnQpO307CiAgICAgIG5vZGUuYXR0YWNoRXZlbnQoIm9uIiArIHR5cGUsIHdyYXBIYW5kbGVyKTsKICAgICAgaWYgKGRpc2Nvbm5lY3QpIHJldHVybiBmdW5jdGlvbigpIHtub2RlLmRldGFjaEV2ZW50KCJvbiIgKyB0eXBlLCB3cmFwSGFuZGxlcik7fTsKICAgIH0KICB9CiAgQ29kZU1pcnJvci5jb25uZWN0ID0gY29ubmVjdDsKCiAgZnVuY3Rpb24gRGVsYXllZCgpIHt0aGlzLmlkID0gbnVsbDt9CiAgRGVsYXllZC5wcm90b3R5cGUgPSB7c2V0OiBmdW5jdGlvbihtcywgZikge2NsZWFyVGltZW91dCh0aGlzLmlkKTsgdGhpcy5pZCA9IHNldFRpbWVvdXQoZiwgbXMpO319OwoKICB2YXIgUGFzcyA9IENvZGVNaXJyb3IuUGFzcyA9IHt0b1N0cmluZzogZnVuY3Rpb24oKXtyZXR1cm4gIkNvZGVNaXJyb3IuUGFzcyI7fX07CgogIC8vIERldGVjdCBkcmFnLWFuZC1kcm9wCiAgdmFyIGRyYWdBbmREcm9wID0gZnVuY3Rpb24oKSB7CiAgICAvLyBUaGVyZSBpcyAqc29tZSoga2luZCBvZiBkcmFnLWFuZC1kcm9wIHN1cHBvcnQgaW4gSUU2LTgsIGJ1dCBJCiAgICAvLyBjb3VsZG4ndCBnZXQgaXQgdG8gd29yayB5ZXQuCiAgICBpZiAoaWVfbHQ5KSByZXR1cm4gZmFsc2U7CiAgICB2YXIgZGl2ID0gZWx0KCdkaXYnKTsKICAgIHJldHVybiAiZHJhZ2dhYmxlIiBpbiBkaXYgfHwgImRyYWdEcm9wIiBpbiBkaXY7CiAgfSgpOwoKICAvLyBGZWF0dXJlLWRldGVjdCB3aGV0aGVyIG5ld2xpbmVzIGluIHRleHRhcmVhcyBhcmUgY29udmVydGVkIHRvIFxyXG4KICB2YXIgbGluZVNlcCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0ZSA9IGVsdCgidGV4dGFyZWEiKTsKICAgIHRlLnZhbHVlID0gImZvb1xuYmFyIjsKICAgIGlmICh0ZS52YWx1ZS5pbmRleE9mKCJcciIpID4gLTEpIHJldHVybiAiXHJcbiI7CiAgICByZXR1cm4gIlxuIjsKICB9KCk7CgogIC8vIEZvciBhIHJlYXNvbiBJIGhhdmUgeWV0IHRvIGZpZ3VyZSBvdXQsIHNvbWUgYnJvd3NlcnMgZGlzYWxsb3cKICAvLyB3b3JkIHdyYXBwaW5nIGJldHdlZW4gY2VydGFpbiBjaGFyYWN0ZXJzICpvbmx5KiBpZiBhIG5ldyBpbmxpbmUKICAvLyBlbGVtZW50IGlzIHN0YXJ0ZWQgYmV0d2VlbiB0aGVtLiBUaGlzIG1ha2VzIGl0IGhhcmQgdG8gcmVsaWFibHkKICAvLyBtZWFzdXJlIHRoZSBwb3NpdGlvbiBvZiB0aGluZ3MsIHNpbmNlIHRoYXQgcmVxdWlyZXMgaW5zZXJ0aW5nIGFuCiAgLy8gZXh0cmEgc3Bhbi4gVGhpcyB0ZXJyaWJseSBmcmFnaWxlIHNldCBvZiByZWdleHBzIG1hdGNoZXMgdGhlCiAgLy8gY2hhcmFjdGVyIGNvbWJpbmF0aW9ucyB0aGF0IHN1ZmZlciBmcm9tIHRoaXMgcGhlbm9tZW5vbiBvbiB0aGUKICAvLyB2YXJpb3VzIGJyb3dzZXJzLgogIHZhciBzcGFuQWZmZWN0c1dyYXBwaW5nID0gL14kLzsgLy8gV29uJ3QgbWF0Y2ggYW55IHR3by1jaGFyYWN0ZXIgc3RyaW5nCiAgaWYgKGdlY2tvKSBzcGFuQWZmZWN0c1dyYXBwaW5nID0gLyQnLzsKICBlbHNlIGlmIChzYWZhcmkpIHNwYW5BZmZlY3RzV3JhcHBpbmcgPSAvXC1bXiBcLT9dfFw/W14gISdcIlwpLC5cLVwvOjtcP1xdXH1dLzsKICBlbHNlIGlmIChjaHJvbWUpIHNwYW5BZmZlY3RzV3JhcHBpbmcgPSAvXC1bXiBcLVwuP118XD9bXiBcLVwuP1xdXH06OyEnXCJcKSxcL118W1wuIVwiIyYlXCkqKyw6Oz0+XF18XH1+XVtcKFx7XFs8XXxcJCcvOwoKICAvLyBDb3VudHMgdGhlIGNvbHVtbiBvZmZzZXQgaW4gYSBzdHJpbmcsIHRha2luZyB0YWJzIGludG8gYWNjb3VudC4KICAvLyBVc2VkIG1vc3RseSB0byBmaW5kIGluZGVudGF0aW9uLgogIGZ1bmN0aW9uIGNvdW50Q29sdW1uKHN0cmluZywgZW5kLCB0YWJTaXplKSB7CiAgICBpZiAoZW5kID09IG51bGwpIHsKICAgICAgZW5kID0gc3RyaW5nLnNlYXJjaCgvW15cc1x1MDBhMF0vKTsKICAgICAgaWYgKGVuZCA9PSAtMSkgZW5kID0gc3RyaW5nLmxlbmd0aDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwLCBuID0gMDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIGlmIChzdHJpbmcuY2hhckF0KGkpID09ICJcdCIpIG4gKz0gdGFiU2l6ZSAtIChuICUgdGFiU2l6ZSk7CiAgICAgIGVsc2UgKytuOwogICAgfQogICAgcmV0dXJuIG47CiAgfQoKICBmdW5jdGlvbiBlbHRPZmZzZXQobm9kZSwgc2NyZWVuKSB7CiAgICAvLyBUYWtlIHRoZSBwYXJ0cyBvZiBib3VuZGluZyBjbGllbnQgcmVjdCB0aGF0IHdlIGFyZSBpbnRlcmVzdGVkIGluIHNvIHdlIGFyZSBhYmxlIHRvIGVkaXQgaWYgbmVlZCBiZSwKICAgIC8vIHNpbmNlIHRoZSByZXR1cm5lZCB2YWx1ZSBjYW5ub3QgYmUgY2hhbmdlZCBleHRlcm5hbGx5ICh0aGV5IGFyZSBrZXB0IGluIHN5bmMgYXMgdGhlIGVsZW1lbnQgbW92ZXMgd2l0aGluIHRoZSBwYWdlKQogICAgdHJ5IHsgdmFyIGJveCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7IGJveCA9IHsgdG9wOiBib3gudG9wLCBsZWZ0OiBib3gubGVmdCB9OyB9CiAgICBjYXRjaChlKSB7IGJveCA9IHt0b3A6IDAsIGxlZnQ6IDB9OyB9CiAgICBpZiAoIXNjcmVlbikgewogICAgICAvLyBHZXQgdGhlIHRvcGxldmVsIHNjcm9sbCwgd29ya2luZyBhcm91bmQgYnJvd3NlciBkaWZmZXJlbmNlcy4KICAgICAgaWYgKHdpbmRvdy5wYWdlWU9mZnNldCA9PSBudWxsKSB7CiAgICAgICAgdmFyIHQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlOwogICAgICAgIGlmICh0LnNjcm9sbFRvcCA9PSBudWxsKSB0ID0gZG9jdW1lbnQuYm9keTsKICAgICAgICBib3gudG9wICs9IHQuc2Nyb2xsVG9wOyBib3gubGVmdCArPSB0LnNjcm9sbExlZnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYm94LnRvcCArPSB3aW5kb3cucGFnZVlPZmZzZXQ7IGJveC5sZWZ0ICs9IHdpbmRvdy5wYWdlWE9mZnNldDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGJveDsKICB9CgogIGZ1bmN0aW9uIGVsdFRleHQobm9kZSkgewogICAgcmV0dXJuIG5vZGUudGV4dENvbnRlbnQgfHwgbm9kZS5pbm5lclRleHQgfHwgbm9kZS5ub2RlVmFsdWUgfHwgIiI7CiAgfQoKICB2YXIgc3BhY2VTdHJzID0gWyIiXTsKICBmdW5jdGlvbiBzcGFjZVN0cihuKSB7CiAgICB3aGlsZSAoc3BhY2VTdHJzLmxlbmd0aCA8PSBuKQogICAgICBzcGFjZVN0cnMucHVzaChsc3Qoc3BhY2VTdHJzKSArICIgIik7CiAgICByZXR1cm4gc3BhY2VTdHJzW25dOwogIH0KCiAgZnVuY3Rpb24gbHN0KGFycikgeyByZXR1cm4gYXJyW2Fyci5sZW5ndGgtMV07IH0KCiAgZnVuY3Rpb24gc2VsZWN0SW5wdXQobm9kZSkgewogICAgaWYgKGlvcykgeyAvLyBNb2JpbGUgU2FmYXJpIGFwcGFyZW50bHkgaGFzIGEgYnVnIHdoZXJlIHNlbGVjdCgpIGlzIGJyb2tlbi4KICAgICAgbm9kZS5zZWxlY3Rpb25TdGFydCA9IDA7CiAgICAgIG5vZGUuc2VsZWN0aW9uRW5kID0gbm9kZS52YWx1ZS5sZW5ndGg7CiAgICB9IGVsc2Ugbm9kZS5zZWxlY3QoKTsKICB9CgogIC8vIE9wZXJhdGlvbnMgb24ge2xpbmUsIGNofSBvYmplY3RzLgogIGZ1bmN0aW9uIHBvc0VxKGEsIGIpIHtyZXR1cm4gYS5saW5lID09IGIubGluZSAmJiBhLmNoID09IGIuY2g7fQogIGZ1bmN0aW9uIHBvc0xlc3MoYSwgYikge3JldHVybiBhLmxpbmUgPCBiLmxpbmUgfHwgKGEubGluZSA9PSBiLmxpbmUgJiYgYS5jaCA8IGIuY2gpO30KICBmdW5jdGlvbiBjb3B5UG9zKHgpIHtyZXR1cm4ge2xpbmU6IHgubGluZSwgY2g6IHguY2h9O30KCiAgZnVuY3Rpb24gZWx0KHRhZywgY29udGVudCwgY2xhc3NOYW1lLCBzdHlsZSkgewogICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7CiAgICBpZiAoY2xhc3NOYW1lKSBlLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTsKICAgIGlmIChzdHlsZSkgZS5zdHlsZS5jc3NUZXh0ID0gc3R5bGU7CiAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT0gInN0cmluZyIpIHNldFRleHRDb250ZW50KGUsIGNvbnRlbnQpOwogICAgZWxzZSBpZiAoY29udGVudCkgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZW50Lmxlbmd0aDsgKytpKSBlLmFwcGVuZENoaWxkKGNvbnRlbnRbaV0pOwogICAgcmV0dXJuIGU7CiAgfQogIGZ1bmN0aW9uIHJlbW92ZUNoaWxkcmVuKGUpIHsKICAgIGUuaW5uZXJIVE1MID0gIiI7CiAgICByZXR1cm4gZTsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlQ2hpbGRyZW5BbmRBZGQocGFyZW50LCBlKSB7CiAgICByZW1vdmVDaGlsZHJlbihwYXJlbnQpLmFwcGVuZENoaWxkKGUpOwogIH0KICBmdW5jdGlvbiBzZXRUZXh0Q29udGVudChlLCBzdHIpIHsKICAgIGlmIChpZV9sdDkpIHsKICAgICAgZS5pbm5lckhUTUwgPSAiIjsKICAgICAgZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShzdHIpKTsKICAgIH0gZWxzZSBlLnRleHRDb250ZW50ID0gc3RyOwogIH0KCiAgLy8gVXNlZCB0byBwb3NpdGlvbiB0aGUgY3Vyc29yIGFmdGVyIGFuIHVuZG8vcmVkbyBieSBmaW5kaW5nIHRoZQogIC8vIGxhc3QgZWRpdGVkIGNoYXJhY3Rlci4KICBmdW5jdGlvbiBlZGl0RW5kKGZyb20sIHRvKSB7CiAgICBpZiAoIXRvKSByZXR1cm4gMDsKICAgIGlmICghZnJvbSkgcmV0dXJuIHRvLmxlbmd0aDsKICAgIGZvciAodmFyIGkgPSBmcm9tLmxlbmd0aCwgaiA9IHRvLmxlbmd0aDsgaSA+PSAwICYmIGogPj0gMDsgLS1pLCAtLWopCiAgICAgIGlmIChmcm9tLmNoYXJBdChpKSAhPSB0by5jaGFyQXQoaikpIGJyZWFrOwogICAgcmV0dXJuIGogKyAxOwogIH0KCiAgZnVuY3Rpb24gaW5kZXhPZihjb2xsZWN0aW9uLCBlbHQpIHsKICAgIGlmIChjb2xsZWN0aW9uLmluZGV4T2YpIHJldHVybiBjb2xsZWN0aW9uLmluZGV4T2YoZWx0KTsKICAgIGZvciAodmFyIGkgPSAwLCBlID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBlOyArK2kpCiAgICAgIGlmIChjb2xsZWN0aW9uW2ldID09IGVsdCkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfQogIGZ1bmN0aW9uIGlzV29yZENoYXIoY2gpIHsKICAgIHJldHVybiAvXHcvLnRlc3QoY2gpIHx8IGNoLnRvVXBwZXJDYXNlKCkgIT0gY2gudG9Mb3dlckNhc2UoKTsKICB9CgogIC8vIFNlZSBpZiAiIi5zcGxpdCBpcyB0aGUgYnJva2VuIElFIHZlcnNpb24sIGlmIHNvLCBwcm92aWRlIGFuCiAgLy8gYWx0ZXJuYXRpdmUgd2F5IHRvIHNwbGl0IGxpbmVzLgogIHZhciBzcGxpdExpbmVzID0gIlxuXG5iIi5zcGxpdCgvXG4vKS5sZW5ndGggIT0gMyA/IGZ1bmN0aW9uKHN0cmluZykgewogICAgdmFyIHBvcyA9IDAsIHJlc3VsdCA9IFtdLCBsID0gc3RyaW5nLmxlbmd0aDsKICAgIHdoaWxlIChwb3MgPD0gbCkgewogICAgICB2YXIgbmwgPSBzdHJpbmcuaW5kZXhPZigiXG4iLCBwb3MpOwogICAgICBpZiAobmwgPT0gLTEpIG5sID0gc3RyaW5nLmxlbmd0aDsKICAgICAgdmFyIGxpbmUgPSBzdHJpbmcuc2xpY2UocG9zLCBzdHJpbmcuY2hhckF0KG5sIC0gMSkgPT0gIlxyIiA/IG5sIC0gMSA6IG5sKTsKICAgICAgdmFyIHJ0ID0gbGluZS5pbmRleE9mKCJcciIpOwogICAgICBpZiAocnQgIT0gLTEpIHsKICAgICAgICByZXN1bHQucHVzaChsaW5lLnNsaWNlKDAsIHJ0KSk7CiAgICAgICAgcG9zICs9IHJ0ICsgMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucHVzaChsaW5lKTsKICAgICAgICBwb3MgPSBubCArIDE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSA6IGZ1bmN0aW9uKHN0cmluZyl7cmV0dXJuIHN0cmluZy5zcGxpdCgvXHJcbj98XG4vKTt9OwogIENvZGVNaXJyb3Iuc3BsaXRMaW5lcyA9IHNwbGl0TGluZXM7CgogIHZhciBoYXNTZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uID8gZnVuY3Rpb24odGUpIHsKICAgIHRyeSB7IHJldHVybiB0ZS5zZWxlY3Rpb25TdGFydCAhPSB0ZS5zZWxlY3Rpb25FbmQ7IH0KICAgIGNhdGNoKGUpIHsgcmV0dXJuIGZhbHNlOyB9CiAgfSA6IGZ1bmN0aW9uKHRlKSB7CiAgICB0cnkge3ZhciByYW5nZSA9IHRlLm93bmVyRG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7fQogICAgY2F0Y2goZSkge30KICAgIGlmICghcmFuZ2UgfHwgcmFuZ2UucGFyZW50RWxlbWVudCgpICE9IHRlKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gcmFuZ2UuY29tcGFyZUVuZFBvaW50cygiU3RhcnRUb0VuZCIsIHJhbmdlKSAhPSAwOwogIH07CgogIENvZGVNaXJyb3IuZGVmaW5lTW9kZSgibnVsbCIsIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHt0b2tlbjogZnVuY3Rpb24oc3RyZWFtKSB7c3RyZWFtLnNraXBUb0VuZCgpO319OwogIH0pOwogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC9wbGFpbiIsICJudWxsIik7CgogIHZhciBrZXlOYW1lcyA9IHszOiAiRW50ZXIiLCA4OiAiQmFja3NwYWNlIiwgOTogIlRhYiIsIDEzOiAiRW50ZXIiLCAxNjogIlNoaWZ0IiwgMTc6ICJDdHJsIiwgMTg6ICJBbHQiLAogICAgICAgICAgICAgICAgICAxOTogIlBhdXNlIiwgMjA6ICJDYXBzTG9jayIsIDI3OiAiRXNjIiwgMzI6ICJTcGFjZSIsIDMzOiAiUGFnZVVwIiwgMzQ6ICJQYWdlRG93biIsIDM1OiAiRW5kIiwKICAgICAgICAgICAgICAgICAgMzY6ICJIb21lIiwgMzc6ICJMZWZ0IiwgMzg6ICJVcCIsIDM5OiAiUmlnaHQiLCA0MDogIkRvd24iLCA0NDogIlByaW50U2NybiIsIDQ1OiAiSW5zZXJ0IiwKICAgICAgICAgICAgICAgICAgNDY6ICJEZWxldGUiLCA1OTogIjsiLCA5MTogIk1vZCIsIDkyOiAiTW9kIiwgOTM6ICJNb2QiLCAxMDk6ICItIiwgMTA3OiAiPSIsIDEyNzogIkRlbGV0ZSIsCiAgICAgICAgICAgICAgICAgIDE4NjogIjsiLCAxODc6ICI9IiwgMTg4OiAiLCIsIDE4OTogIi0iLCAxOTA6ICIuIiwgMTkxOiAiLyIsIDE5MjogImAiLCAyMTk6ICJbIiwgMjIwOiAiXFwiLAogICAgICAgICAgICAgICAgICAyMjE6ICJdIiwgMjIyOiAiJyIsIDYzMjc2OiAiUGFnZVVwIiwgNjMyNzc6ICJQYWdlRG93biIsIDYzMjc1OiAiRW5kIiwgNjMyNzM6ICJIb21lIiwKICAgICAgICAgICAgICAgICAgNjMyMzQ6ICJMZWZ0IiwgNjMyMzI6ICJVcCIsIDYzMjM1OiAiUmlnaHQiLCA2MzIzMzogIkRvd24iLCA2MzMwMjogIkluc2VydCIsIDYzMjcyOiAiRGVsZXRlIn07CiAgQ29kZU1pcnJvci5rZXlOYW1lcyA9IGtleU5hbWVzOwogIChmdW5jdGlvbigpIHsKICAgIC8vIE51bWJlciBrZXlzCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspIGtleU5hbWVzW2kgKyA0OF0gPSBTdHJpbmcoaSk7CiAgICAvLyBBbHBoYWJldGljIGtleXMKICAgIGZvciAodmFyIGkgPSA2NTsgaSA8PSA5MDsgaSsrKSBrZXlOYW1lc1tpXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoaSk7CiAgICAvLyBGdW5jdGlvbiBrZXlzCiAgICBmb3IgKHZhciBpID0gMTsgaSA8PSAxMjsgaSsrKSBrZXlOYW1lc1tpICsgMTExXSA9IGtleU5hbWVzW2kgKyA2MzIzNV0gPSAiRiIgKyBpOwogIH0pKCk7CgogIENvZGVNaXJyb3IudmVyc2lvbiA9ICIyLjM0IjsKCiAgcmV0dXJuIENvZGVNaXJyb3I7Cn0pKCk7CgpmdW5jdGlvbiBjZENsZWFyKCkgewogICAgdmFyIHd0YXJlYSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXcnKTsKICAgIHd0YXJlYS52YWx1ZSA9ICcnOwp9CgogIDwvc2NyaXB0Pgo8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+CglDb2RlTWlycm9yLmRlZmluZU1vZGUoImNzcyIsIGZ1bmN0aW9uKGNvbmZpZykgewogIHZhciBpbmRlbnRVbml0ID0gY29uZmlnLmluZGVudFVuaXQsIHR5cGU7CiAgCiAgdmFyIGF0TWVkaWFUeXBlcyA9IGtleVNldChbCiAgICAiYWxsIiwgImF1cmFsIiwgImJyYWlsbGUiLCAiaGFuZGhlbGQiLCAicHJpbnQiLCAicHJvamVjdGlvbiIsICJzY3JlZW4iLAogICAgInR0eSIsICJ0diIsICJlbWJvc3NlZCIKICBdKTsKICAKICB2YXIgYXRNZWRpYUZlYXR1cmVzID0ga2V5U2V0KFsKICAgICJ3aWR0aCIsICJtaW4td2lkdGgiLCAibWF4LXdpZHRoIiwgImhlaWdodCIsICJtaW4taGVpZ2h0IiwgIm1heC1oZWlnaHQiLAogICAgImRldmljZS13aWR0aCIsICJtaW4tZGV2aWNlLXdpZHRoIiwgIm1heC1kZXZpY2Utd2lkdGgiLCAiZGV2aWNlLWhlaWdodCIsCiAgICAibWluLWRldmljZS1oZWlnaHQiLCAibWF4LWRldmljZS1oZWlnaHQiLCAiYXNwZWN0LXJhdGlvIiwKICAgICJtaW4tYXNwZWN0LXJhdGlvIiwgIm1heC1hc3BlY3QtcmF0aW8iLCAiZGV2aWNlLWFzcGVjdC1yYXRpbyIsCiAgICAibWluLWRldmljZS1hc3BlY3QtcmF0aW8iLCAibWF4LWRldmljZS1hc3BlY3QtcmF0aW8iLCAiY29sb3IiLCAibWluLWNvbG9yIiwKICAgICJtYXgtY29sb3IiLCAiY29sb3ItaW5kZXgiLCAibWluLWNvbG9yLWluZGV4IiwgIm1heC1jb2xvci1pbmRleCIsCiAgICAibW9ub2Nocm9tZSIsICJtaW4tbW9ub2Nocm9tZSIsICJtYXgtbW9ub2Nocm9tZSIsICJyZXNvbHV0aW9uIiwKICAgICJtaW4tcmVzb2x1dGlvbiIsICJtYXgtcmVzb2x1dGlvbiIsICJzY2FuIiwgImdyaWQiCiAgXSk7CgogIHZhciBwcm9wZXJ0eUtleXdvcmRzID0ga2V5U2V0KFsKICAgICJhbGlnbi1jb250ZW50IiwgImFsaWduLWl0ZW1zIiwgImFsaWduLXNlbGYiLCAiYWxpZ25tZW50LWFkanVzdCIsCiAgICAiYWxpZ25tZW50LWJhc2VsaW5lIiwgImFuY2hvci1wb2ludCIsICJhbmltYXRpb24iLCAiYW5pbWF0aW9uLWRlbGF5IiwKICAgICJhbmltYXRpb24tZGlyZWN0aW9uIiwgImFuaW1hdGlvbi1kdXJhdGlvbiIsICJhbmltYXRpb24taXRlcmF0aW9uLWNvdW50IiwKICAgICJhbmltYXRpb24tbmFtZSIsICJhbmltYXRpb24tcGxheS1zdGF0ZSIsICJhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uIiwKICAgICJhcHBlYXJhbmNlIiwgImF6aW11dGgiLCAiYmFja2ZhY2UtdmlzaWJpbGl0eSIsICJiYWNrZ3JvdW5kIiwKICAgICJiYWNrZ3JvdW5kLWF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZC1jbGlwIiwgImJhY2tncm91bmQtY29sb3IiLAogICAgImJhY2tncm91bmQtaW1hZ2UiLCAiYmFja2dyb3VuZC1vcmlnaW4iLCAiYmFja2dyb3VuZC1wb3NpdGlvbiIsCiAgICAiYmFja2dyb3VuZC1yZXBlYXQiLCAiYmFja2dyb3VuZC1zaXplIiwgImJhc2VsaW5lLXNoaWZ0IiwgImJpbmRpbmciLAogICAgImJsZWVkIiwgImJvb2ttYXJrLWxhYmVsIiwgImJvb2ttYXJrLWxldmVsIiwgImJvb2ttYXJrLXN0YXRlIiwKICAgICJib29rbWFyay10YXJnZXQiLCAiYm9yZGVyIiwgImJvcmRlci1ib3R0b20iLCAiYm9yZGVyLWJvdHRvbS1jb2xvciIsCiAgICAiYm9yZGVyLWJvdHRvbS1sZWZ0LXJhZGl1cyIsICJib3JkZXItYm90dG9tLXJpZ2h0LXJhZGl1cyIsCiAgICAiYm9yZGVyLWJvdHRvbS1zdHlsZSIsICJib3JkZXItYm90dG9tLXdpZHRoIiwgImJvcmRlci1jb2xsYXBzZSIsCiAgICAiYm9yZGVyLWNvbG9yIiwgImJvcmRlci1pbWFnZSIsICJib3JkZXItaW1hZ2Utb3V0c2V0IiwKICAgICJib3JkZXItaW1hZ2UtcmVwZWF0IiwgImJvcmRlci1pbWFnZS1zbGljZSIsICJib3JkZXItaW1hZ2Utc291cmNlIiwKICAgICJib3JkZXItaW1hZ2Utd2lkdGgiLCAiYm9yZGVyLWxlZnQiLCAiYm9yZGVyLWxlZnQtY29sb3IiLAogICAgImJvcmRlci1sZWZ0LXN0eWxlIiwgImJvcmRlci1sZWZ0LXdpZHRoIiwgImJvcmRlci1yYWRpdXMiLCAiYm9yZGVyLXJpZ2h0IiwKICAgICJib3JkZXItcmlnaHQtY29sb3IiLCAiYm9yZGVyLXJpZ2h0LXN0eWxlIiwgImJvcmRlci1yaWdodC13aWR0aCIsCiAgICAiYm9yZGVyLXNwYWNpbmciLCAiYm9yZGVyLXN0eWxlIiwgImJvcmRlci10b3AiLCAiYm9yZGVyLXRvcC1jb2xvciIsCiAgICAiYm9yZGVyLXRvcC1sZWZ0LXJhZGl1cyIsICJib3JkZXItdG9wLXJpZ2h0LXJhZGl1cyIsICJib3JkZXItdG9wLXN0eWxlIiwKICAgICJib3JkZXItdG9wLXdpZHRoIiwgImJvcmRlci13aWR0aCIsICJib3R0b20iLCAiYm94LWRlY29yYXRpb24tYnJlYWsiLAogICAgImJveC1zaGFkb3ciLCAiYm94LXNpemluZyIsICJicmVhay1hZnRlciIsICJicmVhay1iZWZvcmUiLCAiYnJlYWstaW5zaWRlIiwKICAgICJjYXB0aW9uLXNpZGUiLCAiY2xlYXIiLCAiY2xpcCIsICJjb2xvciIsICJjb2xvci1wcm9maWxlIiwgImNvbHVtbi1jb3VudCIsCiAgICAiY29sdW1uLWZpbGwiLCAiY29sdW1uLWdhcCIsICJjb2x1bW4tcnVsZSIsICJjb2x1bW4tcnVsZS1jb2xvciIsCiAgICAiY29sdW1uLXJ1bGUtc3R5bGUiLCAiY29sdW1uLXJ1bGUtd2lkdGgiLCAiY29sdW1uLXNwYW4iLCAiY29sdW1uLXdpZHRoIiwKICAgICJjb2x1bW5zIiwgImNvbnRlbnQiLCAiY291bnRlci1pbmNyZW1lbnQiLCAiY291bnRlci1yZXNldCIsICJjcm9wIiwgImN1ZSIsCiAgICAiY3VlLWFmdGVyIiwgImN1ZS1iZWZvcmUiLCAiY3Vyc29yIiwgImRpcmVjdGlvbiIsICJkaXNwbGF5IiwKICAgICJkb21pbmFudC1iYXNlbGluZSIsICJkcm9wLWluaXRpYWwtYWZ0ZXItYWRqdXN0IiwKICAgICJkcm9wLWluaXRpYWwtYWZ0ZXItYWxpZ24iLCAiZHJvcC1pbml0aWFsLWJlZm9yZS1hZGp1c3QiLAogICAgImRyb3AtaW5pdGlhbC1iZWZvcmUtYWxpZ24iLCAiZHJvcC1pbml0aWFsLXNpemUiLCAiZHJvcC1pbml0aWFsLXZhbHVlIiwKICAgICJlbGV2YXRpb24iLCAiZW1wdHktY2VsbHMiLCAiZml0IiwgImZpdC1wb3NpdGlvbiIsICJmbGV4IiwgImZsZXgtYmFzaXMiLAogICAgImZsZXgtZGlyZWN0aW9uIiwgImZsZXgtZmxvdyIsICJmbGV4LWdyb3ciLCAiZmxleC1zaHJpbmsiLCAiZmxleC13cmFwIiwKICAgICJmbG9hdCIsICJmbG9hdC1vZmZzZXQiLCAiZm9udCIsICJmb250LWZlYXR1cmUtc2V0dGluZ3MiLCAiZm9udC1mYW1pbHkiLAogICAgImZvbnQta2VybmluZyIsICJmb250LWxhbmd1YWdlLW92ZXJyaWRlIiwgImZvbnQtc2l6ZSIsICJmb250LXNpemUtYWRqdXN0IiwKICAgICJmb250LXN0cmV0Y2giLCAiZm9udC1zdHlsZSIsICJmb250LXN5bnRoZXNpcyIsICJmb250LXZhcmlhbnQiLAogICAgImZvbnQtdmFyaWFudC1hbHRlcm5hdGVzIiwgImZvbnQtdmFyaWFudC1jYXBzIiwgImZvbnQtdmFyaWFudC1lYXN0LWFzaWFuIiwKICAgICJmb250LXZhcmlhbnQtbGlnYXR1cmVzIiwgImZvbnQtdmFyaWFudC1udW1lcmljIiwgImZvbnQtdmFyaWFudC1wb3NpdGlvbiIsCiAgICAiZm9udC13ZWlnaHQiLCAiZ3JpZC1jZWxsIiwgImdyaWQtY29sdW1uIiwgImdyaWQtY29sdW1uLWFsaWduIiwKICAgICJncmlkLWNvbHVtbi1zaXppbmciLCAiZ3JpZC1jb2x1bW4tc3BhbiIsICJncmlkLWNvbHVtbnMiLCAiZ3JpZC1mbG93IiwKICAgICJncmlkLXJvdyIsICJncmlkLXJvdy1hbGlnbiIsICJncmlkLXJvdy1zaXppbmciLCAiZ3JpZC1yb3ctc3BhbiIsCiAgICAiZ3JpZC1yb3dzIiwgImdyaWQtdGVtcGxhdGUiLCAiaGFuZ2luZy1wdW5jdHVhdGlvbiIsICJoZWlnaHQiLCAiaHlwaGVucyIsCiAgICAiaWNvbiIsICJpbWFnZS1vcmllbnRhdGlvbiIsICJpbWFnZS1yZW5kZXJpbmciLCAiaW1hZ2UtcmVzb2x1dGlvbiIsCiAgICAiaW5saW5lLWJveC1hbGlnbiIsICJqdXN0aWZ5LWNvbnRlbnQiLCAibGVmdCIsICJsZXR0ZXItc3BhY2luZyIsCiAgICAibGluZS1icmVhayIsICJsaW5lLWhlaWdodCIsICJsaW5lLXN0YWNraW5nIiwgImxpbmUtc3RhY2tpbmctcnVieSIsCiAgICAibGluZS1zdGFja2luZy1zaGlmdCIsICJsaW5lLXN0YWNraW5nLXN0cmF0ZWd5IiwgImxpc3Qtc3R5bGUiLAogICAgImxpc3Qtc3R5bGUtaW1hZ2UiLCAibGlzdC1zdHlsZS1wb3NpdGlvbiIsICJsaXN0LXN0eWxlLXR5cGUiLCAibWFyZ2luIiwKICAgICJtYXJnaW4tYm90dG9tIiwgIm1hcmdpbi1sZWZ0IiwgIm1hcmdpbi1yaWdodCIsICJtYXJnaW4tdG9wIiwKICAgICJtYXJrZXItb2Zmc2V0IiwgIm1hcmtzIiwgIm1hcnF1ZWUtZGlyZWN0aW9uIiwgIm1hcnF1ZWUtbG9vcCIsCiAgICAibWFycXVlZS1wbGF5LWNvdW50IiwgIm1hcnF1ZWUtc3BlZWQiLCAibWFycXVlZS1zdHlsZSIsICJtYXgtaGVpZ2h0IiwKICAgICJtYXgtd2lkdGgiLCAibWluLWhlaWdodCIsICJtaW4td2lkdGgiLCAibW92ZS10byIsICJuYXYtZG93biIsICJuYXYtaW5kZXgiLAogICAgIm5hdi1sZWZ0IiwgIm5hdi1yaWdodCIsICJuYXYtdXAiLCAib3BhY2l0eSIsICJvcmRlciIsICJvcnBoYW5zIiwgIm91dGxpbmUiLAogICAgIm91dGxpbmUtY29sb3IiLCAib3V0bGluZS1vZmZzZXQiLCAib3V0bGluZS1zdHlsZSIsICJvdXRsaW5lLXdpZHRoIiwKICAgICJvdmVyZmxvdyIsICJvdmVyZmxvdy1zdHlsZSIsICJvdmVyZmxvdy13cmFwIiwgIm92ZXJmbG93LXgiLCAib3ZlcmZsb3cteSIsCiAgICAicGFkZGluZyIsICJwYWRkaW5nLWJvdHRvbSIsICJwYWRkaW5nLWxlZnQiLCAicGFkZGluZy1yaWdodCIsICJwYWRkaW5nLXRvcCIsCiAgICAicGFnZSIsICJwYWdlLWJyZWFrLWFmdGVyIiwgInBhZ2UtYnJlYWstYmVmb3JlIiwgInBhZ2UtYnJlYWstaW5zaWRlIiwKICAgICJwYWdlLXBvbGljeSIsICJwYXVzZSIsICJwYXVzZS1hZnRlciIsICJwYXVzZS1iZWZvcmUiLCAicGVyc3BlY3RpdmUiLAogICAgInBlcnNwZWN0aXZlLW9yaWdpbiIsICJwaXRjaCIsICJwaXRjaC1yYW5nZSIsICJwbGF5LWR1cmluZyIsICJwb3NpdGlvbiIsCiAgICAicHJlc2VudGF0aW9uLWxldmVsIiwgInB1bmN0dWF0aW9uLXRyaW0iLCAicXVvdGVzIiwgInJlbmRlcmluZy1pbnRlbnQiLAogICAgInJlc2l6ZSIsICJyZXN0IiwgInJlc3QtYWZ0ZXIiLCAicmVzdC1iZWZvcmUiLCAicmljaG5lc3MiLCAicmlnaHQiLAogICAgInJvdGF0aW9uIiwgInJvdGF0aW9uLXBvaW50IiwgInJ1YnktYWxpZ24iLCAicnVieS1vdmVyaGFuZyIsCiAgICAicnVieS1wb3NpdGlvbiIsICJydWJ5LXNwYW4iLCAic2l6ZSIsICJzcGVhayIsICJzcGVhay1hcyIsICJzcGVhay1oZWFkZXIiLAogICAgInNwZWFrLW51bWVyYWwiLCAic3BlYWstcHVuY3R1YXRpb24iLCAic3BlZWNoLXJhdGUiLCAic3RyZXNzIiwgInN0cmluZy1zZXQiLAogICAgInRhYi1zaXplIiwgInRhYmxlLWxheW91dCIsICJ0YXJnZXQiLCAidGFyZ2V0LW5hbWUiLCAidGFyZ2V0LW5ldyIsCiAgICAidGFyZ2V0LXBvc2l0aW9uIiwgInRleHQtYWxpZ24iLCAidGV4dC1hbGlnbi1sYXN0IiwgInRleHQtZGVjb3JhdGlvbiIsCiAgICAidGV4dC1kZWNvcmF0aW9uLWNvbG9yIiwgInRleHQtZGVjb3JhdGlvbi1saW5lIiwgInRleHQtZGVjb3JhdGlvbi1za2lwIiwKICAgICJ0ZXh0LWRlY29yYXRpb24tc3R5bGUiLCAidGV4dC1lbXBoYXNpcyIsICJ0ZXh0LWVtcGhhc2lzLWNvbG9yIiwKICAgICJ0ZXh0LWVtcGhhc2lzLXBvc2l0aW9uIiwgInRleHQtZW1waGFzaXMtc3R5bGUiLCAidGV4dC1oZWlnaHQiLAogICAgInRleHQtaW5kZW50IiwgInRleHQtanVzdGlmeSIsICJ0ZXh0LW91dGxpbmUiLCAidGV4dC1zaGFkb3ciLAogICAgInRleHQtc3BhY2UtY29sbGFwc2UiLCAidGV4dC10cmFuc2Zvcm0iLCAidGV4dC11bmRlcmxpbmUtcG9zaXRpb24iLAogICAgInRleHQtd3JhcCIsICJ0b3AiLCAidHJhbnNmb3JtIiwgInRyYW5zZm9ybS1vcmlnaW4iLCAidHJhbnNmb3JtLXN0eWxlIiwKICAgICJ0cmFuc2l0aW9uIiwgInRyYW5zaXRpb24tZGVsYXkiLCAidHJhbnNpdGlvbi1kdXJhdGlvbiIsCiAgICAidHJhbnNpdGlvbi1wcm9wZXJ0eSIsICJ0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiIsICJ1bmljb2RlLWJpZGkiLAogICAgInZlcnRpY2FsLWFsaWduIiwgInZpc2liaWxpdHkiLCAidm9pY2UtYmFsYW5jZSIsICJ2b2ljZS1kdXJhdGlvbiIsCiAgICAidm9pY2UtZmFtaWx5IiwgInZvaWNlLXBpdGNoIiwgInZvaWNlLXJhbmdlIiwgInZvaWNlLXJhdGUiLCAidm9pY2Utc3RyZXNzIiwKICAgICJ2b2ljZS12b2x1bWUiLCAidm9sdW1lIiwgIndoaXRlLXNwYWNlIiwgIndpZG93cyIsICJ3aWR0aCIsICJ3b3JkLWJyZWFrIiwKICAgICJ3b3JkLXNwYWNpbmciLCAid29yZC13cmFwIiwgInotaW5kZXgiCiAgXSk7CgogIHZhciBjb2xvcktleXdvcmRzID0ga2V5U2V0KFsKICAgICJibGFjayIsICJzaWx2ZXIiLCAiZ3JheSIsICJ3aGl0ZSIsICJtYXJvb24iLCAicmVkIiwgInB1cnBsZSIsICJmdWNoc2lhIiwKICAgICJncmVlbiIsICJsaW1lIiwgIm9saXZlIiwgInllbGxvdyIsICJuYXZ5IiwgImJsdWUiLCAidGVhbCIsICJhcXVhIgogIF0pOwogIAogIHZhciB2YWx1ZUtleXdvcmRzID0ga2V5U2V0KFsKICAgICJhYm92ZSIsICJhYnNvbHV0ZSIsICJhY3RpdmVib3JkZXIiLCAiYWN0aXZlY2FwdGlvbiIsICJhZmFyIiwKICAgICJhZnRlci13aGl0ZS1zcGFjZSIsICJhaGVhZCIsICJhbGlhcyIsICJhbGwiLCAiYWxsLXNjcm9sbCIsICJhbHRlcm5hdGUiLAogICAgImFsd2F5cyIsICJhbWhhcmljIiwgImFtaGFyaWMtYWJlZ2VkZSIsICJhbnRpYWxpYXNlZCIsICJhcHB3b3Jrc3BhY2UiLAogICAgImFyYWJpYy1pbmRpYyIsICJhcm1lbmlhbiIsICJhc3Rlcmlza3MiLCAiYXV0byIsICJhdm9pZCIsICJiYWNrZ3JvdW5kIiwKICAgICJiYWNrd2FyZHMiLCAiYmFzZWxpbmUiLCAiYmVsb3ciLCAiYmlkaS1vdmVycmlkZSIsICJiaW5hcnkiLCAiYmVuZ2FsaSIsCiAgICAiYmxpbmsiLCAiYmxvY2siLCAiYmxvY2stYXhpcyIsICJib2xkIiwgImJvbGRlciIsICJib3JkZXIiLCAiYm9yZGVyLWJveCIsCiAgICAiYm90aCIsICJib3R0b20iLCAiYnJlYWstYWxsIiwgImJyZWFrLXdvcmQiLCAiYnV0dG9uIiwgImJ1dHRvbi1iZXZlbCIsCiAgICAiYnV0dG9uZmFjZSIsICJidXR0b25oaWdobGlnaHQiLCAiYnV0dG9uc2hhZG93IiwgImJ1dHRvbnRleHQiLCAiY2FtYm9kaWFuIiwKICAgICJjYXBpdGFsaXplIiwgImNhcHMtbG9jay1pbmRpY2F0b3IiLCAiY2FwdGlvbiIsICJjYXB0aW9udGV4dCIsICJjYXJldCIsCiAgICAiY2VsbCIsICJjZW50ZXIiLCAiY2hlY2tib3giLCAiY2lyY2xlIiwgImNqay1lYXJ0aGx5LWJyYW5jaCIsCiAgICAiY2prLWhlYXZlbmx5LXN0ZW0iLCAiY2prLWlkZW9ncmFwaGljIiwgImNsZWFyIiwgImNsaXAiLCAiY2xvc2UtcXVvdGUiLAogICAgImNvbC1yZXNpemUiLCAiY29sbGFwc2UiLCAiY29tcGFjdCIsICJjb25kZW5zZWQiLCAiY29udGFpbiIsICJjb250ZW50IiwKICAgICJjb250ZW50LWJveCIsICJjb250ZXh0LW1lbnUiLCAiY29udGludW91cyIsICJjb3B5IiwgImNvdmVyIiwgImNyb3AiLAogICAgImNyb3NzIiwgImNyb3NzaGFpciIsICJjdXJyZW50Y29sb3IiLCAiY3Vyc2l2ZSIsICJkYXNoZWQiLCAiZGVjaW1hbCIsCiAgICAiZGVjaW1hbC1sZWFkaW5nLXplcm8iLCAiZGVmYXVsdCIsICJkZWZhdWx0LWJ1dHRvbiIsICJkZXN0aW5hdGlvbi1hdG9wIiwKICAgICJkZXN0aW5hdGlvbi1pbiIsICJkZXN0aW5hdGlvbi1vdXQiLCAiZGVzdGluYXRpb24tb3ZlciIsICJkZXZhbmFnYXJpIiwKICAgICJkaXNjIiwgImRpc2NhcmQiLCAiZG9jdW1lbnQiLCAiZG90LWRhc2giLCAiZG90LWRvdC1kYXNoIiwgImRvdHRlZCIsCiAgICAiZG91YmxlIiwgImRvd24iLCAiZS1yZXNpemUiLCAiZWFzZSIsICJlYXNlLWluIiwgImVhc2UtaW4tb3V0IiwgImVhc2Utb3V0IiwKICAgICJlbGVtZW50IiwgImVsbGlwc2lzIiwgImVtYmVkIiwgImVuZCIsICJldGhpb3BpYyIsICJldGhpb3BpYy1hYmVnZWRlIiwKICAgICJldGhpb3BpYy1hYmVnZWRlLWFtLWV0IiwgImV0aGlvcGljLWFiZWdlZGUtZ2V6IiwgImV0aGlvcGljLWFiZWdlZGUtdGktZXIiLAogICAgImV0aGlvcGljLWFiZWdlZGUtdGktZXQiLCAiZXRoaW9waWMtaGFsZWhhbWUtYWEtZXIiLAogICAgImV0aGlvcGljLWhhbGVoYW1lLWFhLWV0IiwgImV0aGlvcGljLWhhbGVoYW1lLWFtLWV0IiwKICAgICJldGhpb3BpYy1oYWxlaGFtZS1nZXoiLCAiZXRoaW9waWMtaGFsZWhhbWUtb20tZXQiLAogICAgImV0aGlvcGljLWhhbGVoYW1lLXNpZC1ldCIsICJldGhpb3BpYy1oYWxlaGFtZS1zby1ldCIsCiAgICAiZXRoaW9waWMtaGFsZWhhbWUtdGktZXIiLCAiZXRoaW9waWMtaGFsZWhhbWUtdGktZXQiLAogICAgImV0aGlvcGljLWhhbGVoYW1lLXRpZyIsICJldy1yZXNpemUiLCAiZXhwYW5kZWQiLCAiZXh0cmEtY29uZGVuc2VkIiwKICAgICJleHRyYS1leHBhbmRlZCIsICJmYW50YXN5IiwgImZhc3QiLCAiZmlsbCIsICJmaXhlZCIsICJmbGF0IiwgImZvb3Rub3RlcyIsCiAgICAiZm9yd2FyZHMiLCAiZnJvbSIsICJnZW9tZXRyaWNQcmVjaXNpb24iLCAiZ2VvcmdpYW4iLCAiZ3JheXRleHQiLCAiZ3Jvb3ZlIiwKICAgICJndWphcmF0aSIsICJndXJtdWtoaSIsICJoYW5kIiwgImhhbmd1bCIsICJoYW5ndWwtY29uc29uYW50IiwgImhlYnJldyIsCiAgICAiaGVscCIsICJoaWRkZW4iLCAiaGlkZSIsICJoaWdoZXIiLCAiaGlnaGxpZ2h0IiwgImhpZ2hsaWdodHRleHQiLAogICAgImhpcmFnYW5hIiwgImhpcmFnYW5hLWlyb2hhIiwgImhvcml6b250YWwiLCAiaHNsIiwgImhzbGEiLCAiaWNvbiIsICJpZ25vcmUiLAogICAgImluYWN0aXZlYm9yZGVyIiwgImluYWN0aXZlY2FwdGlvbiIsICJpbmFjdGl2ZWNhcHRpb250ZXh0IiwgImluZmluaXRlIiwKICAgICJpbmZvYmFja2dyb3VuZCIsICJpbmZvdGV4dCIsICJpbmhlcml0IiwgImluaXRpYWwiLCAiaW5saW5lIiwgImlubGluZS1heGlzIiwKICAgICJpbmxpbmUtYmxvY2siLCAiaW5saW5lLXRhYmxlIiwgImluc2V0IiwgImluc2lkZSIsICJpbnRyaW5zaWMiLCAiaW52ZXJ0IiwKICAgICJpdGFsaWMiLCAianVzdGlmeSIsICJrYW5uYWRhIiwgImthdGFrYW5hIiwgImthdGFrYW5hLWlyb2hhIiwgImtobWVyIiwKICAgICJsYW5kc2NhcGUiLCAibGFvIiwgImxhcmdlIiwgImxhcmdlciIsICJsZWZ0IiwgImxldmVsIiwgImxpZ2h0ZXIiLAogICAgImxpbmUtdGhyb3VnaCIsICJsaW5lYXIiLCAibGluZXMiLCAibGlzdC1pdGVtIiwgImxpc3Rib3giLCAibGlzdGl0ZW0iLAogICAgImxvY2FsIiwgImxvZ2ljYWwiLCAibG91ZCIsICJsb3dlciIsICJsb3dlci1hbHBoYSIsICJsb3dlci1hcm1lbmlhbiIsCiAgICAibG93ZXItZ3JlZWsiLCAibG93ZXItaGV4YWRlY2ltYWwiLCAibG93ZXItbGF0aW4iLCAibG93ZXItbm9yd2VnaWFuIiwKICAgICJsb3dlci1yb21hbiIsICJsb3dlcmNhc2UiLCAibHRyIiwgIm1hbGF5YWxhbSIsICJtYXRjaCIsCiAgICAibWVkaWEtY29udHJvbHMtYmFja2dyb3VuZCIsICJtZWRpYS1jdXJyZW50LXRpbWUtZGlzcGxheSIsCiAgICAibWVkaWEtZnVsbHNjcmVlbi1idXR0b24iLCAibWVkaWEtbXV0ZS1idXR0b24iLCAibWVkaWEtcGxheS1idXR0b24iLAogICAgIm1lZGlhLXJldHVybi10by1yZWFsdGltZS1idXR0b24iLCAibWVkaWEtcmV3aW5kLWJ1dHRvbiIsCiAgICAibWVkaWEtc2Vlay1iYWNrLWJ1dHRvbiIsICJtZWRpYS1zZWVrLWZvcndhcmQtYnV0dG9uIiwgIm1lZGlhLXNsaWRlciIsCiAgICAibWVkaWEtc2xpZGVydGh1bWIiLCAibWVkaWEtdGltZS1yZW1haW5pbmctZGlzcGxheSIsICJtZWRpYS12b2x1bWUtc2xpZGVyIiwKICAgICJtZWRpYS12b2x1bWUtc2xpZGVyLWNvbnRhaW5lciIsICJtZWRpYS12b2x1bWUtc2xpZGVydGh1bWIiLCAibWVkaXVtIiwKICAgICJtZW51IiwgIm1lbnVsaXN0IiwgIm1lbnVsaXN0LWJ1dHRvbiIsICJtZW51bGlzdC10ZXh0IiwKICAgICJtZW51bGlzdC10ZXh0ZmllbGQiLCAibWVudXRleHQiLCAibWVzc2FnZS1ib3giLCAibWlkZGxlIiwgIm1pbi1pbnRyaW5zaWMiLAogICAgIm1peCIsICJtb25nb2xpYW4iLCAibW9ub3NwYWNlIiwgIm1vdmUiLCAibXVsdGlwbGUiLCAibXlhbm1hciIsICJuLXJlc2l6ZSIsCiAgICAibmFycm93ZXIiLCAibmF2eSIsICJuZS1yZXNpemUiLCAibmVzdy1yZXNpemUiLCAibm8tY2xvc2UtcXVvdGUiLCAibm8tZHJvcCIsCiAgICAibm8tb3Blbi1xdW90ZSIsICJuby1yZXBlYXQiLCAibm9uZSIsICJub3JtYWwiLCAibm90LWFsbG93ZWQiLCAibm93cmFwIiwKICAgICJucy1yZXNpemUiLCAibnctcmVzaXplIiwgIm53c2UtcmVzaXplIiwgIm9ibGlxdWUiLCAib2N0YWwiLCAib3Blbi1xdW90ZSIsCiAgICAib3B0aW1pemVMZWdpYmlsaXR5IiwgIm9wdGltaXplU3BlZWQiLCAib3JpeWEiLCAib3JvbW8iLCAib3V0c2V0IiwKICAgICJvdXRzaWRlIiwgIm92ZXJsYXkiLCAib3ZlcmxpbmUiLCAicGFkZGluZyIsICJwYWRkaW5nLWJveCIsICJwYWludGVkIiwKICAgICJwYXVzZWQiLCAicGVyc2lhbiIsICJwbHVzLWRhcmtlciIsICJwbHVzLWxpZ2h0ZXIiLCAicG9pbnRlciIsICJwb3J0cmFpdCIsCiAgICAicHJlIiwgInByZS1saW5lIiwgInByZS13cmFwIiwgInByZXNlcnZlLTNkIiwgInByb2dyZXNzIiwgInB1c2gtYnV0dG9uIiwKICAgICJyYWRpbyIsICJyZWFkLW9ubHkiLCAicmVhZC13cml0ZSIsICJyZWFkLXdyaXRlLXBsYWludGV4dC1vbmx5IiwgInJlbGF0aXZlIiwKICAgICJyZXBlYXQiLCAicmVwZWF0LXgiLCAicmVwZWF0LXkiLCAicmVzZXQiLCAicmV2ZXJzZSIsICJyZ2IiLCAicmdiYSIsCiAgICAicmlkZ2UiLCAicmlnaHQiLCAicm91bmQiLCAicm93LXJlc2l6ZSIsICJydGwiLCAicnVuLWluIiwgInJ1bm5pbmciLAogICAgInMtcmVzaXplIiwgInNhbnMtc2VyaWYiLCAic2Nyb2xsIiwgInNjcm9sbGJhciIsICJzZS1yZXNpemUiLCAic2VhcmNoZmllbGQiLAogICAgInNlYXJjaGZpZWxkLWNhbmNlbC1idXR0b24iLCAic2VhcmNoZmllbGQtZGVjb3JhdGlvbiIsCiAgICAic2VhcmNoZmllbGQtcmVzdWx0cy1idXR0b24iLCAic2VhcmNoZmllbGQtcmVzdWx0cy1kZWNvcmF0aW9uIiwKICAgICJzZW1pLWNvbmRlbnNlZCIsICJzZW1pLWV4cGFuZGVkIiwgInNlcGFyYXRlIiwgInNlcmlmIiwgInNob3ciLCAic2lkYW1hIiwKICAgICJzaW5nbGUiLCAic2tpcC13aGl0ZS1zcGFjZSIsICJzbGlkZSIsICJzbGlkZXItaG9yaXpvbnRhbCIsCiAgICAic2xpZGVyLXZlcnRpY2FsIiwgInNsaWRlcnRodW1iLWhvcml6b250YWwiLCAic2xpZGVydGh1bWItdmVydGljYWwiLCAic2xvdyIsCiAgICAic21hbGwiLCAic21hbGwtY2FwcyIsICJzbWFsbC1jYXB0aW9uIiwgInNtYWxsZXIiLCAic29saWQiLCAic29tYWxpIiwKICAgICJzb3VyY2UtYXRvcCIsICJzb3VyY2UtaW4iLCAic291cmNlLW91dCIsICJzb3VyY2Utb3ZlciIsICJzcGFjZSIsICJzcXVhcmUiLAogICAgInNxdWFyZS1idXR0b24iLCAic3RhcnQiLCAic3RhdGljIiwgInN0YXR1cy1iYXIiLCAic3RyZXRjaCIsICJzdHJva2UiLAogICAgInN1YiIsICJzdWJwaXhlbC1hbnRpYWxpYXNlZCIsICJzdXBlciIsICJzdy1yZXNpemUiLCAidGFibGUiLAogICAgInRhYmxlLWNhcHRpb24iLCAidGFibGUtY2VsbCIsICJ0YWJsZS1jb2x1bW4iLCAidGFibGUtY29sdW1uLWdyb3VwIiwKICAgICJ0YWJsZS1mb290ZXItZ3JvdXAiLCAidGFibGUtaGVhZGVyLWdyb3VwIiwgInRhYmxlLXJvdyIsICJ0YWJsZS1yb3ctZ3JvdXAiLAogICAgInRlbHVndSIsICJ0ZXh0IiwgInRleHQtYm90dG9tIiwgInRleHQtdG9wIiwgInRleHRhcmVhIiwgInRleHRmaWVsZCIsICJ0aGFpIiwKICAgICJ0aGljayIsICJ0aGluIiwgInRocmVlZGRhcmtzaGFkb3ciLCAidGhyZWVkZmFjZSIsICJ0aHJlZWRoaWdobGlnaHQiLAogICAgInRocmVlZGxpZ2h0c2hhZG93IiwgInRocmVlZHNoYWRvdyIsICJ0aWJldGFuIiwgInRpZ3JlIiwgInRpZ3JpbnlhLWVyIiwKICAgICJ0aWdyaW55YS1lci1hYmVnZWRlIiwgInRpZ3JpbnlhLWV0IiwgInRpZ3JpbnlhLWV0LWFiZWdlZGUiLCAidG8iLCAidG9wIiwKICAgICJ0cmFuc3BhcmVudCIsICJ1bHRyYS1jb25kZW5zZWQiLCAidWx0cmEtZXhwYW5kZWQiLCAidW5kZXJsaW5lIiwgInVwIiwKICAgICJ1cHBlci1hbHBoYSIsICJ1cHBlci1hcm1lbmlhbiIsICJ1cHBlci1ncmVlayIsICJ1cHBlci1oZXhhZGVjaW1hbCIsCiAgICAidXBwZXItbGF0aW4iLCAidXBwZXItbm9yd2VnaWFuIiwgInVwcGVyLXJvbWFuIiwgInVwcGVyY2FzZSIsICJ1cmR1IiwgInVybCIsCiAgICAidmVydGljYWwiLCAidmVydGljYWwtdGV4dCIsICJ2aXNpYmxlIiwgInZpc2libGVGaWxsIiwgInZpc2libGVQYWludGVkIiwKICAgICJ2aXNpYmxlU3Ryb2tlIiwgInZpc3VhbCIsICJ3LXJlc2l6ZSIsICJ3YWl0IiwgIndhdmUiLCAid2hpdGUiLCAid2lkZXIiLAogICAgIndpbmRvdyIsICJ3aW5kb3dmcmFtZSIsICJ3aW5kb3d0ZXh0IiwgIngtbGFyZ2UiLCAieC1zbWFsbCIsICJ4b3IiLAogICAgInh4LWxhcmdlIiwgInh4LXNtYWxsIiwgInllbGxvdyIKICBdKTsKCiAgZnVuY3Rpb24ga2V5U2V0KGFycmF5KSB7IHZhciBrZXlzID0ge307IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpIGtleXNbYXJyYXlbaV1dID0gdHJ1ZTsgcmV0dXJuIGtleXM7IH0KICBmdW5jdGlvbiByZXQoc3R5bGUsIHRwKSB7dHlwZSA9IHRwOyByZXR1cm4gc3R5bGU7fQoKICBmdW5jdGlvbiB0b2tlbkJhc2Uoc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIGNoID0gc3RyZWFtLm5leHQoKTsKICAgIGlmIChjaCA9PSAiQCIpIHtzdHJlYW0uZWF0V2hpbGUoL1tcd1xcXC1dLyk7IHJldHVybiByZXQoImRlZiIsIHN0cmVhbS5jdXJyZW50KCkpO30KICAgIGVsc2UgaWYgKGNoID09ICIvIiAmJiBzdHJlYW0uZWF0KCIqIikpIHsKICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkNDb21tZW50OwogICAgICByZXR1cm4gdG9rZW5DQ29tbWVudChzdHJlYW0sIHN0YXRlKTsKICAgIH0KICAgIGVsc2UgaWYgKGNoID09ICI8IiAmJiBzdHJlYW0uZWF0KCIhIikpIHsKICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlblNHTUxDb21tZW50OwogICAgICByZXR1cm4gdG9rZW5TR01MQ29tbWVudChzdHJlYW0sIHN0YXRlKTsKICAgIH0KICAgIGVsc2UgaWYgKGNoID09ICI9IikgcmV0KG51bGwsICJjb21wYXJlIik7CiAgICBlbHNlIGlmICgoY2ggPT0gIn4iIHx8IGNoID09ICJ8IikgJiYgc3RyZWFtLmVhdCgiPSIpKSByZXR1cm4gcmV0KG51bGwsICJjb21wYXJlIik7CiAgICBlbHNlIGlmIChjaCA9PSAiXCIiIHx8IGNoID09ICInIikgewogICAgICBzdGF0ZS50b2tlbml6ZSA9IHRva2VuU3RyaW5nKGNoKTsKICAgICAgcmV0dXJuIHN0YXRlLnRva2VuaXplKHN0cmVhbSwgc3RhdGUpOwogICAgfQogICAgZWxzZSBpZiAoY2ggPT0gIiMiKSB7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW1x3XFxcLV0vKTsKICAgICAgcmV0dXJuIHJldCgiYXRvbSIsICJoYXNoIik7CiAgICB9CiAgICBlbHNlIGlmIChjaCA9PSAiISIpIHsKICAgICAgc3RyZWFtLm1hdGNoKC9eXHMqXHcqLyk7CiAgICAgIHJldHVybiByZXQoImtleXdvcmQiLCAiaW1wb3J0YW50Iik7CiAgICB9CiAgICBlbHNlIGlmICgvXGQvLnRlc3QoY2gpKSB7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW1x3LiVdLyk7CiAgICAgIHJldHVybiByZXQoIm51bWJlciIsICJ1bml0Iik7CiAgICB9CiAgICBlbHNlIGlmIChjaCA9PT0gIi0iKSB7CiAgICAgIGlmICgvXGQvLnRlc3Qoc3RyZWFtLnBlZWsoKSkpIHsKICAgICAgICBzdHJlYW0uZWF0V2hpbGUoL1tcdy4lXS8pOwogICAgICAgIHJldHVybiByZXQoIm51bWJlciIsICJ1bml0Iik7CiAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKC9eW14tXSstLykpIHsKICAgICAgICByZXR1cm4gcmV0KCJtZXRhIiwgdHlwZSk7CiAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKC9bLCs+KlwvXS8udGVzdChjaCkpIHsKICAgICAgcmV0dXJuIHJldChudWxsLCAic2VsZWN0LW9wIik7CiAgICB9CiAgICBlbHNlIGlmIChjaCA9PSAiLiIgJiYgc3RyZWFtLm1hdGNoKC9eXHcrLykpIHsKICAgICAgcmV0dXJuIHJldCgicXVhbGlmaWVyIiwgdHlwZSk7CiAgICB9CiAgICBlbHNlIGlmIChjaCA9PSAiOiIpIHsKICAgICAgcmV0dXJuIHJldCgib3BlcmF0b3IiLCBjaCk7CiAgICB9CiAgICBlbHNlIGlmICgvWzt7fVxbXF1cKFwpXS8udGVzdChjaCkpIHsKICAgICAgcmV0dXJuIHJldChudWxsLCBjaCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgc3RyZWFtLmVhdFdoaWxlKC9bXHdcXFwtXS8pOwogICAgICByZXR1cm4gcmV0KCJwcm9wZXJ0eSIsICJ2YXJpYWJsZSIpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdG9rZW5DQ29tbWVudChzdHJlYW0sIHN0YXRlKSB7CiAgICB2YXIgbWF5YmVFbmQgPSBmYWxzZSwgY2g7CiAgICB3aGlsZSAoKGNoID0gc3RyZWFtLm5leHQoKSkgIT0gbnVsbCkgewogICAgICBpZiAobWF5YmVFbmQgJiYgY2ggPT0gIi8iKSB7CiAgICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkJhc2U7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgbWF5YmVFbmQgPSAoY2ggPT0gIioiKTsKICAgIH0KICAgIHJldHVybiByZXQoImNvbW1lbnQiLCAiY29tbWVudCIpOwogIH0KCiAgZnVuY3Rpb24gdG9rZW5TR01MQ29tbWVudChzdHJlYW0sIHN0YXRlKSB7CiAgICB2YXIgZGFzaGVzID0gMCwgY2g7CiAgICB3aGlsZSAoKGNoID0gc3RyZWFtLm5leHQoKSkgIT0gbnVsbCkgewogICAgICBpZiAoZGFzaGVzID49IDIgJiYgY2ggPT0gIj4iKSB7CiAgICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkJhc2U7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgZGFzaGVzID0gKGNoID09ICItIikgPyBkYXNoZXMgKyAxIDogMDsKICAgIH0KICAgIHJldHVybiByZXQoImNvbW1lbnQiLCAiY29tbWVudCIpOwogIH0KCiAgZnVuY3Rpb24gdG9rZW5TdHJpbmcocXVvdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbihzdHJlYW0sIHN0YXRlKSB7CiAgICAgIHZhciBlc2NhcGVkID0gZmFsc2UsIGNoOwogICAgICB3aGlsZSAoKGNoID0gc3RyZWFtLm5leHQoKSkgIT0gbnVsbCkgewogICAgICAgIGlmIChjaCA9PSBxdW90ZSAmJiAhZXNjYXBlZCkKICAgICAgICAgIGJyZWFrOwogICAgICAgIGVzY2FwZWQgPSAhZXNjYXBlZCAmJiBjaCA9PSAiXFwiOwogICAgICB9CiAgICAgIGlmICghZXNjYXBlZCkgc3RhdGUudG9rZW5pemUgPSB0b2tlbkJhc2U7CiAgICAgIHJldHVybiByZXQoInN0cmluZyIsICJzdHJpbmciKTsKICAgIH07CiAgfQoKICByZXR1cm4gewogICAgc3RhcnRTdGF0ZTogZnVuY3Rpb24oYmFzZSkgewogICAgICByZXR1cm4ge3Rva2VuaXplOiB0b2tlbkJhc2UsCiAgICAgICAgICAgICAgYmFzZUluZGVudDogYmFzZSB8fCAwLAogICAgICAgICAgICAgIHN0YWNrOiBbXX07CiAgICB9LAoKICAgIHRva2VuOiBmdW5jdGlvbihzdHJlYW0sIHN0YXRlKSB7CiAgICAgIAogICAgICAvLyBVc2UgdGhlc2UgdGVybXMgd2hlbiBhcHBsaWNhYmxlIChzZWUgaHR0cDovL3d3dy54YW50aGlyLmNvbS9ibG9nL2I0RTUwKQogICAgICAvLyAKICAgICAgLy8gcnVsZSoqIG9yICoqcnVsZXNldDoKICAgICAgLy8gQSBzZWxlY3RvciArIGJyYWNlcyBjb21ibywgb3IgYW4gYXQtcnVsZS4KICAgICAgLy8gCiAgICAgIC8vIGRlY2xhcmF0aW9uIGJsb2NrOgogICAgICAvLyBBIHNlcXVlbmNlIG9mIGRlY2xhcmF0aW9ucy4KICAgICAgLy8gCiAgICAgIC8vIGRlY2xhcmF0aW9uOgogICAgICAvLyBBIHByb3BlcnR5ICsgY29sb24gKyB2YWx1ZSBjb21iby4KICAgICAgLy8gCiAgICAgIC8vIHByb3BlcnR5IHZhbHVlOgogICAgICAvLyBUaGUgZW50aXJlIHZhbHVlIG9mIGEgcHJvcGVydHkuCiAgICAgIC8vIAogICAgICAvLyBjb21wb25lbnQgdmFsdWU6CiAgICAgIC8vIEEgc2luZ2xlIHBpZWNlIG9mIGEgcHJvcGVydHkgdmFsdWUuIExpa2UgdGhlIDVweCBpbgogICAgICAvLyB0ZXh0LXNoYWRvdzogMCAwIDVweCBibHVlOy4gQ2FuIGFsc28gcmVmZXIgdG8gdGhpbmdzIHRoYXQgYXJlCiAgICAgIC8vIG11bHRpcGxlIHRlcm1zLCBsaWtlIHRoZSAxLTQgdGVybXMgdGhhdCBtYWtlIHVwIHRoZSBiYWNrZ3JvdW5kLXNpemUKICAgICAgLy8gcG9ydGlvbiBvZiB0aGUgYmFja2dyb3VuZCBzaG9ydGhhbmQuCiAgICAgIC8vIAogICAgICAvLyB0ZXJtOgogICAgICAvLyBUaGUgYmFzaWMgdW5pdCBvZiBhdXRob3ItZmFjaW5nIENTUywgbGlrZSBhIHNpbmdsZSBudW1iZXIgKDUpLAogICAgICAvLyBkaW1lbnNpb24gKDVweCksIHN0cmluZyAoImZvbyIpLCBvciBmdW5jdGlvbi4gT2ZmaWNpYWxseSBkZWZpbmVkCiAgICAgIC8vICBieSB0aGUgQ1NTIDIuMSBncmFtbWFyIChsb29rIGZvciB0aGUgJ3Rlcm0nIHByb2R1Y3Rpb24pCiAgICAgIC8vIAogICAgICAvLyAKICAgICAgLy8gc2ltcGxlIHNlbGVjdG9yOgogICAgICAvLyBBIHNpbmdsZSBhdG9taWMgc2VsZWN0b3IsIGxpa2UgYSB0eXBlIHNlbGVjdG9yLCBhbiBhdHRyIHNlbGVjdG9yLCBhCiAgICAgIC8vIGNsYXNzIHNlbGVjdG9yLCBldGMuCiAgICAgIC8vIAogICAgICAvLyBjb21wb3VuZCBzZWxlY3RvcjoKICAgICAgLy8gT25lIG9yIG1vcmUgc2ltcGxlIHNlbGVjdG9ycyB3aXRob3V0IGEgY29tYmluYXRvci4gZGl2LmV4YW1wbGUgaXMKICAgICAgLy8gY29tcG91bmQsIGRpdiA+IC5leGFtcGxlIGlzIG5vdC4KICAgICAgLy8gCiAgICAgIC8vIGNvbXBsZXggc2VsZWN0b3I6CiAgICAgIC8vIE9uZSBvciBtb3JlIGNvbXBvdW5kIHNlbGVjdG9ycyBjaGFpbmVkIHdpdGggY29tYmluYXRvcnMuCiAgICAgIC8vIAogICAgICAvLyBjb21iaW5hdG9yOgogICAgICAvLyBUaGUgcGFydHMgb2Ygc2VsZWN0b3JzIHRoYXQgZXhwcmVzcyByZWxhdGlvbnNoaXBzLiBUaGVyZSBhcmUgZm91cgogICAgICAvLyBjdXJyZW50bHkgLSB0aGUgc3BhY2UgKGRlc2NlbmRhbnQgY29tYmluYXRvciksIHRoZSBncmVhdGVyLXRoYW4KICAgICAgLy8gYnJhY2tldCAoY2hpbGQgY29tYmluYXRvciksIHRoZSBwbHVzIHNpZ24gKG5leHQgc2libGluZyBjb21iaW5hdG9yKSwKICAgICAgLy8gYW5kIHRoZSB0aWxkYSAoZm9sbG93aW5nIHNpYmxpbmcgY29tYmluYXRvcikuCiAgICAgIC8vIAogICAgICAvLyBzZXF1ZW5jZSBvZiBzZWxlY3RvcnM6CiAgICAgIC8vIE9uZSBvciBtb3JlIG9mIHRoZSBuYW1lZCB0eXBlIG9mIHNlbGVjdG9yIGNoYWluZWQgd2l0aCBjb21tYXMuCgogICAgICBpZiAoc3RyZWFtLmVhdFNwYWNlKCkpIHJldHVybiBudWxsOwogICAgICB2YXIgc3R5bGUgPSBzdGF0ZS50b2tlbml6ZShzdHJlYW0sIHN0YXRlKTsKCiAgICAgIC8vIENoYW5naW5nIHN0eWxlIHJldHVybmVkIGJhc2VkIG9uIGNvbnRleHQKICAgICAgdmFyIGNvbnRleHQgPSBzdGF0ZS5zdGFja1tzdGF0ZS5zdGFjay5sZW5ndGgtMV07CiAgICAgIGlmIChzdHlsZSA9PSAicHJvcGVydHkiKSB7CiAgICAgICAgaWYgKGNvbnRleHQgPT0gInByb3BlcnR5VmFsdWUiKXsKICAgICAgICAgIGlmICh2YWx1ZUtleXdvcmRzW3N0cmVhbS5jdXJyZW50KCldKSB7CiAgICAgICAgICAgIHN0eWxlID0gInN0cmluZy0yIjsKICAgICAgICAgIH0gZWxzZSBpZiAoY29sb3JLZXl3b3Jkc1tzdHJlYW0uY3VycmVudCgpXSkgewogICAgICAgICAgICBzdHlsZSA9ICJrZXl3b3JkIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0eWxlID0gInZhcmlhYmxlLTIiOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY29udGV4dCA9PSAicnVsZSIpIHsKICAgICAgICAgIGlmICghcHJvcGVydHlLZXl3b3Jkc1tzdHJlYW0uY3VycmVudCgpXSkgewogICAgICAgICAgICBzdHlsZSArPSAiIGVycm9yIjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFjb250ZXh0IHx8IGNvbnRleHQgPT0gIkBtZWRpYXsiKSB7CiAgICAgICAgICBzdHlsZSA9ICJ0YWciOwogICAgICAgIH0gZWxzZSBpZiAoY29udGV4dCA9PSAiQG1lZGlhIikgewogICAgICAgICAgaWYgKGF0TWVkaWFUeXBlc1tzdHJlYW0uY3VycmVudCgpXSkgewogICAgICAgICAgICBzdHlsZSA9ICJhdHRyaWJ1dGUiOyAvLyBLbm93biBhdHRyaWJ1dGUKICAgICAgICAgIH0gZWxzZSBpZiAoL14ob25seXxub3QpJC9pLnRlc3Qoc3RyZWFtLmN1cnJlbnQoKSkpIHsKICAgICAgICAgICAgc3R5bGUgPSAia2V5d29yZCI7CiAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbS5jdXJyZW50KCkudG9Mb3dlckNhc2UoKSA9PSAiYW5kIikgewogICAgICAgICAgICBzdHlsZSA9ICJlcnJvciI7IC8vICJhbmQiIGlzIG9ubHkgYWxsb3dlZCBpbiBAbWVkaWFUeXBlCiAgICAgICAgICB9IGVsc2UgaWYgKGF0TWVkaWFGZWF0dXJlc1tzdHJlYW0uY3VycmVudCgpXSkgewogICAgICAgICAgICBzdHlsZSA9ICJlcnJvciI7IC8vIEtub3duIHByb3BlcnR5LCBzaG91bGQgYmUgaW4gQG1lZGlhVHlwZSgKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVua25vd24sIGV4cGVjdGluZyBrZXl3b3JkIG9yIGF0dHJpYnV0ZSwgYXNzdW1pbmcgYXR0cmlidXRlCiAgICAgICAgICAgIHN0eWxlID0gImF0dHJpYnV0ZSBlcnJvciI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0ID09ICJAbWVkaWFUeXBlIikgewogICAgICAgICAgaWYgKGF0TWVkaWFUeXBlc1tzdHJlYW0uY3VycmVudCgpXSkgewogICAgICAgICAgICBzdHlsZSA9ICJhdHRyaWJ1dGUiOwogICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW0uY3VycmVudCgpLnRvTG93ZXJDYXNlKCkgPT0gImFuZCIpIHsKICAgICAgICAgICAgc3R5bGUgPSAib3BlcmF0b3IiOwogICAgICAgICAgfSBlbHNlIGlmICgvXihvbmx5fG5vdCkkL2kudGVzdChzdHJlYW0uY3VycmVudCgpKSkgewogICAgICAgICAgICBzdHlsZSA9ICJlcnJvciI7IC8vIE9ubHkgYWxsb3dlZCBpbiBAbWVkaWEKICAgICAgICAgIH0gZWxzZSBpZiAoYXRNZWRpYUZlYXR1cmVzW3N0cmVhbS5jdXJyZW50KCldKSB7CiAgICAgICAgICAgIHN0eWxlID0gImVycm9yIjsgLy8gS25vd24gcHJvcGVydHksIHNob3VsZCBiZSBpbiBwYXJlbnRoZXNlcwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVW5rbm93biBhdHRyaWJ1dGUgb3IgcHJvcGVydHksIGJ1dCBleHBlY3RpbmcgcHJvcGVydHkgKHByZWNlZGVkCiAgICAgICAgICAgIC8vIGJ5ICJhbmQiKS4gU2hvdWxkIGJlIGluIHBhcmVudGhlc2VzCiAgICAgICAgICAgIHN0eWxlID0gImVycm9yIjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHQgPT0gIkBtZWRpYVR5cGUoIikgewogICAgICAgICAgaWYgKHByb3BlcnR5S2V5d29yZHNbc3RyZWFtLmN1cnJlbnQoKV0pIHsKICAgICAgICAgICAgLy8gZG8gbm90aGluZywgcmVtYWlucyAicHJvcGVydHkiCiAgICAgICAgICB9IGVsc2UgaWYgKGF0TWVkaWFUeXBlc1tzdHJlYW0uY3VycmVudCgpXSkgewogICAgICAgICAgICBzdHlsZSA9ICJlcnJvciI7IC8vIEtub3duIHByb3BlcnR5LCBzaG91bGQgYmUgaW4gcGFyZW50aGVzZXMKICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLmN1cnJlbnQoKS50b0xvd2VyQ2FzZSgpID09ICJhbmQiKSB7CiAgICAgICAgICAgIHN0eWxlID0gIm9wZXJhdG9yIjsKICAgICAgICAgIH0gZWxzZSBpZiAoL14ob25seXxub3QpJC9pLnRlc3Qoc3RyZWFtLmN1cnJlbnQoKSkpIHsKICAgICAgICAgICAgc3R5bGUgPSAiZXJyb3IiOyAvLyBPbmx5IGFsbG93ZWQgaW4gQG1lZGlhCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHlsZSArPSAiIGVycm9yIjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3R5bGUgPSAiZXJyb3IiOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzdHlsZSA9PSAiYXRvbSIpIHsKICAgICAgICBpZighY29udGV4dCB8fCBjb250ZXh0ID09ICJAbWVkaWF7IikgewogICAgICAgICAgc3R5bGUgPSAiYnVpbHRpbiI7CiAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0ID09ICJwcm9wZXJ0eVZhbHVlIikgewogICAgICAgICAgaWYgKCEvXiMoWzAtOWEtZkEtZl17M318WzAtOWEtZkEtZl17Nn0pJC8udGVzdChzdHJlYW0uY3VycmVudCgpKSkgewogICAgICAgICAgICBzdHlsZSArPSAiIGVycm9yIjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3R5bGUgPSAiZXJyb3IiOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjb250ZXh0ID09ICJAbWVkaWEiICYmIHR5cGUgPT0gInsiKSB7CiAgICAgICAgc3R5bGUgPSAiZXJyb3IiOwogICAgICB9CgogICAgICAvLyBQdXNoL3BvcCBjb250ZXh0IHN0YWNrCiAgICAgIGlmICh0eXBlID09ICJ7IikgewogICAgICAgIGlmIChjb250ZXh0ID09ICJAbWVkaWEiIHx8IGNvbnRleHQgPT0gIkBtZWRpYVR5cGUiKSB7CiAgICAgICAgICBzdGF0ZS5zdGFjay5wb3AoKTsKICAgICAgICAgIHN0YXRlLnN0YWNrW3N0YXRlLnN0YWNrLmxlbmd0aC0xXSA9ICJAbWVkaWF7IjsKICAgICAgICB9CiAgICAgICAgZWxzZSBzdGF0ZS5zdGFjay5wdXNoKCJydWxlIik7CiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZSA9PSAifSIpIHsKICAgICAgICBzdGF0ZS5zdGFjay5wb3AoKTsKICAgICAgICBpZiAoY29udGV4dCA9PSAicHJvcGVydHlWYWx1ZSIpIHN0YXRlLnN0YWNrLnBvcCgpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIkBtZWRpYSIpIHN0YXRlLnN0YWNrLnB1c2goIkBtZWRpYSIpOwogICAgICBlbHNlIGlmIChjb250ZXh0ID09ICJAbWVkaWEiICYmIC9cYihrZXl3b3JkfGF0dHJpYnV0ZSlcYi8udGVzdChzdHlsZSkpCiAgICAgICAgc3RhdGUuc3RhY2sucHVzaCgiQG1lZGlhVHlwZSIpOwogICAgICBlbHNlIGlmIChjb250ZXh0ID09ICJAbWVkaWFUeXBlIiAmJiBzdHJlYW0uY3VycmVudCgpID09ICIsIikgc3RhdGUuc3RhY2sucG9wKCk7CiAgICAgIGVsc2UgaWYgKGNvbnRleHQgPT0gIkBtZWRpYVR5cGUiICYmIHR5cGUgPT0gIigiKSBzdGF0ZS5zdGFjay5wdXNoKCJAbWVkaWFUeXBlKCIpOwogICAgICBlbHNlIGlmIChjb250ZXh0ID09ICJAbWVkaWFUeXBlKCIgJiYgdHlwZSA9PSAiKSIpIHN0YXRlLnN0YWNrLnBvcCgpOwogICAgICBlbHNlIGlmIChjb250ZXh0ID09ICJydWxlIiAmJiB0eXBlID09ICI6Iikgc3RhdGUuc3RhY2sucHVzaCgicHJvcGVydHlWYWx1ZSIpOwogICAgICBlbHNlIGlmIChjb250ZXh0ID09ICJwcm9wZXJ0eVZhbHVlIiAmJiB0eXBlID09ICI7Iikgc3RhdGUuc3RhY2sucG9wKCk7CiAgICAgIHJldHVybiBzdHlsZTsKICAgIH0sCgogICAgaW5kZW50OiBmdW5jdGlvbihzdGF0ZSwgdGV4dEFmdGVyKSB7CiAgICAgIHZhciBuID0gc3RhdGUuc3RhY2subGVuZ3RoOwogICAgICBpZiAoL15cfS8udGVzdCh0ZXh0QWZ0ZXIpKQogICAgICAgIG4gLT0gc3RhdGUuc3RhY2tbc3RhdGUuc3RhY2subGVuZ3RoLTFdID09ICJwcm9wZXJ0eVZhbHVlIiA/IDIgOiAxOwogICAgICByZXR1cm4gc3RhdGUuYmFzZUluZGVudCArIG4gKiBpbmRlbnRVbml0OwogICAgfSwKCiAgICBlbGVjdHJpY0NoYXJzOiAifSIKICB9Owp9KTsKCkNvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC9jc3MiLCAiY3NzIik7Cgo8L3NjcmlwdD4KICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogIAkuQ29kZU1pcnJvciB7CiAgbGluZS1oZWlnaHQ6IDFlbTsKICBmb250LWZhbWlseTogbW9ub3NwYWNlOwoKICAvKiBOZWNlc3Nhcnkgc28gdGhlIHNjcm9sbGJhciBjYW4gYmUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHdpdGhpbiB0aGUgd3JhcHBlciBvbiBMaW9uLiAqLwogIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAvKiBUaGlzIHByZXZlbnRzIHVud2FudGVkIHNjcm9sbGJhcnMgZnJvbSBzaG93aW5nIHVwIG9uIHRoZSBib2R5IGFuZCB3cmFwcGVyIGluIElFLiAqLwogIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5Db2RlTWlycm9yLXNjcm9sbCB7CiAgb3ZlcmZsb3c6IGF1dG87CiAgaGVpZ2h0OiAzMDBweDsKICAvKiBUaGlzIGlzIG5lZWRlZCB0byBwcmV2ZW50IGFuIElFWzY3XSBidWcgd2hlcmUgdGhlIHNjcm9sbGVkIGNvbnRlbnQKICAgICBpcyB2aXNpYmxlIG91dHNpZGUgb2YgdGhlIHNjcm9sbGluZyBib3guICovCiAgcG9zaXRpb246IHJlbGF0aXZlOwogIG91dGxpbmU6IG5vbmU7Cn0KCi8qIFZlcnRpY2FsIHNjcm9sbGJhciAqLwouQ29kZU1pcnJvci1zY3JvbGxiYXIgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICByaWdodDogMDsgdG9wOiAwOwogIG92ZXJmbG93LXg6IGhpZGRlbjsKICBvdmVyZmxvdy15OiBzY3JvbGw7CiAgei1pbmRleDogNTsKfQouQ29kZU1pcnJvci1zY3JvbGxiYXItaW5uZXIgewogIC8qIFRoaXMgbmVlZHMgdG8gaGF2ZSBhIG5vbnplcm8gd2lkdGggaW4gb3JkZXIgZm9yIHRoZSBzY3JvbGxiYXIgdG8gYXBwZWFyCiAgICAgaW4gRmlyZWZveCBhbmQgSUU5LiAqLwogIHdpZHRoOiAxcHg7Cn0KLkNvZGVNaXJyb3Itc2Nyb2xsYmFyLmNtLXNiLW92ZXJsYXAgewogIC8qIEVuc3VyZSB0aGF0IHRoZSBzY3JvbGxiYXIgYXBwZWFycyBpbiBMaW9uLCBhbmQgdGhhdCBpdCBvdmVybGFwcyB0aGUgY29udGVudAogICAgIHJhdGhlciB0aGFuIHNpdHRpbmcgdG8gdGhlIHJpZ2h0IG9mIGl0LiAqLwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB6LWluZGV4OiAxOwogIGZsb2F0OiBub25lOwogIHJpZ2h0OiAwOwogIG1pbi13aWR0aDogMTJweDsKfQouQ29kZU1pcnJvci1zY3JvbGxiYXIuY20tc2Itbm9ub3ZlcmxhcCB7CiAgbWluLXdpZHRoOiAxMnB4Owp9Ci5Db2RlTWlycm9yLXNjcm9sbGJhci5jbS1zYi1pZTcgewogIG1pbi13aWR0aDogMThweDsKfQoKLkNvZGVNaXJyb3ItZ3V0dGVyIHsKICBwb3NpdGlvbjogYWJzb2x1dGU7IGxlZnQ6IDA7IHRvcDogMDsKICB6LWluZGV4OiAxMDsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICBib3JkZXItcmlnaHQ6IDNweCBzb2xpZCAjM2RlYzQ0OwogIG1pbi13aWR0aDogMmVtOwogIGhlaWdodDogMTAwJTsKfQouQ29kZU1pcnJvci1ndXR0ZXItdGV4dCB7CiAgY29sb3I6ICNhYWE7CiAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgcGFkZGluZzogLjRlbSAuMmVtIC40ZW0gLjRlbTsKICB3aGl0ZS1zcGFjZTogcHJlICFpbXBvcnRhbnQ7CiAgY3Vyc29yOiBkZWZhdWx0Owp9Ci5Db2RlTWlycm9yLWxpbmVzIHsKICBwYWRkaW5nOiAuNGVtOwogIHdoaXRlLXNwYWNlOiBwcmU7CiAgY3Vyc29yOiB0ZXh0Owp9CgouQ29kZU1pcnJvciBwcmUgewogIC1tb3otYm9yZGVyLXJhZGl1czogMDsKICAtd2Via2l0LWJvcmRlci1yYWRpdXM6IDA7CiAgLW8tYm9yZGVyLXJhZGl1czogMDsKICBib3JkZXItcmFkaXVzOiAwOwogIGJvcmRlci13aWR0aDogMDsgbWFyZ2luOiAwOyBwYWRkaW5nOiAwOyBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICBmb250LWZhbWlseTogaW5oZXJpdDsKICBmb250LXNpemU6IGluaGVyaXQ7CiAgcGFkZGluZzogMDsgbWFyZ2luOiAwOwogIHdoaXRlLXNwYWNlOiBwcmU7CiAgd29yZC13cmFwOiBub3JtYWw7CiAgbGluZS1oZWlnaHQ6IGluaGVyaXQ7CiAgY29sb3I6IGluaGVyaXQ7Cn0KCi5Db2RlTWlycm9yLXdyYXAgcHJlIHsKICB3b3JkLXdyYXA6IGJyZWFrLXdvcmQ7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogIHdvcmQtYnJlYWs6IG5vcm1hbDsKfQouQ29kZU1pcnJvci13cmFwIC5Db2RlTWlycm9yLXNjcm9sbCB7CiAgb3ZlcmZsb3cteDogaGlkZGVuOwp9CgouQ29kZU1pcnJvciB0ZXh0YXJlYSB7CiAgb3V0bGluZTogbm9uZSAhaW1wb3J0YW50Owp9CgouQ29kZU1pcnJvciBwcmUuQ29kZU1pcnJvci1jdXJzb3IgewogIHotaW5kZXg6IDEwOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB2aXNpYmlsaXR5OiBoaWRkZW47CiAgYm9yZGVyLWxlZnQ6IDFweCBzb2xpZCBibGFjazsKICBib3JkZXItcmlnaHQ6IG5vbmU7CiAgd2lkdGg6IDA7Cn0KLmNtLWtleW1hcC1mYXQtY3Vyc29yIHByZS5Db2RlTWlycm9yLWN1cnNvciB7CiAgd2lkdGg6IGF1dG87CiAgYm9yZGVyOiAwOwogIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogIGJhY2tncm91bmQ6IHJnYmEoMCwgMjAwLCAwLCAuNCk7CiAgZmlsdGVyOiBwcm9naWQ6RFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuZ3JhZGllbnQoc3RhcnRDb2xvcnN0cj0jNjYwMGM4MDAsIGVuZENvbG9yc3RyPSM0YzAwYzgwMCk7Cn0KLyogS2x1ZGdlIHRvIHR1cm4gb2ZmIGZpbHRlciBpbiBpZTkrLCB3aGljaCBhbHNvIGFjY2VwdHMgcmdiYSAqLwouY20ta2V5bWFwLWZhdC1jdXJzb3IgcHJlLkNvZGVNaXJyb3ItY3Vyc29yOm5vdCgjbm9uc2Vuc2VfaWQpIHsKICBmaWx0ZXI6IHByb2dpZDpEWEltYWdlVHJhbnNmb3JtLk1pY3Jvc29mdC5ncmFkaWVudChlbmFibGVkPWZhbHNlKTsKfQouQ29kZU1pcnJvciBwcmUuQ29kZU1pcnJvci1jdXJzb3IuQ29kZU1pcnJvci1vdmVyd3JpdGUge30KLkNvZGVNaXJyb3ItZm9jdXNlZCBwcmUuQ29kZU1pcnJvci1jdXJzb3IgewogIHZpc2liaWxpdHk6IHZpc2libGU7Cn0KCmRpdi5Db2RlTWlycm9yLXNlbGVjdGVkIHsgYmFja2dyb3VuZDogI2Q5ZDlkOTsgfQouQ29kZU1pcnJvci1mb2N1c2VkIGRpdi5Db2RlTWlycm9yLXNlbGVjdGVkIHsgYmFja2dyb3VuZDogI2Q3ZDRmMDsgfQoKLkNvZGVNaXJyb3Itc2VhcmNoaW5nIHsKICBiYWNrZ3JvdW5kOiAjZmZhOwogIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDAsIC40KTsKfQoKLyogRGVmYXVsdCB0aGVtZSAqLwoKLmNtLXMtZGVmYXVsdCBzcGFuLmNtLWtleXdvcmQge2NvbG9yOiAjNzA4O30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLWF0b20ge2NvbG9yOiAjMjE5O30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLW51bWJlciB7Y29sb3I6ICMxNjQ7fQouY20tcy1kZWZhdWx0IHNwYW4uY20tZGVmIHtjb2xvcjogIzAwZjt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS12YXJpYWJsZSB7Y29sb3I6IGJsYWNrO30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLXZhcmlhYmxlLTIge2NvbG9yOiAjMDVhO30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLXZhcmlhYmxlLTMge2NvbG9yOiAjMDg1O30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLXByb3BlcnR5IHtjb2xvcjogYmxhY2s7fQouY20tcy1kZWZhdWx0IHNwYW4uY20tb3BlcmF0b3Ige2NvbG9yOiBibGFjazt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1jb21tZW50IHtjb2xvcjogI2E1MDt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1zdHJpbmcge2NvbG9yOiAjYTExO30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLXN0cmluZy0yIHtjb2xvcjogI2Y1MDt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1tZXRhIHtjb2xvcjogIzU1NTt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1lcnJvciB7Y29sb3I6ICNmMDA7fQouY20tcy1kZWZhdWx0IHNwYW4uY20tcXVhbGlmaWVyIHtjb2xvcjogIzU1NTt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1idWlsdGluIHtjb2xvcjogIzMwYTt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1icmFja2V0IHtjb2xvcjogIzk5Nzt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS10YWcge2NvbG9yOiAjMTcwO30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLWF0dHJpYnV0ZSB7Y29sb3I6ICMwMGM7fQouY20tcy1kZWZhdWx0IHNwYW4uY20taGVhZGVyIHtjb2xvcjogYmx1ZTt9Ci5jbS1zLWRlZmF1bHQgc3Bhbi5jbS1xdW90ZSB7Y29sb3I6ICMwOTA7fQouY20tcy1kZWZhdWx0IHNwYW4uY20taHIge2NvbG9yOiAjOTk5O30KLmNtLXMtZGVmYXVsdCBzcGFuLmNtLWxpbmsge2NvbG9yOiAjMDBjO30KCnNwYW4uY20taGVhZGVyLCBzcGFuLmNtLXN0cm9uZyB7Zm9udC13ZWlnaHQ6IGJvbGQ7fQpzcGFuLmNtLWVtIHtmb250LXN0eWxlOiBpdGFsaWM7fQpzcGFuLmNtLWVtc3Ryb25nIHtmb250LXN0eWxlOiBpdGFsaWM7IGZvbnQtd2VpZ2h0OiBib2xkO30Kc3Bhbi5jbS1saW5rIHt0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTt9CgpzcGFuLmNtLWludmFsaWRjaGFyIHtjb2xvcjogI2YwMDt9CgpkaXYuQ29kZU1pcnJvciBzcGFuLkNvZGVNaXJyb3ItbWF0Y2hpbmdicmFja2V0IHtjb2xvcjogIzBmMDt9CmRpdi5Db2RlTWlycm9yIHNwYW4uQ29kZU1pcnJvci1ub25tYXRjaGluZ2JyYWNrZXQge2NvbG9yOiAjZjIyO30KCkBtZWRpYSBwcmludCB7CgogIC8qIEhpZGUgdGhlIGN1cnNvciB3aGVuIHByaW50aW5nICovCiAgLkNvZGVNaXJyb3IgcHJlLkNvZGVNaXJyb3ItY3Vyc29yIHsKICAgIHZpc2liaWxpdHk6IGhpZGRlbjsKICB9Cgp9CgogIDwvc3R5bGU+CiAgPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAJYm9keSB7CiAgICBtaW4td2lkdGg6IDk2MHB4OwogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsKICAgIG1hcmdpbjogMDsKICAgIGZvbnQtZmFtaWx5OiAiSGVsdmV0aWNhIE5ldWUiLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAxM3B4OwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGxpbmUtaGVpZ2h0OiAxOHB4OwogICAgY29sb3I6ICM0NDQ7Cn0KCnAgewogICAgZm9udC1zaXplOiAxM3B4OwogICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgIGxpbmUtaGVpZ2h0OiAxOHB4OwogICAgbWFyZ2luLWJvdHRvbTogOXB4Owp9CgphIHsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKfQpoZWFkZXJ7dGV4dC1hbGlnbjogY2VudGVyOwogICAgYmFja2dyb3VuZDogI2Q5ZDlkOTsKICAgIGJvcmRlci1yYWRpdXM6IDVweCA1cHggMHB4IDBweDsKICAgIGhlaWdodDogMTNweDsKICAgIHBhZGRpbmc6MTVweDsKICAgIG1hcmdpbi1ib3R0b206IDEzMHB4O30KLnBycHsKICAgIGJhY2tncm91bmQ6ICNlNzRjM2M7CiAgICB3aWR0aDogMTVweDsKICAgIGhlaWdodDogMTVweDsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgYm9yZGVyLXJhZGl1czogMTAwJTsKICAgIGZsb2F0OiBsZWZ0OwogICAgbWFyZ2luOjBweCA1cHg7Cn0KLm1pbnsKICAgIGJhY2tncm91bmQ6ICNmMWM0MGY7Cn0gCi5tYXh7CiAgICBiYWNrZ3JvdW5kOiAjMmVjYzcxOwp9Ci5tYXhlcnsKICAgIGZvbnQtc2l6ZTogMjBweDsKICAgIGNvbG9yOiM4RDhEOEQ7CiAgICB0ZXh0LXNoYWRvdzowcHggMXB4IDBweCAjZmZmOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogICAgLXdlYmtpdC10cmFuc2Zvcm06IHJvdGF0ZSgtNDVkZWcpOwogICAgICAgLW1vei10cmFuc2Zvcm06IHJvdGF0ZSgtNDVkZWcpOwogICAgICAgICAtby10cmFuc2Zvcm06IHJvdGF0ZSgtNDVkZWcpOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBmbG9hdDogcmlnaHQ7CiAgICBsaW5lLWhlaWdodDogMTRweDsKfQpoMSB7CiAgICBtYXJnaW4tYm90dG9tOiAxOHB4OwogICAgZm9udC1zaXplOiAzMHB4OwogICAgbGluZS1oZWlnaHQ6IDM2cHg7CiAgICBmb250LXdlaWdodDogYm9sZDsKICAgIGNvbG9yOiAjNDQ0OwogICAgcGFkZGluZy10b3A6IDMwcHg7Cn0KCmgxIHNtYWxsIHsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGNvbG9yOiAjY2NjOwp9CgpoMyB7CiAgICBjb2xvcjogIzU1NTsKfQpoMSxoMixoMyB7dGV4dC1hbGlnbjogY2VudGVyO30KdGV4dGFyZWEgewogICAgZm9udC1mYW1pbHk6IEluY29uc29sYXRhLCBNb25hY28sIENvbnNvbGFzLCAiTHVjaWRhIENvbnNvbGUiLCBtb25vc3BhY2U7CiAgICBmb250LXNpemU6IDE0cHg7CiAgICBjb2xvcjogIzU1NTsKICAgIHdpZHRoOiAzNDBweDsKICAgIHBhZGRpbmc6IDdweDsKICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgIG91dGxpbmU6IDA7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjYmJiOwp9CgouY29udGFpbmVyIHsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50IC1tb3otbGluZWFyLWdyYWRpZW50KGNlbnRlciB0b3AgLCAjRTVFNUU1IDAlLCAjQkFCQUJBIDEwMCUsICNCQUJBQkEgMTAwJSkgcmVwZWF0IHNjcm9sbCAwJSAwJTsKICAgIHBhZGRpbmctYm90dG9tOiA0NHB4OwogICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgIG1hcmdpbjogODdweCBhdXRvIDBweDsKICAgIHdpZHRoOiA5NzBweDsKICAgIGJveC1zaGFkb3c6IDBweCAwcHggOXB4OwoKCn0KCi5jb250YWluZXIgLnJhdyB7CiAgICB3aWR0aDogMzgwcHg7CiAgICBkaXNwbGF5OiBpbmxpbmU7CiAgICBmbG9hdDogbGVmdDsKICAgIG1hcmdpbi1sZWZ0OiAxMHB4OwogICAgbWFyZ2luLXJpZ2h0OiAxMHB4Owp9CgouY29udGFpbmVyIC5yYXcgdGV4dGFyZWEgewogICAgYm94LXNoYWRvdzogaW5zZXQgMCAxcHggM3B4IHJnYmEoMCwgMCwgMCwgMC4yKTsKICAgIC13ZWJraXQtYm94LXNoYWRvdzogaW5zZXQgMCAxcHggM3B4IHJnYmEoMCwgMCwgMCwgMC4yKTsKICAgIC1tb3otYm94LXNoYWRvdzogaW5zZXQgMCAxcHggM3B4IHJnYmEoMCwgMCwgMCwgMC4yKTsKICAgIHRyYW5zaXRpb246IGJvcmRlciBsaW5lYXIgMC4yNXMsIGJveC1zaGFkb3cgbGluZWFyIDAuMjVzOwogICAgLXdlYmtpdC10cmFuc2l0aW9uOiBib3JkZXIgbGluZWFyIDAuMjVzLCBib3gtc2hhZG93IGxpbmVhciAwLjI1czsKICAgIC1tb3otdHJhbnNpdGlvbjogYm9yZGVyIGxpbmVhciAwLjI1cywgYm94LXNoYWRvdyBsaW5lYXIgMC4yNXM7CiAgICAtby10cmFuc2l0aW9uOiBib3JkZXIgbGluZWFyIDAuMjVzLCBib3gtc2hhZG93IGxpbmVhciAwLjI1czsKfQoKLmNvbnRhaW5lciAucmF3IHRleHRhcmVhOmZvY3VzIHsKICAgIGJvcmRlci1jb2xvcjogcmdiYSg2MCwgMjAwLCAxLCAwLjgpOwogICAgYm94LXNoYWRvdzogaW5zZXQgMCAxcHggM3B4IHJnYmEoMCwgMCwgMCwgMC4xKSwgMCAwIDhweCByZ2JhKDYwLCAyMDAsIDEsIDAuNCk7CiAgICAtd2Via2l0LWJveC1zaGFkb3c6IGluc2V0IDAgMXB4IDNweCByZ2JhKDAsIDAsIDAsIDAuMSksIDAgMCA4cHggcmdiYSg2MCwgMjAwLCAxLCAwLjQpOwogICAgLW1vei1ib3gtc2hhZG93OiBpbnNldCAwIDFweCAzcHggcmdiYSgwLCAwLCAwLCAwLjEpLCAwIDAgOHB4IHJnYmEoNjAsIDIwMCwgMSwgMC40KTsKfQouQ29kZU1pcnJvcjpob3ZlciB7CiBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoImh0dHBzOi8vMS5icC5ibG9nc3BvdC5jb20vLXRaeDVUemZ0UjhFL1gxYmJhN083WHZJL0FBQUFBQUFBQUR3L3F3Z21zbk5vbzF3V1NHWlJZaGZHTi03Z1BJWTZVN1Vvd0NMY0JHQXNZSFEvczE2MDAvc2J0LW1hc2Jyby5wbmciKTsKYmFja2dyb3VuZC1zaXplOiA3MCUgYXV0bzsKYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyOwp9Ci5jb250YWluZXIgLmZvcm1hdHRlZCB7CiAgICB3aWR0aDogMzgwcHg7CiAgICBkaXNwbGF5OiBpbmxpbmU7CiAgICBmbG9hdDogbGVmdDsKICAgIG1hcmdpbi1sZWZ0OiAxMHB4OwogICAgbWFyZ2luLXJpZ2h0OiAxMHB4Owp9CgouY29udGFpbmVyIC5mb3JtYXR0ZWQgdGV4dGFyZWEgewogICAgY29sb3I6ICMwMDA7Cn0KCi5jb250YWluZXIgLm9wdGlvbnMgewogICAgd2lkdGg6IDE0MHB4OwogICAgZGlzcGxheTogaW5saW5lOwogICAgZmxvYXQ6IGxlZnQ7CiAgICBtYXJnaW4tbGVmdDogMTBweDsKICAgIG1hcmdpbi1yaWdodDogMTBweDsKfQoKLmNvbnRhaW5lciAub3B0aW9ucyBpbnB1dCB7CiAgICBtYXJnaW46IDVweCA1cHggNXB4IDBweDsKfQoKLmNvbnRhaW5lciAub3B0aW9ucyBpbnB1dFt0eXBlPXJhZGlvXSB7CiAgICBtYXJnaW4tbGVmdDogMTBweDsKfQoKLmZvb3RlciB7CiAgICBtYXJnaW4tdG9wOiAyNXB4OwogICAgY29sb3I6ICM1NTU7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7Cn0KCi5Db2RlTWlycm9yIHsKICAgIHBhZGRpbmc6IDA7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjYmJiOwogICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgIHRyYW5zaXRpb246IGFsbCAxcyBjdWJpYy1iZXppZXIoLjY4LC0wLjU1LC4yNywxLjU1KSAwczsKICAgIHRyYW5zaXRpb24tcHJvcGVydHk6IGFsbDsKICAgIHRyYW5zaXRpb24tZHVyYXRpb246IDFzOwogICAgdHJhbnNpdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllcigwLjY4LCAtMC41NSwgMC4yNywgMS41NSk7CiAgICB0cmFuc2l0aW9uLWRlbGF5OiAwczsKICAgIAoKfQoKLkNvZGVNaXJyb3Itc2Nyb2xsIHsKICAgIGhlaWdodDogMzIwcHg7Cn0KICAgIC8qIElOUFVUIE1BU0JSTyAqLwpAc3VwcG9ydHMgKC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZSkgb3IgKC1tb3otYXBwZWFyYW5jZTogbm9uZSkgewoJIGlucHV0W3R5cGU9J2NoZWNrYm94J10sIGlucHV0W3R5cGU9J3JhZGlvJ10gewoJCSAtLWFjdGl2ZTogIzI3NWVmZTsKCQkgLS1hY3RpdmUtaW5uZXI6ICNmZmY7CgkJIC0tZm9jdXM6IDJweCByZ2JhKDM5LCA5NCwgMjU0LCAuMyk7CgkJIC0tYm9yZGVyOiAjYmJjMWUxOwoJCSAtLWJvcmRlci1ob3ZlcjogIzI3NWVmZTsKCQkgLS1iYWNrZ3JvdW5kOiAjZmZmOwoJCSAtLWRpc2FibGVkOiAjZjZmOGZmOwoJCSAtLWRpc2FibGVkLWlubmVyOiAjZTFlNmY5OwoJCSAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7CgkJIC1tb3otYXBwZWFyYW5jZTogbm9uZTsKCQkgaGVpZ2h0OiAyMXB4OwoJCSBvdXRsaW5lOiBub25lOwoJCSBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CgkJIHZlcnRpY2FsLWFsaWduOiB0b3A7CgkJIHBvc2l0aW9uOiByZWxhdGl2ZTsKCQkgbWFyZ2luOiAwOwoJCSBjdXJzb3I6IHBvaW50ZXI7CgkJIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJjLCB2YXIoLS1ib3JkZXIpKTsKCQkgYmFja2dyb3VuZDogdmFyKC0tYiwgdmFyKC0tYmFja2dyb3VuZCkpOwoJCSB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuM3MsIGJvcmRlci1jb2xvciAwLjNzLCBib3gtc2hhZG93IDAuMnM7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTphZnRlciwgaW5wdXRbdHlwZT0ncmFkaW8nXTphZnRlciB7CgkJIGNvbnRlbnQ6ICcnOwoJCSBkaXNwbGF5OiBibG9jazsKCQkgbGVmdDogMDsKCQkgdG9wOiAwOwoJCSBwb3NpdGlvbjogYWJzb2x1dGU7CgkJIHRyYW5zaXRpb246IHRyYW5zZm9ybSB2YXIoLS1kLXQsIDAuM3MpIHZhcigtLWQtdC1lLCBlYXNlKSwgb3BhY2l0eSB2YXIoLS1kLW8sIDAuMnMpOwoJfQoJIGlucHV0W3R5cGU9J2NoZWNrYm94J106Y2hlY2tlZCwgaW5wdXRbdHlwZT0ncmFkaW8nXTpjaGVja2VkIHsKCQkgLS1iOiB2YXIoLS1hY3RpdmUpOwoJCSAtLWJjOiB2YXIoLS1hY3RpdmUpOwoJCSAtLWQtbzogMC4zczsKCQkgLS1kLXQ6IDAuNnM7CgkJIC0tZC10LWU6IGN1YmljLWJlemllcigwLjIsIDAuODUsIDAuMzIsIDEuMik7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpkaXNhYmxlZCwgaW5wdXRbdHlwZT0ncmFkaW8nXTpkaXNhYmxlZCB7CgkJIC0tYjogdmFyKC0tZGlzYWJsZWQpOwoJCSBjdXJzb3I6IG5vdC1hbGxvd2VkOwoJCSBvcGFjaXR5OiAwLjk7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpkaXNhYmxlZDpjaGVja2VkLCBpbnB1dFt0eXBlPSdyYWRpbyddOmRpc2FibGVkOmNoZWNrZWQgewoJCSAtLWI6IHZhcigtLWRpc2FibGVkLWlubmVyKTsKCQkgLS1iYzogdmFyKC0tYm9yZGVyKTsKCX0KCSBpbnB1dFt0eXBlPSdjaGVja2JveCddOmRpc2FibGVkICsgbGFiZWwsIGlucHV0W3R5cGU9J3JhZGlvJ106ZGlzYWJsZWQgKyBsYWJlbCB7CgkJIGN1cnNvcjogbm90LWFsbG93ZWQ7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpob3Zlcjpub3QoOmNoZWNrZWQpOm5vdCg6ZGlzYWJsZWQpLCBpbnB1dFt0eXBlPSdyYWRpbyddOmhvdmVyOm5vdCg6Y2hlY2tlZCk6bm90KDpkaXNhYmxlZCkgewoJCSAtLWJjOiB2YXIoLS1ib3JkZXItaG92ZXIpOwoJfQoJIGlucHV0W3R5cGU9J2NoZWNrYm94J106Zm9jdXMsIGlucHV0W3R5cGU9J3JhZGlvJ106Zm9jdXMgewoJCSBib3gtc2hhZG93OiAwIDAgMCB2YXIoLS1mb2N1cyk7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpub3QoLnN3aXRjaCksIGlucHV0W3R5cGU9J3JhZGlvJ106bm90KC5zd2l0Y2gpIHsKCQkgd2lkdGg6IDIxcHg7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpub3QoLnN3aXRjaCk6YWZ0ZXIsIGlucHV0W3R5cGU9J3JhZGlvJ106bm90KC5zd2l0Y2gpOmFmdGVyIHsKCQkgb3BhY2l0eTogdmFyKC0tbywgMCk7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpub3QoLnN3aXRjaCk6Y2hlY2tlZCwgaW5wdXRbdHlwZT0ncmFkaW8nXTpub3QoLnN3aXRjaCk6Y2hlY2tlZCB7CgkJIC0tbzogMTsKCX0KCSBpbnB1dFt0eXBlPSdjaGVja2JveCddICsgbGFiZWwsIGlucHV0W3R5cGU9J3JhZGlvJ10gKyBsYWJlbCB7CgkJIGxpbmUtaGVpZ2h0OiAzMnB4OwoJCSB2ZXJ0aWNhbC1hbGlnbjogdG9wOwoJCSBjdXJzb3I6IHBvaW50ZXI7CgkJIG1hcmdpbi1sZWZ0OiA0cHg7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpub3QoLnN3aXRjaCkgewoJCSBib3JkZXItcmFkaXVzOiA3cHg7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpub3QoLnN3aXRjaCk6YWZ0ZXIgewoJCSB3aWR0aDogNXB4OwoJCSBoZWlnaHQ6IDlweDsKCQkgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYWN0aXZlLWlubmVyKTsKCQkgYm9yZGVyLXRvcDogMDsKCQkgYm9yZGVyLWxlZnQ6IDA7CgkJIGxlZnQ6IDdweDsKCQkgdG9wOiA0cHg7CgkJIHRyYW5zZm9ybTogcm90YXRlKHZhcigtLXIsIDIwZGVnKSk7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXTpub3QoLnN3aXRjaCk6Y2hlY2tlZCB7CgkJIC0tcjogNDNkZWc7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXS5zd2l0Y2ggewoJCSB3aWR0aDogMzhweDsKCQkgYm9yZGVyLXJhZGl1czogMTFweDsKCX0KCSBpbnB1dFt0eXBlPSdjaGVja2JveCddLnN3aXRjaDphZnRlciB7CgkJIGxlZnQ6IDJweDsKCQkgdG9wOiAycHg7CgkJIGJvcmRlci1yYWRpdXM6IDUwJTsKCQkgd2lkdGg6IDE1cHg7CgkJIGhlaWdodDogMTVweDsKCQkgYmFja2dyb3VuZDogdmFyKC0tYWIsIHZhcigtLWJvcmRlcikpOwoJCSB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgodmFyKC0teCwgMCkpOwoJfQoJIGlucHV0W3R5cGU9J2NoZWNrYm94J10uc3dpdGNoOmNoZWNrZWQgewoJCSAtLWFiOiB2YXIoLS1hY3RpdmUtaW5uZXIpOwoJCSAtLXg6IDE3cHg7Cgl9CgkgaW5wdXRbdHlwZT0nY2hlY2tib3gnXS5zd2l0Y2g6ZGlzYWJsZWQ6bm90KDpjaGVja2VkKTphZnRlciB7CgkJIG9wYWNpdHk6IDAuNjsKCX0KCSBpbnB1dFt0eXBlPSdyYWRpbyddIHsKCQkgYm9yZGVyLXJhZGl1czogNTAlOwoJfQoJIGlucHV0W3R5cGU9J3JhZGlvJ106YWZ0ZXIgewoJCSB3aWR0aDogMTlweDsKCQkgaGVpZ2h0OiAxOXB4OwoJCSBib3JkZXItcmFkaXVzOiA1MCU7CgkJIGJhY2tncm91bmQ6IHZhcigtLWFjdGl2ZS1pbm5lcik7CgkJIG9wYWNpdHk6IDA7CgkJIHRyYW5zZm9ybTogc2NhbGUodmFyKC0tcywgMC43KSk7Cgl9CgkgaW5wdXRbdHlwZT0ncmFkaW8nXTpjaGVja2VkIHsKCQkgLS1zOiAwLjU7Cgl9Cn0KIAoKICA8L3N0eWxlPgogIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0Ij4KICAJCihmdW5jdGlvbiAoKSB7CgogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGZ1bmN0aW9uIGNzc2JlYXV0aWZ5KHN0eWxlLCBvcHQpIHsKCiAgICAgICAgdmFyIG9wdGlvbnMsIGluZGV4ID0gMCwgbGVuZ3RoID0gc3R5bGUubGVuZ3RoLCBibG9ja3MsIGZvcm1hdHRlZCA9ICcnLAogICAgICAgICAgICBjaCwgY2gyLCBzdHIsIHN0YXRlLCBTdGF0ZSwgZGVwdGgsIHF1b3RlLCBjb21tZW50LAogICAgICAgICAgICBvcGVuYnJhY2VzdWZmaXggPSB0cnVlLAogICAgICAgICAgICBhdXRvc2VtaWNvbG9uID0gZmFsc2UsCiAgICAgICAgICAgIHRyaW1SaWdodDsKCiAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gb3B0IDoge307CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmluZGVudCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgb3B0aW9ucy5pbmRlbnQgPSAnICAgICc7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vcGVuYnJhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIG9wZW5icmFjZXN1ZmZpeCA9IChvcHRpb25zLm9wZW5icmFjZSA9PT0gJ2VuZC1vZi1saW5lJyk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5hdXRvc2VtaWNvbG9uID09PSAnYm9vbGVhbicpIHsKICAgICAgICAgICAgYXV0b3NlbWljb2xvbiA9IG9wdGlvbnMuYXV0b3NlbWljb2xvbjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzV2hpdGVzcGFjZShjKSB7CiAgICAgICAgICAgIHJldHVybiAoYyA9PT0gJyAnKSB8fCAoYyA9PT0gJ1xuJykgfHwgKGMgPT09ICdcdCcpIHx8IChjID09PSAnXHInKSB8fCAoYyA9PT0gJ1xmJyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc1F1b3RlKGMpIHsKICAgICAgICAgICAgcmV0dXJuIChjID09PSAnXCcnKSB8fCAoYyA9PT0gJyInKTsKICAgICAgICB9CgogICAgICAgIC8vIEZJWE1FOiBoYW5kbGUgVW5pY29kZSBjaGFyYWN0ZXJzCiAgICAgICAgZnVuY3Rpb24gaXNOYW1lKGMpIHsKICAgICAgICAgICAgcmV0dXJuIChjaCA+PSAnYScgJiYgY2ggPD0gJ3onKSB8fAogICAgICAgICAgICAgICAgKGNoID49ICdBJyAmJiBjaCA8PSAnWicpIHx8CiAgICAgICAgICAgICAgICAoY2ggPj0gJzAnICYmIGNoIDw9ICc5JykgfHwKICAgICAgICAgICAgICAgICctXyouOiNbXScuaW5kZXhPZihjKSA+PSAwOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kSW5kZW50KCkgewogICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgZm9yIChpID0gZGVwdGg7IGkgPiAwOyBpIC09IDEpIHsKICAgICAgICAgICAgICAgIGZvcm1hdHRlZCArPSBvcHRpb25zLmluZGVudDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb3BlbkJsb2NrKCkgewogICAgICAgICAgICBmb3JtYXR0ZWQgPSB0cmltUmlnaHQoZm9ybWF0dGVkKTsKICAgICAgICAgICAgaWYgKG9wZW5icmFjZXN1ZmZpeCkgewogICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9ICcgeyc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gJ1xuJzsKICAgICAgICAgICAgICAgIGFwcGVuZEluZGVudCgpOwogICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9ICd7JzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2gyICE9PSAnXG4nKSB7CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gJ1xuJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZXB0aCArPSAxOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2xvc2VCbG9jaygpIHsKICAgICAgICAgICAgdmFyIGNoOwogICAgICAgICAgICBkZXB0aCAtPSAxOwogICAgICAgICAgICBmb3JtYXR0ZWQgPSB0cmltUmlnaHQoZm9ybWF0dGVkKTsKCiAgICAgICAgICAgIGlmIChhdXRvc2VtaWNvbG9uKSB7CiAgICAgICAgICAgICAgICBjaCA9IGZvcm1hdHRlZC5jaGFyQXQoZm9ybWF0dGVkLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgaWYgKGNoICE9PSAnOycgJiYgY2ggIT09ICd7JykgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZCArPSAnOyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvcm1hdHRlZCArPSAnXG4nOwogICAgICAgICAgICBhcHBlbmRJbmRlbnQoKTsKICAgICAgICAgICAgZm9ybWF0dGVkICs9ICd9JzsKICAgICAgICAgICAgYmxvY2tzLnB1c2goZm9ybWF0dGVkKTsKICAgICAgICAgICAgZm9ybWF0dGVkID0gJyc7CiAgICAgICAgfQoKICAgICAgICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltUmlnaHQpIHsKICAgICAgICAgICAgdHJpbVJpZ2h0ID0gZnVuY3Rpb24gKHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzLnRyaW1SaWdodCgpOwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgICAgICAgICB0cmltUmlnaHQgPSBmdW5jdGlvbiAocykgewogICAgICAgICAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvXHMrJC8sICcnKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIFN0YXRlID0gewogICAgICAgICAgICBTdGFydDogMCwKICAgICAgICAgICAgQXRSdWxlOiAxLAogICAgICAgICAgICBCbG9jazogMiwKICAgICAgICAgICAgU2VsZWN0b3I6IDMsCiAgICAgICAgICAgIFJ1bGVzZXQ6IDQsCiAgICAgICAgICAgIFByb3BlcnR5OiA1LAogICAgICAgICAgICBTZXBhcmF0b3I6IDYsCiAgICAgICAgICAgIEV4cHJlc3Npb246IDcsCiAgICAgICAgICAgIFVSTDogOAogICAgICAgIH07CgogICAgICAgIGRlcHRoID0gMDsKICAgICAgICBzdGF0ZSA9IFN0YXRlLlN0YXJ0OwogICAgICAgIGNvbW1lbnQgPSBmYWxzZTsKICAgICAgICBibG9ja3MgPSBbXTsKCiAgICAgICAgLy8gV2Ugd2FudCB0byBkZWFsIHdpdGggTEYgKFxuKSBvbmx5CiAgICAgICAgc3R5bGUgPSBzdHlsZS5yZXBsYWNlKC9cclxuL2csICdcbicpOwoKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgY2ggPSBzdHlsZS5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICBjaDIgPSBzdHlsZS5jaGFyQXQoaW5kZXggKyAxKTsKICAgICAgICAgICAgaW5kZXggKz0gMTsKCiAgICAgICAgICAgIC8vIEluc2lkZSBhIHN0cmluZyBsaXRlcmFsPwogICAgICAgICAgICBpZiAoaXNRdW90ZShxdW90ZSkpIHsKICAgICAgICAgICAgICAgIGZvcm1hdHRlZCArPSBjaDsKICAgICAgICAgICAgICAgIGlmIChjaCA9PT0gcXVvdGUpIHsKICAgICAgICAgICAgICAgICAgICBxdW90ZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICdcXCcgJiYgY2gyID09PSBxdW90ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIERvbid0IHRyZWF0IGVzY2FwZWQgY2hhcmFjdGVyIGFzIHRoZSBjbG9zaW5nIHF1b3RlCiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoMjsKICAgICAgICAgICAgICAgICAgICBpbmRleCArPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0aW5nIGEgc3RyaW5nIGxpdGVyYWw/CiAgICAgICAgICAgIGlmIChpc1F1b3RlKGNoKSkgewogICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgcXVvdGUgPSBjaDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb21tZW50CiAgICAgICAgICAgIGlmIChjb21tZW50KSB7CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gY2g7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICcqJyAmJiBjaDIgPT09ICcvJykgewogICAgICAgICAgICAgICAgICAgIGNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gY2gyOwogICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjaCA9PT0gJy8nICYmIGNoMiA9PT0gJyonKSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWVudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZCArPSBjaDI7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHN0YXRlID09PSBTdGF0ZS5TdGFydCkgewoKICAgICAgICAgICAgICAgIGlmIChibG9ja3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaCkgJiYgZm9ybWF0dGVkLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ29weSB3aGl0ZSBzcGFjZXMgYW5kIGNvbnRyb2wgY2hhcmFjdGVycwogICAgICAgICAgICAgICAgaWYgKGNoIDw9ICcgJyB8fCBjaC5jaGFyQ29kZUF0KDApID49IDEyOCkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNlbGVjdG9yIG9yIGF0LXJ1bGUKICAgICAgICAgICAgICAgIGlmIChpc05hbWUoY2gpIHx8IChjaCA9PT0gJ0AnKSkgewoKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciB0cmFpbGluZyB3aGl0ZXNwYWNlcyBhbmQgbGluZWZlZWRzLgogICAgICAgICAgICAgICAgICAgIHN0ciA9IHRyaW1SaWdodChmb3JtYXR0ZWQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGVtcHR5IHN0cmluZyBhZnRlciByZW1vdmluZyBhbGwgdGhlIHRyYWlsaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNwYWNlcywgdGhhdCBtZWFucyB3ZSBhcmUgcmlnaHQgYWZ0ZXIgYSBibG9jay4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGEgYmxhbmsgbGluZSBhcyB0aGUgc2VwYXJhdG9yLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZCA9ICdcblxuJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFmdGVyIGZpbmlzaGluZyBhIHJ1bGVzZXQgb3IgZGlyZWN0aXZlIHN0YXRlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlcmUgc2hvdWxkIGJlIG9uZSBibGFuayBsaW5lLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLmNoYXJBdChzdHIubGVuZ3RoIC0gMSkgPT09ICd9JyB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ci5jaGFyQXQoc3RyLmxlbmd0aCAtIDEpID09PSAnOycpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgPSBzdHIgKyAnXG5cbic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBZnRlciBibG9jayBjb21tZW50LCBrZWVwIGFsbCB0aGUgbGluZWZlZWRzIGJ1dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RhcnQgZnJvbSB0aGUgZmlyc3QgY29sdW1uIChyZW1vdmUgd2hpdGVzcGFjZXMgcHJlZml4KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2gyID0gZm9ybWF0dGVkLmNoYXJBdChmb3JtYXR0ZWQubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoMiAhPT0gJyAnICYmIGNoMi5jaGFyQ29kZUF0KDApICE9PSA5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgPSBmb3JtYXR0ZWQuc3Vic3RyKDAsIGZvcm1hdHRlZC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gY2g7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSAoY2ggPT09ICdAJykgPyBTdGF0ZS5BdFJ1bGUgOiBTdGF0ZS5TZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHN0YXRlID09PSBTdGF0ZS5BdFJ1bGUpIHsKCiAgICAgICAgICAgICAgICAvLyAnOycgdGVybWluYXRlcyBhIHN0YXRlbWVudC4KICAgICAgICAgICAgICAgIGlmIChjaCA9PT0gJzsnKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gJ3snIHN0YXJ0cyBhIGJsb2NrCiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICd7JykgewogICAgICAgICAgICAgICAgICAgIHN0ciA9IHRyaW1SaWdodChmb3JtYXR0ZWQpOwogICAgICAgICAgICAgICAgICAgIG9wZW5CbG9jaygpOwogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gKHN0ciA9PT0gJ0Bmb250LWZhY2UnKSA/IFN0YXRlLlJ1bGVzZXQgOiBTdGF0ZS5CbG9jazsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gY2g7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHN0YXRlID09PSBTdGF0ZS5CbG9jaykgewoKICAgICAgICAgICAgICAgIC8vIFNlbGVjdG9yCiAgICAgICAgICAgICAgICBpZiAoaXNOYW1lKGNoKSkgewoKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciB0cmFpbGluZyB3aGl0ZXNwYWNlcyBhbmQgbGluZWZlZWRzLgogICAgICAgICAgICAgICAgICAgIHN0ciA9IHRyaW1SaWdodChmb3JtYXR0ZWQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGVtcHR5IHN0cmluZyBhZnRlciByZW1vdmluZyBhbGwgdGhlIHRyYWlsaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNwYWNlcywgdGhhdCBtZWFucyB3ZSBhcmUgcmlnaHQgYWZ0ZXIgYSBibG9jay4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIGEgYmxhbmsgbGluZSBhcyB0aGUgc2VwYXJhdG9yLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZCA9ICdcblxuJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2VydCBibGFuayBsaW5lIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0ci5jaGFyQXQoc3RyLmxlbmd0aCAtIDEpID09PSAnfScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZCA9IHN0ciArICdcblxuJzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFmdGVyIGJsb2NrIGNvbW1lbnQsIGtlZXAgYWxsIHRoZSBsaW5lZmVlZHMgYnV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdGFydCBmcm9tIHRoZSBmaXJzdCBjb2x1bW4gKHJlbW92ZSB3aGl0ZXNwYWNlcyBwcmVmaXgpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaDIgPSBmb3JtYXR0ZWQuY2hhckF0KGZvcm1hdHRlZC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2gyICE9PSAnICcgJiYgY2gyLmNoYXJDb2RlQXQoMCkgIT09IDkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZCA9IGZvcm1hdHRlZC5zdWJzdHIoMCwgZm9ybWF0dGVkLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBhcHBlbmRJbmRlbnQoKTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gY2g7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBTdGF0ZS5TZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAnfScgcmVzZXRzIHRoZSBzdGF0ZS4KICAgICAgICAgICAgICAgIGlmIChjaCA9PT0gJ30nKSB7CiAgICAgICAgICAgICAgICAgICAgY2xvc2VCbG9jaygpOwogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gU3RhdGUuU2VsZWN0b3IpIHsKCiAgICAgICAgICAgICAgICAvLyAneycgc3RhcnRzIHRoZSBydWxlc2V0LgogICAgICAgICAgICAgICAgaWYgKGNoID09PSAneycpIHsKICAgICAgICAgICAgICAgICAgICBvcGVuQmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IFN0YXRlLlJ1bGVzZXQ7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gJ30nIHJlc2V0cyB0aGUgc3RhdGUuCiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICd9JykgewogICAgICAgICAgICAgICAgICAgIGNsb3NlQmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IFN0YXRlLlN0YXJ0OwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvcm1hdHRlZCArPSBjaDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc3RhdGUgPT09IFN0YXRlLlJ1bGVzZXQpIHsKCiAgICAgICAgICAgICAgICAvLyAnfScgZmluaXNoZXMgdGhlIHJ1bGVzZXQuCiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICd9JykgewogICAgICAgICAgICAgICAgICAgIGNsb3NlQmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IFN0YXRlLlN0YXJ0OwogICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBTdGF0ZS5CbG9jazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoZXJlIGlzIG5vIGJsYW5rIGxpbmUgb3IgdHJhaWxpbmcgc3BhY2VzIGluYmV0d2VlbgogICAgICAgICAgICAgICAgaWYgKGNoID09PSAnXG4nKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkID0gdHJpbVJpZ2h0KGZvcm1hdHRlZCk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9ICdcbic7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgbmFtZQogICAgICAgICAgICAgICAgaWYgKCFpc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkID0gdHJpbVJpZ2h0KGZvcm1hdHRlZCk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9ICdcbic7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kSW5kZW50KCk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuUHJvcGVydHk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gY2g7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHN0YXRlID09PSBTdGF0ZS5Qcm9wZXJ0eSkgewoKICAgICAgICAgICAgICAgIC8vICc6JyBjb25jbHVkZXMgdGhlIHByb3BlcnR5LgogICAgICAgICAgICAgICAgaWYgKGNoID09PSAnOicpIHsKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgPSB0cmltUmlnaHQoZm9ybWF0dGVkKTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gJzogJzsKICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IFN0YXRlLkV4cHJlc3Npb247CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaDIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuU2VwYXJhdG9yOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAnfScgZmluaXNoZXMgdGhlIHJ1bGVzZXQuCiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICd9JykgewogICAgICAgICAgICAgICAgICAgIGNsb3NlQmxvY2soKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IFN0YXRlLlN0YXJ0OwogICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBTdGF0ZS5CbG9jazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gU3RhdGUuU2VwYXJhdG9yKSB7CgogICAgICAgICAgICAgICAgLy8gTm9uLXdoaXRlc3BhY2Ugc3RhcnRzIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICAgICAgaWYgKCFpc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuRXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBbnRpY2lwYXRlIHN0cmluZyBsaXRlcmFsLgogICAgICAgICAgICAgICAgaWYgKGlzUXVvdGUoY2gyKSkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuRXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHN0YXRlID09PSBTdGF0ZS5FeHByZXNzaW9uKSB7CgogICAgICAgICAgICAgICAgLy8gJ30nIGZpbmlzaGVzIHRoZSBydWxlc2V0LgogICAgICAgICAgICAgICAgaWYgKGNoID09PSAnfScpIHsKICAgICAgICAgICAgICAgICAgICBjbG9zZUJsb2NrKCk7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBTdGF0ZS5TdGFydDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVwdGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuQmxvY2s7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vICc7JyBjb21wbGV0ZXMgdGhlIGRlY2xhcmF0aW9uLgogICAgICAgICAgICAgICAgaWYgKGNoID09PSAnOycpIHsKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgPSB0cmltUmlnaHQoZm9ybWF0dGVkKTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQgKz0gJztcbic7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBTdGF0ZS5SdWxlc2V0OwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvcm1hdHRlZCArPSBjaDsKCiAgICAgICAgICAgICAgICBpZiAoY2ggPT09ICcoJykgewogICAgICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZWQuY2hhckF0KGZvcm1hdHRlZC5sZW5ndGggLSAyKSA9PT0gJ2wnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQuY2hhckF0KGZvcm1hdHRlZC5sZW5ndGggLSAzKSA9PT0gJ3InICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQuY2hhckF0KGZvcm1hdHRlZC5sZW5ndGggLSA0KSA9PT0gJ3UnKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBVUkwgc3RhcnRzIHdpdGggJygnIGFuZCBjbG9zZXMgd2l0aCAnKScuCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuVVJMOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gU3RhdGUuVVJMKSB7CgoKICAgICAgICAgICAgICAgIC8vICcpJyBmaW5pc2hlcyB0aGUgVVJMIChvbmx5IGlmIGl0IGlzIG5vdCBlc2NhcGVkKS4KICAgICAgICAgICAgICAgIGlmIChjaCA9PT0gJyknICYmIGZvcm1hdHRlZC5jaGFyQXQoZm9ybWF0dGVkLmxlbmd0aCAtIDEgIT09ICdcXCcpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gU3RhdGUuRXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGhlIGRlZmF1bHQgYWN0aW9uIGlzIHRvIGNvcHkgdGhlIGNoYXJhY3RlciAodG8gcHJldmVudAogICAgICAgICAgICAvLyBpbmZpbml0ZSBsb29wKS4KICAgICAgICAgICAgZm9ybWF0dGVkICs9IGNoOwogICAgICAgIH0KCiAgICAgICAgZm9ybWF0dGVkID0gYmxvY2tzLmpvaW4oJycpICsgZm9ybWF0dGVkOwoKICAgICAgICByZXR1cm4gZm9ybWF0dGVkOwogICAgfQoKICAgIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAvLyBOb2RlLmpzIG1vZHVsZS4KICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBjc3NiZWF1dGlmeTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBCcm93c2VyIGxvYWRpbmcuCiAgICAgICAgd2luZG93LmNzc2JlYXV0aWZ5ID0gY3NzYmVhdXRpZnk7CiAgICB9Cgp9KCkpOwoKICA8L3NjcmlwdD4KICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+CiAgCS8qZ2xvYmFsIGNzc2JlYXV0aWZ5OnRydWUsIGRvY3VtZW50OnRydWUsIHdpbmRvdzp0cnVlLCBDb2RlTWlycm9yOiB0cnVlICovCgp2YXIgZWRpdG9yLCB2aWV3ZXIsIGZvcm1hdElkOwoKZnVuY3Rpb24gZm9ybWF0KCkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgaWYgKGZvcm1hdElkKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChmb3JtYXRJZCk7CiAgICB9CiAgICBmb3JtYXRJZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgb3B0aW9ucywgcmF3LCBiZWF1dGlmaWVkOwoKICAgICAgICBvcHRpb25zID0gewogICAgICAgICAgICBpbmRlbnQ6ICcgICAgJwogICAgICAgIH07CgogICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFiJykuY2hlY2tlZCkgewogICAgICAgICAgICBvcHRpb25zLmluZGVudCA9ICdcdCc7CiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHdvc3BhY2VzJykuY2hlY2tlZCkgewogICAgICAgICAgICBvcHRpb25zLmluZGVudCA9ICcgICc7CiAgICAgICAgfQoKICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29wZW5icmFjZS1zZXBhcmF0ZS1saW5lJykuY2hlY2tlZCkgewogICAgICAgICAgICBvcHRpb25zLm9wZW5icmFjZSA9ICdzZXBhcmF0ZS1saW5lJzsKICAgICAgICB9CgogICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0b3NlbWljb2xvbicpLmNoZWNrZWQpIHsKICAgICAgICAgICAgb3B0aW9ucy5hdXRvc2VtaWNvbG9uID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgZWRpdG9yID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmF3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JhdycpLnZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJhdyA9IGVkaXRvci5nZXRWYWx1ZSgpOwogICAgICAgIH0KCiAgICAgICAgYmVhdXRpZmllZCA9IGNzc2JlYXV0aWZ5KHJhdywgb3B0aW9ucyk7CgogICAgICAgIGlmICh0eXBlb2Ygdmlld2VyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JlYXV0aWZpZWQnKS52YWx1ZSA9IGJlYXV0aWZpZWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmlld2VyLnNldFZhbHVlKGJlYXV0aWZpZWQpOwogICAgICAgIH0KCiAgICAgICAgZm9ybWF0SWQgPSB1bmRlZmluZWQ7CiAgICB9LCA0Mik7Cn0KCndpbmRvdy5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZWRpdG9yID0gQ29kZU1pcnJvci5mcm9tVGV4dEFyZWEoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJhdyIpLCB7CiAgICAgICAgbGluZU51bWJlcnM6IHRydWUsCiAgICAgICAgbWF0Y2hCcmFja2V0czogZmFsc2UsCiAgICAgICAgbGluZVdyYXBwaW5nOiB0cnVlLAogICAgICAgIHRhYlNpemU6IDgsCiAgICAgICAgb25DaGFuZ2U6IGZvcm1hdAogICAgfSk7CgogICAgdmlld2VyID0gQ29kZU1pcnJvci5mcm9tVGV4dEFyZWEoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJlYXV0aWZpZWQiKSwgewogICAgICAgIGxpbmVOdW1iZXJzOiB0cnVlLAogICAgICAgIG1hdGNoQnJhY2tldHM6IGZhbHNlLAogICAgICAgIGxpbmVXcmFwcGluZzogdHJ1ZSwKICAgICAgICByZWFkT25seTogdHJ1ZSwKICAgICAgICB0YWJTaXplOiA4CiAgICB9KTsKCiAgICBmb3JtYXQoKTsKfTsKCgogIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5Pgo8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogIDxoZWFkZXI+ICAKICAgICAgICAgIDxhIGhyZWY9IiMiIGNsYXNzPSdwcnAgY2xvc2UnIGVuYWJsZWQgPjwvYT4KICAgICAgPGEgaHJlZj0iIyIgY2xhc3M9J3BycCBtaW4nPjwvYT4KICAgICAgPGEgaHJlZj0iIyIgY2xhc3M9J3BycCBtYXgnPjwvYT4gIAogICAgICA8YSBocmVmPSIjIiBjbGFzcz0nbWF4ZXInPiYjODY2MDs8L2E+CiAgICAgIDxoMT48YSBocmVmPSJodHRwczovL3NvYmF0bWFzYnJvLmJsb2dzcG90LmNvbSIgdGFyZ2V0PSJfYmxhbmsiPkNTUyBCZWF1dGlmaWVyIHwgQmxvZyBTb2JhdCBNYXNicm88L2E+PC9oMT4KICA8c3Ryb25nPkNTUyBCZWF1dGlmaWVyIFRvb2wgdW50dWsgTWVyYXBpaGthbiBhdGF1IE1lbXBlcmNhbnRpayBDU1MgeWFuZyBCZXJhbnRha2FuPC9zdHJvbmc+PC9oZWFkZXI+CgogICAgPGRpdiBjbGFzcz0icmF3Ij4KICAgICAgPGgzPlBhc3RlIEtvZGUgQ1NTICBzb2JhdCwgeWFuZyBUaWRhayBSYXBpaCA6PC9oMz4KICAgICAgPHRleHRhcmVhIGlkPSJyYXciIHJvd3M9IjIyIiBhdXRvZm9jdXM9ImF1dG9mb2N1cyIgc3BlbGxjaGVjaz0iZmFsc2UiIG9uQ2hhbmdlPSdmb3JtYXQoKScgb25LZXlEb3duPSdmb3JtYXQoKSc+PC90ZXh0YXJlYT4KICAgICAgICAgICAgPGgzPkNUUkwgKyBWIDogVW50dWsgTWVtYXN1a2FuIENTUzwvaDM+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImZvcm1hdHRlZCI+CiAgICAgICAgPGgzPktvZGUgQ1NTIHlhbmcgc3VkYWggZGkgUmFwaWhrYW4gOjwvaDM+CiAgICAgICAgPHRleHRhcmVhIGlkPSJiZWF1dGlmaWVkIiByb3dzPSIyMiIgcmVhZG9ubHk+PC90ZXh0YXJlYT4KICAgICAgICAgICAgICAgICAgICA8aDM+Q1RSTCArIEEgKyBDIDogVW50dWsgTWVuY29weSBDU1M8L2gzPgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJvcHRpb25zIj4KICAgICAgICA8aDM+UGVuZ2F0dXJhbiA6PC9oMz4KICAgICAgICA8cD5KYXJhayBQZXJpbnRhaCBDU1M8YnI+CiAgICAgICAgPGlucHV0IGNoZWNrZWQgdHlwZT0icmFkaW8iIG5hbWU9ImluZGVudCIgaWQ9ImZvdXJzcGFjZXMiIHZhbHVlPSJmb3Vyc3BhY2VzIiBvbkNoYW5nZT0nZm9ybWF0KCknPgogICAgICAgICAgPGxhYmVsPjQgU3Bhc2k8L2xhYmVsPjxicj4KICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImluZGVudCIgaWQ9InR3b3NwYWNlcyIgdmFsdWU9InR3b3NwYWNlcyIgb25DaGFuZ2U9J2Zvcm1hdCgpJz4KICAgICAgICAgIDxsYWJlbD4yIFNwYXNpPC9sYWJlbD48YnI+CiAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuYW1lPSJpbmRlbnQiIGlkPSJ0YWIiIHZhbHVlPSJ0YWIiIG9uQ2hhbmdlPSdmb3JtYXQoKSc+ICAgICAgICA8bGFiZWw+VGFiPC9sYWJlbD4KICAgICAgICA8L3A+CiAgICAgICAgPHA+UGVuZW1wYXRhbiBQZW1idWthIDo8YnI+CiAgICAgICAgPGlucHV0IGNoZWNrZWQgdHlwZT0icmFkaW8iIG5hbWU9Im9wZW5icmFjZSIgaWQ9Im9wZW5icmFjZS1lbmQtb2YtbGluZSIgb25DaGFuZ2U9J2Zvcm1hdCgpJz48bGFiZWw+U2V0ZWxhaCBLZXBhbGE8L2xhYmVsPjxicj4KICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9Im9wZW5icmFjZSIgaWQ9Im9wZW5icmFjZS1zZXBhcmF0ZS1saW5lIiBvbkNoYW5nZT0nZm9ybWF0KCknPjxsYWJlbD5EaWJhd2FoIEtlcGFsYTwvbGFiZWw+CiAgICAgICAgPC9wPgogICAgICAgIDxwPjxpbnB1dCBjaGVja2VkIHR5cGU9ImNoZWNrYm94IiBuYW1lPSJhdXRvc2VtaWNvbG9uIiBpZD0iYXV0b3NlbWljb2xvbiIgb25DaGFuZ2U9J2Zvcm1hdCgpJz48bGFiZWw+T3RvbWF0aXMgbWVtYmVyaSBwZW51dHVwICggPGI+OzwvYj4gKTwvbGFiZWw+PC9wPgogICAgPC9kaXY+CiAgICA8YnIgY2xlYXI9ImFsbCIvPgogICAgPGRpdiBjbGFzcz0iZm9vdGVyIj48c3Ryb25nPjxzY3JpcHQ+CmZvb3RibG9nc29iYXRtYXNicm89bmV3IERhdGUoKTsKdGhuc29iYXRtYXNicm89Zm9vdGJsb2dzb2JhdG1hc2Jyby5nZXRGdWxsWWVhcigpOwpkb2N1bWVudC53cml0ZSgiQ29weXJpZ2h0ICZjb3B5OyAyMDE3LSIrdGhuc29iYXRtYXNicm8pOwo8L3NjcmlwdD4tIENTUyBCZWF1dGlmaWVyIHwgUHVibGlzaGVkIGJ5IDxhIGhyZWY9Imh0dHBzOi8vc29iYXRtYXNicm8uYmxvZ3Nwb3QuY29tIiB0YXJnZXQ9Il9ibGFuayIgdGl0bGU9J0tsaWsgdW50dWsgbWFtcGlyIGtlIEJsb2cgU29iYXQgTWFzYnJvJyA+QmxvZyBTb2JhdCBNYXNicm88L2E+PC9zdHJvbmc+PC9kaXY+CjwvZGl2Pgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgphOmxpbmsgLCBhOnZpc2l0ZWQgeyBjb2xvcjojMzMzOyB9Cjwvc3R5bGU+CjwvYm9keT4KPC9odG1sPg==" style="border: none; height: 100%; width: 100%;"></iframe>'});});
